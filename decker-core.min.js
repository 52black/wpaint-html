VERSION="1.56",DANGEROUS=0,window.HIDE_NAV=0;let allocs=0,calldepth=0,do_panic=0;NIL={t:"nil"},linil=e=>e&&"nil"==e.t,lmn=e=>(allocs++,{t:"num",v:isFinite(e)?+e:0}),lin=e=>e&&"num"==e.t,lms=e=>(allocs++,{t:"str",v:""+e}),lis=e=>e&&"str"==e.t,lml=e=>(allocs++,{t:"lst",v:e}),lil=e=>e&&"lst"==e.t,lmd=(e,t)=>(allocs++,{t:"dic",k:e||[],v:t||[]}),lid=e=>e&&"dic"==e.t,lmt=e=>(allocs++,{t:"tab",v:new Map}),lit=e=>e&&"tab"==e.t,lmi=(e,t,r)=>(allocs++,{t:"int",f:e,n:t}),lii=e=>e&&"int"==e.t,lmon=(e,t,r)=>(allocs++,{t:"on",n:e,a:t,b:r,c:null}),lion=e=>e&&"on"==e.t,lmnat=e=>(allocs++,{t:"nat",f:e}),linat=e=>e&&"nat"==e.t,lmblk=e=>(allocs++,{t:"blk",b:[],locals:[]}),liblk=e=>e&&"blk"==e.t,lmbool=e=>e?ONE:ZERO,lmenv=e=>{allocs++;const t={t:"env",v:new Map,p:e,local:(e,r)=>env_local(t,lms(e),r)};return t},ZERO=lmn(0),ONE=lmn(1),seed=74565,max=Math.max,min=Math.min,abs=Math.abs,ISODATE=lms("%04i-%02i-%02iT%02i:%02i:%02iZ%n%m"),PARTS=["year","month","day","hour","minute","second"].map(lms),drom_toupper=e=>e.replace(/([ßẞ])|([^ßẞ])/g,(e,t,r)=>t?"ẞ":r.toUpperCase()),drom_tolower=e=>e.replace(/([ßẞ])|([^ßẞ])/g,(e,t,r)=>t?"ß":r.toLowerCase()),clchars=e=>e.normalize("NFC").replace(/(\r)|(\t)|([‘’])|([“”])|([^\x20-\x7E\n…ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿĀāĂăĄąĆćĒēĘęĪīıŁłŃńŌōŐőŒœŚśŠšŪūŰűŸŹźŻżŽžȘșȚțẞ¡¿«»€°\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3000-\u303f\uff00-\uffef]$)/gm,(e,t,r,i,l)=>t?"":r?" ":i?"'":l?'"':"�"),drom_chars="…ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿĀāĂăĄąĆćĒēĘęĪīıŁłŃńŌōŐőŒœŚśŠšŪūŰűŸŹźŻżŽžȘșȚțẞ¡¿«»€°".split(""),drom_idx=new Map,drom_chars.forEach((e,t)=>drom_idx.set(e.charCodeAt(0),127+t)),drom_to_ord=e=>{const t=e.charCodeAt(0);return 10==t||t>=32&&t<=126?t:drom_idx.get(t)||255},drom_from_ord=e=>9==e?" ":10==e?"\n":13==e?"":e>=32&&e<=126?String.fromCharCode(e):e>=127&&e<=240?drom_chars[e-127]:"�",wnum=e=>{let t="",r="",i=e<0?(e=-e,"-"):"",l=Math.floor(e);for((e=Math.round(1e6*(e-Math.floor(e))))>=1e6&&l++;l>0;)t=(0|l%10)+t,l/=10;for(let t=0;t<6;t++)r=(0|e%10)+r,e/=10;return i+("0"+t).replace(/^(0+)(?=[^0])/,"")+("."+r).replace(/(\.?0+)$/,"")},mod=(e,t)=>e-t*Math.floor(e/t),range=e=>Array.from(Array(e)).map((e,t)=>t),tab_get=(e,t)=>e.v.get(t),tab_has=(e,t)=>null!=e.v.get(t),tab_cell=(e,t,r)=>(e.v.get(t)||[])[r],tab_set=(e,t,r)=>e.v.set(t,r),tab_cols=e=>{const t=[];for(let r of e.v.keys())t.push(r);return t},tab_row=(e,t)=>{const r=lmd();for(let i of e.v.keys())dset(r,lms(i),tab_cell(e,i,t));return r},tab_splice=(e,t,r)=>{const i=lmt();for(let l of r.v.keys())tab_set(i,l,e(t,tab_get(r,l)));return i},tab_clone=e=>{const t=lmt();for(let r of e.v.keys())tab_set(t,r,tab_get(e,r).slice(0));return t},tab_rowcount=e=>e.v.size?e.v.values().next().value.length:0,torect=e=>{let t=0;for(let r of e.v.values())t=max(t,lil(r)?count(r):1);for(let r of e.v.keys()){const i=tab_get(e,r);tab_set(e,r,take(t,lil(i)?i.v:[i]))}},count=e=>lin(e)?1:lis(e)||lil(e)||lid(e)?e.v.length:lit(e)?tab_rowcount(e):0,rows=e=>{const t=lt(e);return lml(range(tab_rowcount(t)).map(e=>tab_row(t,e)))},coltab=e=>{const t=lmn(e.v.reduce((e,t)=>max(e,lil(t)?count(t):1),0)),r=lmt();return e.k.map((i,l)=>tab_set(r,ls(i),dyad.take(t,dyad.take(t,lil(e.v[l])?e.v[l]:lml([e.v[l]]))).v)),r},rowtab=e=>{const t=[],r=lmt();return e.v.map(e=>e.k.map(e=>{tab_has(r,ls(e))||t.push(e),tab_set(r,ls(e),[])})),e.v.map(e=>t.map(t=>tab_get(r,ls(t)).push(dget(e,t)||NIL))),r},listab=e=>{const t=e.v.reduce((e,t)=>max(e,count(t)),0),r=lmt();for(let e=0;e<t;e++)tab_set(r,"c"+e,[]);return e.v.map(e=>{for(let i=0;i<t;i++)tab_get(r,"c"+i).push(i>=count(e)?NIL:e.v[i])}),r},tflip=e=>{const t=tab_cols(e),r=t.indexOf("key")>-1?"key":t[0],i=(tab_get(e,r)||[]).map(ls),l=t.filter(e=>e!=r),s=lmt();return tab_set(s,"key",l.map(lms)),i.map((t,r)=>tab_set(s,t,l.map(t=>tab_cell(e,t,r)))),s},tcat=(e,t)=>{const r=lmt();return tab_cols(e).map(i=>tab_set(r,i,tab_get(e,i).concat(tab_has(t,i)?[]:range(count(t)).map(e=>NIL)))),tab_cols(t).map(i=>tab_set(r,i,(tab_has(e,i)?tab_get(e,i):range(count(e)).map(e=>NIL)).concat(tab_get(t,i)))),r},zip=(e,t,r)=>{const i=count(e),l=count(t)<i?take(i,t.v):t.v;return e.v.map((e,t)=>r(e,l[t%i]))},dzip=(e,t,r)=>{const i=lmd(e.k.slice(0),e.v.map((i,l)=>r(i,dget(t,e.k[l])||NIL)));return t.k.filter(t=>!dget(e,t)).map(e=>dset(i,e,r(NIL,dget(t,e)))),i},match=(e,t)=>e==t?1:e.t!=t.t||count(e)!=count(t)?0:lin(e)||lis(t)?e.v==t.v:lil(e)?e.v.every((e,r)=>dyad["~"](e,t.v[r]).v):lit(e)?dyad["~"](rows(e),rows(t)).v:lid(e)?e.v.every((r,i)=>dyad["~"](r,t.v[i]).v&&dyad["~"](e.k[i],t.k[i]).v):0,splice=(e,t,r)=>lis(r)?lms(e(t,ll(r)).map(ls).join("")):lid(r)?lmd(e(t,r.k),e(t,r.v)):lit(r)?tab_splice(e,t,r):lml(e(t,ll(r))),ina=(e,t)=>lmn(lis(t)?t.v.indexOf(ls(e))>=0:lil(t)?t.v.some(t=>match(e,t)):lid(t)?null!=dget(t,e):lit(t)?tab_has(t,ls(e)):e==t),filter=(e,t,r)=>{if(t=lis(t)||linil(t)?monad.list(t):lml(ll(t)),lid(r)){const i=lmd();return r.k.forEach((l,s)=>e==lb(ina(l,t))&&dset(i,l,r.v[s])),i}if(!lit(r))return lml(ll(r).filter(r=>e==lb(ina(r,t))));const i=t.v.every(lin),l=t.v.map(ln),s=range(tab_rowcount(r));if(i&&e){const e=dyad.take(ZERO,r);return l.forEach(t=>{for(c of r.v.keys()){const i=tab_cell(r,c,t);i&&tab_get(e,c).push(i)}}),e}if(i&&!e){const e=dyad.take(ZERO,r);return s.forEach(t=>{if(l.indexOf(t)<0)for(let i of r.v.keys())tab_get(e,i).push(tab_cell(r,i,t))}),e}const n=lmt();for(let i of r.v.keys())e==lb(ina(lms(i),t))&&tab_set(n,i,tab_get(r,i));return n},take=(e,t)=>{const r=t.length,i=e<0?mod(e,r):0;return range(abs(e)).map(e=>t[mod(e+i,r)]||NIL)},dkix=(e,t)=>e.k?e.k.findIndex(e=>match(t,e)):-1,dget=(e,t)=>e.v?e.v[dkix(e,t)]:void 0,dvix=(e,t)=>e.v?e.v.findIndex(e=>match(t,e)):-1,dkey=(e,t)=>e.k?e.k[dvix(e,t)]:void 0,dset=(e,t,r)=>{e.k||(e.k=[]),e.v||(e.v=[]);const i=e.k.findIndex(e=>match(e,t));return i<0?(e.k.push(t),e.v.push(r)):e.v[i]=r,e},union=(e,t)=>{const r=lmd(e.k.slice(0),e.v.slice(0));return t.k.forEach(e=>dset(r,e,dget(t,e))),r},amend=(e,t,r)=>{if(lii(e))return e.f(e,t,r);if(lit(e)&&lin(t)){const i=tab_clone(e),l=count(e),s=ll(monad.keys(e)),n=0|ln(t);return r=lid(r)?r:lmd(s,new Array(s.length).fill(r)),n>=0&&n<l&&r.k.map((e,t)=>{e=ls(e),tab_has(i,e)&&(tab_get(i,e)[n]=r.v[t])}),i}if(lit(e)&&lis(t)){const i=tab_clone(e),l=count(e),s=lil(r)?ll(r).slice(0,l):new Array(l).fill(r);for(;s.length<l;)s.push(NIL);return tab_set(i,ls(t),s),i}if(!lis(e)&&!lil(e)&&!lid(e))return amend(lml([]),t,r);if((lil(e)||lis(e))&&(!lin(t)||ln(t)<0||ln(t)>count(e)))return amend(ld(e),t,r);if(lil(e)){const i=lml(e.v.slice(0));return i.v[0|ln(t)]=r,i}return lid(e)?dset(lmd(e.k.slice(0),e.v.slice(0)),t,r):lis(e)?lms(ls(e).slice(0,ln(t))+ls(r)+ls(e).slice(1+ln(t))):lml([])},l_at=(e,t)=>{if(linil(e))return NIL;if(lii(e))return lis(t)&&"type"==t.v?lms(e.n):e.f(e,t);if(lit(e)&&lin(t)&&(e=monad.rows(e)),(lis(e)||lil(e))&&linil(t)&&(t=ZERO),!lis(e)&&!lil(e)||lin(t)||(e=ld(e)),lit(e)&&lis(t)){const r=tab_get(e,ls(t));return r?lml(r):NIL}return lis(e)?lms(e.v[0|ln(t)]||""):lil(e)?e.v[0|ln(t)]||NIL:lid(e)&&dget(e,t)||NIL},amendv=(e,t,r,i,l)=>{lii(e)&&(l.v=0);const s=monad.first(t[i]||NIL);return!l.v&&i+1<t.length?amendv(l_at(e,s),t,r,i+1,l):i+1<t.length?amend(e,s,amendv(l_at(e,s),t,r,i+1,l)):i+1==t.length?amend(e,s,r):r},lb=e=>linil(e)?0:lin(e)?0!=e.v:lis(e)?""!=e.v:lil(e)||lid(e)?e.v.length:1,ln=e=>linil(e)?0:lin(e)?e.v:lis(e)?isFinite(e.v)?+e.v:0:lil(e)||lid(e)?ln(e.v[0]):0,ls=e=>lin(e)?wnum(e.v):lis(e)?e.v:lil(e)?e.v.map(ls).join(""):"",ll=e=>linil(e)?[]:lis(e)?e.v.split("").map(lms):lil(e)||lid(e)?e.v:lit(e)?rows(e).v:[e],ld=e=>lid(e)?e:lit(e)?monad.cols(e):lil(e)||lis(e)?lmd(range(count(e)).map(lmn),lis(e)?ll(e):e.v):lmd(),lt=e=>{if(lit(e))return e;const t=lmt();return linil(e)||(lid(e)&&tab_set(t,"key",e.k.slice(0)),tab_set(t,"value",ll(e))),t},vm=e=>{const t=r=>lid(r)?lmd(r.k,r.v.map(t)):lil(r)?lml(r.v.map(t)):e(r);return t},vd=e=>{const t=(r,i)=>lid(r)&lid(i)?dzip(r,i,t):lid(r)&!lid(i)?lmd(r.k.slice(0),r.v.map(e=>t(e,i))):!lid(r)&lid(i)?lmd(i.k.slice(0),i.v.map(e=>t(r,e))):lil(r)&lil(i)?lml(zip(r,i,t)):lil(r)&!lil(i)?lml(r.v.map(e=>t(e,i))):!lil(r)&lil(i)?lml(i.v.map(e=>t(r,e))):e(r,i);return t},vmnl=e=>{const t=r=>lil(r)&&ll(r).some(e=>!lin(e))?lml(r.v.map(t)):e(r);return t},fstr=e=>{let t=0;return e.split("").map(e=>{let r=0;return"<"==e?t=1:"/"==e&&t?r=1:" "!=e&&"\n"!=e&&(t=0),r?"\\/":{"\n":"\\n","\\":"\\\\",'"':'\\"'}[e]||e}).join("")},fjson=e=>lin(e)?wnum(e.v):lit(e)?fjson(rows(e)):lil(e)?`[${e.v.map(fjson).join(",")}]`:lis(e)?`"${fstr(e.v)}"`:lid(e)?`{${e.k.map((t,r)=>`${fjson(lms(ls(t)))}:${fjson(e.v[r])}`).join(",")}}`:"null",fii=e=>{const t=ifield(e,"encoded");return linil(t)?"null":ls(t)},flove=e=>lin(e)||lis(e)?fjson(e):lil(e)?`[${e.v.map(flove).join(",")}]`:lid(e)?`{${e.k.map((t,r)=>`${flove(t)}:${flove(e.v[r])}`).join(",")}}`:lit(e)?`<${tab_cols(e).map(t=>`${flove(lms(t))}:${flove(lml(tab_get(e,t)))}`).join(",")}>`:lii(e)?fii(e):"null",pjson=(e,t,r)=>{const i=t,l=l=>m&&e[t]&&(r?t-i<r:1),s=l=>m&&t+l<=e.length&&(r?t+l-i<r:1),n=r=>{for(;l()&&/[0-9]/.test(e[t]);)t++},o=r=>l()&&e[t]==r?(t++,1):0,a=r=>/[ \n]/.test(e[t]),d=e=>{for(;l()&&a();)t++},c=r=>"n"==r?"\n":/[\\/"']/.test(r)?r:"u"==r&&s(4)?String.fromCharCode(parseInt(e.slice(t,t+=4),16)):" ";let A=1,m=1,_=r=>{const i={null:NIL,false:ZERO,true:ONE};for(let r in i)if(s(r.length)&&e.slice(t,t+r.length)==r)return t+=r.length,i[r];if(o("[")){const e=lml([]);for(;A&&l()&&(d(),!o("]"));)e.v.push(_()),d(),o(",");return e}if(o("{")){const e=lmd();for(;A&&l()&&(d(),!o("}"));){const t=_();d(),o(":"),d(),A&&dset(e,t,_()),d(),o(",")}return e}if(o('"')){let r="";for(;A&&l()&&!o('"');)r+=s(2)&&o("\\")?c(e[t++]):e[t++];return lms(clchars(r))}if(o("'")){let r="";for(;A&&l()&&!o("'");)r+=s(2)&&o("\\")?c(e[t++]):e[t++];return lms(clchars(r))}const a=t;return o("-"),n(),o("."),n(),(o("e")||o("E"))&&(o("-")||o("+"),n()),t<=a?(A=0,NIL):lmn(+e.slice(a,t))};return{value:_(),index:t}},idecode=e=>{const t=e.slice(0,5).toLowerCase();return"%%img"==t?image_read(e):"%%snd"==t?sound_read(e):"%%dat"==t?array_read(e):NIL},plove=(e,t,r)=>{const i=t,l=l=>m&&e[t]&&(r?t-i<r:1),s=l=>m&&t+l<=e.length&&(r?t+l-i<r:1),n=r=>{for(;l()&&/[0-9]/.test(e[t]);)t++},o=r=>l()&&e[t]==r?(t++,1):0,a=r=>/[ \n]/.test(e[t]),d=e=>{for(;l()&&a();)t++},c=r=>"n"==r?"\n":/[\\/"']/.test(r)?r:"u"==r&&s(4)?String.fromCharCode(parseInt(e.slice(t,t+=4),16)):" ";let A=1,m=1,_=r=>{const i={null:NIL,false:ZERO,true:ONE};for(let r in i)if(s(r.length)&&e.slice(t,t+r.length)==r)return t+=r.length,i[r];if(o("[")){const e=lml([]);for(;A&&l()&&(d(),!o("]"));)e.v.push(_()),d(),o(",");return e}if(o("{")){const e=lmd();for(;A&&l()&&(d(),!o("}"));){const t=_();d(),o(":"),d(),A&&dset(e,t,_()),d(),o(",")}return e}if(o("<")){const e=lmd();for(;A&&l()&&(d(),!o(">"));){const t=_();d(),o(":"),d(),A&&dset(e,lms(ls(t)),lml(ll(_()))),d(),o(",")}return monad.table(e)}if(o("%")){o("%");let r="%%";for(;A&&l()&&/[a-zA-Z0-9+/=]/.test(e[t]);)r+=e[t++];return idecode(r)}if(o('"')){let r="";for(;A&&l()&&!o('"');)r+=s(2)&&o("\\")?c(e[t++]):e[t++];return lms(r)}if(o("'")){let r="";for(;A&&l()&&!o("'");)r+=s(2)&&o("\\")?c(e[t++]):e[t++];return lms(r)}const a=t;return o("-"),n(),o("."),n(),(o("e")||o("E"))&&(o("-")||o("+"),n()),t<=a?(A=0,NIL):lmn(+e.slice(a,t))};return{value:_(),index:t}},format_has_names=e=>{let t=0;for(;e[t];){if("%"!=e[t]){t++;continue}if(t++,"["==e[t])return 1;for("*"==e[t]&&t++,"-"==e[t]&&t++,"0"==e[t]&&t++;/[0-9]/.test(e[t]);)t++;"."==e[t]&&t++;let r=0;for(;/[0-9]/.test(e[t]);)r=10*r+ +e[t++];if(!e[t])break;const i=e[t++];if("r"==i||"o"==i)for(;r&&e[t];)r--,t++}return 0},razetab=e=>{const t=tab_cols(e);return dyad.dict(lml(tab_get(e,t[0])||[]),lml(tab_get(e,t[1])||[]))},monad={"-":vm(e=>lmn(-ln(e))),"!":vm(e=>lmbool(!lb(e))),floor:vm(e=>lmn(Math.floor(ln(e)))),cos:vm(e=>lmn(Math.cos(ln(e)))),sin:vm(e=>lmn(Math.sin(ln(e)))),tan:vm(e=>lmn(Math.tan(ln(e)))),exp:vm(e=>lmn(Math.exp(ln(e)))),ln:vm(e=>lmn(Math.log(ln(e)))),sqrt:vm(e=>lmn(Math.sqrt(ln(e)))),unit:vm(e=>{const t=ln(e);return lml([lmn(Math.cos(t)),lmn(Math.sin(t))])}),mag:vmnl(e=>lmn(Math.sqrt(ll(e).reduce((e,t)=>e+Math.pow(ln(t),2),0)))),heading:vmnl(e=>{const t=getpair(e);return lmn(Math.atan2(t.y,t.x))}),sum:e=>ll(e).reduce(dyad["+"],ZERO),prod:e=>ll(e).reduce(dyad["*"],ONE),raze:e=>lit(e)?razetab(e):ll(e).slice(1).reduce(dyad[","],monad.first(e)),max:e=>ll(e).slice(1).reduce(dyad["|"],monad.first(e)),min:e=>ll(e).slice(1).reduce(dyad["&"],monad.first(e)),count:e=>lmn(count(e)),first:e=>linil(e)?NIL:lis(e)?e.v.length?lms(e.v[0]):NIL:lit(e)?monad.first(rows(e)):lion(e)?lms(e.n):linat(e)?lms("native"):count(e)?ll(e)[0]:NIL,last:e=>linil(e)?NIL:lis(e)?e.v.length?lms(e.v[e.v.length-1]):NIL:lit(e)?monad.last(rows(e)):count(e)?ll(e)[count(e)-1]:NIL,keys:e=>lml(lii(e)?[]:lion(e)?e.a.map(lms):ld(e).k),range:e=>lml(lin(e)?range(max(0,0|ln(e))).map(lmn):ld(e).v),list:e=>lml([e]),typeof:e=>lms({num:"number",str:"string",lst:"list",dic:"dict",tab:"table",on:"function",nat:"function",nil:"nil"}[e.t]||e.n||"interface"),flip:e=>lit(e)?tflip(e):lml(range(ll(e).reduce((e,t)=>max(e,lil(t)?count(t):1),0)).map(t=>lml(ll(e).map(e=>lil(e)?t<count(e)?e.v[t]:NIL:e)))),rows:e=>rows(e),cols:e=>{const t=lt(e),r=tab_cols(t);return lmd(r.map(lms),r.map(e=>lml(tab_get(t,e))))},table:e=>lid(e)?coltab(e):lil(e)&&e.v.every(lid)?rowtab(e):lil(e)&&e.v.every(lil)?listab(e):lt(e),"@tab":e=>{e=lt(e);const t=tab_clone(e);return tab_set(t,"index",range(count(t)).map(lmn)),tab_set(t,"gindex",range(count(t)).map(lmn)),tab_set(t,"group",range(count(t)).map(e=>ZERO)),t}},dyad={"+":vd((e,t)=>lmn(ln(e)+ln(t))),"-":vd((e,t)=>lmn(ln(e)-ln(t))),"*":vd((e,t)=>lmn(ln(e)*ln(t))),"/":vd((e,t)=>lmn(ln(e)/ln(t))),"%":vd((e,t)=>lmn(mod(ln(t),ln(e)))),"^":vd((e,t)=>lmn(Math.pow(ln(e),ln(t)))),"<":vd((e,t)=>lmn((linil(e)||lin(e))&&(linil(t)||lin(t))?ln(e)<ln(t):ls(e)<ls(t))),">":vd((e,t)=>lmn((linil(e)||lin(e))&&(linil(t)||lin(t))?ln(e)>ln(t):ls(e)>ls(t))),"=":vd((e,t)=>lmn(lii(e)||lii(t)||linil(e)||linil(t)?e==t:lin(e)&&lin(t)?ln(e)==ln(t):ls(e)==ls(t))),"&":vd((e,t)=>lin(e)||lin(t)?lmn(min(ln(e),ln(t))):lms(ls(e)<ls(t)?ls(e):ls(t))),"|":vd((e,t)=>lin(e)||lin(t)?lmn(max(ln(e),ln(t))):lms(ls(e)>ls(t)?ls(e):ls(t))),split:(e,t)=>lml(ls(t).split(ls(e)).map(lms)),fuse:(e,t)=>lms(ll(t).map(ls).join(ls(e))),dict:(e,t)=>(t=ll(t),ll(e).reduce((e,r,i)=>dset(e,r,t[i]||NIL),lmd())),take:(e,t)=>lis(t)&&lin(e)&&ln(e)<0&&abs(ln(e))<=count(t)?lms(t.v.slice(count(t)+ln(e))):lis(t)&&lin(e)&&ln(e)>=0&&ln(e)<=count(t)?lms(t.v.slice(0,ln(e))):lin(e)?splice(take,ln(e),t):filter(1,e,t),drop:(e,t)=>lis(t)&&lin(e)&&ln(e)>=0?lms(t.v.slice(ln(e))):lis(t)&&lin(e)&&ln(e)<0?lms(t.v.slice(0,max(0,count(t)+ln(e)))):lin(e)?splice((e,t)=>e<0?t.slice(0,e):t.slice(e),ln(e),t):filter(0,e,t),limit:(e,t)=>count(t)>ln(e)?dyad.take(lmn(ln(e)),t):t,in:(e,t)=>lil(e)?lml(e.v.map(e=>ina(e,t))):ina(e,t),",":(e,t)=>lit(e)&&lit(t)?tcat(e,t):lid(e)?union(e,ld(t)):lis(e)||linil(e)?dyad[","](lml([e]),t):lis(t)||linil(t)?dyad[","](e,lml([t])):lml(ll(e).concat(ll(t))),"~":(e,t)=>lmbool(match(e,t)),unless:(e,t)=>linil(t)?e:t,join:(e,t)=>{const r=e=>lin(e)?monad.range(e):lml(ll(e));if(!lit(e)||!lit(t))return lml(zip(r(e),r(t),dyad[","]));const i=e,l=t,s=tab_cols(i),n=tab_cols(l),o=n.filter(e=>s.indexOf(e)>=0),a=n.filter(e=>s.indexOf(e)<0),d=lmt();s.forEach(e=>tab_set(d,e,[])),a.forEach(e=>tab_set(d,e,[]));for(let e=0;e<count(i);e++)for(let t=0;t<count(l);t++)o.every(r=>match(tab_cell(i,r,e),tab_cell(l,r,t)))&&(s.forEach(t=>tab_get(d,t).push(tab_cell(i,t,e))),a.forEach(e=>tab_get(d,e).push(tab_cell(l,e,t))));return d},cross:(e,t)=>{const r=e=>lt(lin(e)?monad.range(e):lml(ll(e)));if(!lit(e)||!lit(t))return lml(rows(dyad.cross(r(e),r(t))).v.map(e=>lml(e.v)));const i=lt(e),l=lt(t),s=tab_cols(i),n=tab_cols(l),o=n.map(e=>s.indexOf(e)>=0?e+"_":e),a=lmt();s.forEach(e=>tab_set(a,e,[])),o.forEach(e=>tab_set(a,e,[]));for(let e=0;e<count(l);e++)for(let t=0;t<count(i);t++)s.forEach(e=>tab_get(a,e).push(tab_cell(i,e,t))),n.forEach((t,r)=>tab_get(a,o[r]).push(tab_cell(l,t,e)));return a},parse:(e,t)=>{if(lil(t))return lml(t.v.map(t=>dyad.parse(e,t)));e=ls(e),t=ls(t);let r=0,i=0,l=1,s=0,n=format_has_names(e),o=n?lmd():lml([]);for(;e[r];){if("%"!=e[r]){l&&e[r]==t[i]?i++:l=0,r++;continue}r++;let a=null;if("["==e[r]){for(r++,a="";e[r]&&"]"!=e[r];)a+=e[r++];"]"==e[r]&&r++}let d=l,c=0,A=0,m=null,_=i,u="*"==e[r]&&(r++,1),p="-"==e[r]&&(r++,1);"0"==e[r]&&r++;const g=e=>l&&t[i]&&(c?i-_<c:1),f=e=>/[0-9]/.test(e),w=e=>/[0-9a-fA-F]/.test(t[i]),y=e=>/[ \n]/.test(t[i]);for(;f(e[r]);)c=10*c+ +e[r++];for("."==e[r]&&r++;f(e[r]);)A=10*A+ +e[r++];if(!e[r])break;const h=e[r++];if("%mnzsluqarojJ".indexOf(h)<0)for(;g()&&y();)i++;if("%"==h)l&&h==t[i]?i++:l=0;else if("m"==h)m=lmbool(l);else if("n"==h)m=lmn(i);else if("z"==h)m=lmbool(l&&i==t.length);else if("s"==h||"l"==h||"u"==h){for(m=lms("");g()&&(c||t[i]!=e[r]);)m.v+=t[i++];"l"==h&&(m.v=drom_tolower(m.v)),"u"==h&&(m.v=drom_toupper(m.v))}else if("a"==h)for(m=lml([]);g()&&(c||t[i]!=e[r]);)m.v.push(lmn(drom_to_ord(t[i++])));else if("b"==h)for(m=lmbool(/[tTyYx1]/.test(t[i]));g()&&(c||t[i]!=e[r]);)i++;else if("i"==h){m=lmn(0);const e="-"==t[i]?(i++,-1):1;for(l&=f(t[i]);g()&&f(t[i]);)m.v=10*m.v+ +t[i++];m.v*=e}else if("h"==h||"H"==h)for(m=lmn(0),l&=w();g()&&w();)m.v=16*m.v+parseInt(t[i++],16);else if("j"==h)if(l){const e=pjson(t,i,c);i=e.index,m=e.value}else m=NIL;else if("J"==h)if(l){const e=plove(t,i,c);i=e.index,m=e.value}else m=NIL;else if("v"==h){for(m=lms(""),l&=!f(t[i]);g()&&/[0-9a-zA-Z_?]/.test(t[i]);)m.v+=t[i++];l&=count(m)>0}else if("q"==h){for(m=lms(""),l&='"'==t[i],l&&i++;g()&&'"'!=t[i];)"\\"==t[i]?(i++,/[n\\"]/.test(t[i])?m.v+="n"==t[i]?"\n":t[i]:l=0):m.v+=t[i],i++;(l&='"'==t[i])&&i++,l||(m=NIL)}else if("f"==h||"c"==h||"C"==h){m=lmn(0);let e=10,r="-"==t[i]?(i++,-1):1;for("c"==h&&l&&"$"==t[i]&&i++,l&=f(t[i])||"."==t[i];g()&&f(t[i]);)m.v=10*m.v+ +t[i++];for(l&&g()&&"."==t[i]&&i++;g()&&f(t[i]);)m.v+=+t[i++]/e,e*=10;m.v*=r}else if("r"==h||"o"==h){let s=e.slice(r,r+(A||1));for(m=lms(""),r+=A||1;g();){if(s.indexOf(t[i])>=0==p){c&&(l=0);break}if(m.v+=t[i++],"o"==h)break}l||(m.v="")}else if("e"==h||"p"==h){const[e,r,s,n,o,a,d,c]=ll(dyad.parse(ISODATE,lms(t.slice(i)))),A=ln(d),_=new Date(t.slice(i,i+A));A&&ln(c)?i+=A:l=0,m="e"==h?lmn(l?0|_.getTime()/1e3:0):lmd(PARTS,[e,r,s,n,o,a].map(e=>lmn(ln(e))))}else l=0;for(;c&&t[i]&&i-_<c;)i++,l=0;!u&&m&&(d||-1!="%mnz".indexOf(h)?i-_==0&&"fcCihHv".indexOf(h)>=0&&(m=NIL,l=0):m=NIL,n?dset(o,null!=a?lms(a):lmn(s),m):o.v.push(m),s++)}return n?o:1==o.v.length?o.v[0]:o},format:(e,t)=>{const r=(e,t,i)=>{if(e>=count(t))return i;const l=(count(t)-e)%2?0:1,s=format_has_names(ls(t.v[e+l])),n=lml(ll(lit(i)?rows(i):i).map(n=>dyad.format(t.v[e+l],r(e+l+1,t,lit(i)&&!s?lml(ll(n)):n))));return l?dyad.fuse(t.v[e],n):n};if(lil(e))return r(0,e,t);e=ls(e);let i="",l=0,s=0,n=format_has_names(e);for(t=n?ld(t):lil(t)?t:monad.list(t);e[l];){if("%"!=e[l]){i+=e[l++];continue}l++;let r=null;if("["==e[l]){for(l++,r="";e[l]&&"]"!=e[l];)r+=e[l++];"]"==e[l]&&l++}let o="",a=0,d=0,c="*"==e[l]&&(l++,1),A="-"==e[l]&&(l++,1),m="0"==e[l]&&(l++,1);const _=e=>/[0-9]/.test(e);for(;_(e[l]);)a=10*a+ +e[l++];for("."==e[l]&&l++;_(e[l]);)d=10*d+ +e[l++];if(!e[l])break;const u=e[l++],p=n?dget(t,null!=r?lms(r):lmn(s)):null,g="%"==u?NIL:n?p||NIL:!c&&s<count(t)?t.v[s]:NIL;if("%"==u||c||s++,"%"==u)o="%";else if("s"==u||"v"==u)o=ls(g);else if("l"==u)o=drom_tolower(ls(g));else if("u"==u)o=drom_toupper(ls(g));else if("r"==u||"o"==u){for(o=ls(g),A=1,d=max(1,d);d&&e[l];)d--,l++;d=a}else if("a"==u)o=ll(g).map(e=>drom_from_ord(ln(e))).join("");else if("b"==u)o=lb(g)?"true":"false";else if("f"==u)o=d?ln(g).toFixed(min(100,d)):wnum(ln(g));else if("c"==u){const e=ln(g);o=(e<0?"-":"")+"$"+abs(e).toFixed(min(100,d)||2)}else if("C"==u){const e=ln(g);o=(e<0?"-":"")+abs(e).toFixed(min(100,d)||2)}else if("i"==u)o=""+Math.trunc(ln(g));else if("h"==u||"H"==u)o=ln(g).toString(16),"H"==u&&(o=o.toUpperCase());else if("e"==u)o=new Date(1e3*ln(g)).toISOString().split(".")[0]+"Z";else if("p"==u){const e=ld(g);o=dyad.format(ISODATE,lml(PARTS.map(t=>dget(e,t)))).v}else"j"==u?o=fjson(g):"J"==u?o=flove(g):"q"==u&&(o=fjson(lms(ls(g))));let f=o.length;if(!d||"f"!=u&&"c"!=u&&"C"!=u||(d=0),d&&A&&(f=min(d,f)),a&&!A)for(let e=0;e<a-f;e++)i+=m?"0":" ";for(let e=d&&!A?max(0,f-d):0;e<f;e++)i+=o[e];if(a&&A)for(let e=0;e<a-f;e++)i+=m?"0":" "}return lms(i)},like:(e,t)=>{lil(t)||(t=monad.list(t));const r=t.v.map(e=>{const t={m:"",l:"",a:[]},r=ls(e).split("");for(let e=0;e<r.length;e++){t.m+="`"==r[e]&&e<r.length-1?(t.l+=r[++e],"a"):r[e]in{".":1,"*":1,"#":1}?(t.l+="!",r[e]):(t.l+=r[e],"a");for(;"*"==r[e]&&"*"==r[e+1];)e++}return t}),i=e=>{for(let t=0;t<r.length;t++){const i=r[t].m,l=r[t].l,s=i.length,n=new Uint8Array(s);if(n[0]="*"==i[0],!s&&!e.length)return ONE;if(s){for(let t=0;t<e.length;t++){const r=e[t];for(let e=s-1;e>=0;e--){const s=e>0&&n[e-1]||0==e&&0==t||e>1&&"*"==i[e-1]&&n[e-2];n[e]="*"==i[e]?n[e]||s:"."==i[e]?s:"#"==i[e]?/[0-9]/.test(r)&&s:r==l[e]&&s}}if(n[s-1]||s>1&&"*"==i[s-1]&&n[s-2])return ONE}}return ZERO};return lil(e)?lml(e.v.map(e=>i(ls(e)))):i(ls(e))},window:(e,t)=>{let r,i=ln(e),l=[];if(lis(t)?(t=ls(t),r=lms):(t=ll(t),r=lml),i>0)for(let e=0;e<t.length;e+=i)l.push(r(t.slice(e,e+i)));if(i<0){i=-i;for(let e=0;e+i-1<t.length;e++)l.push(r(t.slice(e,e+i)))}return lml(l)},fill:(e,t)=>{if(lit(t)){const r=lmt();for(let i of t.v.keys())tab_set(r,i,ll(dyad.fill(e,lml(tab_get(t,i)))));return r}return lil(t)?lml(ll(t).map(t=>dyad.fill(e,t))):lid(t)?lmd(t.k.slice(0),t.v.map(t=>dyad.fill(e,t))):linil(t)?e:t},"@where":(e,t)=>{const r=dyad.take(lmn(count(t)),lml(ll(e))),i=lml(range(count(t)).filter(e=>lb(r.v[e])).map(lmn)),l=dyad.take(i,t);return tab_set(l,"gindex",range(count(l)).map(lmn)),l},"@by":(e,t)=>{const r=dyad.take(lmn(count(t)),lml(ll(e))),i=(monad.rows(t),r.v.reduce((e,t)=>(dset(e,t,t),e),lmd([],[])).v.map((e,i)=>{const l=lml(range(count(t)).filter(t=>match(e,r.v[t])).map(lmn)),s=dyad.take(l,t);return tab_set(s,"gindex",range(count(s)).map(lmn)),tab_set(s,"group",range(count(s)).map(e=>lmn(i))),s}));return lml(i)}},merge=(e,t,r)=>{const i=lms("@index");let l=null;r||(l=lml([]),e.v.map((e,t)=>{dget(e,i).v.map(e=>l.v.push(e))})),r&&(e.v=e.v.filter(e=>count(dget(e,i)))),0==count(e)&&e.v.push(t.v.reduce((e,t)=>dset(e,t,lml([])),lmd()));let s=monad.raze(lml(e.v.map(e=>monad.table(r?e:dyad.drop(i,e)))));return r&&(l=lml(tab_get(s,"@index")),s=dyad.drop(i,s)),{r:s,ix:l}},n_uplevel=([e])=>{let t=2,r=getev(),i=null,l=ls(e);for(;r&&t;)i=r.v.get(l),i&&t--,r=r.p;return i||NIL},n_eval=([e,t,r])=>{t=t?ld(t):lmd();const i=lmd(t.k.slice(0),t.v.slice(0)),l=lmd(["value","vars"].map(lms),[NIL,i]),s=([e,t])=>{dset(e,lms("value"),t);const r=dget(e,lms("vars")),i=getev().v;for(let e of i.keys())dset(r,lms(e),i.get(e));return e};try{const t=parse(e?ls(e):"");blk_opa(t,op.BUND,2),blk_lit(t,lmnat(s)),blk_op(t,op.SWAP),blk_op(t,op.CALL),issue(env_bind(r&&lb(r)?getev():null,i.k.map(ls),lml(i.v)),t)}catch(e){dset(l,lms("error"),lms(e.x)),dset(l,lms("errorpos"),lml([lmn(e.r),lmn(e.c)]))}return l},triad={"@orderby":(e,t,r)=>{const i=(e,t,r,n)=>{if(e.length<n&&t.length<n)return 0;const o=e[n]||NIL,a=t[n]||NIL;return l(o,a)?r:s(o,a)?!r:i(e,t,r,n+1)},l=(e,t)=>lil(e)&&lil(t)?i(e.v,t.v,1,0):lb(dyad["<"](e,t)),s=(e,t)=>lil(e)&&lil(t)?i(e.v,t.v,0,0):lb(dyad[">"](e,t)),n=dyad.take(lmn(count(t)),lml(ll(e)));r=ln(r);const o=range(count(t)).sort((e,t)=>l(n.v[e],n.v[t])?r:s(n.v[e],n.v[t])?-r:e-t),a=dyad.take(lml(o.map(lmn)),t);return tab_set(a,"gindex",range(count(t)).map(lmn)),a},"@sel":(e,t,r)=>{const i=merge(t,r,0);return count(r)>1?i.r:dyad.take(i.ix,dyad.drop(lml(["index","gindex","group"].map(lms)),e))},"@ext":(e,t,r)=>{const i=monad.cols(triad["@sel"](e,t,r));return 1==count(r)?count(i)?monad.first(i):lml([]):1!=count(i)||count(i.k[0])?i:monad.first(i)},"@upd":(e,t,r)=>{e=dyad.drop(lml(["index","gindex","group"].map(lms)),e);const i=merge(t,r,1),l=i.r,s=i.ix;return tab_cols(l).map(t=>{if(tab_get(l,t)==s)return;const r=tab_has(e,t),i=range(count(e)).map(i=>r?tab_cell(e,t,i):NIL);tab_set(e,t,i),s.v.map((e,r)=>i[0|ln(e)]=tab_cell(l,t,r))}),e},"@ins":(e,t,r)=>{const i=count(t),l=Math.ceil(count(e)/i),s=monad.table(lmd(t.v,t.v.map((t,r)=>lml(range(l).map(t=>e.v[i*t+r]||NIL)))));return lin(r)?s:dyad[","](lt(r),s)}},findop=(e,t)=>Object.keys(t).indexOf(e),as_enum=e=>e.split(",").reduce((e,t,r)=>(e[t]=r,e),{});let tnames=0;tempname=e=>lms("@t"+tnames++),op=as_enum("JUMP,JUMPF,LIT,DUP,DROP,SWAP,OVER,BUND,OP1,OP2,OP3,GET,SET,LOC,AMEND,TAIL,CALL,BIND,ITER,EACH,NEXT,COL,IPRE,IPOST,FIDX,FMAP"),oplens=[3,3,3,1,1,1,1,3,3,3,3,3,3,3,3,1,1,1,1,3,3,1,3,3,3,3],blk_addb=(e,t)=>e.b.push(255&t),blk_here=e=>e.b.length,blk_setb=(e,t,r)=>e.b[t]=255&r,blk_getb=(e,t)=>255&e.b[t],blk_adds=(e,t)=>{blk_addb(e,t>>8),blk_addb(e,t)},blk_sets=(e,t,r)=>{blk_setb(e,t,r>>8),blk_setb(e,t+1,r)},blk_gets=(e,t)=>65535&(blk_getb(e,t)<<8|blk_getb(e,t+1)),blk_op=(e,t)=>{blk_addb(e,t),t==op.COL&&blk_addb(e,op.SWAP)},blk_opa=(e,t,r)=>(blk_addb(e,t),blk_adds(e,r),blk_here(e)-2),blk_imm=(e,t,r)=>{let i=e.locals.findIndex(e=>match(e,r));-1==i&&(i=e.locals.length,e.locals.push(r)),blk_opa(e,t,i)},blk_op1=(e,t)=>blk_opa(e,op.OP1,findop(t,monad)),blk_op2=(e,t)=>blk_opa(e,op.OP2,findop(t,dyad)),blk_op3=(e,t)=>blk_opa(e,op.OP3,findop(t,triad)),blk_lit=(e,t)=>blk_imm(e,op.LIT,t),blk_set=(e,t)=>blk_imm(e,op.SET,t),blk_loc=(e,t)=>blk_imm(e,op.LOC,t),blk_get=(e,t)=>blk_imm(e,op.GET,t),blk_getimm=(e,t)=>e.locals[t],blk_cat=(e,t)=>{let r=0,i=blk_here(e);for(;r<blk_here(t);){const l=blk_getb(t,r);if(l==op.LIT||l==op.GET||l==op.SET||l==op.LOC||l==op.AMEND)blk_imm(e,l,blk_getimm(t,blk_gets(t,r+1)));else if(l==op.JUMP||l==op.JUMPF||l==op.EACH||l==op.NEXT||l==op.FIDX)blk_opa(e,l,blk_gets(t,r+1)+i);else for(let i=0;i<oplens[l];i++)blk_addb(e,blk_getb(t,r+i));r+=oplens[l]}},blk_loop=(e,t,r)=>{blk_op(e,op.ITER);const i=blk_here(e);blk_lit(e,t);const l=blk_opa(e,op.EACH,0);r(),blk_opa(e,op.NEXT,i),blk_sets(e,l,blk_here(e))},blk_end=e=>{let t=0;for(;t<blk_here(e);){let r=blk_getb(e,t);if(t+=oplens[r],r!=op.CALL)continue;let i=1,l=t;for(;l<blk_here(e);){if(blk_getb(e,l)!=op.JUMP){i=0;break}const t=blk_gets(e,l+1);if(t<=l){i=0;break}l=t}i&&blk_setb(e,t-1,op.TAIL)}return e},parse=e=>{let t=0,r=0,i=0,l=null;const s=e=>{throw{x:e,r:r,c:i,i:t,stack:(new Error).stack}},n=l=>{const s=e[t++];return"\n"==s?(r++,i=0):i++,s},o=r=>e[t]in{" ":1,"\t":1,"\n":1,"#":1},a=r=>0<="0123456789".indexOf(e[t]),d=' s" sss ()ssssdsdddddddddd: sssn@nnnnnnnnnnnnnnnnnnnnnnnnnn[ ]sn nnnnnnnnnnnnnnnnnnnnnnnnnn s s',c={"\\":"\\",'"':'"',n:"\n"},A=e=>{const t=n();return c[t]?c[t]:s(`Invalid escape character '\\${t}' in string.`)},m=e=>{let t=0,r=10;for(;a();)t+=+n()/r,r*=10;return t},_=(r,i,l,s,o)=>"."!=r||a()?("."==r?s=m():(s=(e=>{let t=+e;for(;a();)t=10*t+ +n();return t})(r),s+="."==e[t]?(n(),m()):0),{t:"number",v:o*s,r:i,c:l}):{t:".",r:i,c:l},u=l=>{const a=o()||0==t||"x"=="     xx x xxxx x          x xxx x                          x  x                             x x"[e[t-1].charCodeAt(0)-32];if((()=>{for(;o();)if("#"==e[t])for(;t<e.length&&"\n"!=e[t];)n();else n()})(),t>=e.length)return{t:"the end of the script"};const c=r,m=i,u=n(),p=d[u.charCodeAt(0)-32];if(" "!=p&&null!=p||s(`Invalid character '${u}'.`),"-"==u&&a&&"d"==d[(e[t]||"").charCodeAt(0)-32])return _(n(),r,i,0,-1);if("n"==p){let r=u;for(;"n"=="                nnnnnnnnnn     n nnnnnnnnnnnnnnnnnnnnnnnnnn    n nnnnnnnnnnnnnnnnnnnnnnnnnn    "[(e[t]||" ").charCodeAt(0)-32];)r+=n();return{t:"name",v:r,r:c,c:m}}if('"'==p){let r,i="";for(;t<e.length&&'"'!=(r=n());)i+="\\"==r?A():clchars(r);return{t:"string",v:i,r:c,c:m}}return"s"==p?{t:"symbol",v:u,r:c,c:m}:"d"==p?_(u,c,m,0,1):{t:u,r:c,c:m}},p=e=>(l||(l=u()),l),g=e=>"the end of the script"!=p().t,f=e=>{const s=t,n=r,o=i,a=l;w();const d=p();return t=s,r=n,i=o,l=a,d},w=e=>{if(l){const e=l;return l=null,e}return u()},y=e=>"name"==p().t&&p().v==e,h=e=>y(e)?(w(),1):0,x=e=>p().t==e?(w(),1):0,b=e=>p().t==e?w().v:s(`Expected ${e}, but found ${p().t}.`),v=e=>!({while:1,each:1,send:1,on:1,if:1,elseif:1,else:1,end:1,do:1,with:1,local:1,select:1,extract:1,update:1,insert:1,into:1,from:1,where:1,by:1,orderby:1,asc:1,desc:1}.hasOwnProperty(e)||monad.hasOwnProperty(e)||dyad.hasOwnProperty(e)),k=e=>{const t=b("name");return v(t)||"member"==e||s(`'${t}' is a keyword, and cannot be used for a ${e} name.`),t},I=(e,t)=>{const r=[];for(;!h(e);)r.push(k(t));return r},C=e=>{const t=lmblk();return N(t),blk_end(t),t},z=e=>{let t=0,r=lmblk();for(;g()&&!x("]");)N(r),t++;return blk_opa(r,op.BUND,t),r},M=e=>{const t=lmblk();return blk_lit(t,lml([lms(k("member"))])),t},B=e=>{let t=0;for(;g();){if(h("end"))return void(t||blk_lit(e,NIL));t&&blk_op(e,op.DROP),N(e),t++}s("Expected 'end' for block.")},S=(e,t)=>{const r=(t,r)=>{if(t){const t=tempname();blk_loop(e,[ls(t)],i=>{blk_get(e,t),r()})}else r()};if(h("where")){const i=C(),l=S(e,t);return r(l,t=>{blk_lit(e,i),blk_op(e,op.COL),blk_op2(e,"@where")}),l}if(h("orderby")){const i=C(),l=h("asc")?-1:h("desc")?1:s("Expected 'asc' or 'desc'."),n=S(e,t);return r(n,t=>{blk_lit(e,i),blk_op(e,op.COL),blk_lit(e,lmn(l)),blk_op3(e,"@orderby")}),n}if(h("by")){const r=C();return S(e,t)&&blk_op1(e,"raze"),blk_lit(e,r),blk_op(e,op.COL),blk_op2(e,"@by"),1}return h("from")||s("Expected 'from'."),N(e),blk_op1(e,"@tab"),blk_op(e,op.DUP),0},D=(e,t,r)=>{const i=lmd([],[]);for(;!(y("from")||y("where")||y("by")||y("orderby"));){let e=":"==f().t,t="string"==p().t,l=lms(t?e?p().v:"":"name"==p().t?p().v:""),s=v(ls(l)),n=ls(l).length&&-1==dkix(i,l);e&&t&&!n&&(w(),w());const o=e&&n?(w(),w(),l):s&&n&&r?l:lms(r?`c${i.k.length}`:"");i.k.push(o),i.v.push(C())}const l=S(e,t),s=lmblk();blk_get(s,lms("index"));const n=lml(i.k.concat([lms("@index")])),o=tempname();l||blk_op1(e,"list"),blk_loop(e,[ls(o)],t=>{blk_lit(e,n),blk_get(e,o),i.v.map(t=>(blk_lit(e,t),blk_op(e,op.COL))),blk_lit(e,s),blk_op(e,op.COL),blk_op(e,op.DROP),blk_opa(e,op.BUND,count(n)),blk_op2(e,"dict")}),blk_lit(e,n),blk_op3(e,t)},E=(e,t)=>{const r=[];for(;{"[":1,".":1}[p().t];)if(x("[")&&r.push(z()),x(".")){if({"[":1,".":1}[p().t]){const t=tempname();return r.map(t=>(blk_cat(e,t),blk_op(e,op.CALL))),void blk_loop(e,[t.v],r=>{blk_get(e,t),E(e)})}r.push(M())}if(x(":")){r.map(t=>blk_cat(e,t)),blk_opa(e,op.BUND,r.length),blk_op(e,op.OVER);for(let t=0;t<r.length-1;t++)blk_opa(e,op.IPRE,t),blk_opa(e,op.IPOST,t);N(e),blk_imm(e,op.AMEND,t||ZERO)}else r.map(t=>(blk_cat(e,t),blk_op(e,op.CALL)))},O=e=>{if("number"==p().t)return void blk_lit(e,lmn(w().v));if("string"==p().t)return void blk_lit(e,lms(w().v));if(h("if")){const t=[];let r=0,i=0,l=-1;for(N(e),l=blk_opa(e,op.JUMPF,0);g();)if(h("elseif"))i&&s("Expected 'end'."),r||blk_lit(e,NIL),r=0,t.push(blk_opa(e,op.JUMP,0)),blk_sets(e,l,blk_here(e)),N(e),l=blk_opa(e,op.JUMPF,0);else if(h("else"))i&&s("Expected 'end'."),r||blk_lit(e,NIL),r=0,i=1,t.push(blk_opa(e,op.JUMP,0)),blk_sets(e,l,blk_here(e)),l=-1;else{if(h("end"))return r||blk_lit(e,NIL),r=0,i||t.push(blk_opa(e,op.JUMP,0)),-1!=l&&blk_sets(e,l,blk_here(e)),i||blk_lit(e,NIL),void t.map(t=>blk_sets(e,t,blk_here(e)));r&&blk_op(e,op.DROP),N(e),r++}}if(h("while")){blk_lit(e,NIL);const t=blk_here(e);N(e);const r=blk_opa(e,op.JUMPF,0);return blk_op(e,op.DROP),B(e),blk_opa(e,op.JUMP,t),void blk_sets(e,r,blk_here(e))}if(h("each")){const t=I("in","variable");return N(e),void blk_loop(e,t,t=>B(e))}if(h("on")){const t=k("function"),r=x(".")&&x(".")&&x(".");let i=I("do","argument");return r&&1!=i.length?s("Variadic functions must take exactly one named argument."):(r&&(i=["..."+i[0]]),blk_lit(e,lmon(t,i,blk_end((()=>{const e=lmblk();return B(e),e})()))),void blk_op(e,op.BIND))}if(h("send"))return blk_lit(e,lmnat(n_uplevel)),blk_lit(e,lml([lms(k("function"))])),blk_op(e,op.CALL),b("["),blk_cat(e,z()),void blk_op(e,op.CALL);if(h("local")){const t=lms(k("variable"));return b(":"),N(e),void blk_loc(e,t)}if(h("select"))return void D(e,"@sel",1);if(h("extract"))return void D(e,"@ext",0);if(h("update"))return void D(e,"@upd",1);if(h("insert")){const t=lml([]);for(;!h("with");)t.v.push(lms("string"==p().t?w().v:k("column")));let r=0,i=0;for(;;){if(h("into")){i=1;break}if(h("end")){i=0;break}N(e),r++}return 0==t.v.length&&0==r&&0==i?void blk_lit(e,lmt()):(t.v.length<1&&t.v.push(lms("value")),blk_opa(e,op.BUND,r),blk_lit(e,t),i?N(e):blk_lit(e,ZERO),void blk_op3(e,"@ins"))}if(x("("))return x(")")?void blk_lit(e,lml([])):(N(e),void b(")"));const t=p().v;if(findop(t,monad)>=0&&{symbol:1,name:1}[p().t]){if(w(),x("@")){let r=0,i=lmblk();for(;x("@");)r++;for(N(e),blk_opa(i,op.FMAP,findop(t,monad));r-- >0;){const e=tempname(),t=lmblk();blk_loop(t,[ls(e)],r=>{blk_get(t,e),blk_cat(t,i)}),i=t}blk_cat(e,i)}else N(e),blk_op1(e,t);return}const r=lms(k("variable"));if(x(":"))return N(e),void blk_set(e,r);blk_get(e,r),E(e,r)},N=e=>{if(O(e),{"[":1,".":1}[p().t]&&E(e),x("@")){let t=0;for(;x("@");)t++;const r=tempname();blk_set(e,r),blk_op(e,op.DROP),N(e);let i=lmblk();blk_get(i,r),blk_op(i,op.SWAP);const l=blk_opa(i,op.FIDX,0);for(blk_loop(i,["v"],e=>{blk_get(i,r),blk_get(i,lms("v")),blk_opa(i,op.BUND,1),blk_op(i,op.CALL)}),blk_sets(i,l,blk_here(i));t-- >0;){const e=tempname(),t=lmblk();blk_loop(t,[ls(e)],r=>{blk_get(t,e),blk_cat(t,i)}),i=t}return void blk_cat(e,i)}const t=p().v;findop(t,dyad)>=0&&{symbol:1,name:1}[p().t]&&(w(),N(e),blk_op2(e,t))},Q=lmblk();for(g()&&N(Q);g();)blk_op(Q,op.DROP),N(Q);return 0==blk_here(Q)&&blk_lit(Q,NIL),Q},env_local=(e,t,r)=>{e.v.set(ls(t),r)},env_getr=(e,t)=>{const i=ls(t);return r=e.v.get(i),r||(e.p?env_getr(e.p,t):null)},env_setr=(e,t,i)=>{const l=ls(t);return r=e.v.get(l),r?e.v.set(l,i):e.p?env_setr(e.p,t,i):null},env_get=(e,t)=>env_getr(e,t)||NIL,env_set=(e,t,r)=>{env_getr(e,t)?env_setr(e,t,r):env_local(e,t,r)},env_bind=(e,t,r)=>{const i=lmenv(e);return t.map((e,t)=>env_local(i,lms(e),r.v[t]||NIL)),i};const monadi=Object.values(monad),dyadi=Object.values(dyad),triadi=Object.values(triad),states=[];let state=null;pushstate=e=>{state&&states.push(state),state={e:[e],p:[],t:[],pcs:[]}},popstate=e=>{state=states.pop()},halt=e=>{state.p=[],state.t=[],state.e=[state.e[0]]},running=e=>state.t.length>0,getev=e=>state.e[state.e.length-1],getblock=e=>state.t[state.t.length-1],getpc=e=>state.pcs[state.pcs.length-1],setpc=e=>state.pcs[state.pcs.length-1]=e,issue=(e,t)=>(state.e.push(e),state.t.push(t),state.pcs.push(0)),descope=e=>(state.e.pop(),state.t.pop(),state.pcs.pop()),ret=e=>state.p.push(e),arg=e=>state.p.pop(),docall=(e,t,r)=>{linat(e)?ret(e.f(ll(t))):lion(e)?(r&&descope(),issue(1==e.a.length&&"."==e.a[0][0]?env_bind(e.c,[e.a[0].slice(3)],monad.list(t)):env_bind(e.c,e.a,t),e.b),calldepth=max(calldepth,state.e.length)):ret(l_at(e,monad.first(t)))},runop=e=>{const t=getblock();liblk(t)||ret(state.t.pop());const r=getpc(),i=blk_getb(t,r),l=3==oplens[i]?blk_gets(t,1+r):0;switch(setpc(r+oplens[i]),i){case op.DROP:arg();break;case op.DUP:{const e=arg();ret(e),ret(e);break}case op.SWAP:{const e=arg(),t=arg();ret(e),ret(t);break}case op.OVER:{const e=arg(),t=arg();ret(t),ret(e),ret(t);break}case op.JUMP:setpc(l);break;case op.JUMPF:lb(arg())||setpc(l);break;case op.LIT:ret(blk_getimm(t,l));break;case op.GET:ret(env_get(getev(),blk_getimm(t,l)));break;case op.SET:{const e=arg();env_set(getev(),blk_getimm(t,l),e),ret(e);break}case op.LOC:{const e=arg();env_local(getev(),blk_getimm(t,l),e),ret(e);break}case op.BUND:{const e=[];for(let t=0;t<l;t++)e.push(arg());e.reverse(),ret(lml(e));break}case op.OP1:ret(monadi[l](arg()));break;case op.OP2:{const e=arg();ret(dyadi[l](arg(),e));break}case op.OP3:{const e=arg(),t=arg();ret(triadi[l](arg(),t,e));break}case op.IPRE:{const e=arg(),t=arg();if(ret(t),docall(e,t.v[l]),lion(e)||lii(e)||linat(e))for(let e=0;e<=l;e++)t.v[e]=null;break}case op.IPOST:{const e=arg(),t=arg(),r=arg();ret(t.v[l]?r:e),ret(t),ret(e);break}case op.AMEND:{let e=arg(),r=arg(),i=ll(arg()),s=arg(),n=blk_getimm(t,l),o={v:1};i.length&&!i[0]&&(i=i.filter(e=>e),o.v=0),r=amendv(s,i,e,0,o),o.v&&!lin(n)&&env_set(getev(),n,r),ret(r);break}case op.CALL:case op.TAIL:{const e=arg(),t=arg();docall(t,e,i==op.TAIL);break}case op.BIND:{const e=arg(),t=lmon(e.n,e.a,e.b);t.c=getev(),env_local(getev(),lms(e.n),t),ret(t);break}case op.ITER:{const e=arg();ret(lil(e)?e:ld(e)),ret(lid(e)?lmd():lml([]));break}case op.FIDX:{const e=arg(),t=arg();(lid(t)||lil(t)||lis(t))&&lil(e)?(ret(lml(e.v.map(e=>l_at(t,e)))),setpc(l)):ret(e);break}case op.FMAP:{const e=arg(),t=monadi[l];ret(lid(e)?lmd(e.k,e.v.map(t)):lml(ll(e).map(t)));break}case op.EACH:{const e=arg(),t=arg(),r=arg();if(count(t)==count(r)){setpc(l),ret(t);break}const i=count(t),s=lml([r.v[i],lid(r)?r.k[i]:lmn(i),lmn(i)]);state.e.push(env_bind(getev(),e,s)),ret(r),ret(t);break}case op.NEXT:{const e=arg(),t=arg(),r=arg();state.e.pop(),lid(t)&&t.k.push(r.k[t.v.length]),t.v.push(e),ret(r),ret(t),setpc(l);break}case op.COL:{const e=arg(),t=arg(),r=tab_cols(t),i=ll(monad.cols(t));ret(t),r.push("column"),i.push(t),issue(env_bind(getev(),r,lml(i)),e);break}}for(;running()&&getpc()>=blk_here(getblock());)descope()},fchar=e=>"I"==e?"i":"B"==e?"b":"L"==e?"s":e,n_writecsv=([e,t,r])=>{let i="",l=t?ls(t).split(""):[];const s=lt(e),n=tab_cols(s).length;for(r=r?ls(r)[0]:",";l.length<n;)l.push("s");let o=0;return l.forEach((e,t)=>{"_"!=e&&(o&&(i+=r),o++,i+=tab_cols(s)[t]||`c${t+1}`)}),rows(s).v.forEach(e=>{i+="\n";let t=0;l.forEach((l,s)=>{if("_"==l)return;t&&(i+=r),t++;const n=e.v[s],o=fchar(l),a=dyad.format(lms("%"+o),"j"==o||"a"==o?monad.list(n):n).v;i+=/["\n]/.test(a)||a.indexOf(r)>=0?`"${a.replace(/"/g,'""')}"`:a})}),lms(i)},n_readcsv=([e,t,r])=>{let i=0,l=0,s=t&&lis(t)?ls(t):null,n=count(e)?ls(e):"",o=lmt();r=r?ls(r)[0]:",";const a=e=>{let t="";for(;n[i]&&"\n"!=n[i]&&n[i]!=r;)t+=n[i++];return t},d=e=>n[i]==e?(i++,1):0;for(;i<n.length&&"\n"!=n[i];){for(;d(" "););const e=a();if((!s||l<s.length&&"_"!=s[l])&&tab_set(o,e,[]),l++,d("\n"))break;for(;d(" "););d(r)}for(;s&&l<s.length;)"_"!=s[l]&&tab_set(o,"c"+l,[]),l++;s||(s="s".repeat(tab_cols(o).length));let c=0,A=0;if(s.split("").map(e=>{"_"!=e&&c++}),c=min(c,tab_cols(o).length),l=0,i>=n.length)return o;for(;i<=n.length;){for(;d(" "););let e="";if(d('"'))for(;n[i];)if(d('"')){if(!d('"'))break;e+='"'}else e+=n[i++];else e=a();if(s[l]&&"_"!=s[l]){const t=tab_cols(o)[A],r=((e[0]||"").toLowerCase(),s[l]);let i=1,n=0;"-"==e[n]&&(i=-1,n++),"$"==e[n]&&n++,tab_get(o,t).push(dyad.parse(lms("%"+fchar(r)),lms(e))),A++}if(l++,i>=n.length||"\n"==n[i]){for(;l<s.length;){"_"!=s[l++]&&A<c&&tab_get(o,tab_cols(o)[A++]).push(NIL)}if("\n"==n[i]&&i==n.length-1)break;i++,l=0,A=0}else{for(;d(" "););d(r)}}return o},n_writexml=([e,t])=>{t=t?lb(t):0;const r=e=>{const t={"&":"amp","'":"apos",'"':"quot","<":"lt",">":"gt"};return ls(e).replace(/[&'"<>]/g,e=>t[e]?`&${t[e]};`:e)},i=(e,l)=>{if(array_is(e)){const t=lms("cast"),r=ifield(e,"cast");iwrite(e,t,lms("char"));const i=iwrite(e,lml([ZERO,ifield(e,"size")]));return iwrite(e,t,r),ls(i)}if(lil(e))return e.v.map(e=>i(e,l)).join("");if(!lid(e))return r(e)+(l&&t?"\n":"");const s=ls(dget(e,lms("tag"))||lms("")),n=ld(dget(e,lms("attr"))||lmd()),o=ll(dget(e,lms("children"))||lml([])),a=`<${s}${n.k.map((e,t)=>` ${ls(e)}="${r(n.v[t])}"`).join("")}${o.length?"":"/"}>${t?"\n":""}`;return o.length?`${a}${o.map(e=>" ".repeat(t?l+2:0)+i(e,l+2)).join("")}${" ".repeat(t?l:0)}</${s}>${t?"\n":""}`:a};return lms(i(e,0))},n_readxml=([e])=>{let t=0,r=ls(e);const i=e=>r[t]==e?(t++,1):0,l=e=>{for(;r[t]&&">"!=r[t];)t++;t++},s=e=>{let i=0;for(;/[ \n]/.test(r[t]);)t++,i=1;return i},n=(e,i)=>r.slice(t,t+2+e.length)==`&${e};`?(t+=2+e.length,i):null,o=e=>{let i="";for(s();r[t]&&!/[>/= \n]/.test(r[t]);)i+=r[t++];return s(),i.toLowerCase()},a=e=>{let i="";for(;r[t]&&(" "!=e||!/[>/ \n]/.test(r[t]))&&(s()&&(i+=" "),e!=r[t]&&r[t]);)i+=n("amp","&")||n("apos","'")||n("quot",'"')||n("lt","<")||n("gt",">")||n("nbsp"," ")||r[t++];return/['"]/.test(e)&&r[t]&&t++,lms(i)},d=e=>{let n=[];for(;r[t];){const c=s();if("<![CDATA["==r.slice(t,t+9)){t+=9;let e="";for(;r[t]&&"]]>"!=r.slice(t,t+3);)e+=r[t++];t+=3,n.push(lms(e));continue}if("<"!=r[t]){c&&t--,n.push(a("<"));continue}if(t++,s(),i("!")||i("?")){l();continue}if(i("/")){const t=o();if(i(">"),e==t)break;continue}const A=lmd(),m=lmd(),_=o();for(n.push(A),dset(A,lms("tag"),lms(_)),dset(A,lms("attr"),m),dset(A,lms("children"),lml([]));r[t]&&!/[>/]/.test(r[t]);){const e=lms(o());i("=")?(s(),dset(m,e,a(i("'")?"'":i('"')?'"':" "))):dset(m,e,ONE)}i("/")?l():(r[t]&&t++,dset(A,lms("children"),d(_)))}return lml(n)};return d("")},n_random=e=>{const t=e=>{let t=seed;return t^=t<<13,t^=t>>>17,t^=t<<15,mod(seed=t,e)},r=e=>lin(e)?lmn(t(ln(e))):count(e)<1?NIL:l_at(e,lmn(t(count(e))));if(0==e.length)return t(1),lmn((2147483647&seed)/2147483647);let i=e[0]||NIL;if(lid(i)&&(i=monad.range(i)),e.length<2)return r(i);const l=ln(e[1]);if(l>=0){const e=[];for(let t=0;t<l;t++)e.push(r(i));return lml(e)}i=lin(i)?monad.range(i).v:ll(i),i.length<1&&(i=[NIL]);const s=range(i.length),n=[];for(let e=i.length-1;e>0;e--){const r=t(e+1),i=s[r];s[r]=s[e],s[e]=i}for(let e=0;e<abs(l);e++)n.push(i[s[e%i.length]]);return lml(n)};let frame_count=0;interface_system=lmi((e,t,r)=>t?r&&lis(t)&&"seed"==t.v?(seed=0|ln(r),r):lis(t)&&"version"==t.v?lms(VERSION):lis(t)&&"platform"==t.v?lms("web"):lis(t)&&"seed"==t.v?lmn(seed):lis(t)&&"frame"==t.v?lmn(frame_count):lis(t)&&"now"==t.v?lmn(0|(new Date).getTime()/1e3):lis(t)&&"ms"==t.v?lmn(0|Date.now()):lis(t)&&"workspace"==t.v?lmd(["allocs","depth"].map(lms),[allocs,calldepth].map(lmn)):r||NIL:NIL,"system"),showt=(e,t)=>{if(!t){const t=monad.rows(e).v.map(e=>e.v.map(e=>show(e)).join(" ")).join(" ");return`insert ${tab_cols(e).map(e=>e+" ").join("")}with ${t?t+" ":""}end`}try{const t=tab_cols(e).map(t=>tab_get(e,t).reduce((e,t)=>max(e,show(t).length+2),t.length+2)),r="+"+tab_cols(e).map((e,r)=>"-".repeat(t[r])).join("+")+"+",i=range(tab_rowcount(e)).map(r=>tab_cols(e).map(t=>" "+show(tab_cell(e,t,r))).map((e,r)=>e+" ".repeat(max(0,t[r]-e.length)))).map(e=>`|${e.join("|")}|`).join("\n");return`${r}\n|${tab_cols(e).map((e,r)=>` ${e+" ".repeat(t[r]-e.length-2)} `).join("|")}|\n${r}${i.length?"\n"+i+"\n"+r:""}`}catch(t){throw console.log("cannot serialize",e),t}},show=(e,t)=>linat(e)?"on native x do ... end":linil(e)?t?"":"nil":lil(e)?`(${e.v.map(e=>show(e)).join(",")})`:lit(e)?showt(e,t):lion(e)?`on ${e.n}${e.a.map(e=>" "+e).join("")} do ... end`:lis(e)?`"${e.v.split("").map(e=>({"\n":"\\n","\\":"\\\\",'"':'\\"'}[e]||e)).join("")}"`:lin(e)?fjson(e):lid(e)?`{${e.k.map((t,r)=>`${show(t)}:${show(e.v[r])}`).join(",")}}`:lii(e)?`<${e.n}>`:`<INVALID ${e}>`,FORMAT_VERSION=1,RTEXT_END=2147483647,SFX_RATE=8e3,ANTS=255,FRAME_QUOTA=MODULE_QUOTA=40960,TRANS_QUOTA=8192,LOOP_QUOTA=4096,ATTR_QUOTA=4096,BRUSH_QUOTA=128,sleep_frames=0,sleep_play=0,pending_popstate=0,DEFAULT_HANDLERS='\non link x do go[x] end\non drag x do if !me.locked|me.draggable me.line[(pointer.prev-me.offset)/me.scale x] end end\non order x do if !me.locked me.value:select orderby me.value[x] asc from me.value end end\non changecell x do\n\tf:me.format[me.col] f:if count f f else "s" end\n\tme.cellvalue:("%%%l" format f) parse x\n\tme.event["change" me.value]\nend\non navigate x do if x~"right" go["Next"] end if x~"left" go["Prev"] end end\non loop x do x end\n',DEFAULT_TRANSITIONS='\ntransition[on SlideRight c a b t do  c.paste[a c.size*t,0   ] c.paste[b c.size*(t-1),0]      end]\ntransition[on SlideLeft  c a b t do  c.paste[a c.size*(-t),0] c.paste[b c.size*(1-t),0]      end]\ntransition[on SlideDown  c a b t do  c.paste[a c.size*0,t   ] c.paste[b c.size*0,t-1  ]      end]\ntransition[on SlideUp    c a b t do  c.paste[a c.size*0,-t  ] c.paste[b c.size*0,1-t  ]      end]\ntransition[on WipeRight  c a b t do  c.rect[0,0        c.size*t,1    ]          c.merge[a b] end]\ntransition[on WipeLeft   c a b t do  c.rect[0,0        c.size*(1-t),1]          c.merge[b a] end]\ntransition[on WipeDown   c a b t do  c.rect[0,0        c.size*1,t    ]          c.merge[a b] end]\ntransition[on WipeUp     c a b t do  c.rect[0,0        c.size*1,1-t  ]          c.merge[b a] end]\ntransition[on BoxIn      c a b t do  c.rect[c.size/2   c.size*t   "center"]     c.merge[a b] end]\ntransition[on BoxOut     c a b t do  c.rect[c.size/2   c.size*1-t "center"]     c.merge[b a] end]\n',FONTS={body:"%%FNT1CAoBIAEAAAAAAAAAAAAAIQEAgICAgIAAgAAAIgMAoKAAAAAAAAAAIwUAAFD4UPhQAAAAJAUgcKigcCiocCAAJQgAf5KUbhkpRgAAJgcwSFAgVIiUYgAAJwEAgIAAAAAAAAAAKAMgQICAgICAQCAAKQOAQCAgICAgQIAAKgUAUCD4IFAAAAAAKwUAACAg+CAgAAAALAIAAAAAAAAAQECALQQAAAAA8AAAAAAALgEAAAAAAAAAgAAALwQQECAgQECAgAAAMAUAcIiIiIiIcAAAMQUAIGAgICAgIAAAMgUAcIgIECBA+AAAMwUA+BAgcAiIcAAANAUAEDBQkPgQEAAANQUA+IDwCAiIcAAANgUAMECA8IiIcAAANwUA+AgQECAgIAAAOAUAcIiIcIiIcAAAOQUAcIiIeAgQYAAAOgIAAABAAAAAQAAAOwMAAAAgAAAAICBAPAQAABAgQCAQAAAAPQUAAAD4APgAAAAAPgQAAEAgECBAAAAAPwUAMEgIECAAIAAAQAcAOESaqqqcQDgAQQUAICBQUPiIiAAAQgUA8IiI8IiI8AAAQwUAcIiAgICIcAAARAUA4JCIiIiQ4AAARQQA8ICA4ICA8AAARgQA8ICA4ICAgAAARwUAcIiAmIiIcAAASAUAiIiI+IiIiAAASQIAQEBAQEBAQAAASgUACAgICIiIcAAASwUAiJCgwKCQiAAATAQAgICAgICA8AAATQcAgsaqkoKCggAATgUAyMioqJiYiAAATwUAcIiIiIiIcAAAUAUA8IiI8ICAgAAAUQUAcIiIiIiocBAAUgUA8IiI8KCQiAAAUwUAcIiAcAiIcAAAVAUA+CAgICAgIAAAVQUAiIiIiIiIcAAAVgUAiIiIUFAgIAAAVwcAgoJUVCgoKAAAWAUAiIhQIFCIiAAAWQUAiIhQICAgIAAAWgQA8BAgQICA8AAAWwNgQEBAQEBAQGAAXASAgEBAICAQEAAAXQNgICAgICAgIGAAXgMAQKAAAAAAAAAAXwYAAAAAAAAA/AAAYAIAgEAAAAAAAAAAYQQAAABgEHCQcAAAYgQAgIDgkJCQ4AAAYwQAAABgkICQYAAAZAQAEBBwkJCQcAAAZQQAAABgkPCAYAAAZgQAMEDgQEBAQAAAZwQAAABwkJCQcBBgaAQAgIDgkJCQkAAAaQIAQADAQEBAQAAAagMAIABgICAgICDAawQAgICQoMCgkAAAbAIAwEBAQEBAQAAAbQcAAADskpKSkgAAbgQAAADgkJCQkAAAbwQAAABgkJCQYAAAcAQAAADgkJCQ4ICAcQQAAABwkJCQcBAQcgQAAACwwICAgAAAcwQAAABwgGAQ4AAAdAMAQEDgQEBAIAAAdQQAAACQkJCQcAAAdgUAAACIUFAgIAAAdwcAAACCVFQoKAAAeAUAAACIUCBQiAAAeQQAAACQkJCQcBBgegQAAADwIECA8AAAewMgQEBAgEBAQCAAfAGAgICAgICAgIAAfQOAQEBAIEBAQIAAfgUAaLAAAAAAAAAAfwUAAAAAAAAAqAAAgAVAIAAgUFD4iAAAgQUQIAAgUFD4iAAAggUgUAAgUFD4iAAAgwUoUAAgUFD4iAAAhAVQACAgUFD4iAAAhQUgUCAgUFD4iAAAhgYAPDBQUPiQnAAAhwUAcIiAgICIcCBgiARAIADwgOCA8AAAiQQgQADwgOCA8AAAigQgUADwgOCA8AAAiwRQAPCA4ICA8AAAjAKAQABAQEBAQAAAjQMgQABAQEBAQAAAjgNAoABAQEBAQAAAjwOgAEBAQEBAQAAAkAUA4JCI6IiQ4AAAkQUoUADIqKiYmAAAkgVAIHCIiIiIcAAAkwUQIHCIiIiIcAAAlAUgUHCIiIiIcAAAlQUoUHCIiIiIcAAAlgVQAHCIiIiIcAAAlwcAOkRMVGREuAAAmAVAIIiIiIiIcAAAmQUQIIiIiIiIcAAAmgUgUACIiIiIcAAAmwVQAIiIiIiIcAAAnAUQIIiIUCAgIAAAnQUAgPCIiPCAgAAAngUAcIiwiIiIsAAAnwRAIABgEHCQcAAAoAQgQABgEHCQcAAAoQQgUABgEHCQcAAAogRQoABgEHCQcAAAowQAUABgEHCQcAAApAQgUCBgEHCQcAAApQcAAAB8En6QfAAApgQAAABgkICQYCBgpwRAIABgkPCAYAAAqAQgQABgkPCAYAAAqQQgUABgkPCAYAAAqgQAUABgkPCAYAAAqwKAQADAQEBAQAAArAMgQADAQEBAQAAArQNAoADAQEBAQAAArgMAoADAQEBAQAAArwUAaBAoeIiIcAAAsARQoADgkJCQkAAAsQRAIABgkJCQYAAAsgQgQABgkJCQYAAAswQgUABgkJCQYAAAtARQoABgkJCQYAAAtQQAUABgkJCQYAAAtgYAAAA0SHhIsAAAtwRAIACQkJCQcAAAuAQgQACQkJCQcAAAuQQgUACQkJCQcAAAugQAUACQkJCQcAAAuwQgQACQkJCQcBBgvAUAAICwyIjIsIAAvQQAUACQkJCQcBBgvgVwICBQUPiIiAAAvwQAcABgEHCQcAAAwAVQcCAgUFD4iAAAwQRQcABgEHCQcAAAwgUAICBQUPiIiBAIwwQAAABgEHCQcCAQxAUQIHCIgICIcAAAxQQgQABgkICQYAAAxgRwAPCA4ICA8AAAxwQAcABgkPCAYAAAyAQA8ICA4ICA8CAQyQQAAABgkPCAYEAgygPgAEBAQEBAQAAAywMA4ADAQEBAQAAAzAIAAADAQEBAQAAAzQUAQEBQYMBAeAAAzgUAYCgwYKAgIAAAzwUQIMjIqKiYmAAA0AQgQADgkJCQkAAA0QVwAHCIiIiIcAAA0gQAcABgkJCQYAAA0wVIkHCIiIiIcAAA1AVIkABgkJCQYAAA1QcAfpCQnJCQfgAA1gYAAAB4pLygeAAA1wUQIHiAcAiIcAAA2AQgQABwgGAQ4AAA2QVQIHiAcAiIcAAA2gRQIABwgGAQ4AAA2wVwAIiIiIiIcAAA3AQAcACQkJCQcAAA3QVIkACIiIiIcAAA3gVIkACQkJCQcAAA3wVQAIiIUCAgIAAA4AQgQPAQIECA8AAA4QQgQADwIECA8AAA4gQgAPAQIECA8AAA4wQAIADwIECA8AAA5ARQIPAQIECA8AAA5QRQIADwIECA8AAA5gUAcIiAcAiIcCBA5wQAAABwgGAQ4CBA6AUA+CAgICAgACAg6QMAQEDgQEBAIEBA6gUA+IiQsIiIsAAA6wEAAIAAgICAgIAA7AUAABAAECBASDAA7QUAAChQoFAoAAAA7gUAAKBQKFCgAAAA7wYAOETwQPBEOAAA8AUwSEgwAAAAAAAA/wYA/My05Pzs/AAA",menu:"%%FNT1EA0BIAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACECAADAAMAAwADAAMAAwAAAAMAAwAAAAAAAAAAiAwAAoACgAKAAAAAAAAAAAAAAAAAAAAAAAAAAIwgSABIAfwAkACQA/gBIAEgAAAAAAAAAAAAAACQFIABwAKgA4ADgAHAAOAA4AKgAcAAgAAAAAAAlCW4AkgCUAGQACAAIABMAFIAkgCMAAAAAAAAAJggAAHgAzADNAGEAzgDMAMwAzAB4AAAAAAAAACcBAACAAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAoAyAAQADAAMAAwADAAMAAwADAAEAAIAAAAAAAKQOAAEAAYABgAGAAYABgAGAAYABAAIAAAAAAACoFAAAgAKgAcACoACAAAAAAAAAAAAAAAAAAAAArBQAAAAAAACAAIAD4ACAAIAAAAAAAAAAAAAAALAIAAAAAAAAAAAAAAAAAAAAAwADAAEAAgAAAAC0FAAAAAAAAAAAAAPgAAAAAAAAAAAAAAAAAAAAuAgAAAAAAAAAAAAAAAAAAAADAAMAAAAAAAAAALwUIAAgAEAAQACAAIABAAEAAgACAAAAAAAAAADAGAAB4AMwAzADMAMwAzADMAMwAeAAAAAAAAAAxBAAAMABwADAAMAAwADAAMAAwADAAAAAAAAAAMgYAAHgAjAAMAAwAGAAwAGAAwAD8AAAAAAAAADMGAAD8ABgAMAB4AAwADAAMAIwAeAAAAAAAAAA0BwAADAAcACwATACMAP4ADAAMAAwAAAAAAAAANQYAAPwAwADAAPgADAAMAAwAjAB4AAAAAAAAADYGAAA4AGAAwAD4AMwAzADMAMwAeAAAAAAAAAA3BgAA/AAMAAwADAAYADAAMAAwADAAAAAAAAAAOAYAAHgAzADMAMwAeADMAMwAzAB4AAAAAAAAADkGAAB4AMwAzADMAMwAfAAMABgAcAAAAAAAAAA6AgAAAAAAAMAAwAAAAAAAAADAAMAAAAAAAAAAOwIAAAAAAADAAMAAAAAAAAAAwADAAEAAgAAAADwFAAAAABgAMABgAMAAYAAwABgAAAAAAAAAAAA9BgAAAAAAAAAA/AAAAPwAAAAAAAAAAAAAAAAAPgUAAAAAwABgADAAGAAwAGAAwAAAAAAAAAAAAD8GAAB4AIwADAAYADAAMAAAADAAMAAAAAAAAABACQAAAAA+AEEAnICkgKSAmwBAAD4AAAAAAAAAQQYAAHgAzADMAMwA/ADMAMwAzADMAAAAAAAAAEIGAAD4AMwAzADMAPgAzADMAMwA+AAAAAAAAABDBgAAeADEAMAAwADAAMAAwADEAHgAAAAAAAAARAYAAPgAzADMAMwAzADMAMwAzAD4AAAAAAAAAEUFAAD4AMAAwADAAPAAwADAAMAA+AAAAAAAAABGBQAA+ADAAMAAwADwAMAAwADAAMAAAAAAAAAARwYAAHgAxADAAMAA3ADMAMwAzAB4AAAAAAAAAEgGAADMAMwAzADMAPwAzADMAMwAzAAAAAAAAABJAgAAwADAAMAAwADAAMAAwADAAMAAAAAAAAAASgYAAAwADAAMAAwADADMAMwAzAB4AAAAAAAAAEsHAADGAMwA2ADwAOAA8ADYAMwAxgAAAAAAAABMBQAAwADAAMAAwADAAMAAwADAAPgAAAAAAAAATQoAAIBAwMDhwPPAvsCcwIjAgMCAwAAAAAAAAE4HAACCAMIA4gDyALoAngCOAIYAggAAAAAAAABPBgAAeADMAMwAzADMAMwAzADMAHgAAAAAAAAAUAYAAPgAzADMAMwA+ADAAMAAwADAAAAAAAAAAFEGAAB4AMwAzADMAMwAzADMAMwAeAAMAAAAAABSBgAA+ADMAMwAzAD4AMwAzADMAMwAAAAAAAAAUwUAAHAAyADAAOAAcAA4ABgAmABwAAAAAAAAAFQGAAD8ADAAMAAwADAAMAAwADAAMAAAAAAAAABVBgAAzADMAMwAzADMAMwAzADMAHgAAAAAAAAAVgYAAMwAzADMAMwAzADMAMwAyADwAAAAAAAAAFcKAADMwMzAzMDMwMzAzMDMwMyA/wAAAAAAAABYBgAAzADMAMwAzAB4AMwAzADMAMwAAAAAAAAAWQYAAMwAzADMAMwAeAAwADAAMAAwAAAAAAAAAFoGAAD8AAwADAAYADAAYADAAMAA/AAAAAAAAABbA+AAwADAAMAAwADAAMAAwADAAMAA4AAAAAAAXAWAAIAAQABAACAAIAAQABAACAAIAAAAAAAAAF0D4ABgAGAAYABgAGAAYABgAGAAYADgAAAAAABeBQAAIABQAIgAAAAAAAAAAAAAAAAAAAAAAAAAXwgAAAAAAAAAAAAAAAAAAAAAAAD/AAAAAAAAAGADgABAACAAAAAAAAAAAAAAAAAAAAAAAAAAAABhBgAAAAAAAHgAjAB8AMwAzADMAHwAAAAAAAAAYgYAAMAAwAD4AMwAzADMAMwAzAD4AAAAAAAAAGMFAAAAAAAAcADIAMAAwADAAMgAcAAAAAAAAABkBgAADAAMAHwAzADMAMwAzADMAHwAAAAAAAAAZQYAAAAAAAB4AMwAzAD8AMAAxAB4AAAAAAAAAGYFAAA4AGAA8ABgAGAAYABgAGAAYAAAAAAAAABnBgAAAAAAAHwAzADMAMwAzADMAHwADACMAHgAaAYAAMAAwAD4AMwAzADMAMwAzADMAAAAAAAAAGkCAADAAAAAwADAAMAAwADAAMAAwAAAAAAAAABqBQAAGAAAABgAGAAYABgAGAAYABgAGACYAHAAawYAAMAAwADMANgA8ADgAPAA2ADMAAAAAAAAAGwCAADAAMAAwADAAMAAwADAAMAAwAAAAAAAAABtCgAAAAAAAP+AzMDMwMzAzMDMwMzAAAAAAAAAbgYAAAAAAAD4AMwAzADMAMwAzADMAAAAAAAAAG8GAAAAAAAAeADMAMwAzADMAMwAeAAAAAAAAABwBgAAAAAAAPgAzADMAMwAzADMAPgAwADAAAAAcQYAAAAAAAB8AMwAzADMAMwAzAB8AAwADAAAAHIFAAAAAAAA2ADgAMAAwADAAMAAwAAAAAAAAABzBQAAAAAAAHAAyADgAHAAOACYAHAAAAAAAAAAdAQAAGAAYADwAGAAYABgAGAAYAAwAAAAAAAAAHUGAAAAAAAAzADMAMwAzADMAMwAfAAAAAAAAAB2BgAAAAAAAMwAzADMAMwAzADIAPAAAAAAAAAAdwoAAAAAAADMwMzAzMDMwMzAzID/AAAAAAAAAHgGAAAAAAAAzADMAMwAeADMAMwAzAAAAAAAAAB5BgAAAAAAAMwAzADMAMwAzADMAHwADACMAHgAegYAAAAAAAD8AAwAGAAwAGAAwAD8AAAAAAAAAHsDIABAAEAAQABAAIAAQABAAEAAQAAgAAAAAAB8AYAAgACAAIAAgACAAIAAgACAAIAAgAAAAAAAfQOAAEAAQABAAEAAIABAAEAAQABAAIAAAAAAAH4GAAAAAAAAZACYAAAAAAAAAAAAAAAAAAAAAAB/CAAAAAAAAAAAAAAAAAAAAADbANsAAAAAAAAAgAYgABAAeADMAMwA/ADMAMwAzADMAAAAAAAAAIEGEAAgAHgAzADMAPwAzADMAMwAzAAAAAAAAACCBjAASAAAAHgAzADMAPwAzADMAMwAAAAAAAAAgwY0AFgAAAB4AMwAzAD8AMwAzADMAAAAAAAAAIQGSAAAAHgAzADMAPwAzADMAMwAzAAAAAAAAACFBjAASAAwAHgAzADMAPwAzADMAMwAAAAAAAAAhgkAAH+AzADMAMwA/gDMAMwAzADPgAAAAAAAAIcGAAB4AMQAwADAAMAAwADAAMQAeAAQADAAAACIBSAAEAD4AMAAwADwAMAAwADAAPgAAAAAAAAAiQUQACAA+ADAAMAA8ADAAMAAwAD4AAAAAAAAAIoFMABIAAAA+ADAAMAA8ADAAMAA+AAAAAAAAACLBUgAAAD4AMAAwADwAMAAwADAAPgAAAAAAAAAjAKAAEAAwADAAMAAwADAAMAAwADAAAAAAAAAAI0CQACAAMAAwADAAMAAwADAAMAAwAAAAAAAAACOBGAAkAAAAGAAYABgAGAAYABgAGAAAAAAAAAAjwSQAAAAYABgAGAAYABgAGAAYABgAAAAAAAAAJAGAAD4AMwAzADsAMwAzADMAMwA+AAAAAAAAACRBzQAWADCAOIA8gC6AJ4AjgCGAIIAAAAAAAAAkgYgABAAeADMAMwAzADMAMwAzAB4AAAAAAAAAJMGEAAgAHgAzADMAMwAzADMAMwAeAAAAAAAAACUBjAASAAAAHgAzADMAMwAzADMAHgAAAAAAAAAlQY0AFgAAAB4AMwAzADMAMwAzAB4AAAAAAAAAJYGSAAAAHgAzADMAMwAzADMAMwAeAAAAAAAAACXBgAAAAB0AMgAzADcAOwAzABMALgAAAAAAAAAmAYgABAAzADMAMwAzADMAMwAzAB4AAAAAAAAAJkGEAAgAMwAzADMAMwAzADMAMwAeAAAAAAAAACaBjAASAAAAMwAzADMAMwAzADMAHgAAAAAAAAAmwZIAAAAzADMAMwAzADMAMwAzAB4AAAAAAAAAJwGEAAgAMwAzADMAMwAeAAwADAAMAAAAAAAAACdBgAAwADAAPgAzADMAMwA+ADAAMAAAAAAAAAAngYAAPgAzADMANgAzADMAMwAzADYAAAAAAAAAJ8GIAAQAAAAeACMAHwAzADMAMwAfAAAAAAAAACgBhAAIAAAAHgAjAB8AMwAzADMAHwAAAAAAAAAoQYwAEgAAAB4AIwAfADMAMwAzAB8AAAAAAAAAKIGNABYAAAAeACMAHwAzADMAMwAfAAAAAAAAACjBgAASAAAAHgAjAB8AMwAzADMAHwAAAAAAAAApAYwAEgAMAB4AIwAfADMAMwAzAB8AAAAAAAAAKUKAAAAAAAAf4CMwHzAz8DMAMxAf4AAAAAAAACmBQAAAAAAAHAAyADAAMAAwADIAHAAEAAwAAAApwYgABAAAAB4AMwAzAD8AMAAxAB4AAAAAAAAAKgGEAAgAAAAeADMAMwA/ADAAMQAeAAAAAAAAACpBjAASAAAAHgAzADMAPwAwADEAHgAAAAAAAAAqgYAAEgAAAB4AMwAzAD8AMAAxAB4AAAAAAAAAKsCAACAAEAAAADAAMAAwADAAMAAwAAAAAAAAACsAgAAQACAAAAAwADAAMAAwADAAMAAAAAAAAAArQQAAGAAkAAAAGAAYABgAGAAYABgAAAAAAAAAK4EAACQAAAAYABgAGAAYABgAGAAYAAAAAAAAACvBgAAdAAYACwADAB8AMwAzADMAHgAAAAAAAAAsAY0AFgAAAD4AMwAzADMAMwAzADMAAAAAAAAALEGAAAgABAAAAB4AMwAzADMAMwAeAAAAAAAAACyBgAAEAAgAAAAeADMAMwAzADMAHgAAAAAAAAAswYAADAASAAAAHgAzADMAMwAzAB4AAAAAAAAALQGAAA0AFgAAAB4AMwAzADMAMwAeAAAAAAAAAC1BgAAAABIAAAAeADMAMwAzADMAHgAAAAAAAAAtgYAAAAAAAB0AMgA3AD8AOwATAC4AAAAAAAAALcGIAAQAAAAzADMAMwAzADMAMwAfAAAAAAAAAC4BhAAIAAAAMwAzADMAMwAzADMAHwAAAAAAAAAuQYwAEgAAADMAMwAzADMAMwAzAB8AAAAAAAAALoGAABIAAAAzADMAMwAzADMAMwAfAAAAAAAAAC7BhAAIAAAAMwAzADMAMwAzADMAHwADACMAHgAvAcAAAAAwADAANwA5gDGAMYA5gDcAMAAwAAAAL0GAABIAAAAzADMAMwAzADMAMwAfAAMAIwAeAC+BngAAAB4AMwAzAD8AMwAzADMAMwAAAAAAAAAvwYAAHgAAAB4AIwAfADMAMwAzAB8AAAAAAAAAMAGSAAwAAAAeADMAMwA/ADMAMwAzAAAAAAAAADBBkgAMAAAAHgAjAB8AMwAzADMAHwAAAAAAAAAwgYAAHgAzADMAMwA/ADMAMwAzADMABgADAAAAMMGAAAAAAAAeACMAHwAzADMAMwAfAAYAAwAAADEBggAEAB4AMQAwADAAMAAwADEAHgAAAAAAAAAxQUQACAAAABwAMgAwADAAMAAyABwAAAAAAAAAMYFeAAAAPgAwADAAPAAwADAAMAA+AAAAAAAAADHBgAAeAAAAHgAzADMAPwAwADEAHgAAAAAAAAAyAUAAPgAwADAAMAA8ADAAMAAwAD4ADAAGAAAAMkGAAAAAAAAeADMAMwA/ADAAMQAeAAYAAwAAADKBPAAAABgAGAAYABgAGAAYABgAGAAAAAAAAAAywQAAAAA8AAAAGAAYABgAGAAYABgAAAAAAAAAMwCAAAAAAAAAADAAMAAwADAAMAAwAAAAAAAAADNBgAAYABgAGAAaABwAGAA4ABgAHwAAAAAAAAAzgUAAGAAYABoAHAAYADgAGAAYABgAAAAAAAAAM8HCACSAMIA4gDyALoAngCOAIYAggAAAAAAAADQBhAAIAAAAPgAzADMAMwAzADMAMwAAAAAAAAA0QZ4AAAAeADMAMwAzADMAMwAzAB4AAAAAAAAANIGAAAAAHgAAAB4AMwAzADMAMwAeAAAAAAAAADTBkQAiAAAAHgAzADMAMwAzADMAHgAAAAAAAAA1AYAAEQAiAAAAHgAzADMAMwAzAB4AAAAAAAAANUJAAB/gMwAzADPAMwAzADMAMwAf4AAAAAAAADWCQAAAAAAAH8AyYDJgM+AyADIgH8AAAAAAAAA1wUQACAAcADIAMAA8AB4ABgAmABwAAAAAAAAANgFEAAgAAAAcADIAOAAcAA4AJgAcAAAAAAAAADZBVAAIABwAMgAwADwAHgAGACYAHAAAAAAAAAA2gVQACAAAABwAMgA4ABwADgAmABwAAAAAAAAANsGeAAAAMwAzADMAMwAzADMAMwAeAAAAAAAAADcBgAAAAB4AAAAzADMAMwAzADMAHwAAAAAAAAA3QZEAIgAAADMAMwAzADMAMwAzAB4AAAAAAAAAN4GAABEAIgAAADMAMwAzADMAMwAfAAAAAAAAADfBkgAAADMAMwAzADMAHgAMAAwADAAAAAAAAAA4AYQACAA/AAMABgAMABgAMAAwAD8AAAAAAAAAOEGEAAgAAAA/AAMABgAMABgAMAA/AAAAAAAAADiBhAAAAD8AAwAGAAwAGAAwADAAPwAAAAAAAAA4wYAABAAAAD8AAwAGAAwAGAAwAD8AAAAAAAAAOQGKAAQAPwADAAYADAAYADAAMAA/AAAAAAAAADlBigAEAAAAPwADAAYADAAYADAAPwAAAAAAAAA5gUAAHAAyADAAOAAcAA4ABgAmABwAAAAIABAAOcFAAAAAAAAcADIAOAAcAA4AJgAcAAAACAAQADoBgAA/AAwADAAMAAwADAAMAAwADAAAAAgAEAA6QQAAGAAYADwAGAAYABgAGAAYAAwAAAAIABAAOoGAAAAAHwA7ADMAMgA3ADMAMwA2AAAAAAAAADrAgAAAAAAAMAAwAAAAMAAwADAAMAAwADAAAAA7AYAAAAAAAAwADAAAAAwADAAYADAAMQAeAAAAO0IAAAAAAAAMwBmAMwAZgAzAAAAAAAAAAAAAADuCAAAAAAAAMwAZgAzAGYAzAAAAAAAAAAAAAAA7wcAADwAYgBgAPgAYAD4AGAAYgA8AAAAAAAAAPAFAAAwAEgASAAwAAAAAAAAAAAAAAAAAAAAAAD/CAAAfwBjAF0AXQB7AHcAdwB/AHcAfwAAAAAA",mono:"%%FNT1BQsBIAUAAAAAAAAAAAAAACEFAAAgICAgIAAgAAAiBQAAUFBQAAAAAAAAIwUAAFD4UPhQAAAAACQFACBwqKBwKKhwIAAlBQAASKhQIFCokAAAJgUAAGCQoECokGgAACcFACAgIAAAAAAAAAAoBQAQICBAQEAgIBAAKQUAIBAQCAgIEBAgACoFAAAgqHCoIAAAAAArBQAAACAg+CAgAAAALAUAAAAAAAAAYGAgQC0FAAAAAAD4AAAAAAAuBQAAAAAAAAAwMAAALwUICBAQICBAQICAADAFAABwiJioyIhwAAAxBQAAIGAgICAgIAAAMgUAAHCICBAgQPgAADMFAABwiAgwCIhwAAA0BQAAEDBQkPgQEAAANQUAAPiA8AgIiHAAADYFAABwgPCIiIhwAAA3BQAA+AgIECAgIAAAOAUAAHCIiHCIiHAAADkFAABwiIiIeAhwAAA6BQAAADAwAAAwMAAAOwUAAABgYAAAYGAgQDwFAAAIECBAIBAIAAA9BQAAAAD4APgAAAAAPgUAAEAgEAgQIEAAAD8FAABwiAgQIAAgAABABQBwiIio6LCAiHAAQQUAAHCIiPiIiIgAAEIFAADwiIjwiIjwAABDBQAAcIiAgICIcAAARAUAAPCIiIiIiPAAAEUFAAD4gIDwgID4AABGBQAA+ICA8ICAgAAARwUAAHCIgJiIiHAAAEgFAACIiIj4iIiIAABJBQAAICAgICAgIAAASgUAAAgICAiIiHAAAEsFAACIkKDAoJCIAABMBQAAgICAgICA+AAATQUAAIjYqIiIiIgAAE4FAACIyKiYiIiIAABPBQAAcIiIiIiIcAAAUAUAAPCIiPCAgIAAAFEFAABwiIiIiIhwCABSBQAA8IiI8IiIiAAAUwUAAHCIgHAIiHAAAFQFAAD4ICAgICAgAABVBQAAiIiIiIiIcAAAVgUAAIiIiFBQICAAAFcFAACIiIiIqNiIAABYBQAAiFAgICBQiAAAWQUAAIiIiFAgICAAAFoFAAD4CBAgQID4AABbBQAwICAgICAgIDAAXAWAgEBAICAQEAgIAF0FADAQEBAQEBAQMABeBQAgUIgAAAAAAAAAXwUAAAAAAAAAAPgAAGAFAEAgEAAAAAAAAABhBQAAAAB4iIiYaAAAYgUAAICA8IiIiPAAAGMFAAAAAHCIgIB4AABkBQAACAh4iIiIeAAAZQUAAAAAcIj4gHgAAGYFAAAYIHAgICAgAABnBQAAAAB4iIiIeAhwaAUAAICA8IiIiIgAAGkFAAAgACAgICAgAABqBQAAIAAgICAgICDAawUAAICAkKDgkIgAAGwFAAAgICAgICAwAABtBQAAAADwqKioqAAAbgUAAAAAsMiIiIgAAG8FAAAAAHCIiIhwAABwBQAAAADwiIiI8ICAcQUAAAAAeIiIiHgICHIFAAAAALDIgICAAABzBQAAAAB4gHAI8AAAdAUAACAgeCAgIBgAAHUFAAAAAIiIiJhoAAB2BQAAAACIiFBQIAAAdwUAAAAAqKioqFAAAHgFAAAAAIhQIFCIAAB5BQAAAACIiIiIeAhwegUAAAAA+BAgQPgAAHsFABggICDAICAgGAB8BSAgICAgICAgICAgfQUAwCAgIBggICDAAH4FAABosAAAAAAAAAB/BQAAAAAAAAAAqAAAgAVAIHCIiPiIiIgAAIEFECBwiIj4iIiIAACCBSBQcIiI+IiIiAAAgwUoUHCIiPiIiIgAAIQFUABwiIj4iIiIAACFBSBQIFCI+IiIiAAAhgUAADhQUPiQkJgAAIcFAABwiICAgIhwIGCIBUAg+ICA8ICA+AAAiQUQIPiAgPCAgPgAAIoFIFD4gIDwgID4AACLBVAA+ICA8ICA+AAAjAVAIAAgICAgICAAAI0FECAAICAgICAgAACOBSBQACAgICAgIAAAjwVQACAgICAgICAAAJAFAADwiIjoiIjwAACRBShQiMiomIiIiAAAkgVAIHCIiIiIiHAAAJMFECBwiIiIiIhwAACUBSBQcIiIiIiIcAAAlQUoUHCIiIiIiHAAAJYFUABwiIiIiIhwAACXBQAAaJCoqKhIsAAAmAVAIIiIiIiIiHAAAJkFECCIiIiIiIhwAACaBSBQAIiIiIiIcAAAmwVQAIiIiIiIiHAAAJwFECCIiIhQICAgAACdBQAAgPCIiPCAgAAAngUAAOCQoJCIiLAAAJ8FAEAgAHiIiJhoAACgBQAQIAB4iIiYaAAAoQUAIFAAeIiImGgAAKIFAChQAHiIiJhoAACjBQAAUAB4iIiYaAAApAUAIFAgeIiImGgAAKUFAAAAAHCouKBYAACmBQAAAABwiICAeCBgpwUAQCAAcIj4gHgAAKgFABAgAHCI+IB4AACpBQAgUABwiPiAeAAAqgUAAFAAcIj4gHgAAKsFAEAgACAgICAgAACsBQAQIAAgICAgIAAArQUAIFAAICAgICAAAK4FAABQAGAgICAgAACvBQBoECh4iIiIcAAAsAUAKFAAsMiIiIgAALEFAEAgAHCIiIhwAACyBQAQIABwiIiIcAAAswUAIFAAcIiIiHAAALQFAChQAHCIiIhwAAC1BQAAUABwiIiIcAAAtgUAAABokKioSLAAALcFAEAgAIiIiJhoAAC4BQAQIACIiIiYaAAAuQUAIFAAiIiImGgAALoFAABQAIiIiJhoAAC7BQAQIACIiIiIeAhwvAUAAICwyIjIsIAAAL0FAABQAIiIiIh4CHC+BXAAcIiI+IiIiAAAvwUAAHAAeIiImGgAAMAFUCBwiIj4iIiIAADBBQBQIAB4iIiYaAAAwgUAAHCIiPiIiIgQCMMFAAAAAHiIiJhoEAjEBRAgcIiAgICIcAAAxQUAABAgcIiAgHgAAMYFcAD4gIDwgID4AADHBQAAcABwiPiAeAAAyAUAAPiAgPCAgPAQCMkFAAAAAHCI+IBwEAjKBXAAICAgICAgIAAAywUAAHAAYCAgICAAAMwFAAAAAGAgICAgAADNBQAAQFBgQMBAeAAAzgUAACAgKDBgoDAAAM8FECCIyKiYiIiIAADQBQAQIACwyIiIiAAA0QVwAHCIiIiIiHAAANIFAABwAHCIiIhwAADTBUiQAHCIiIiIcAAA1AUASJAAcIiIiHAAANUFAAB4oKCwoKB4AADWBQAAAABQqLigWAAA1wUQIHCIgHAIiHAAANgFABAgAHiAcAjwAADZBVAgcIiAcAiIcAAA2gUAUCAAeIBwCPAAANsFcACIiIiIiIhwAADcBQAAcACIiIiYaAAA3QVIkACIiIiIiHAAAN4FAEiQAIiIiJhoAADfBVAAiIiIUCAgIAAA4AUQIPgIECBAgPgAAOEFABAgAPgQIED4AADiBSAA+AgQIECA+AAA4wUAACAA+BAgQPgAAOQFUCD4CBAgQID4AADlBQBQIAD4ECBA+AAA5gUAcIiAcAiIcAAgIOcFAAAAeIBwCPAAICDoBQAA+CAgICAgACAg6QUAACAgeCAgGAAgIOoFAAD4iJCgkIiwAADrBQAAACAAICAgICAA7AUAAAAgACBAgIhwAO0FAAAAKFCgUCgAAADuBQAAAKBQKFCgAAAA7wUAADBI4EDgSDAAAPAFADBISDAAAAAAAAD/BQAA+IiIiIiI+AAA"},COLORS=[4294967295,4294967040,4294927616,4292608e3,4294901911,4281729175,4278190282,4278228991,4278233088,4278215936,4284823040,4288111926,4290361785,4287006342,4282729797,4278190080],DEFAULT_COLORS=COLORS.slice(0),BRUSHES=[0,0,0,16,0,0,0,0,0,0,16,56,16,0,0,0,0,0,24,60,60,24,0,0,0,56,124,124,124,56,0,0,56,124,254,254,254,124,56,0,16,0,65,8,128,17,0,34,0,0,0,24,24,0,0,0,0,0,56,56,56,0,0,0,0,0,60,60,60,60,0,0,0,124,124,124,124,124,0,0,254,254,254,254,254,254,254,0,32,10,128,36,1,72,2,81,0,0,16,16,16,0,0,0,16,16,16,16,16,16,16,0,16,0,16,0,16,0,16,0,0,0,8,16,32,0,0,0,2,4,8,16,32,64,128,0,2,0,8,0,32,0,128,0,0,0,0,56,0,0,0,0,0,0,0,254,0,0,0,0,0,0,0,170,0,0,0,0,0,0,32,16,8,0,0,0,128,64,32,16,8,4,2,0,128,0,32,0,8,0,2,0],ALIGN={left:0,center:1,right:2},DEFAULT_ANIMS="[[13,9,5,1,5,9],[4,4,8,14,14,8],[18,18,20,19,19,20],[0,0,0,0,1,1,1,1]]",DEFAULT_PATTERNS="%%IMG0AAgA4AAAAAAAAAAA//////////+AgID/CAgI/yBAgMEiHAgQgAAIAIAACAD/d//d/3f/3XEiF49HInT4iFAgAgWIiIiIACIAiAAiAHfdd9133XfdQIAACAQCACABAQOESDAMAogiiCKIIogiqlWqVapVqlWABEAIASACEMAMjbEwAxvYqgCqAKoAqgD/Vf9V/1X/Vf8A/wD/AP8AqqqqqqqqqqpEiBEiRIgRIt27d+7du3fuQIABAgQIECC/f/79+/fv3wgAqgAIAIgAj493mPj4d4mqAIgUIkGIALCwsL8Av7+w",array_is=e=>lii(e)&&"array"==e.n,image_is=e=>lii(e)&&"image"==e.n,sound_is=e=>lii(e)&&"sound"==e.n,font_is=e=>lii(e)&&"font"==e.n,button_is=e=>lii(e)&&"button"==e.n,field_is=e=>lii(e)&&"field"==e.n,grid_is=e=>lii(e)&&"grid"==e.n,slider_is=e=>lii(e)&&"slider"==e.n,canvas_is=e=>lii(e)&&"canvas"==e.n,contraption_is=e=>lii(e)&&"contraption"==e.n,proxy_is=e=>lii(e)&&"proxy"==e.n,prototype_is=e=>lii(e)&&"prototype"==e.n,deck_is=e=>lii(e)&&"deck"==e.n,card_is=e=>lii(e)&&"card"==e.n,patterns_is=e=>lii(e)&&"patterns"==e.n,module_is=e=>lii(e)&&"module"==e.n,widget_is=e=>lii(e)&&{button:1,field:1,grid:1,slider:1,canvas:1,contraption:1,proxy:1}[e.n],ikey=(e,t)=>lis(e)&&e.v==t,ivalue=(e,t,r)=>e.hasOwnProperty(t)?e[t]:r,ifield=(e,t)=>e.f(e,lms(t)),iindex=(e,t,r)=>e.f(e,lmn(t),r),iwrite=(e,t,r)=>e.f(e,t,r),value_inherit=(e,t)=>{let r=e[t];"string"==typeof r&&(r=lms(r)),"number"!=typeof r&&"boolean"!=typeof r||(r=lmn(r));const i=e.card;if(!contraption_is(i))return r;const l=dget(i.def.widgets,ifield(e,"name"));if(!l)return r;const s=ifield(l,t);return r&&s&&match(r,s)&&delete e[t],r||s},init_field=(e,t,r)=>{const i=lms(t),l=dget(r,i);l&&iwrite(e,i,l)},normalize_enum=(e,t)=>e.hasOwnProperty(t)?t:Object.keys(e)[0],normalize_font=(e,t)=>ls(dkey(e,t)||e.k[dkix(e,t)]||lms("body")),data_enc=e=>null==e[5]?-1:+e[5],data_read=(e,t)=>"%%"!=t.slice(0,2)||t.slice(2,5)!=e?null:new Uint8Array(atob(t.slice(6)).split("").map(e=>e.charCodeAt(0))),data_write=(e,t)=>`%%${e}${btoa(Array.from(t).map(e=>String.fromCharCode(e)).join(""))}`,is_rooted=e=>card_is(e)?!e.dead:widget_is(e)?is_rooted(e.card)&&!e.dead:1,ceil=Math.ceil,clamp=(e,t,r)=>t<e?e:t>r?r:t,sign=e=>e>0?1:-1,last=e=>e[e.length-1],rect=(e,t,r,i)=>({x:e||0,y:t||0,w:r||0,h:i||0}),rpair=(e,t)=>rect(e.x,e.y,t.x,t.y),rcopy=e=>rect(e.x,e.y,e.w,e.h),rint=e=>rect(0|e.x,0|e.y,0|e.w,0|e.h),radd=(e,t)=>rect(e.x+t.x,e.y+t.y,e.w+t.w,e.h+t.h),rsub=(e,t)=>rect(e.x-t.x,e.y-t.y,e.w-t.w,e.h-t.h),rmul=(e,t)=>rect(e.x*t,e.y*t,e.w*t,e.h*t),rdiv=(e,t)=>rint(rmul(e,1/t)),inset=(e,t)=>rect(e.x+t,e.y+t,e.w-2*t,e.h-2*t),rin=(e,t)=>t.x>=e.x&&t.y>=e.y&&t.x<e.x+e.w&&t.y<e.y+e.h,ron=(e,t)=>t.x+t.w>=e.x&&t.x<=e.x+e.w&&t.y+t.h>=e.y&&t.y<=e.y+e.h,requ=(e,t)=>e.x==t.x&&e.y==t.y&&e.w==t.w&&e.h==t.h,rmax=(e,t)=>rect(max(e.x,t.x),max(e.y,t.y),max(e.w,t.w),max(e.h,t.h)),rmin=(e,t)=>rect(min(e.x,t.x),min(e.y,t.y),min(e.w,t.w),min(e.h,t.h)),rclip=(e,t)=>{const r=rmax(e,t);return rect(r.x,r.y,min(e.x+e.w,t.x+t.w)-r.x,min(e.y+e.h,t.y+t.h)-r.y)},runion=(e,t)=>{const r=rmin(e,t);return rect(r.x,r.y,max(e.x+e.w,t.x+t.w)-r.x,max(e.y+e.h,t.y+t.h)-r.y)},rcenter=(e,t)=>rint(rect(e.x+(e.w-t.x)/2,ceil(e.y+(e.h-t.y)/2),t.x,t.y)),rnorm=e=>((e=rcopy(e)).w<0&&(e.w*=-1,e.x-=e.w),e.h<0&&(e.h*=-1,e.y-=e.h),rint(e)),rclamp=(e,t,r)=>rmin(rmax(e,t),r),lmpair=e=>lml([lmn(e.x),lmn(e.y)]),lmrect=e=>lml([lmn(e.x),lmn(e.y),lmn(e.w),lmn(e.h)]),getpair=e=>e&&lil(e)?rect(e.v.length>0?ln(e.v[0]):0,e.v.length>1?ln(e.v[1]):0):rect(),getrect=e=>e&&lil(e)?rect(e.v.length>0?ln(e.v[0]):0,e.v.length>1?ln(e.v[1]):0,e.v.length>2?ln(e.v[2]):0,e.v.length>3?ln(e.v[3]):0):rect(),getimage=e=>e&&image_is(e)?e:image_make(rect()),ukey=(e,t,r,i)=>{if(i&&match(t,i))return t;if(t&&lis(t)&&!dget(e,t))return t;let l=1;for(;;){let t=lms(r+l++);if(!dget(e,t))return t}},uset=(e,t,r,i)=>(dset(e,ukey(e,t,r),i),i),reorder=(e,t,r)=>{r=clamp(0,r,count(e)-1);const i=e.k[t],l=e.v[t];if(r<t)for(let i=t;i>r;i--)e.k[i]=e.k[i-1],e.v[i]=e.v[i-1];else for(let i=t;i<r;i++)e.k[i]=e.k[i+1],e.v[i]=e.v[i+1];e.k[r]=i,e.v[r]=l},anchors={top_left:0,top_center:1,top_right:2,center_left:3,center:4,center_right:5,bottom_left:6,bottom_center:7,bottom_right:8},anchor=(e,t)=>(null==t||(1!=(t=anchors[ls(t)]||0)&&4!=t&&7!=t||(e.x-=e.w/2),2!=t&&5!=t&&8!=t||(e.x-=e.w),3!=t&&4!=t&&5!=t||(e.y-=e.h/2),6!=t&&7!=t&&8!=t||(e.y-=e.h)),rint(e)),unpack_rect=(e,t)=>{let r=t||frame.image.size,i=rect(0,0,r.x,r.y);if(e.length>=1){const t=rint(getpair(e[0])),r=rint(getpair(e[1]));r.x<0&&(t.x+=1+r.x,r.x*=-1),r.y<0&&(t.y+=1+r.y,r.y*=-1),i=rpair(t,r)}return anchor(i,e[2])},unpack_poly=e=>{const t=[];return e.map(e=>{lil(e)&&e.v.every(e=>!lin(e))?ll(e).map(e=>t.push(getpair(e))):t.push(getpair(e))}),1==t.length&&t.push(t[0]),t},readcolor=(e,t,r,i)=>{if(i){const i=.2126*Math.pow(e,2.2),l=.7152*Math.pow(t,2.2),s=.0722*Math.pow(r,2.2),n=Math.pow(i+l+s,1/2.2);return clamp(0,0|n,255)}let l=0,s=1e20;for(let i=0;i<16;i++){const n=abs((COLORS[i]>>16&255)/256-e/256),o=abs((COLORS[i]>>8&255)/256-t/256),a=abs((255&COLORS[i])/256-r/256),d=n*n+o*o+a*a;d<s&&(l=i,s=d)}return 15==l?1:l+32};let audio_playing=0;interface_app=lmi((e,t,r)=>{if(r&&lis(t)){if("fullscreen"==t.v)return set_fullscreen(lb(r)),r}else if(lis(t)){if("fullscreen"==t.v)return lmn(is_fullscreen());if("playing"==t.v)return lmn(audio_playing);if("save"==t.v)return lmnat(e=>(modal_enter&&modal_enter("save_deck"),NIL));if("exit"==t.v)return lmnat(e=>NIL);if("show"==t.v)return lmnat(e=>(lit(e[0])?console.table(rows(e[0]).v.map(e=>e.k.reduce((t,r,i)=>(t[ls(r)]=(e=>lis(e)?ls(e):lin(e)?ln(e):show(e))(e.v[i]),t),{}))):console.log(e.map(t=>show(t,1==e.length)).join(" ")),e[0]||NIL));if("print"==t.v)return lmnat(e=>{const t=ls(e.length>1?dyad.format(e[0],lml(e.slice(1))):e[0]||NIL);return console.log(t),lms(t)});if("render"==t.v)return null==draw_con?NIL:lmnat(([e])=>widget_is(e)?draw_widget(e):card_is(e)?draw_con(e,1):image_make(rect()))}return r||NIL},"app"),interface_bits=lmi((e,t,r)=>{const i=e=>4294967295&ln(e),l=e=>lmnat(t=>{let r=t.length<2?ll(t[0]||NIL):t,i=r[0]||NIL;for(let t=1;t<r.length;t++)i=vd(e)(i,r[t]);return i});return ikey(t,"and")?l((e,t)=>lmn((i(e)&i(t))>>>0)):ikey(t,"or")?l((e,t)=>lmn((i(e)|i(t))>>>0)):ikey(t,"xor")?l((e,t)=>lmn((i(e)^i(t))>>>0)):r||NIL},"bits");let frame=null;inclip=e=>rin(frame.clip,e),gpix=e=>frame.image.pix[e.x+e.y*frame.image.size.x],pix=(e,t)=>frame.image.pix[e.x+e.y*frame.image.size.x]=t,pal_pat=(e,t,r,i)=>e[r%8+i%8*8+64*t],draw_pattern=(e,t,r)=>t<2?t?1:0:t>31?32==t?0:1:1&pal_pat(e,t,r.x,r.y),draw_hline=(e,t,r,i)=>{if(!(r<frame.clip.y||r>=frame.clip.y+frame.clip.h)){e=max(frame.clip.x,e),t=min(frame.clip.x+frame.clip.w,t);for(let l=e;l<t;l++)pix(rect(l,r),i)}},draw_vline=(e,t,r,i)=>{if(!(e<frame.clip.x||e>=frame.clip.x+frame.clip.w)){t=max(frame.clip.y,t),r=min(frame.clip.y+frame.clip.h,r);for(let l=t;l<r;l++)pix(rect(e,l),i)}},draw_rect=(e,t)=>{for(let r=(e=rclip(e,frame.clip)).y;r<e.y+e.h;r++)for(let i=e.x;i<e.x+e.w;i++)pix(rect(i,r),t)},draw_invert_raw=(e,t)=>{for(let r=(t=rclip(t,frame.clip)).y;r<t.y+t.h;r++)for(let i=t.x;i<t.x+t.w;i++){const t=rect(i,r);pix(t,1^draw_pattern(e,gpix(t),t))}},draw_icon=(e,t,r)=>{const i=t.size;for(let l=0;l<i.y;l++)for(let s=0;s<i.x;s++){const n=rect(e.x+s,e.y+l);t.pix[s+l*i.x]&&inclip(n)&&pix(n,r)}},draw_iconc=(e,t,r)=>draw_icon(rcenter(e,t.size),t,r),draw_line_simple=(e,t,r,i)=>{e=rint(e);const l=(e,t,r)=>BRUSHES[8*e+r]>>7-t&1;let s=abs(e.w-e.x),n=-abs(e.h-e.y),o=s+n,a=e.x<e.w?1:-1,d=e.y<e.h?1:-1;for(;;){if(0==t){if(inclip(e))if(i){const t=gpix(e),l=i[0],s=i[1];t>=l&&t<=s&&pix(e,r)}else pix(e,r)}else for(let s=0;s<8;s++)for(let n=0;n<8;n++){const o=rect(e.x+n-3,e.y+s-3);if(l(t,n,s)&&inclip(o))if(i){const e=gpix(o),t=i[0],l=i[1];e>=t&&e<=l&&pix(o,r)}else pix(o,r)}if(e.x==e.w&&e.y==e.h)break;let c=2*o;c>=n&&(o+=n,e.x+=a),c<=s&&(o+=s,e.y+=d)}},draw_line_custom=(e,t,r,i)=>{let l=abs(e.w-e.x),s=-abs(e.h-e.y),n=l+s,o=e.x<e.w?1:-1,a=e.y<e.h?1:-1,d=t.size,c=rint(rdiv(d,2));for(;;){for(let l=0;l<d.y;l++)for(let s=0;s<d.x;s++){const n=rect(e.x+s-c.x,e.y+l-c.y),o=t.pix[s+l*d.x];if(o&&inclip(n))if(i){const e=gpix(n),t=i[0],l=i[1];e>=t&&e<=l&&pix(n,1==o?r:47==o?1:o)}else pix(n,1==o?r:47==o?1:o)}if(e.x==e.w&&e.y==e.h)break;let A=2*n;A>=s&&(n+=s,e.x+=o),A<=l&&(n+=l,e.y+=a)}},draw_line_function=(e,t,r,i)=>{const l=lml([lmpair(rect(e.w-e.x,e.h-e.y)),ONE]),s=lmblk(),n=lmenv();blk_lit(s,t),blk_lit(s,l),blk_op(s,op.CALL),pushstate(n);let o=abs(e.w-e.x),a=-abs(e.h-e.y),d=o+a,c=e.x<e.w?1:-1,A=e.y<e.h?1:-1;for(;!do_panic;){state.e=[n],state.t=[],state.pcs=[],issue(n,s);let t=BRUSH_QUOTA;for(;t&&running();)runop(),t--;const m=running()?ZERO:arg();if(image_is(m)){const t=m.size,l=rint(rdiv(t,2));for(let s=0;s<t.y;s++)for(let n=0;n<t.x;n++){const o=rect(e.x+n-l.x,e.y+s-l.y),a=m.pix[n+s*t.x];if(a&&inclip(o))if(i){const e=gpix(o),t=i[0],l=i[1];e>=t&&e<=l&&pix(o,1==a?r:47==a?1:a)}else pix(o,1==a?r:47==a?1:a)}}if(e.x==e.w&&e.y==e.h)break;let _=2*d;_>=a&&(d+=a,e.x+=c),_<=o&&(d+=o,e.y+=A),l.v[1]=ZERO}popstate()},draw_line=(e,t,r,i,l)=>{if(t>=0&&t<=23)return void draw_line_simple(e,t,r,l);const s=i.brushes;if(t<0||t-24>=s.v.length)return;const n=s.v[t-24];image_is(n)?draw_line_custom(e,n,r,l):lion(n)&&draw_line_function(e,n,r,l)},n_brush=(e,t)=>{const r=t.brushes,i=t.brusht,l=e[0],s=e[1];if(lion(l)){const e=lms(l.n),s=image_make(rect(64,32)),n=frame;dset(r,e,l),frame={size:s.size,clip:rect(0,0,64,32),image:s},draw_line(rect(16,16,32,16),24+dkix(r,e),1,t),draw_line(rect(32,16,40,16),24+dkix(r,e),1,t),draw_line(rect(40,16,44,16),24+dkix(r,e),1,t),draw_line(rect(44,16,48,16),24+dkix(r,e),1,t),frame=n,dset(i,lms(l.n),s)}return lis(l)&&s&&image_is(s)&&(dset(r,l,s),dset(i,l,s)),r},draw_box=(e,t,r)=>{const i=frame.image.size;0!=e.w&&0!=e.h&&ron(e,rect(0,0,i.x,i.y))&&(e.y>=0&&draw_line_simple(rect(e.x,e.y,e.x+e.w-1,e.y),t,r),e.y+e.h<=i.y&&draw_line_simple(rect(e.x,e.y+e.h-1,e.x+e.w-1,e.y+e.h-1),t,r),e.x>=0&&draw_line_simple(rect(e.x,e.y,e.x,e.y+e.h-1),t,r),e.x+e.w<=i.x&&draw_line_simple(rect(e.x+e.w-1,e.y,e.x+e.w-1,e.y+e.h-1),t,r))},draw_boxf=(e,t,r,i)=>{const l=frame.image.size;0!=e.w&&0!=e.h&&ron(e,rect(0,0,l.x,l.y))&&(e.y>=0&&draw_line(rect(e.x,e.y,e.x+e.w-1,e.y),t,r,i),e.y+e.h<=l.y&&draw_line(rect(e.x,e.y+e.h-1,e.x+e.w-1,e.y+e.h-1),t,r,i),e.x>=0&&draw_line(rect(e.x,e.y,e.x,e.y+e.h-1),t,r,i),e.x+e.w<=l.x&&draw_line(rect(e.x+e.w-1,e.y,e.x+e.w-1,e.y+e.h-1),t,r,i))},draw_lines=(e,t,r,i,l)=>{for(let s=0;s<e.length-1;s++)draw_line(rpair(e[s],e[s+1]),t,r,i,l)},poly_bounds=e=>{const t=rect(frame.clip.x+frame.clip.w,frame.clip.y+frame.clip.h,frame.clip.x,frame.clip.y);for(let r=0;r<e.length;r++){const i=e[r];t.x=min(t.x,i.x),t.y=min(t.y,i.y),t.w=max(t.w,i.x),t.h=max(t.h,i.y)}return t.w-=t.x,t.h-=t.y,t.w++,t.h++,t},poly_in=(e,t)=>{let r=0;for(let i=0,l=e.length-1;i<e.length;i++){if(t.x==e[i].x&&t.y==e[i].y)return 1;e[i].y>=t.y!=e[l].y>=t.y&&t.x<=(e[l].x-e[i].x)*(t.y-e[i].y)/(e[l].y-e[i].y)+e[i].x&&(r^=1),l=i}return r},draw_poly=(e,t)=>{const r=rint(rclip(frame.clip,poly_bounds(e)));for(let i=0;i<r.h;i++)for(let l=0;l<r.w;l++){const s=rect(l+r.x,i+r.y);poly_in(e,s)&&pix(s,t)}},draw_fill=(e,t,r)=>{if(!inclip(e))return;const i=r||frame.image,l=new Uint8Array(i.size.x*i.size.y),s=e=>i.pix[e.x+e.y*i.size.x],n=s(e),o=[e],a=[rect(-1,0),rect(0,-1),rect(1,0),rect(0,1)],d=frame.image.size.x;for(;o.length;){const e=o.pop();if(gpix(e)!=t){pix(e,t);for(let t=0;t<4;t++){const r=radd(e,a[t]),i=r.x+r.y*d;inclip(r)&&!l[i]&&s(r)==n&&(o.push(r),l[i]=1)}}}};const canvasFontRenderer={canvas:null,ctx:null,fontFamily:"Arial, sans-serif",fontSize:12,init(){this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,void 0!==this.ctx.webkitImageSmoothingEnabled&&(this.ctx.webkitImageSmoothingEnabled=!1),void 0!==this.ctx.mozImageSmoothingEnabled&&(this.ctx.mozImageSmoothingEnabled=!1),void 0!==this.ctx.msImageSmoothingEnabled&&(this.ctx.msImageSmoothingEnabled=!1))},cache:new Map,measureWidth(e,t=12){return this.init(),this.ctx.font=`${t}px ${this.fontFamily}`,this.ctx.measureText(e).width},renderChar(e,t=12,r="direct"){this.init(),this.fontSize=t;const i=`${e}_${t}_${r}`;if(this.cache.has(i))return this.cache.get(i);let l;if("direct"===(r="direct")){const r=t;this.canvas.width=r,this.canvas.height=2*r+1,this.ctx.font=`${r}px ${this.fontFamily}`,this.ctx.fillStyle="#000",this.ctx.textBaseline="top",this.ctx.textAlign="left",this.ctx.clearRect(0,0,r,r),this.ctx.fillText(e,0,1);const i=this.ctx.getImageData(0,0,r,2*r).data,s=[];for(let e=0;e<i.length;e+=4)s.push(i[e+3]);l={bitmap:s,width:r,height:r}}return this.cache.set(i,l),l}};function isCanvasChar(e){return e.charCodeAt(0)>255}function isThai(e){const t=e.charCodeAt(0);return t>=3584&&t<=3711}let segmenter;try{segmenter=new Intl.Segmenter(void 0,{granularity:"grapheme"})}catch(e){segmenter={segment:e=>e.split("").map(e=>({segment:e}))}}const segmentText=e=>[...segmenter.segment(e)].map(e=>e.segment);function getCharWidth(e,t){return isCanvasChar(t)?isThai(t)||t.length>1?Math.ceil(canvasFontRenderer.measureWidth(t,font_h(e))):font_h(e):font_gw(e,t)}draw_char=(e,t,r,i,l="balanced")=>{if(isCanvasChar(r)){const s=canvasFontRenderer.renderChar(r,font_h(t),l);for(let t=0;t<s.height;t++)for(let r=0;r<s.width;r++){if(s.bitmap[r+t*s.width]>32){const l=rect(e.x+r,e.y+t);inclip(l)&&pix(l,i)}}return}const s=font_w(t),n=font_h(t);for(let l=0;l<n;l++)for(let n=0;n<s;n++)if(font_gpix(t,r,n,l)){const t=rect(e.x+n,e.y+l);inclip(t)&&pix(t,i)}},draw_text=(e,t,r,i)=>{const l=segmentText(t),s=rect(e.x,e.y);for(let t=0;t<l.length;t++){const n=l[t];if("\n"!=n){draw_char(s,r,n,i);const e=getCharWidth(r,n),t=isCanvasChar(n)&&!isThai(n)&&1===n.length?font_sw(r)+1:font_sw(r);s.x+=e+t}else s.x=e.x,s.y+=font_h(r)}};const ELLIPSIS="…";layout_plaintext=(e,t,r,i)=>{const l=segmentText(e);let s=[],n=[],o=rect(0,0),a=e=>(o.x=0,o.y+=1),d=e=>"\n"==e||" "==e;const c=font_h(t),A=font_sw(t);for(let e=0;e<l.length;e++){let r=e,n="\n"==l[e]?0:getCharWidth(t,l[e])+(isCanvasChar(l[e])&&!isThai(l[e])&&1===l[e].length?A+1:A);if(!d(l[e]))for(;l[e+1]&&!d(l[e+1]);)n+=getCharWidth(t,l[++e])+(isCanvasChar(l[e])&&!isThai(l[e])&&1===l[e].length?A+1:A);o.x+n>=i.x&&o.x>0&&a();for(let n=r;n<=e;n++){const e=l[n],r=isCanvasChar(e)&&!isThai(e)&&1===e.length?A+1:A,m=rect("\n"==e?0:getCharWidth(t,e)+r,c);" "==e&&0==o.x&&s.length>0&&!d(last(s).char)&&(m.x=0),o.x+m.x>=i.x&&a(),s.push({pos:rpair(o,m),line:o.y,char:e,font:t,arg:NIL}),"\n"==e?a():o.x+=m.x}}let m=0;for(let e=0,t=0;e<s.length;e++,t++){let l=e;for(;e<s.length-1&&s[e+1].pos.y==t;)e++;let o=0;for(let t=l;t<=e;t++)o=max(o,s[t].pos.h);let a=l&&l==e?0:s[e].pos.x+s[e].pos.w,d=r==ALIGN.center?0|(i.x-a)/2:r==ALIGN.right?i.x-a:0;n.push({pos:rect(d,m,a,o),range:rect(l,e)});for(let t=l;t<=e;t++){const e=s[t].pos;e.y=m+0|(o-e.h)/2,e.x+=d}e<s.length-1&&(m+=o)}return{size:rect(i.x,m+c),layout:s,lines:n}},layout_richtext=(e,t,r,i,l)=>{const s=[],n=[],o=rect(0,0),a=e=>(o.x=0,o.y+=1),d=e=>"\n"==e||" "==e,c=tab_get(t,"text"),A=tab_get(t,"font"),m=tab_get(t,"arg");for(let t=0;t<c.length;t++){const i=dget(e.fonts,A[t])||r,n=font_h(i),_=font_sw(i);if(image_is(m[t])){const e=m[t].size;o.x+e.x>=l&&o.x>0&&a(),s.push({pos:rpair(o,e),line:o.y,char:"i",font:i,arg:m[t]}),o.x+=e.x;continue}const u=segmentText(ls(c[t]));for(let e=0;e<u.length;e++){let r=e,c="\n"==u[e]?0:getCharWidth(i,u[e])+(isCanvasChar(u[e])&&!isThai(u[e])&&1===u[e].length?_+1:_);if(!d(u[e]))for(;e+1<u.length&&!d(u[e+1]);)c+=getCharWidth(i,u[++e])+(isCanvasChar(u[e])&&!isThai(u[e])&&1===u[e].length?_+1:_);o.x+c>=l&&o.x>0&&a();for(let c=r;c<=e;c++){const e=u[c],r=isCanvasChar(e)&&!isThai(e)&&1===e.length?_+1:_,A=rect("\n"==e?0:getCharWidth(i,e)+r,n);" "==e&&0==o.x&&s.length>0&&!d(last(s).char)&&(A.x=0),o.x+A.x>=l&&a(),s.push({pos:rpair(o,A),line:o.y,char:e,font:i,arg:m[t]}),"\n"==e?a():o.x+=A.x}}}let _=0;for(let e=0,t=0;e<s.length;e++,t++){let r=e;for(;e<s.length-1&&s[e+1].pos.y==t;)e++;let o=0;for(let t=r;t<=e;t++)o=max(o,s[t].pos.h);let a=r&&r==e?0:s[e].pos.x+s[e].pos.w,d=i==ALIGN.center?0|(l-a)/2:i==ALIGN.right?l-a:0;n.push({pos:rect(d,_,a,o),range:rect(r,e)});for(let t=r;t<=e;t++){const e=s[t].pos;e.y=_+0|(o-e.h)/2,e.x+=d}_+=o}return{size:rect(l,_),layout:s,lines:n}},draw_text_wrap=(e,t,r)=>{e=rint(e);const i=frame.clip;frame.clip=e;for(let i=0;i<t.layout.length;i++){const l=t.layout[i];l.pos.w<1||draw_char(radd(l.pos,e),l.font,l.char,r)}frame.clip=i},draw_text_rich=(e,t,r,i)=>{const l=frame.clip;frame.clip=e;for(let l=0;l<t.layout.length;l++){const s=t.layout[l];s.pos.w<1||(s.pos.y+s.pos.h<0||s.pos.y>e.h||(s.pos.x+=e.x,s.pos.y+=e.y,lis(s.arg)&&count(s.arg)&&draw_hline(s.pos.x,s.pos.x+s.pos.w,s.pos.y+s.pos.h-1,19),image_is(s.arg)?image_paste(s.pos,frame.clip,s.arg,frame.image,i):draw_char(s.pos,s.font,s.char,r)))}frame.clip=l},draw_9seg=(e,t,r,i,l,s,n)=>{const o=rect(e.x,e.y),a=r.size,d=a,c=t.size;if(a.x<1||a.y<1)return;const A=(e,i)=>{const o=rclip(e,l),a=rsub(o,e);if(i=rclip(i,rpair(rect(0,0),d)),!(o.w<=0||o.h<=0||i.w<=0||i.h<=0))if(n){const e=(e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(n,e,t,r);for(let l=0;l<o.h;l++)for(let s=0;s<o.w;s++){let n=o.x+s,A=o.y+l,m=e(r.pix[i.x+(s+a.x)%i.w+(i.y+(l+a.y)%i.h)*d.x],n,A),_=o.x+s+(o.y+l)*c.x;t.pix[_]=m^e(t.pix[_],n,A)}}else for(let e=0;e<o.h;e++)for(let l=0;l<o.w;l++){const n=r.pix[i.x+(l+a.x)%i.w+(i.y+(e+a.y)%i.h)*d.x];(s||n)&&(t.pix[o.x+l+(o.y+e)*c.x]=n)}};A(radd(rect(0,0,i.x,i.y),o),rect(0,0,i.x,i.y)),A(radd(rect(0,e.h-i.h,i.x,i.h),o),rect(0,a.y-i.h,i.x,i.h)),A(radd(rect(e.w-i.w,0,i.w,i.y),o),rect(a.x-i.w,0,i.w,i.y)),A(radd(rect(e.w-i.w,e.h-i.h,i.w,i.h),o),rect(a.x-i.w,a.y-i.h,i.w,i.h)),A(radd(rect(0,i.y,i.x,e.h-(i.y+i.h)),o),rect(0,i.y,i.x,a.y-(i.y+i.h))),A(radd(rect(i.x,0,e.w-(i.x+i.w),i.y),o),rect(i.x,0,a.x-(i.x+i.w),i.y)),A(radd(rect(e.w-i.w,i.y,i.w,e.h-(i.y+i.h)),o),rect(a.x-i.w,i.y,i.w,a.y-(i.y+i.h))),A(radd(rect(i.x,e.h-i.h,e.w-(i.x+i.w),i.h),o),rect(i.x,a.y-i.h,a.x-(i.x+i.w),i.h)),A(radd(rect(i.x,i.y,e.w-(i.x+i.w),e.h-(i.y+i.h)),o),rect(i.x,i.y,a.x-(i.x+i.w),a.y-(i.y+i.h)))},pointer={f:(e,t,r)=>ikey(t,"held")?lmn(e.held):ikey(t,"down")?lmn(e.down):ikey(t,"up")?lmn(e.up):ikey(t,"pos")?lmpair(e.pos):ikey(t,"start")?lmpair(e.start):ikey(t,"prev")?lmpair(e.prev):ikey(t,"end")?lmpair(e.end):r||NIL,t:"int",n:"pointer",held:0,down:0,up:0,pos:rect(),start:rect(),prev:rect(),end:rect()},keystore_read=e=>{let t=lmd();return e&&e.k.filter((t,r)=>!linil(e.v[r])).map((r,i)=>dset(t,r,e.v[i])),{f:(e,t,r)=>{if("keys"==(t=ls(t)))return monad.keys(e.data);if(r){const i=lms("%J"),l=dyad.parse(i,dyad.format(i,r));return linil(l)?e.data=dyad.drop(lms(t),e.data):dset(e.data,lms(t),l),r}return dget(e.data,lms(t))||NIL},t:"int",n:"keystore",data:t}},module_read=(e,t)=>{const r=lmi((e,r,i)=>{if(i){if(ikey(r,"description"))return e.description=ls(i),i;if(ikey(r,"version"))return e.version=ln(i),i;if(ikey(r,"name"))return""==ls(i)||(e.name=ls(ukey(e.deck.modules,lms(ls(i)),ls(i),lms(e.name))),e.deck.modules.k[dvix(e.deck.modules,e)]=e.name),i;if(ikey(r,"script")){e.script=ls(i),e.error="",e.value=lmd();try{const r=parse(e.script),i=lmenv();primitives(i,t),constants(i),i.local("data",e.data),pushstate(i),issue(i,r);let l=MODULE_QUOTA;for(;running()&&l>0;)runop(),l--;running()?e.error="initialization took too long.":e.value=ld(arg()),popstate()}catch(t){return e.error=t.x,i}}}else{if(ikey(r,"name"))return lms(e.name);if(ikey(r,"data"))return e.data;if(ikey(r,"description"))return lms(e.description||"");if(ikey(r,"version"))return lmn(e.version||0);if(ikey(r,"script"))return lms(e.script||"");if(ikey(r,"error"))return lms(e.error||"");if(ikey(r,"value"))return e.value}return i||NIL},"module"),i=dget(e,lms("name"));return r.deck=t,r.name=ls(ukey(t.modules,i&&lis(i)&&0==count(i)?null:i,"module")),r.data=keystore_read(dget(e,lms("data"))),r.value=lmd(),init_field(r,"description",e),init_field(r,"version",e),init_field(r,"script",e),r},module_write=e=>{const t=lmd();return dset(t,lms("name"),ifield(e,"name")),dset(t,lms("data"),e.data.data),dset(t,lms("script"),ifield(e,"script")),e.description&&dset(t,lms("description"),ifield(e,"description")),e.version&&dset(t,lms("version"),ifield(e,"version")),t};const casts={u8:1,i8:1,u16b:2,u16l:2,i16b:2,i16l:2,u32b:4,u32l:4,i32b:4,i32l:4,char:1};array_write=e=>data_write("DAT"+String.fromCharCode(48+Object.keys(casts).indexOf(e.cast)),e.data.slice(e.base,e.base+e.size)),array_read=e=>{const t=e.charCodeAt(5),r=data_read("DAT",e);return r?array_make(r.length,Object.keys(casts)[clamp(0,t-48,10)],0,r):array_make(0,"u8",0)},n_array=([e,t])=>{if(lis(e))return array_read(ls(e));const r=ln(e),i=t?normalize_enum(casts,ls(t)):"u8";return array_make(r,i,0)},array_make=(e,t,r,i)=>{const l=e=>({offset:ln(lil(e)?monad.first(e):e),len:lil(e)?max(0,ln(monad.last(e))):-1}),s=(e,t)=>({here:0,size:e.size-t,base:e.base+t,cast:e.cast,data:e.data}),n=(e,t)=>{if(e.slice)return;t=max(0,t);const r=e.data;e.data=new Uint8Array(t);for(let t=0;t<e.data.length;t++)e.data[t]=t>=r.length?0:r[t];e.size=t},o=(e,t)=>{const r=casts[e.cast];if(t<0||t>=(0|e.size/r))return 0;const i=e.base+r*t;if(i<0||i+r>e.data.length)return 0;const l=(t,r)=>e.data[i+t]<<r,s=e=>e<<16>>16,n=(e,t,r,i)=>2*e+(t|r|i);return"u8"==e.cast?l(0,0):"i8"==e.cast?l(0,0)<<24>>24:"u16b"==e.cast?l(0,8)|l(1,0):"u16l"==e.cast?l(1,8)|l(0,0):"i16b"==e.cast?s(l(0,8)|l(1,0)):"i16l"==e.cast?s(l(1,8)|l(0,0)):"u32b"==e.cast?n(l(0,23),l(1,16),l(2,8),l(3,0)):"u32l"==e.cast?n(l(3,23),l(2,16),l(1,8),l(0,0)):"i32b"==e.cast?l(0,24)|l(1,16)|l(2,8)|l(3,0):"i32l"==e.cast?l(3,24)|l(2,16)|l(1,8)|l(0,0):drom_from_ord(l(0,0))},a=(e,t,r)=>{"string"==typeof r&&(r=drom_to_ord(r));const i=casts[e.cast];if(t<0||t>=(0|e.size/i))return;const l=e.base+i*t;if(l<0||l+i>e.data.length)return;const s=(t,i)=>e.data[l+t]=r>>>i;"u16b"==e.cast||"i16b"==e.cast?(s(0,8),s(1,0)):"u16l"==e.cast||"i16l"==e.cast?(s(1,8),s(0,0)):"u32b"==e.cast||"i32b"==e.cast?(s(0,24),s(1,16),s(2,8),s(3,0)):"u32l"==e.cast||"i32l"==e.cast?(s(3,24),s(2,16),s(1,8),s(0,0)):s(0,0)},d=(e,t,r)=>{if("char"==e.cast&&r<0&&(r=1),"char"==e.cast){const i=e.cast;e.cast="u8";const l=range(r).map(r=>drom_from_ord(o(e,t+r))).join("");return e.cast=i,lms(l)}return r<0?lmn(o(e,t)):lml(range(r).map(r=>lmn(o(e,t+r))))},c=(e,t,r,i)=>{if(r<0&&(r=1),array_is(i))for(let l=0;l<r;l++)a(e,t+l,o(i,l));else if(lis(i))for(let l=0;l<r;l++)a(e,t+l,l>=count(i)?0:i.v[l]);else if(lil(i))for(let l=0;l<r;l++)a(e,t+l,l>=count(i)?0:ln(i.v[l]));else{const l=ln(i);for(let i=0;i<r;i++)a(e,t+i,l)}},A=e=>{if(lis(e))return casts[ls(e)]||1;if(lil(e))return(casts[ls(monad.first(e))]||1)*max(0,ln(monad.last(e)));if(!lid(e))return 0;let t=0,r=0;return e.v.map(e=>{!lin(e)&&t&&(t=0,r++),lin(e)?(t+=clamp(1,ln(e),31),r+=0|t/8,t%=8):r+=A(e)}),r},m=(e,t)=>{if(lis(t)){e.cast=normalize_enum(casts,ls(t));const r=d(s(e,e.here),0,-1);return e.here+=casts[e.cast],r}if(lil(t)){const r=max(0,ln(monad.last(t)));e.cast=normalize_enum(casts,ls(monad.first(t)));const i=d(s(e,e.here),0,r);return e.here+=r*casts[e.cast],i}if(!lid(t))return ZERO;let r=0,i=lmd();return t.v.map((l,s)=>{let n=ZERO;if(!lin(l)&&r&&(r=0,e.here++),lin(l)){let t=clamp(1,ln(l),31),i=0;for(e.cast="u8";t>0;)i=i<<1|1&o(e,e.here)>>7-r,r++,t--,8==r&&(r=0,e.here++);n=lmn(i)}else n=m(e,l);dset(i,t.k[s],n)}),i},_=(e,t,r)=>{if(lis(t)||lil(t)){let i=lis(t)?1:max(0,ln(monad.last(t)));return e.cast=normalize_enum(casts,ls(lis(t)?t:monad.first(t))),c(s(e,e.here),0,i,r),void(e.here+=i*casts[e.cast])}if(!lid(t))return;let i=0;t.v.map((l,s)=>{let n=dget(r,t.k[s])||ZERO;if(!lin(l))return i&&(i=0,e.here++),void _(e,l,n);let d=clamp(1,ln(l),31),c=ln(n);c&=(1<<d)-1,e.cast="u8";for(let t=0;t<d;t++){let r=1<<7-i,l=o(e,e.here)&~r;a(e,e.here,c&1<<d-1-t?l|r:l),i++,8==i&&(i=0,e.here++)}})},u=(e,t)=>{const r=e.cast,i=t[0]||ZERO,l=t[1],s=A(i);l&&e.here+s>=e.size&&n(e,e.here+s);const o=l?(_(e,i,l),l):m(e,i);return e.cast=r,o},p=lmi((e,t,r)=>{if(!lis(t)){const i=l(t);return r?(c(e,i.offset,i.len,r),r):d(e,i.offset,i.len)}if(r){if(ikey(t,"size"))return n(e,ln(r)*casts[e.cast]),r;if(ikey(t,"cast"))return e.cast=normalize_enum(casts,ls(r)),r;if(ikey(t,"here"))return e.here=max(0,ln(r)),r}else{if(ikey(t,"encoded"))return lms(array_write(e));if(ikey(t,"cast"))return lms(e.cast);if(ikey(t,"size"))return lmn(e.size/casts[e.cast]);if(ikey(t,"here"))return lmn(e.here);if(ikey(t,"slice"))return lmnat(t=>((e,t)=>{const r=l(t[0]||ZERO),i=t[1]?normalize_enum(casts,ls(t[1])):e.cast,s=casts[i];r.offset*=casts[e.cast],r.len<0&&(r.len=0|(e.size-r.offset)/s);const n=array_make(r.len,i,r.offset,e.data);return n.slice=1,n})(e,t));if(ikey(t,"copy"))return lmnat(t=>((e,t)=>{const r=l(t[0]||ZERO),i=t[1]?normalize_enum(casts,ls(t[1])):e.cast,n=casts[i];r.offset*=casts[e.cast],r.len<0&&(r.len=0|(src.size-r.offset)/n);const d=array_make(r.len,i,0);for(let t=0;t<r.len;t++)a(d,t,o(s(e,r.offset),t));return d})(e,t));if(ikey(t,"struct"))return lmnat(t=>u(e,t));if(ikey(t,"cat"))return lmnat(t=>((e,t)=>(t.map(t=>{const r=lin(t)?lms(e.cast):lil(t)?lml([lms(e.cast),monad.count(t)]):array_is(t)?lml([ifield(t,"cast"),ifield(t,"size")]):(t=lms(ls(t)),lml([lms("char"),monad.count(t)]));u(e,[r,t])}),e))(e,t))}return r||NIL},"array");return p.size=e*casts[t],p.here=0,p.base=r,p.cast=t,p.data=i||new Uint8Array(p.size),p},find_occupied=(e,t)=>{const r=e.size,i=rcopy(r);for(let l=0;l<e.pix.length;l++){if(e.pix[l]==t)continue;const s=l%r.x,n=0|l/r.x;i.x=min(i.x,s),i.y=min(i.y,n),i.w=max(i.w,s),i.h=max(i.h,n)}return i.w-=i.x,i.h-=i.y,i.w++,i.h++,i},image_copy=(e,t)=>{t=t?rint(t):rect(0,0,e.size.x,e.size.y);const r=image_make(rect(t.w,t.h)),i=rect(0,0,e.size.x,e.size.y);for(let l=0;l<t.h;l++)for(let s=0;s<t.w;s++)r.pix[s+t.w*l]=rin(i,rect(t.x+s,t.y+l))?e.pix[t.x+s+e.size.x*(t.y+l)]:0;return r},image_paste=(e,t,r,i,l)=>{e=rint(e);const s=r.size,n=i.size;for(let o=0;o<s.y;o++)for(let a=0;a<s.x;a++)rin(t,rect(e.x+a,e.y+o))&&(l||r.pix[a+s.x*o])&&(i.pix[e.x+a+n.x*(e.y+o)]=r.pix[a+s.x*o])},lerp_scale=(e,t)=>rect(e.w/t.x,e.h/t.y),image_paste_scaled=(e,t,r,i,l)=>{if(0==(e=rint(e)).w||0==e.h)return;const s=r.size,n=i.size,o=lerp_scale(e,s);if(e.w==s.x&&e.h==s.y)return image_paste(e,t,r,i,l);for(let a=0;a<e.h;a++)for(let d=0;d<e.w;d++){let c=0|d/o.x,A=0|a/o.y,m=r.pix[c+A*s.x];(l||0!=m)&&rin(t,rect(e.x+d,e.y+a))&&(i.pix[e.x+d+n.x*(e.y+a)]=m)}},image_dither=e=>{const t=2*e.size.x,r=[0,1,e.size.x-2,e.size.x-1,e.size.x,t-1],i=new Float32Array(t);for(let l=0,s=0;s<e.pix.length;s++){const n=(255&e.pix[s])/256+i[l],o=n>.5?1:0,a=(n-o)/8;i[l]=0,l=(l+1)%t;for(let e=0;e<6;e++)i[(l+r[e])%t]+=a;e.pix[s]=!o}},image_flip_h=e=>{const t=e.size;for(let r=0;r<t.y;r++){let i=r*t.x,l=(r+1)*t.x-1;for(;i<l;){let t=e.pix[i];e.pix[i]=e.pix[l],e.pix[l]=t,i++,l--}}},image_flip_v=e=>{const t=e.size;for(let r=0;r<t.x;r++){let i=r,l=r+t.x*(t.y-1);for(;i<l;){let r=e.pix[i];e.pix[i]=e.pix[l],e.pix[l]=r,i+=t.x,l-=t.x}}},image_flip=e=>{const t=e.size,r=image_make(rect(t.y,t.x));for(let i=0;i<t.y;i++)for(let l=0;l<t.x;l++)r.pix[i+t.y*l]=e.pix[l+t.x*i];e.pix=r.pix,e.size=r.size},image_resize=(e,t)=>{const r=e.size,i=e.pix;if(t=rint(rmax(t,rect())),requ(r,t))return e;0!=t.x&&0!=t.y||(t=rect()),e.pix=new Uint8Array(t.x*t.y),e.size=t;for(let l=0;l<t.y;l++)for(let s=0;s<t.x;s++)e.pix[s+l*t.x]=l>=r.y||s>=r.x?0:i[s+l*r.x];return e},buffer_map=(e,t,r)=>{const i=new Uint8Array(256);for(let e=0;e<256;e++)i[e]=r?ln(r):e;t=ld(t);for(let e=0;e<t.k.length;e++){let r=0|ln(t.k[e]);r>=-128&&r<=255&&(i[255&r]=255&ln(t.v[e]))}for(let t=0;t<e.length;t++)e[t]=i[e[t]]},buffer_hist=(e,t)=>{const r=e=>e|0-(128&e),i=lmd(),l=new Float32Array(256);for(let t=0;t<e.length;t++)l[e[t]]++;for(let e=0;e<256;e++)0!=l[e]&&dset(i,lmn(t?r(e):e),lmn(l[e]));return i},image_bounds=e=>{const t=e.size,r=rect(t.x,t.y,0,0);for(let i=0;i<e.pix.length;i++)if(0!=e.pix[i]){const e=i%t.x,l=0|i/t.x;r.x=min(r.x,e),r.y=min(r.y,l),r.w=max(r.w,e),r.h=max(r.h,l)}return lmd(["pos","size"].map(lms),[r,rmin(t,rect(r.w-r.x+1,r.h-r.y+1))].map(lmpair))},image_merge_op=(e,t,r)=>{const i=e.size,l=t.size,s=e.pix,n=t.pix;if(0!=l.x&&0!=l.y){if("+"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]+=n[r%l.x+e%l.y*l.x];if("-"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]-=n[r%l.x+e%l.y*l.x];if("*"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]*=n[r%l.x+e%l.y*l.x];if("&"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]=min(s[t],n[r%l.x+e%l.y*l.x]);if("|"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]=max(s[t],n[r%l.x+e%l.y*l.x]);if("<"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]=s[t]<n[r%l.x+e%l.y*l.x];if(">"==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]=s[t]>n[r%l.x+e%l.y*l.x];if("="==r)for(let e=0,t=0;e<i.y;e++)for(let r=0;r<i.x;r++,t++)s[t]=s[t]==n[r%l.x+e%l.y*l.x]}},image_make=e=>({t:"int",f:(e,t,r)=>{const i=e.size;if(t&&lil(t)){const l=rint(getpair(t)),s=l.x>=0&&l.y>=0&&l.x<i.x&&l.y<i.y;return r?(s&&(e.pix[l.x+l.y*i.x]=ln(r)),r):s?lmn(e.pix[l.x+l.y*i.x]):NIL}if(ikey(t,"pixels")){if(r)return ll(monad.raze(lml(ll(r)))).forEach((t,r)=>e.pix[r]=ln(t)),r;const t=[];for(let r=0;r<i.y;r++){const l=[];for(let t=0;t<i.x;t++)l.push(lmn(e.pix[t+r*i.x]));t.push(lml(l))}return lml(t)}return ikey(t,"encoded")?lms(image_write(e)):ikey(t,"hist")?buffer_hist(e.pix,0):ikey(t,"bounds")?image_bounds(e):ikey(t,"size")?r?(image_resize(e,getpair(r)),r):lmpair(e.size):ikey(t,"map")?lmnat(([t,r])=>(buffer_map(e.pix,t,r),e)):ikey(t,"merge")?lmnat(t=>{if(lis(t[0]))return image_is(t[1])&&image_merge_op(e,t[1],ls(t[0])[0]),e;lil(t[0])&&(t=ll(t[0]));const r=e=>e&&image_is(e)&&e.size.x>0&&e.size.y>0,i=e.size,l=new Uint8Array(256),s=new Uint32Array(256),n=new Uint32Array(256);for(let e=0;e<t.length&&e<256;e++)r(t[e])&&(l[e]=1,s[e]=t[e].size.x,n[e]=t[e].size.y);for(let r=0,o=0;r<i.y;r++)for(let a=0;a<i.x;a++,o++){const i=e.pix[o],d=l[i]?t[i].pix[a%s[i]+r%n[i]*s[i]]:0;e.pix[o]=d}return e}):ikey(t,"transform")?lmnat(([t])=>("horiz"==t.v&&image_flip_h(e),"vert"==t.v&&image_flip_v(e),"flip"==t.v&&image_flip(e),"dither"==t.v&&image_dither(e),"left"==t.v&&(image_flip_h(e),image_flip(e)),"right"==t.v&&(image_flip(e),image_flip_h(e)),e)):ikey(t,"rotate")?lmnat(([t])=>{t=-ln(t)%(2*Math.PI),abs(t)>Math.PI/2&&abs(t)<3*Math.PI/2&&(image_flip_v(e),image_flip_h(e),t+=(t<0?1:-1)*Math.PI);const r=e.size,i=image_make(r),l=t=>{for(let l=0;l<r.y;l++){const s=0|t*(l-r.y/2);for(let t=0;t<r.x;t++)i.pix[t+l*r.x]=e.pix[mod(t+s,r.x)+l*r.x]}e.pix.set(i.pix)};return l(-Math.tan(t/2)),(t=>{for(let l=0;l<r.x;l++){const s=0|t*(l-r.x/2);for(let t=0;t<r.y;t++)i.pix[l+t*r.x]=e.pix[l+mod(t+s,r.y)*r.x]}e.pix.set(i.pix)})(Math.sin(t)),l(-Math.tan(t/2)),e}):ikey(t,"translate")?lmnat(([t,r])=>{const i=rint(getpair(t)),l=r?lb(r):0;if(0==i.x&&0==i.y)return e;const s=e.size,n=image_make(s);if(l)for(let t=0,r=0;t<s.y;t++)for(let l=0;l<s.x;l++,r++)n.pix[r]=e.pix[mod(l-i.x,s.x)+mod(t-i.y,s.y)*s.x];else for(let t=0,r=0;t<s.y;t++)for(let l=0;l<s.x;l++,r++){const o=rect(l-i.x,t-i.y);n.pix[r]=o.x<0||o.x>=s.x||o.y<0||o.y>=s.y?0:e.pix[o.x+o.y*s.x]}return e.pix.set(n.pix),e}):ikey(t,"scale")?lmnat(([t,r])=>{const i=image_copy(e),l=lin(t)?rect(ln(t),ln(t)):getpair(t),s=rmax(rect(),rint(r&&lb(r)?l:rect(l.x*i.size.x,l.y*i.size.y))),n=rpair(rect(),s);return image_resize(e,s),image_paste_scaled(n,n,i,e,1),e}):ikey(t,"copy")?lmnat(t=>image_copy(e,unpack_rect(t,e.size))):ikey(t,"paste")?lmnat(([t,r,i])=>{t=getimage(t),r=(r?ll(r):[]).map(ln);let l=i?!lb(i):1,s=rect(0,0,e.size.x,e.size.y);return t==e&&(t=image_copy(t)),image_paste_scaled(r.length<=2?rect(r[0],r[1],t.size.x,t.size.y):rect(r[0],r[1],r[2],r[3]),s,t,e,l),e}):r||NIL},n:"image",size:e=rint(e),pix:new Uint8Array(e.x*e.y)}),image_read=e=>{const t=data_read("IMG",e);if(!t||t.length<4)return image_make(rect());const r=data_enc(e),i=t[0]<<8|t[1],l=t[2]<<8|t[3],s=image_make(rect(i,l));if(0==r&&t.length-4>=i*l/8){let e=ceil(i/8),r=0;for(let n=0;n<l;n++)for(let l=0;l<i;l++)s.pix[r++]=t[4+(0|l/8)+n*e]&1<<7-l%8?1:0}if(1==r&&t.length-4>=i*l&&(s.pix=t.slice(4)),2==r){let e=4,r=0;for(;e+2<=t.length;){let i=t[e++],l=255&t[e++];for(;l&&r+1<=s.pix.length;)l--,s.pix[r++]=i}}return s},image_write=e=>{let t=0,r=(e=image_is(e)?e:image_make(rect())).size,i=[255&r.x>>8,255&r.x,255&r.y>>8,255&r.y],l=i.slice(0);for(let t=0;t<e.pix.length;){let r=0,i=e.pix[t];for(;r<255&&t<e.pix.length&&e.pix[t]==i;)r++,t++;l.push(i),l.push(r)}if(!e.pix.some(e=>e>1)&&l.length>4+r.x*r.y/8){t="0";let l=8*ceil(r.x/8);for(let t=0;t<r.y;t++)for(let s=0;s<l;s+=8){let l=0;for(let i=0;i<8;i++)l=l<<1|(s+i>=r.x?0:e.pix[s+i+t*r.x]?1:0);i.push(l)}}else if(l.length>4+r.x*r.y){t="1";for(let t=0;t<r.x*r.y;t++)i.push(e.pix[t])}else t="2",i=l;return data_write("IMG"+t,i)},n_image=([e])=>lis(e)?image_read(ls(e)):image_make(getpair(e)),is_blank=e=>image_is(e)?!e.pix.some(e=>e>0):0,sound_make=e=>{const t=lmi((e,t,r)=>{const i=t=>t<0||t>=e.data.length?NIL:lmn((e=>e<<24>>24)(e.data[t]));if(t&&lin(t))return r?(e.data[ln(t)]=255&ln(r),r):i(ln(t));if(t&&lil(t)){const l=getpair(t);if(l.y=max(0,l.y),r){const t=ll(r),i=e.data.length,s=t.length,n=new Uint8Array(clamp(0,i-l.y+s,10*SFX_RATE));for(let t=0;t<l.x;t++)n[t]=e.data[t];for(let e=0;e<s;e++)n[l.x+e]=255&ln(t[e]);for(let t=0;t<i-(l.x+l.y);t++)n[l.x+s+t]=255&e.data[l.x+l.y+t];return e.data=n,r}return lml(range(l.y).map(e=>i(e+l.x)))}if(ikey(t,"encoded"))return lms(sound_write(e));if(ikey(t,"hist"))return buffer_hist(e.data,1);if(ikey(t,"size")){if(!r)return lmn(e.data.length);const t=clamp(0,ln(r),10*SFX_RATE),i=e.data;e.data=new Uint8Array(t);for(let r=0;r<i.length&&r<t;r++)e.data[r]=i[r];return r}return ikey(t,"duration")?lmn(e.data.length/SFX_RATE):ikey(t,"map")?lmnat(([t,r])=>(buffer_map(e.data,t,r),e)):r||NIL},"sound");return e&&e.length>10*SFX_RATE&&(e=e.slice(0,10*SFX_RATE)),t.data=e||new Uint8Array(0),t},sound_read=e=>sound_make("string"==typeof e?data_read("SND",e):new Uint8Array(clamp(0,+e,10*SFX_RATE))),sound_write=e=>data_write("SND0",e.data),n_sound=([e])=>e?lis(e)?sound_read(ls(e)):lin(e)?sound_read(ln(e)):sound_make(Uint8Array.from(ll(e).map(ln))):sound_read(0),pal_col_get=(e,t)=>{const r=1792+3*t;return e[r]<<16|e[r+1]<<8|e[r+2]|4278190080},pal_col_set=(e,t,r)=>{const i=1792+3*t;e[i]=255&r>>16,e[i+1]=255&r>>8,e[i+2]=255&r},pick_palette=e=>{for(let t=0;t<16;t++)COLORS[t]=pal_col_get(e.patterns.pal.pix,t)},patterns_read=e=>{const t=(e,t,r,i,l)=>e[r%8+i%8*8+64*t]=l,r=lmi((e,r,i)=>{let l=null,s=r&&ln(r)?ln(r):0;if(i){if(s>=2&&s<=27&&image_is(i))for(let r=0;r<8;r++)for(let l=0;l<8;l++)t(e.pal.pix,s,l,r,lb(iwrite(i,lmpair(rect(l,r)))));s>=28&&s<=31&&(l=ll(i),l.length>256&&(l=l.slice(0,256)),e.anim[s-28]=l.map(e=>{const t=clamp(0,ln(e),47);return t>=28&&t<=31?0:t}),l=lml(l)),s>=32&&s<=47&&(pal_col_set(e.pal.pix,s-32,4278190080|ln(i)),l=i)}else s>=0&&s<=27&&(l=image_copy(e.pal,rect(0,8*s,8,8))),s>=28&&s<=31&&(l=lml(e.anim[s-28].map(lmn))),s>=32&&s<=47&&(l=lmn(16777215&pal_col_get(e.pal.pix,s-32)));return l||(i||NIL)},"patterns");let i=image_read(e.patterns?ls(e.patterns):DEFAULT_PATTERNS);if(8!=i.size.x||230!=i.size.y){i=image_resize(i,rect(8,230));for(let e=0;e<16;e++)pal_col_set(i.pix,e,DEFAULT_COLORS[e])}return r.pal=i,r.anim=JSON.parse(DEFAULT_ANIMS),e.animations&&lil(e.animations)&&ll(e.animations).map((e,t)=>iindex(r,28+t,e)),r},patterns_write=e=>{const t=e.pal.pix;DEFAULT_COLORS.some((e,r)=>(16777215&e)!=(16777215&pal_col_get(t,r)));return image_write(image_resize(image_copy(e.pal),rect(8,230)))},anims_write=e=>lml(e.anim.map(e=>lml(e.map(lmn)))),font_get=(e,t,r)=>(null!=r&&(t.pix[e]=r),t.pix[e]),font_w=(e,t)=>font_get(0,e,t),font_h=(e,t)=>font_get(1,e,t),font_sw=(e,t)=>font_get(2,e,t),font_gs=(e,t)=>font_h(e)*ceil(font_w(e)/8)+1,font_gb=(e,t)=>3+drom_to_ord(t)*font_gs(e),font_gbi=(e,t)=>3+t*font_gs(e),font_gw=(e,t,r)=>font_get(font_gb(e,t),e,r),font_gwi=(e,t,r)=>font_get(font_gbi(e,t),e,r),font_pp=(e,t,r,i,l)=>font_get(font_gb(e,t)+1+i*ceil(font_w(e)/8)+Math.floor(r/8),e,l),font_bit=(e,t)=>t<<7-e%8,font_gpix=(e,t,r,i)=>font_pp(e,t,r,i)&font_bit(r,1)?1:0,font_spix=(e,t,r,i,l)=>font_pp(e,t,r,i,font_pp(e,t,r,i)&~font_bit(r,1)|font_bit(r,l)),font_textsize=(e,t)=>{const r=rect(),i=rect(0,font_h(e));for(let l=0;t[l];l++)if("\n"!=t[l]){const s=getCharWidth(e,t[l]),n=isCanvasChar(t[l])&&!isThai(t[l])?font_sw(e)+1:font_sw(e);r.x+=s+n,i.x=max(i.x,r.x)}else r.x=0,i.y+=font_h(e);return i},font_read=e=>{const t=lmi((e,t,r)=>{if(lin(t)||lis(t)&&1==count(t)){let i=lin(t)?ln(t):drom_to_ord(ls(t));const l=drom_from_ord(i);if(r){if(i<0||i>255)return r;image_is(r)||(r=image_make(rect())),font_gwi(e,i,min(r.size.x,font_w(e)));const t=rect(font_gwi(e,i),font_h(e));for(let i=t.y-1;i>=0;i--)for(let s=t.x-1;s>=0;s--)font_spix(e,l,s,i,s>=(r.size.x||i>=r.size.y)?0:r.pix[s+i*r.size.x]?1:0);return r}if(i<0||i>255)return image_make(rect());const s=rect(font_gwi(e,i),font_h(e)),n=image_make(s);for(let t=s.y-1;t>=0;t--)for(let r=s.x-1;r>=0;r--)n.pix[r+t*s.x]=font_gpix(e,l,r,t);return n}if(r){if(ikey(t,"space"))return font_sw(e,ln(r)),r;if(ikey(t,"size")){const t=font_read(rmax(rint(getpair(r)),rect(1,1)));iwrite(t,lms("space"),ifield(e,"space"));for(let r=0;r<256;r++)iindex(t,r,iindex(e,r));return e.pix=t.pix,r}}else{if(ikey(t,"size"))return lmpair(rect(font_w(e),font_h(e)));if(ikey(t,"space"))return lmn(font_sw(e));if(ikey(t,"textsize"))return lmnat(([t])=>lmpair(font_textsize(e,t?ls(t):"")));if(ikey(t,"glyphs"))return lml(range(256).filter(t=>font_gwi(e,t)).map(lmn))}return r||NIL},"font"),r=e=>{t.pix=new Uint8Array(3+256*(1+e.y*ceil(e.x/8))),font_w(t,e.x),font_h(t,e.y),font_sw(t,1)};if("string"==typeof e){const i=data_read("FNT",e),l=rmax(rect(i[0],i[1]),rect(1,1)),s=ceil(l.x/8)*l.y;if(r(l),font_sw(t,i[2]),"0"==e[5])for(let e=3,r=32;e<i.length&&r<128;r++,e+=s){const l=i[e++];if(e+s>i.length)break;for(let l=0;l<s;l++)font_get(font_gbi(t,r)+1+l,t,i[e+l]);font_gwi(t,r,l)}if("1"==e[5])for(let e=3;e+1<i.length;e+=s){const r=i[e++],l=i[e++];if(e+s>i.length)break;for(let l=0;l<s;l++)font_get(font_gbi(t,r)+1+l,t,i[e+l]);font_gwi(t,r,l)}}return t.pix||r(rmax(rint(e),rect(1,1))),t},font_write=e=>{const t=rect(font_w(e),font_h(e)),r=font_gs(e),i=[t.x,t.y,font_sw(e)];if(range(256).every(t=>0!=font_gwi(e,t)==(t>=32&&t<=127))){for(let t=32;t<128;t++){i.push(font_gwi(e,t));for(let l=0;l<r-1;l++)i.push(font_get(font_gbi(e,t)+l+1,e))}return data_write("FNT0",i)}for(let t=0;t<256;t++)if(font_gwi(e,t)){i.push(t),i.push(font_gwi(e,t));for(let l=0;l<r-1;l++)i.push(font_get(font_gbi(e,t)+l+1,e))}return data_write("FNT1",i)},rtext_empty=e=>{const t=lmt();return tab_set(t,"text",[]),tab_set(t,"font",[]),tab_set(t,"arg",[]),t},rtext_len=e=>tab_get(e,"text").reduce((e,t)=>e+ls(t).length,0),rtext_get=(e,t)=>{const r=tab_get(e,"text");let i=0;for(let e=0;e<r.length;e++)if(i+=count(r[e]),i>=t)return e;return-1},rtext_getr=(e,t)=>{const r=tab_get(e,"text");let i=0;for(let e=0;e<r.length;e++){const l=count(r[e]);if(i+l>=t)return rect(i,i+l);i+=l}return rect(t,t)},rtext_make=(e,t,r)=>{r=r?image_is(r)?r:ls(r):"",t=t?ls(t):"",e=image_is(r)?"i":e&&count(e)?ls(e):"";const i=lmt();return tab_set(i,"text",[lms(e)]),tab_set(i,"font",[lms(t)]),tab_set(i,"arg",[image_is(r)?r:lms(r)]),i},rtext_cast=e=>{if(e||(e=lms("")),image_is(e))return rtext_make("","",e);if(lid(e)&&(e=monad.table(e)),!lit(e))return rtext_make(e);const t=tab_get(e,"text"),r=tab_get(e,"font"),i=tab_get(e,"arg");if(t&&r&&i&&t.every((e,t)=>lis(e)&&lis(r[t])&&(image_is(i[t])||lis(i[t]))))return e;const l=lmt();tab_set(l,"text",t||[lms("")]),tab_set(l,"font",r||[lms("")]),tab_set(l,"arg",i||[lms("")]);const s=tab_get(l,"text"),n=tab_get(l,"font"),o=tab_get(l,"arg");return s.map((e,t)=>{const r=image_is(o[t]);s[t]=r?lms("i"):lms(ls(s[t])),n[t]=lms(ls(n[t])),o[t]=r?o[t]:lms(ls(o[t]))}),l},rtext_append=(e,t,r,i)=>{if(image_is(i)&&(count(t)>1&&(t=lms("i")),count(t)<1))return 0;if(!count(t))return 0;const l=tab_get(e,"text"),s=tab_get(e,"font"),n=tab_get(e,"arg");return l.length&&match(r,last(s))&&!image_is(i)&&match(i,last(n))?l[l.length-1]=lms(ls(last(l))+ls(t)):(l.push(t),s.push(r),n.push(i)),count(t)},rtext_appendr=(e,t)=>{fv=tab_get(t,"font"),av=tab_get(t,"arg"),tab_get(t,"text").map((t,r)=>rtext_append(e,t,fv[r],av[r]))},rtext_string=(e,t)=>{t=t||rect(0,RTEXT_END);let r="",i=0,l=min(t.x,t.y),s=max(t.x,t.y);return tab_get(e,"text").map(e=>{for(let t=0;t<e.v.length;t++,i++)i>=l&&i<s&&(r+=e.v[t])}),lms(r)},rtext_is_plain=e=>{if(!lit(e))return 0;const t=tab_get(e,"text"),r=tab_get(e,"font"),i=tab_get(e,"arg");return!t||!r||!i||t.length>1?0:0==t.length?1:""==ls(r[0])&&!image_is(i[0])&&""==ls(i[0])},rtext_is_image=e=>{let t=null,r=tab_get(e,"text"),i=tab_get(e,"arg");for(let l=0;l<count(e);l++)if(image_is(i[l]))t||(t=i[l]);else if(""!=ls(r[l]).trim())return null;return t},rtext_read_images=e=>lml((tab_get(e,"arg")||[]).filter(image_is)),rtext_write_images=e=>rtext_cat(ll(e)),rtext_span=(e,t)=>{const r=tab_get(e,"text"),i=tab_get(e,"font"),l=tab_get(e,"arg");let s=dyad.take(ZERO,e),n=0,o=0,a=min(t.x,t.y),d=max(t.x,t.y),c=e=>{let t="";for(let e=0;e<count(r[o]);e++,n++)n>=a&&n<d&&(t+=r[o].v[e]);rtext_append(s,lms(t),i[o],l[o]),o++};for(;o<r.length&&n+count(r[o])<a;)n+=count(r[o++]);for(o<r.length&&n<=a&&c();o<r.length&&n+count(r[o])<d;)n+=rtext_append(s,r[o],i[o],l[o]),o++;return o<r.length&&n<d&&c(),s},rtext_splice=(e,t,r,i,l,s)=>{const n=min(l.x,l.y),o=max(l.x,l.y),a=rtext_cast();return rtext_appendr(a,rtext_span(e,rect(0,n))),rtext_append(a,lms(i),t,r),rtext_appendr(a,rtext_span(e,rect(o,RTEXT_END))),s.x=s.y=n+i.length,a},rtext_splicer=(e,t,r,i)=>{const l=min(r.x,r.y),s=max(r.x,r.y),n=rtext_cast();return rtext_appendr(n,rtext_span(e,rect(0,l))),rtext_appendr(n,t),rtext_appendr(n,rtext_span(e,rect(s,RTEXT_END))),i.x=i.y=l+rtext_len(t),n},rtext_write=e=>{const t=monad.cols(e),r=dget(t,lms("arg"));return r&&(r.v=r.v.map(e=>image_is(e)?lms(image_write(e)):e)),t},rtext_read=e=>{if(lis(e))return e;e=ld(e);const t=dget(e,lms("arg"));return t&&dset(e,lms("arg"),lml(ll(t).map(e=>ls(e).startsWith("%%IMG")?image_read(ls(e)):lms(ls(e))))),rtext_cast(e)},rtext_encode=e=>`%%RTX0${fjson(rtext_write(e))}`,rtext_decode=e=>rtext_read(pjson(e,6,e.length-6).value),rtext_cat=e=>{let t=rtext_empty();return e.map(e=>rtext_appendr(t,rtext_cast(e))),t},interface_rtext=lmi((e,t,r)=>ikey(t,"end")?lmn(RTEXT_END):ikey(t,"make")?lmnat(([e,t,r])=>rtext_make(e,t,r)):ikey(t,"len")?lmnat(([e])=>lmn(rtext_len(rtext_cast(e)))):ikey(t,"get")?lmnat(([e,t])=>lmn(rtext_get(rtext_cast(e),t?ln(t):0))):ikey(t,"string")?lmnat(([e,t])=>rtext_string(rtext_cast(e),t?getpair(t):void 0)):ikey(t,"span")?lmnat(([e,t])=>rtext_span(rtext_cast(e),t?getpair(t):void 0)):ikey(t,"cat")?lmnat(rtext_cat):ikey(t,"split")?lmnat(([e,t])=>{const r=ls(e),i=rtext_cast(t),l=ls(rtext_string(i)),s=lml([]);if(r.length<1||!e||!t)return s;let n=0;for(let e=0;e<l.length;e++){let t=1;for(let i=0;i<r.length;i++)if(r[i]!=l[e+i]){t=0;break}t&&(s.v.push(rtext_span(i,rect(n,e))),e+=r.length-1,n=e+1)}return n<=l.length&&s.v.push(rtext_span(i,rect(n,l.length))),s}):ikey(t,"replace")?lmnat(([e,t,r,i])=>{if(!t||!r)return e||NIL;const l=rtext_cast(e),s=[],n=ls(rtext_string(l)),o=i&&lb(i),a=o?n.toLowerCase():n,d=rect(0,0);for(lil(t)||(t=monad.list(t)),lil(r)||(r=monad.list(r)),(t=dyad.take(lmn(max(count(t),count(r))),t)).v=t.v.map(o?e=>ls(e).toLowerCase():ls),(r=dyad.take(lmn(max(count(t),count(r))),r)).v=r.v.map(rtext_cast);d.y<a.length;){let e=0;for(let i=0;i<t.v.length;i++){const n=t.v[i],o=r.v[i];if(n.length<1)break;let c=1;for(let e=0;e<n.length;e++)if(a[d.y+e]!=n[e]){c=0;break}c&&(d.x!=d.y&&s.push(rtext_span(l,d)),s.push(s,o),d.x=d.y=d.y+n.length,e=1)}e||d.y++}return d.x<a.length&&s.push(rtext_span(l,rect(d.x,RTEXT_END))),rtext_cat(s)}):ikey(t,"find")?lmnat(([e,t,r])=>{const i=[];if(!e||!t)return lml(i);const l=r&&lb(r),s=ls(rtext_string(rtext_cast(e))),n=l?s.toLowerCase():s;t=(t=lil(t)?ll(t):[t]).map(e=>l?ls(e).toLowerCase():ls(e));for(let e=0;e<n.length;){let r=0;for(let l=0;l<t.length;l++){const s=t[l];let o=1;for(let t=0;t<s.length;t++)if(n[e+t]!=s[t]){o=0;break}if(o){i.push(lml([lmn(e),lmn(e+s.length)])),e+=max(1,s.length),r=1;break}}r||e++}return lml(i)}):ikey(t,"index")?lmnat(([e,t])=>{if(!e)return ZERO;let r=0;const i=ls(rtext_string(rtext_cast(e)));for(t=t?rint(getpair(t)):rect();r<i.length&&t.x>0;)"\n"==i[r++]&&t.x--;for(;r<i.length&&t.y>0&&"\n"!=i[r];)t.y--,r++;return lmn(r)}):r||NIL,"rtext"),button_styles={round:1,rect:1,check:1,invisible:1},normalize_shortcut=e=>ls(e).toLowerCase().replace(/[^a-z0-9 ]/g,"").slice(0,1),button_read=(e,t)=>{const r=lmi((e,t,r)=>{if(!is_rooted(e))return NIL;if(r){if(ikey(t,"value"))return e.value=lb(r),r;if(ikey(t,"text"))return e.text=ls(r),r;if(ikey(t,"style"))return e.style=normalize_enum(button_styles,ls(r)),r;if(ikey(t,"shortcut"))return e.shortcut=normalize_shortcut(r),r}else{if(ikey(t,"value"))return value_inherit(e,ls(t))||ZERO;if(ikey(t,"text"))return lms(ivalue(e,ls(t),""));if(ikey(t,"style"))return lms(ivalue(e,ls(t),"round"));if(ikey(t,"size"))return lmpair(ivalue(e,ls(t),rect(60,20)));if(ikey(t,"shortcut"))return lms(ivalue(e,ls(t),""))}return interface_widget(e,t,r)},"button");return r.card=t,init_field(r,"text",e),init_field(r,"style",e),init_field(r,"value",e),init_field(r,"shortcut",e),r},button_write=e=>{const t=lmd([lms("type")],[lms("button")]);return e.text&&dset(t,lms("text"),lms(e.text)),e.style&&"round"!=e.style&&dset(t,lms("style"),lms(e.style)),null==e.value||e.volatile||dset(t,lms("value"),lmn(e.value)),e.shortcut&&dset(t,lms("shortcut"),lms(e.shortcut)),t},field_styles={rich:1,plain:1,code:1},field_aligns={left:1,center:1,right:1},field_read=(e,t)=>{const r=lmi((e,t,r)=>{if(!is_rooted(e))return NIL;if(r){if(ikey(t,"text"))return e.value=rtext_cast(lms(ls(r))),field_notify(e),r;if(ikey(t,"images"))return e.value=rtext_write_images(r),field_notify(e),r;if(ikey(t,"data"))return e.value=rtext_cast(dyad.format(lms("%J"),monad.list(r))),field_notify(e),r;if(ikey(t,"scroll"))return e.scroll=max(0,ln(r)),r;if(ikey(t,"value"))return"rich"==ls(ifield(e,"style"))||rtext_is_plain(r)||(r=rtext_string(rtext_cast(r))),e.value=rtext_cast(r),field_notify(e),r;if(ikey(t,"border"))return e.border=lb(r),r;if(ikey(t,"scrollbar"))return e.scrollbar=lb(r),r;if(ikey(t,"style"))return e.style=normalize_enum(field_styles,ls(r)),iwrite(e,lms("value"),ifield(e,"value")),r;if(ikey(t,"align"))return e.align=normalize_enum(field_aligns,ls(r)),r}else{if(ikey(t,"text")){const t=value_inherit(e,"value");return null!=t?rtext_string(t):lms("")}if(ikey(t,"images")){const t=value_inherit(e,"value");return null!=t?rtext_read_images(t):lml([])}if(ikey(t,"data")){const t=value_inherit(e,"value");return null!=t?dyad.parse(lms("%J"),rtext_string(t)):NIL}if(ikey(t,"border"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"colorpicker"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"value"))return value_inherit(e,ls(t))||rtext_cast();if(ikey(t,"scroll"))return value_inherit(e,ls(t))||ZERO;if(ikey(t,"scrollbar"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"style"))return lms(ivalue(e,ls(t),"rich"));if(ikey(t,"align"))return lms(ivalue(e,ls(t),"left"));if(ikey(t,"size"))return lmpair(ivalue(e,ls(t),rect(100,20)));if(ikey(t,"font"))return dget(e.card.deck.fonts,lms(e.font||("code"==e.style?"mono":"body")));if(ikey(t,"scrollto"))return lmnat(([t])=>{const r=inset(rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),2);lb(ifield(e,"scrollbar"))&&(r.w-=15);const i=layout_richtext(e.card.deck,ifield(e,"value"),ifield(e,"font"),ALIGN[ls(ifield(e,"align"))],r.w),l=t?min(max(0,0|ln(monad.first(t))),i.layout.length-1):0,s=rcopy(i.layout[l].pos),n=ln(ifield(e,"scroll"));s.y-=n;const o=min(r.h,s.h);let a=n;return s.y<0&&(a+=s.y),s.y+o>=r.h&&(a+=s.y+o-r.h),a!=n&&iwrite(e,lms("scroll"),lmn(a)),e})}return interface_widget(e,t,r)},"field");r.card=t;{const t=lms("value"),i=dget(e,t);i&&iwrite(r,t,rtext_read(i))}return init_field(r,"colorpicker",e),init_field(r,"border",e),init_field(r,"scrollbar",e),init_field(r,"style",e),init_field(r,"align",e),init_field(r,"scroll",e),r},field_write=e=>{const t=lmd([lms("type")],[lms("field")]);if(null!=e.colorpicker&&dset(t,lms("colorpicker"),lmn(e.colorpicker)),null!=e.border&&dset(t,lms("border"),lmn(e.border)),null!=e.scrollbar&&dset(t,lms("scrollbar"),lmn(e.scrollbar)),e.style&&"rich"!=e.style&&dset(t,lms("style"),lms(e.style)),e.align&&"left"!=e.align&&dset(t,lms("align"),lms(e.align)),e.scroll&&!e.volatile&&dset(t,lms("scroll"),lmn(e.scroll)),e.value&&!e.volatile)if(rtext_is_plain(e.value)){const r=rtext_string(e.value);ls(r)&&dset(t,lms("value"),r)}else dset(t,lms("value"),rtext_write(e.value));return t},slider_styles={horiz:1,vert:1,bar:1,compact:1},slider_normalize=(e,t)=>{const r=getpair(ifield(e,"interval")),i=ln(ifield(e,"step"));return clamp(r.x,Math.round(t/i)*i,r.y)},slider_read=(e,t)=>{const r=e=>iwrite(e,lms("value"),ifield(e,"value")),i=lmi((e,t,i)=>{if(!is_rooted(e))return NIL;if(i){if(ikey(t,"value"))return e.value=slider_normalize(e,ln(i)),i;if(ikey(t,"step"))return e.step=max(1e-6,ln(i)),r(e),i;if(ikey(t,"format"))return e.format=ls(i),i;if(ikey(t,"style"))return e.style=normalize_enum(slider_styles,ls(i)),i;if(ikey(t,"interval")){const t=getpair(i);return e.interval=rect(min(t.x,t.y),max(t.x,t.y)),r(e),i}}else{if(ikey(t,"value")){const r=getpair(ifield(e,"interval"));return value_inherit(e,ls(t))||lmn(clamp(r.x,0,r.y))}if(ikey(t,"format"))return lms(ivalue(e,ls(t),"%f"));if(ikey(t,"step"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"interval"))return lmpair(ivalue(e,ls(t),rect(0,100)));if(ikey(t,"style"))return lms(ivalue(e,ls(t),"horiz"));if(ikey(t,"size"))return lmpair(ivalue(e,ls(t),rect(100,25)))}return interface_widget(e,t,i)},"slider");return i.card=t,init_field(i,"interval",e),init_field(i,"step",e),init_field(i,"value",e),init_field(i,"format",e),init_field(i,"style",e),i},slider_write=e=>{const t=lmd([lms("type")],[lms("slider")]);return e.interval&&dset(t,lms("interval"),lmpair(e.interval)),null==e.value||0==e.value||e.volatile||dset(t,lms("value"),lmn(e.value)),null!=e.step&&1!=e.step&&dset(t,lms("step"),lmn(e.step)),null!=e.format&&"%f"!=e.format&&dset(t,lms("format"),lms(e.format)),e.style&&"horiz"!=e.style&&dset(t,lms("style"),lms(e.style)),t},grid_scrollto=(e,t,r,i)=>{const l=t.headers?15:0,s=t.font?font_h(t.font):11,n=min(count(e),0|(t.size.h-l+1)/(s+5));return i-r<0?i:i-r>=n?i-(n-1):r},grid_read=(e,t)=>{const r=lmi((e,t,r)=>{if(!is_rooted(e))return NIL;if(r){if(ikey(t,"value"))return e.value=lt(r),r;if(ikey(t,"scroll"))return e.scroll=max(0,ln(r)),r;if(ikey(t,"row"))return e.row=max(-1,ln(r)),r;if(ikey(t,"col"))return lin(r)?e.col=max(-1,ln(r)):iwrite(e,lms("colname"),r),r;if(ikey(t,"colname"))return iwrite(e,lms("col"),lmn(tab_cols(ifield(e,"value")).indexOf(ls(r)))),r;if(ikey(t,"cell"))return iwrite(e,lms("col"),l_at(r,ZERO)),iwrite(e,lms("row"),l_at(r,ONE)),r;if(ikey(t,"scrollbar"))return e.scrollbar=lb(r),r;if(ikey(t,"headers"))return e.headers=lb(r),r;if(ikey(t,"lines"))return e.lines=lb(r),r;if(ikey(t,"bycell"))return e.bycell=lb(r),r;if(ikey(t,"widths"))return e.widths=((e,t)=>{const r=[];for(let i=0;i<t&&i<e.length;i++)r.push(ln(e[i]));return r})(ll(r),255),r;if(ikey(t,"format"))return e.format=ls(r),r;if(ikey(t,"rowvalue"))return iwrite(e,lms("value"),amend(ifield(e,"value"),ifield(e,"row"),r)),r;if(ikey(t,"cellvalue"))return iwrite(e,lms("rowvalue"),amend(ifield(e,"rowvalue"),ifield(e,"colname"),r)),r}else{if(ikey(t,"value"))return value_inherit(e,ls(t))||lmt();if(ikey(t,"scroll"))return value_inherit(e,ls(t))||ZERO;if(ikey(t,"scrollbar"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"headers"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"lines"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"bycell"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"widths"))return lml(ivalue(e,ls(t),[]).map(lmn));if(ikey(t,"format"))return lms(ivalue(e,ls(t),""));if(ikey(t,"size"))return lmpair(ivalue(e,ls(t),rect(100,50)));if(ikey(t,"cell"))return lml([ifield(e,"col"),ifield(e,"row")]);if(ikey(t,"row")){const r=value_inherit(e,ls(t))||lmn(-1);return lmn(clamp(-1,ln(r),count(ifield(e,"value"))-1))}if(ikey(t,"col")){const r=value_inherit(e,ls(t))||lmn(-1);return lmn(clamp(-1,ln(r),count(monad.keys(ifield(e,"value")))-1))}if(ikey(t,"colname")){const t=ln(ifield(e,"col"));return k=tab_cols(ifield(e,"value")),t<0||t>=k.length?NIL:lms(k[t])}if(ikey(t,"rowvalue")){const t=ln(ifield(e,"row")),r=ifield(e,"value");return t<0||t>=count(r)?lmd():l_at(r,lmn(t))}if(ikey(t,"cellvalue")){const t=ln(ifield(e,"row")),r=ln(ifield(e,"col")),i=ifield(e,"value"),l=tab_cols(i);return t<0||r<0||t>=count(i)||r>=tab_cols(i).length?NIL:tab_cell(i,l[r],t)}if(ikey(t,"scrollto"))return lmnat(t=>{const r=rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),i=ln(ifield(e,"scroll")),l={size:r,font:ifield(e,"font"),headers:lb(ifield(e,"headers"))},s=grid_scrollto(ifield(e,"value"),l,i,ln(t.length?t[0]:ZERO));return s!=i&&iwrite(e,lms("scroll"),lmn(s)),e})}return interface_widget(e,t,r)},"grid");r.card=t,init_field(r,"scrollbar",e),init_field(r,"headers",e),init_field(r,"lines",e),init_field(r,"bycell",e),init_field(r,"widths",e),init_field(r,"format",e),init_field(r,"scroll",e),init_field(r,"row",e),init_field(r,"col",e);{const t=lms("value"),i=dget(e,t);i&&iwrite(r,t,monad.table(i))}return r},grid_write=e=>{const t=lmd([lms("type")],[lms("grid")]);return null!=e.scrollbar&&dset(t,lms("scrollbar"),lmn(e.scrollbar)),null!=e.headers&&dset(t,lms("headers"),lmn(e.headers)),null!=e.lines&&dset(t,lms("lines"),lmn(e.lines)),null!=e.bycell&&dset(t,lms("bycell"),lmn(e.bycell)),e.widths&&dset(t,lms("widths"),lml(e.widths.map(lmn))),e.format&&dset(t,lms("format"),lms(e.format)),e.value&&!e.volatile&&dset(t,lms("value"),monad.cols(e.value)),e.scroll&&!e.volatile&&dset(t,lms("scroll"),lmn(e.scroll)),null==e.row||-1==e.row||e.volatile||dset(t,lms("row"),lmn(e.row)),null==e.col||-1==e.col||e.volatile||dset(t,lms("col"),lmn(e.col)),t},canvas_clip=(e,t)=>{const r=container_image(e,1).size,i=rect(0,0,r.x,r.y);e.clip=!t||t.length<1?i:rint(rclip(i,unpack_rect(t,i)))},canvas_pick=e=>{container_image(e,1),e.brush||iwrite(e,lms("brush"),ifield(e,"brush")),e.pattern||iwrite(e,lms("pattern"),ifield(e,"pattern")),e.font||iwrite(e,lms("font"),ifield(e,"font")),e.clip||canvas_clip(e),frame=e},container_image=(e,t)=>{if(e.image||!t)return e.image;const r=e.image,i=canvas_is(e)?ln(ifield(e,"scale")):1,l=getpair(ifield(e,"size"));return e.image=r?image_copy(r):image_make(rect(ceil(l.x/i),ceil(l.y/i))),canvas_clip(e),e.image},canvas_resize=(e,t)=>{if(!e.image)return;const r=ln(ifield(e,"scale"));image_resize(e.image,rect(ceil(t.x/r),ceil(t.y/r))),canvas_clip(e)},canvas_read=(e,t)=>{const r=(e,t)=>rint(rclip(unpack_rect(t,container_image(e).size),frame.clip)),i=(e,t,r)=>{const l=ifield(frame,"font");if(t&&lil(t)&&count(t)>=4){r=anchors[ls(r)]||0;const i=rint(getrect(t)),s=0==r||3==r||6==r?ALIGN.left:2==r||5==r||8==r?ALIGN.right:ALIGN.center,n=e=>rect(s==ALIGN.left?0:s==ALIGN.right?i.w-e.x:0|(i.w-e.x)/2,y=0==r||1==r||2==r?0:6==r||7==r||8==r?i.h-e.y:0|(i.h-e.y)/2),o=e=>{const t=n(e);return rclip(rint(rect(i.x+t.x,i.y+t.y,e.x,e.y)),frame.clip)};if(lit(e)){const t=layout_richtext(frame.card.deck,e,l,s,i.w);draw_text_rich(o(t.size),t,frame.pattern,0)}else{const t=layout_plaintext(ls(e),l,s,rect(i.w,i.h));draw_text_wrap(o(t.size),t,frame.pattern)}}else{if(lit(e)){const r=getpair(t);return i(e,lml([r.x,r.y,RTEXT_END/1e3,RTEXT_END].map(lmn)))}const s=anchor(rpair(getpair(t),font_textsize(l,ls(e))),r);draw_text(s,ls(e),l,frame.pattern)}},l=lmi((e,t,l)=>{if(!is_rooted(e))return NIL;if(l){if(ikey(t,"brush")){let t=0|max(0,ln(l));if(lis(l)){const r=dkix(e.card.deck.brushes,l);-1!=r&&(t=24+r)}return e.brush=t,l}if(ikey(t,"pattern"))return e.pattern=0|clamp(0,ln(l),255),l;if(ikey(t,"font"))return e.font=normalize_font(e.card.deck.fonts,l),l;if(!lis(t)){const r=container_image(e,1);return r.f(r,t,l)}if(e.free)return l;if(ikey(t,"border"))return e.border=lb(l),l;if(ikey(t,"draggable"))return e.draggable=lb(l),l;if(ikey(t,"lsize")&&(t=lms("size"),l=lmpair(rmul(getpair(l),ln(ifield(e,"scale"))))),ikey(t,"size")&&canvas_resize(e,getpair(l)),ikey(t,"scale"))return e.scale=max(.1,ln(l)),canvas_resize(e,getpair(ifield(e,"size"))),l}else{if(!lis(t)){const r=container_image(e,0);return r?r.f(r,t,l):NIL}if(ikey(t,"border"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"draggable"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"brush"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"pattern"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"size"))return lmpair(ivalue(e,ls(t),rect(100,100)));if(ikey(t,"scale"))return lmn(ivalue(e,ls(t),1));if(ikey(t,"lsize")){const t=getpair(ifield(e,"size")),r=ln(ifield(e,"scale"));return lmpair(rect(ceil(t.x/r),ceil(t.y/r)))}if(ikey(t,"clip"))return lmnat(t=>(canvas_clip(e,t),e));if(ikey(t,"clear"))return lmnat(t=>(canvas_pick(e),draw_rect(r(e,t),0),e));if(ikey(t,"rect"))return lmnat(t=>(canvas_pick(e),draw_rect(r(e,t),frame.pattern),e));if(ikey(t,"invert"))return lmnat(t=>(canvas_pick(e),draw_invert_raw((e=>e.card.deck.patterns.pal.pix)(e),r(e,t)),e));if(ikey(t,"box"))return lmnat(t=>(canvas_pick(e),draw_boxf(((e,t)=>rint(unpack_rect(t,container_image(e).size)))(e,t),frame.brush,frame.pattern,e.card.deck),e));if(ikey(t,"poly"))return lmnat(t=>(canvas_pick(e),draw_poly(unpack_poly(t),frame.pattern),e));if(ikey(t,"line")&&ikey(t,"line"))return lmnat(t=>{canvas_pick(e);let r=null;if(t.length>=3){const e=t[t.length-1];if(lil(e)&&2==count(e)&&lin(e.v[0])&&lin(e.v[1])){const i=ln(e.v[0]),l=ln(e.v[1]);i>=0&&i<=255&&l>=0&&l<=255&&i<=l&&(r=[i,l],t=t.slice(0,t.length-1))}}const i=unpack_poly(t);return draw_lines(i,frame.brush,frame.pattern,e.card.deck,r),e});if(ikey(t,"fill"))return lmnat(([t])=>(canvas_pick(e),draw_fill(rint(getpair(t)),e.pattern),e));if(ikey(t,"copy"))return lmnat(t=>{const r=container_image(e,1);return image_copy(r,unpack_rect(t,r.size))});if(ikey(t,"paste"))return lmnat(([t,r,i])=>{canvas_pick(e);const l=container_image(e,1);t=getimage(t),r=(r?ll(r):[]).map(ln);let s=i?!lb(i):1;return image_paste_scaled(r.length<=2?rect(r[0],r[1],t.size.x,t.size.y):rect(r[0],r[1],r[2],r[3]),frame.clip,t,l,s),e});if(ikey(t,"merge"))return lmnat(t=>{if(canvas_pick(e),lis(t[0]))return image_is(t[1])&&image_merge_op(frame.image,t[1],ls(t[0])[0]),e;lil(t[0])&&(t=ll(t[0]));const r=e=>e&&image_is(e)&&e.size.x>0&&e.size.y>0,i=frame.image.size,l=new Uint8Array(256),s=new Uint32Array(256),n=new Uint32Array(256);for(let e=0;e<t.length&&e<256;e++)r(t[e])&&(l[e]=1,s[e]=t[e].size.x,n[e]=t[e].size.y);for(let e=0;e<i.y;e++)for(let r=0;r<i.x;r++){const i=rect(r,e);if(inclip(i)){const o=gpix(i),a=l[o]?t[o].pix[r%s[o]+e%n[o]*s[o]]:0;pix(i,a)}}return e});if(ikey(t,"segment"))return lmnat(([t,r,i])=>{if(canvas_pick(e),!image_is(t))return e;const l=rint(getrect(r)),s=normalize_margin(i,t.size);return l.w=max(l.w,s.x+s.w),l.h=max(l.h,s.y+s.h),draw_9seg(l,frame.image,t,s,frame.clip,0,null),e});if(ikey(t,"text"))return lmnat(([t,r,l])=>(canvas_pick(e),i(t=lit(t)?rtext_cast(t):lms(ls(t)),r,l),e));if(ikey(t,"textsize"))return lmnat(([t,r])=>{const i=layout_richtext(e.card.deck,rtext_cast(t||lms("")),ifield(e,"font"),ALIGN.left,r?ln(r):RTEXT_END);return r||(i.size.x=i.lines.reduce((e,t)=>max(e,t.pos.x+t.pos.w),0)),lmpair(i.size)})}return interface_widget(e,t,l)},"canvas");l.card=t,l.card=t;{const t=dget(e,lms("image"));t&&(l.image=image_read(ls(t)),iwrite(l,lms("size"),lmpair(l.image.size)))}{const t=dget(e,lms("clip"));t&&canvas_clip(l,ll(t))}{const t=dget(e,lms("size"));t&&(l.size=getpair(t))}{const t=dget(e,lms("scale"));t&&(l.scale=max(.1,ln(t)))}return init_field(l,"border",e),init_field(l,"draggable",e),init_field(l,"brush",e),init_field(l,"pattern",e),init_field(l,"font",e),l},canvas_write=e=>{const t=lmd([lms("type")],[lms("canvas")]);return null!=e.border&&dset(t,lms("border"),lmn(e.border)),!e.image||is_blank(e.image)||e.volatile||dset(t,lms("image"),lms(image_write(e.image))),e.draggable&&dset(t,lms("draggable"),lmn(e.draggable)),e.brush&&dset(t,lms("brush"),lmn(e.brush)),null!=e.pattern&&1!=e.pattern&&dset(t,lms("pattern"),lmn(e.pattern)),e.scale&&dset(t,lms("scale"),lmn(e.scale)),e.clip&&!requ(e.clip,rpair(rect(),getpair(ifield(e,"lsize"))))&&dset(t,lms("clip"),lml([e.clip.x,e.clip.y,e.clip.w,e.clip.h].map(lmn))),t},contraption_read=(e,t)=>{e=ld(e);const r=dget(e,lms("def")),i=r?dget(t.deck.contraptions,r):null;if(!i)return null;const l=(e,t,r,i)=>rect(e.x<r.x?e.x:e.x>t.x-r.w?i.x-(t.x-e.x):0==t.x?0:Math.round(e.x/t.x*i.x),e.y<r.y?e.y:e.y>t.y-r.h?i.y-(t.y-e.y):0==t.y?0:Math.round(e.y/t.y*i.y)),s={name:1,index:1,image:1,script:1,locked:1,animated:1,volatile:1,pos:1,show:1,font:1,toggle:1,event:1,offset:1,parent:1},n=lmi((e,t,r)=>{if(!is_rooted(e))return NIL;if(r){if(ikey(t,"def"))return r;if(ikey(t,"image"))return r;if(ikey(t,"size")){const t=e.def.margin;return e.size=rmax(rect(t.x+t.w,t.y+t.h),getpair(r)),(e=>{const t=e.def,r=t.widgets,i=e.widgets,s=t.margin,n=t.size,o=getpair(ifield(e,"size"));r.k.map((e,t)=>{const a=r.v[t],d=dget(i,e);if(!d)return;let c=getpair(ifield(a,"pos")),A=radd(getpair(ifield(a,"size")),c);c=l(c,n,s,o),A=l(A,n,s,o),iwrite(d,lms("pos"),lmpair(c)),iwrite(d,lms("size"),lmpair(rsub(A,c)))})})(e),r}return lis(t)&&s.hasOwnProperty(ls(t))?interface_widget(e,t,r):(fire_attr_sync(e,"set_"+ls(t),r),r)}return ikey(t,"def")?e.def:ikey(t,"size")?lmpair((i.resizable?e.size:i.size)||i.size):ikey(t,"image")?ifield(e.def,"image"):lis(t)&&s.hasOwnProperty(ls(t))?interface_widget(e,t,r):fire_attr_sync(e,"get_"+ls(t),null)},"contraption");n.card=t,n.deck=t.deck,n.def=i,n.widgets=lmd();let o=dget(e,lms("widgets")),a=i.widgets;o?o=ld(o):(o=lmd(),i.widgets.k.map(e=>dset(o,e,lmd()))),a.k.map((e,t)=>{const r=widget_write(a.v[t]),i=dget(o,e);widget_add(n,i?dyad[","](r,i):r)});{const t=lms("size"),r=dget(e,t);iwrite(n,t,r||ifield(i,"size"))}return n.viewproxy=lmi(interface_widget,"proxy"),n.viewproxy.card=n,n},contraption_write=e=>{const t=lmd(),r=lmd(["type","def","widgets"].map(lms),[lms("contraption"),ifield(e.def,"name"),t]);return e.widgets.v.map(r=>{let i=widget_write(r),l=ifield(r,"name"),s=dget(e.def.widgets,l);dset(t,l,dyad.drop(lms("name"),s?((e,t)=>{const r=lmd();return t.k.map((i,l)=>{const s=dget(e,i),n=t.v[l];s&&match(s,n)||dset(r,i,n)}),r})(widget_write(s),i):i))}),r},widget_shows={solid:1,invert:1,transparent:1,none:1},interface_widget=(e,t,r)=>{if(widget_rename=(e,t,r)=>{const i=e.widgets,l=dkix(i,t);i.k[l]=r,i.v[l].name=ls(r)},r){if(ikey(t,"name"))return widget_rename(e.card,lms(e.name),ukey(e.card.widgets,lms(ls(r)),ls(r),lms(e.name))),r;if(ikey(t,"index"))return reorder(e.card.widgets,dvix(e.card.widgets,e),ln(r)),r;if(ikey(t,"font"))return e.font=normalize_font(e.card.deck.fonts,r),r;if(ikey(t,"script"))return e.script=ls(r),r;if(ikey(t,"locked"))return e.locked=lb(r),r;if(ikey(t,"animated"))return e.animated=lb(r),r;if(ikey(t,"volatile"))return e.volatile=lb(r),r;if(ikey(t,"size"))return e.size=rint(rclamp(rect(),getpair(r),rect(4096,4096))),r;if(ikey(t,"pos"))return e.pos=rint(getpair(r)),r;if(ikey(t,"show"))return e.show=normalize_enum(widget_shows,ls(r)),r;if(!(ikey(t,"name")||ikey(t,"index")||ikey(t,"font")||ikey(t,"script")||ikey(t,"locked")||ikey(t,"animated")||ikey(t,"volatile")||ikey(t,"size")||ikey(t,"pos")||ikey(t,"show")))return e[ls(t)]=lb(r)?lb(r):lin(r)?ln(r):lis(r)?ls(r):r,r}else{if(ikey(t,"name"))return lms(e.name);if(ikey(t,"index"))return lmn(dvix(e.card.widgets,e));if(ikey(t,"script"))return lms(ivalue(e,ls(t),""));if(ikey(t,"locked"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"animated"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"volatile"))return lmn(ivalue(e,ls(t),0));if(ikey(t,"pos"))return lmpair(ivalue(e,ls(t),rect()));if(ikey(t,"show"))return lms(ivalue(e,ls(t),"solid"));if(ikey(t,"font"))return dget(e.card.deck.fonts,lms(ivalue(e,ls(t),button_is(e)?"menu":"body")));if(ikey(t,"event"))return lmnat(t=>n_event(e,t));if(ikey(t,"parent"))return e.card;if(ikey(t,"toggle"))return lmnat(([t,r])=>{const i=null==r;t=t||lms("solid"),r=r||ZERO;const l=ifield(e,"show"),s=lms("none"),n=(i?match(l,s):lb(r)&&!match(r,s))?t:s;return iwrite(e,lms("show"),n),n});if(ikey(t,"offset")){let t=getpair(ifield(e.card,"size")),r=getpair(ifield(e,"pos")),i=e.card.deck.size,l=e.card;for(;contraption_is(l);)r=radd(r,getpair(ifield(l,"pos"))),l=l.card,t=getpair(ifield(l,"size"));return lmpair(radd(r,rcenter(rect(0,0,i.x,i.y),t)))}if(e.hasOwnProperty&&e.hasOwnProperty(ls(t))){const r=e[ls(t)];return"boolean"==typeof r?lmn(r?1:0):"number"==typeof r?lmn(r):"string"==typeof r?lms(r):r}if(e.b){const r=dget(e.b,t);if(!linil(r))return r}}return r||NIL},widget_read=(e,t)=>{const r=ls(dget(e,lms("type"))||lms("button")),i="contraption"==r?ls(dget(e,lms("def"))||lms(r)):r,l=({button:button_read,field:field_read,slider:slider_read,grid:grid_read,canvas:canvas_read,contraption:contraption_read}[r]||button_read)(ld(e),t);return lii(l)?(l.name=ls(ukey(t.widgets,dget(e,lms("name")),i)),init_field(l,"size",e),init_field(l,"script",e),init_field(l,"font",e),init_field(l,"locked",e),init_field(l,"animated",e),init_field(l,"volatile",e),init_field(l,"pos",e),init_field(l,"show",e),init_field(l,"colorpicker",e),l):null},widget_write=e=>{const t=lmd();return dset(t,lms("name"),lms(e.name)),dset(t,lms("type"),lms(e.n)),dset(t,lms("size"),ifield(e,"size")),dset(t,lms("pos"),ifield(e,"pos")),e.size&&dset(t,lms("size"),lmpair(e.size)),e.pos&&dset(t,lms("pos"),lmpair(e.pos)),e.locked&&dset(t,lms("locked"),lmn(e.locked)),e.animated&&dset(t,lms("animated"),lmn(e.animated)),e.volatile&&dset(t,lms("volatile"),lmn(e.volatile)),e.script&&dset(t,lms("script"),lms(e.script)),e.font&&e.font!=(button_is(e)?"menu":"body")&&dset(t,lms("font"),lms(e.font)),e.show&&"solid"!=e.show&&dset(t,lms("show"),lms(e.show)),dyad[","](t,button_is(e)?button_write(e):field_is(e)?field_write(e):slider_is(e)?slider_write(e):grid_is(e)?grid_write(e):canvas_is(e)?canvas_write(e):contraption_is(e)?contraption_write(e):lmd())},widget_strip=e=>dyad.take(lml([lms("name"),lms("type")]),e),widget_add=(e,t)=>{const r=widget_read(t,e);return lii(r)&&dset(e.widgets,ifield(r,"name"),r),r},card_add=(e,t,r,i)=>{if(prototype_is(e)&&(contraption_is(t)||"contraption"==ls(t)))return NIL;if(lis(t)){if("contraption"==ls(t)){const t=e.deck.contraptions,l=lms(r?ls(r):"");if(!dget(t,l))return NIL;const s=lmd(["type","def"].map(lms),[lms("contraption"),l]);return i&&dset(s,lms("name"),lms(ls(i))),widget_add(e,s)}if(!ls(t)in{button:1,field:1,slider:1,canvas:1,grid:1})return NIL;const l=lmd([lms("type")],[t]);return r&&dset(l,lms("name"),lms(ls(r))),widget_add(e,l)}if(widget_is(t)){const i=widget_write(t);return r&&dset(i,lms("name"),r),widget_add(e,i)}return NIL},card_remove=(e,t)=>{if(lil(t)||lid(t))return t.v.reduce((t,r)=>t&card_remove(e,r),1);if(!widget_is(t)||!dkey(e.widgets,t))return 0;const r=ifield(t,"name");return dget(e.widgets,r).dead=!0,e.widgets=dyad.drop(r,e.widgets),1},con_copy_raw=(e,t)=>t.filter(t=>widget_is(t)&&t.card==e).map(widget_write),con_paste_raw=(e,t)=>t.map(t=>widget_add(e,ld(t))),find_fonts=(e,t,r)=>{let i=lmd([],[]);r.filter(widget_is).map(t=>{t.font&&dset(i,lms(t.font),dget(e.fonts,lms(t.font))),contraption_is(t)&&t.widgets.v.map(e=>ifield(e,"font")).map(t=>dset(i,dkey(e.fonts,t),t)),field_is(t)&&match(ifield(t,"style"),lms("rich"))&&tab_get(ifield(t,"value"),"font").filter(t=>count(t)&&!dget(i,t)&&dget(e.fonts,t)).map(t=>dset(i,t,dget(e.fonts,t)))}),i=dyad.drop(lml(["body","menu","mono"].map(lms)),i),i.v.map((e,t)=>{i.v[t]=lms(font_write(e))}),count(i)&&dset(t,lms("f"),i)},merge_fonts=(e,t)=>{t&&(t=ld(t)).v.map((r,i)=>{const l=t.k[i],s=font_read(ls(r));font_is(s)&&!dget(e.fonts,l)&&dset(e.fonts,l,s)})},con_copy=(e,t)=>{t=lil(t)||lid(t)?ll(t):[t];const r=lml(con_copy_raw(e,t)),i=lmd(),l=lmd(["w","d"].map(lms),[r,i]),s=e.deck.contraptions;return find_fonts(e.deck,l,t),r.v.map(e=>{const t=dget(e,lms("type")),r=dget(e,lms("def"));"contraption"==ls(t)&&null==dget(i,r)&&dset(i,r,prototype_write(dget(s,r)))}),lms(`%%WGT0${fjson(l)}`)},merge_prototypes=(e,t,r)=>{const i=e.contraptions;t.v.map(t=>{const l=dget(t,lms("name"));let s=dget(t,lms("description"));if(!lis(l))return;s||(s=lms(""));const n=dget(t,lms("version")),o=n?ln(n):0;if(i.v.some(r=>{const i=match(l,ifield(r,"name"))&&match(s,ifield(r,"description"));return i&&ln(ifield(r,"version"))<o&&deck_add(e,prototype_read(t,deck_read(""))),i}))return;const a=prototype_read(t,e),d=ifield(a,"name");dset(i,d,a),r.map(e=>{const t=dget(e,lms("type")),r=dget(e,lms("def"));lis(t)&&"contraption"==ls(t)&&lis(r)&&ls(r)==ls(l)&&dset(e,lms("def"),d)})})},con_paste=(e,t)=>{if(!lis(t)||!t.v.startsWith("%%WGT0"))return NIL;const r=ld(pjson(ls(t),6,count(t)-6).value),i=dget(r,lms("d"));let l=dget(r,lms("w"));return l=l?ll(l):[],merge_fonts(e.deck,dget(r,lms("f"))),merge_prototypes(e.deck,i?ld(i):lmd(),l),lml(con_paste_raw(e,l))},card_read=(e,t,r)=>{e=ld(e);const i=lmi((e,r,i)=>{if(e.dead)return NIL;if(i){if(ikey(r,"name")){if(0==ls(i).length)return i;const r=ukey(t.cards,lms(ls(i)),ls(i),lms(e.name));return t.cards.k[dvix(t.cards,e)]=r,e.name=ls(r),i}if(ikey(r,"script"))return e.script=ls(i),i;if(ikey(r,"image"))return e.image=image_is(i)?i:image_make(rect()),i;if(ikey(r,"index"))return reorder(e.deck.cards,dvix(e.deck.cards,e),ln(i)),e.deck.history=[ln(ifield(e,"index"))],i}else{if(ikey(r,"name"))return lms(e.name);if(ikey(r,"size"))return lmpair(t.size);if(ikey(r,"index"))return lmn(dvix(t.cards,e));if(ikey(r,"script"))return lms(e.script||"");if(ikey(r,"widgets"))return e.widgets;if(ikey(r,"parent"))return e.deck;if(ikey(r,"image"))return e.image;if(ikey(r,"add"))return lmnat(([t,r,i])=>card_add(e,t,r,i));if(ikey(r,"remove"))return lmnat(([t])=>lmn(card_remove(e,t)));if(ikey(r,"event"))return lmnat(t=>n_event(e,t));if(ikey(r,"copy"))return lmnat(([t])=>con_copy(e,t));if(ikey(r,"paste"))return lmnat(([t])=>con_paste(e,t))}return i||NIL},"card"),l=dget(e,lms("name"));i.deck=t,i.widgets=lmd(),i.name=ls(ukey(t.cards,l&&lis(l)&&0==count(l)?null:l,"card")),i.script=ls(dget(e,lms("script"))||lms(""));{const r=dget(e,lms("image"));i.image=r?image_read(ls(r)):image_make(t.size)}return ll(dget(e,lms("widgets"))||lml([])).filter(e=>dget(e,lms("name"))).map(e=>{const t=widget_read(e,i);lii(t)&&dset(i.widgets,ifield(t,"name"),t)}),i},card_write=e=>{const t=lmd(),r=lmd();return dset(t,lms("name"),lms(e.name)),dset(t,lms("widgets"),r),e.script.length&&dset(t,lms("script"),lms(e.script)),e.image&&!is_blank(e.image)&&dset(t,lms("image"),lms(image_write(e.image))),e.widgets.k.map((t,i)=>{let l=widget_write(e.widgets.v[i]),s=dget(l,lms("name"));l=dyad.drop(lms("name"),l),count(l)&&dset(r,s,l)}),t},contraption_update=(e,t)=>{e.cards.v.map(e=>{e.widgets.v.filter(e=>contraption_is(e)&&e.def==t).map(t=>{const r=widget_write(t),i=t.name;for(var l in dset(r,lms("widgets"),(e=>{const t=lmd();return e.widgets.v.map(e=>{let r=widget_write(e);button_is(e)&&(r=dyad.take(lms("value"),r)),slider_is(e)&&(r=dyad.take(lms("value"),r)),field_is(e)&&(r=dyad.take(lml(["value","scroll"].map(lms)),r)),grid_is(e)&&(r=dyad.take(lml(["value","scroll","row","col"].map(lms)),r)),canvas_is(e)&&(r=dyad.take(lms("image"),r)),dset(t,ifield(e,"name"),r)}),t})(t)),t)delete t[l];Object.assign(t,widget_read(r,e)),t.name=i})})},normalize_margin=(e,t)=>{const r=rint(getrect(e));return rmax(rect(min(r.x,t.x),min(r.y,t.y),min(r.w,t.x-r.x),min(r.h,t.y-r.y)),rect(0,0,0,0))},prototype_read=(e,t)=>{e=ld(e);const r={"":1,bool:1,number:1,string:1,code:1,rich:1},i=e=>{const t=lmt();if(tab_set(t,"name",[]),tab_set(t,"label",[]),tab_set(t,"type",[]),!lit(e))return t;const i=tab_get(e,"name"),l=tab_get(e,"label")||i,s=tab_get(e,"type");return i&&s&&i.filter(e=>lis(e)&&count(e)).map((e,i)=>{const n=normalize_enum(r,ls(s[i]));n.length&&(tab_get(t,"name").push(e),tab_get(t,"label").push(lms(ls(l[i]))),tab_get(t,"type").push(lms(n)))}),t},l=e=>lmpair(rcenter(rect(0,0,t.size.x,t.size.y),e.size)),s=lmi((e,r,s)=>{if(e.dead)return NIL;if(s){if(ikey(r,"name")){const t=e.deck.contraptions,r=e.name,i=ukey(t,lms(ls(s)),ls(s),lms(r));return t.k[dvix(t,e)]=i,e.name=ls(i),s}if(ikey(r,"description"))return e.description=ls(s),s;if(ikey(r,"version"))return e.version=ln(s),s;if(ikey(r,"size"))return e.size=rint(getpair(s)),contraption_update(t,e),s;if(ikey(r,"margin"))return e.margin=normalize_margin(s,getpair(ifield(e,"size"))),contraption_update(t,e),s;if(ikey(r,"resizable"))return e.resizable=lb(s),contraption_update(t,e),s;if(ikey(r,"image"))return e.image=image_is(s)?s:image_make(rect(0,0)),s;if(ikey(r,"script"))return e.script=ls(s),s;if(ikey(r,"template"))return e.template=ls(s),s;if(ikey(r,"attributes"))return e.attributes=i(s),s}else{if(ikey(r,"name"))return lms(e.name);if(ikey(r,"description"))return lms(e.description||"");if(ikey(r,"version"))return lmn(e.version||0);if(ikey(r,"script"))return lms(e.script||"");if(ikey(r,"template"))return lms(e.template||"");if(ikey(r,"font"))return monad.first(e.deck.fonts);if(ikey(r,"show"))return lms("solid");if(ikey(r,"parent"))return ifield(e.deck,"card");if(ikey(r,"size"))return lmpair(e.size);if(ikey(r,"margin"))return lmrect(e.margin);if(ikey(r,"resizable"))return lmn(e.resizable);if(ikey(r,"image"))return e.image;if(ikey(r,"widgets"))return e.widgets;if(ikey(r,"attributes"))return e.attributes||i(NIL);if(ikey(r,"offset"))return l(e);if(ikey(r,"pos"))return l(e);if(ikey(r,"add"))return lmnat(([r,i,l])=>{const s=card_add(e,r,i,l);return widget_is(s)&&contraption_update(t,e),s});if(ikey(r,"remove"))return lmnat(([r])=>{const i=card_remove(e,r);return lb(i)&&contraption_update(t,e),i});if(ikey(r,"update"))return lmnat(r=>(contraption_update(t,e),NIL))}return s||NIL},"prototype");s.deck=t,s.widgets=lmd();{const r=dget(e,lms("name"));s.name=ls(ukey(t.contraptions,r&&lis(r)&&0==count(r)?null:r,"prototype"))}{const t=dget(e,lms("attributes"));t&&iwrite(s,lms("attributes"),monad.table(t))}{const t=dget(e,lms("size"));s.size=t?rint(getpair(t)):rect(100,100)}{const t=dget(e,lms("image"));s.image=t?image_read(ls(t)):image_make(s.size)}{const t=dget(e,lms("resizable"));s.resizable=t?lb(t):0}let n=dget(e,lms("widgets"));return lid(n)&&n.v.map((e,t)=>dset(e,lms("name"),n.k[t])),(n?ll(n):[]).map(e=>{if(dget(e,lms("name"))){const t=widget_read(e,s);lii(t)&&dset(s.widgets,ifield(t,"name"),t)}}),init_field(s,"description",e),init_field(s,"version",e),init_field(s,"script",e),init_field(s,"template",e),s.margin=normalize_margin(dget(e,lms("margin"))||NIL,getpair(ifield(s,"size"))),s},prototype_write=e=>{const t=lmd(),r=lmd();return dset(t,lms("name"),lms(e.name)),dset(t,lms("size"),ifield(e,"size")),e.resizable&&dset(t,lms("resizable"),ONE),dset(t,lms("margin"),ifield(e,"margin")),e.description&&e.description.length&&dset(t,lms("description"),lms(e.description)),e.version&&0!=e.version&&dset(t,lms("version"),lmn(e.version)),e.script&&e.script.length&&dset(t,lms("script"),lms(e.script)),e.template&&e.template.length&&dset(t,lms("template"),lms(e.template)),(e=>e&&image_is(e)&&e.size.x>0&&e.size.y>0&&!is_blank(e))(e.image)&&dset(t,lms("image"),lms(image_write(e.image))),e.attributes&&dset(t,lms("attributes"),monad.cols(e.attributes)),e.widgets.v.map(e=>{let t=widget_write(e),i=dget(t,lms("name"));t=dyad.drop(lms("name"),t),count(t)&&dset(r,i,t)}),dset(t,lms("widgets"),r),t},rename_sound=(e,t,r)=>{const i=e.sounds,l=dkey(i,t);i.k[dkix(i,l)]=ukey(i,r,ls(r),l)},deck_add=(e,t,r,i)=>{const l=e=>e?lms(ls(e)):NIL;if(font_is(t))return uset(e.fonts,l(r),"font",font_read(font_write(t)));if(ikey(t,"font"))return uset(e.fonts,l(i),"font",font_read(getpair(r)));if(sound_is(t))return uset(e.sounds,l(r),"sound",sound_read(sound_write(t)));if(ikey(t,"sound"))return uset(e.sounds,l(i),"sound",sound_read(r?ln(r):0));if(module_is(t)){if(!r&&dget(e.modules,ifield(t,"name"))){deck_remove(e,dget(e.modules,ifield(t,"name")));const r=module_read(module_write(t),e);return dset(e.modules,ifield(r,"name"),r),r}{const i=module_write(t);r&&dset(i,lms("name"),lms(ls(r)));const l=module_read(i,e);return dset(e.modules,ifield(l,"name"),l),l}}if(ikey(t,"module")){const t=lmd();r&&dset(t,lms("name"),lms(ls(r)));const i=module_read(t,e);return dset(e.modules,ifield(i,"name"),i),i}if(card_is(t))return deck_paste(e,deck_copy(e,t),r?lms(ls(r)):null);if(ikey(t,"card")){const t=lmd();r&&dset(t,lms("name"),lms(ls(r)));const i=card_read(t,e);return dset(e.cards,ifield(i,"name"),i),i}if(prototype_is(t)){if(!r&&dget(e.contraptions,ifield(t,"name"))){const r=ifield(t,"name"),i=dget(e.contraptions,r);for(var s in i)delete i[s];return Object.assign(i,prototype_read(prototype_write(t),e)),i.name=ls(r),contraption_update(e,i),i}{const i=prototype_write(t);r&&dset(i,lms("name"),lms(ls(r)));const l=prototype_read(i,e);return dset(e.contraptions,ifield(l,"name"),l),l}}ikey(t);{const t=lmd();r&&dset(t,lms("name"),lms(ls(r)));const i=prototype_read(t,e);return dset(e.contraptions,ifield(i,"name"),i),i}},deck_remove=(e,t)=>{if(widget_is(t)&&is_rooted(t))return card_remove(t.card,t);if(patterns_is(t)){const e=patterns_read({});return t.pal=e.pal,t.anim=e.anim,1}if(module_is(t)){const r=dkey(e.modules,t);if(r)return e.modules=dyad.drop(r,e.modules),1}if(sound_is(t)){const r=dkey(e.sounds,t);if(r)return e.sounds=dyad.drop(r,e.sounds),1}if(font_is(t)){const r=dkey(e.fonts,t);if(!r||ls(r)in{body:1,menu:1,mono:1})return 0;const i=e=>e.v.map(e=>{e.font==ls(r)&&(e.font="body"),contraption_is(e)&&i(e.widgets)});return e.cards.v.map(e=>i(e.widgets)),e.contraptions.v.map(e=>i(e.widgets)),e.fonts=dyad.drop(r,e.fonts),1}if(prototype_is(t)){const r=dkey(e.contraptions,t);return r?(e.cards.v.map(e=>e.widgets.v.filter(e=>contraption_is(e)&&e.def==t).map(t=>card_remove(e,t))),e.contraptions=dyad.drop(r,e.contraptions),t.dead=!0,1):0}return card_is(t)?count(e.cards)<=1?0:(e.cards=dyad.drop(dkey(e.cards,t)||NIL,e.cards),t.dead=!0,e.card>=count(e.cards)&&(e.card=count(e.cards-1)),e.history=[ln(ifield(ifield(e,"card"),"index"))],1):0},deck_copy=(e,t)=>{if(!card_is(t))return NIL;const r=lmd(),i=lmd(["c","d"].map(lms),[card_write(t),r]);return find_fonts(e,i,t.widgets.v),t.widgets.v.filter(contraption_is).map(e=>{const t=e.def,i=ifield(t,"name");null==dget(r,i)&&dset(r,i,prototype_write(t))}),lms(`%%CRD0${fjson(i)}`)},deck_paste=(e,t,r)=>{if(!lis(t)||!ls(t).startsWith("%%CRD0"))return NIL;const i=ld(pjson(ls(t),6,count(t)-6).value);let l=dget(i,lms("c")),s=dget(i,lms("d"));l=l?ld(l):lmd();const n=dget(l,lms("widgets"));n&&lid(n)&&n.v.map((e,t)=>dset(e,lms("name"),n.k[t])),merge_fonts(e,dget(i,lms("f"))),merge_prototypes(e,s?ld(s):lmd(),n?ll(n):[]);const o=card_read(l,e);return dset(e.cards,r||ifield(o,"name"),o),o},widget_purge=e=>{if(e.volatile){if(button_is(e)&&iwrite(e,lms("value"),ZERO),slider_is(e)&&iwrite(e,lms("value"),ZERO),field_is(e)&&(iwrite(e,lms("value"),lms("")),iwrite(e,lms("scroll"),ZERO)),grid_is(e)&&(iwrite(e,lms("value"),lmt()),iwrite(e,lms("scroll"),ZERO)),canvas_is(e)){const t=frame;canvas_pick(e),draw_rect(frame.clip,0),frame=t}contraption_is(e)&&e.widgets.v.map(e=>widget_purge(e))}},deck_purge=e=>{e.cards.v.map(e=>e.widgets.v.map(e=>widget_purge(e)))},deck_read=e=>{const t={},r=new Map,i={},l={},s={},n=lmd(),o=lmd();let a=0,d=0,c=0,A=0;Object.keys(FONTS).map(e=>dset(n,lms(e),font_read(FONTS[e])));const m=t=>e.startsWith(t,a)?(a+=t.length,1):0,_=t=>a>=e.length||e.startsWith("<\/script>",a),u=t=>{let r="";for(;!_()&&!m(t);)r+=m("{l}")?"{":m("{r}")?"}":m("{c}")?":":m("{s}")?"/":e[a++];return clchars(r)},p=e=>{const t=Object.keys(e);return e[t[t.length-1]]||lmd()};if(m('<meta charset="UTF-8">'),m("<body>")){const t=e.indexOf('<script language="decker">',a);-1!==t&&(a=t+26,console.log("deck_read: 找到script标签，跳转到位置",a))}for(m('<body><script language="decker">');!_();)if("\n"==e[a])a++;else if("#"==e[a])for(;!_()&&"\n"!=e[a];)a++;else if(m("{deck}\n"))d=1;else if(m("{fonts}\n"))d=2;else if(m("{sounds}\n"))d=3;else if(m("{widgets}\n"))d=4;else if(m("{card:")){const e=u("}");i["~"+e]=lmd(["name","widgets"].map(lms),[lms(e),lml([])]),d=5,A=0}else if(m("{script:")){const e=u("}\n");r.set(e,u("\n{end}"))}else if(m("{module:")){const e=u("}");l["~"+e]=lmd(["name","script","data"].map(lms),[lms(e),lms(""),lmd()]),d=6,c=0}else if(m("{contraption:")){const e=u("}");s["~"+e]=lmd(["name","widgets"].map(lms),[lms(e),lml([])]),d=7,A=1}else if(m("{autoswitch_config}\n"))console.log("Found autoswitch_config section"),d=8;else if(8==d&&m("{end}\n"))console.log("End of autoswitch_config section"),d=1;else if(6==d&&m("{data}\n"))c=1;else if(6==d&&m("{script}\n"))dset(p(l),lms("script"),lms(u("\n{end}"))),d=1;else{const r=u(":"),m=plove(e,a,e.length-a),_=m.value;a=m.index,1==d&&(t[r]=_),2==d&&dset(n,lms(r),font_read(ls(_))),3==d&&dset(o,lms(r),sound_read(ls(_))),4!=d||A||Object.keys(i).length&&dget(p(i),lms("widgets")).v.push(dset(ld(_),lms("name"),lms(r))),4==d&&A&&Object.keys(s).length&&dget(p(s),lms("widgets")).v.push(dset(ld(_),lms("name"),lms(r))),5==d&&dset(p(i),lms(r),_),6==d&&dset(c?dget(p(l),lms("data")):p(l),lms(r),_),7==d&&dset(p(s),lms(r),_),8==d&&(console.log("Reading autoswitch config:",r,"=",_),t["autoswitch_"+r]=_)}const g=e=>{const t=lms("script"),i=dget(e,t);i&&dset(e,t,lms(r.get(ls(i))))};Object.values(i).map(e=>{g(e),dget(e,lms("widgets")).v.map(g)}),Object.values(s).map(e=>{g(e),dget(e,lms("widgets")).v.map(g)});const f=lmi((e,t,r)=>{if(r){if(ikey(t,"locked"))return e.locked=lb(r),r;if(ikey(t,"name"))return e.name=ls(r),r;if(ikey(t,"author"))return e.author=ls(r),r;if(ikey(t,"script"))return e.script=ls(r),r;if(ikey(t,"card"))return n_go([r],e),r}else{if(ikey(t,"version"))return lmn(e.version);if(ikey(t,"locked"))return lmn(e.locked);if(ikey(t,"name"))return lms(e.name);if(ikey(t,"author"))return lms(e.author);if(ikey(t,"script"))return lms(e.script);if(ikey(t,"patterns"))return e.patterns;if(ikey(t,"sounds"))return dyad.drop(ZERO,e.sounds);if(ikey(t,"fonts"))return dyad.drop(ZERO,e.fonts);if(ikey(t,"cards"))return e.cards;if(ikey(t,"modules"))return e.modules;if(ikey(t,"contraptions"))return e.contraptions;if(ikey(t,"card"))return e.cards.v[min(count(e.cards)-1,e.card)];if(ikey(t,"add"))return lmnat(([t,r,i])=>deck_add(e,t,r,i));if(ikey(t,"remove"))return lmnat(([t])=>lmn(deck_remove(e,t)));if(ikey(t,"event"))return lmnat(t=>n_event(e,t));if(ikey(t,"copy"))return lmnat(([t])=>deck_copy(e,t));if(ikey(t,"paste"))return lmnat(([t])=>deck_paste(e,t));if(ikey(t,"purge"))return lmnat(()=>(deck_purge(e),e));if(ikey(t,"encoded"))return lms(deck_write(e))}return r||NIL},"deck");f.fonts=n,f.sounds=o,f.contraptions=lmd(),f.cards=lmd(),f.modules=lmd(),f.transit=lmd(),f.brushes=lmd(),f.brusht=lmd(),f.patterns=patterns_read(t),f.version=t.hasOwnProperty("version")?ln(t.version):1,f.locked=t.hasOwnProperty("locked")?lb(t.locked):0,f.name=t.hasOwnProperty("name")?ls(t.name):"",f.author=t.hasOwnProperty("author")?ls(t.author):"",f.script=t.hasOwnProperty("script")?r.get(ls(t.script)):"",f.card=t.hasOwnProperty("card")?clamp(0,ln(t.card),Object.keys(i).length-1):0,f.size=t.hasOwnProperty("size")?rclamp(rect(8,8),getpair(t.size),rect(4096,4096)):rect(512,342),0==Object.keys(i).length&&(i.home=lmd(["name"].map(lms),[lms("home")]));const w=lmenv();for(constants(w),primitives(w,f),pushstate(w),issue(w,parse(DEFAULT_TRANSITIONS));running();)runop();return popstate(),Object.values(s).map(e=>{const t=prototype_read(e,f);dset(f.contraptions,ifield(t,"name"),t)}),Object.values(i).map(e=>{const t=card_read(e,f,i);dset(f.cards,ifield(t,"name"),t)}),Object.values(l).map(e=>{const t=module_read(e,f);dset(f.modules,ifield(t,"name"),t)}),f.history=[ln(ifield(ifield(f,"card"),"index"))],t.hasOwnProperty("autoswitch_uniformInterval")&&(f.autoswitch_uniformInterval=t.autoswitch_uniformInterval,console.log("Added autoswitch_uniformInterval to ri:",t.autoswitch_uniformInterval)),t.hasOwnProperty("autoswitch_intervals")&&(f.autoswitch_intervals=t.autoswitch_intervals,console.log("Added autoswitch_intervals to ri:",t.autoswitch_intervals)),t.hasOwnProperty("autoswitch_startCard")&&(f.autoswitch_startCard=t.autoswitch_startCard,console.log("Added autoswitch_startCard to ri:",t.autoswitch_startCard)),t.hasOwnProperty("autoswitch_endCard")&&(f.autoswitch_endCard=t.autoswitch_endCard,console.log("Added autoswitch_endCard to ri:",t.autoswitch_endCard)),t.hasOwnProperty("autoswitch_isEnabled")&&(f.autoswitch_isEnabled=t.autoswitch_isEnabled,console.log("Added autoswitch_isEnabled to ri:",t.autoswitch_isEnabled)),f},deck_write=(e,t)=>{if(!deck_is(e))return"";let r=e,i=lmd(),l=0,s=0,n=(t?'<meta charset="UTF-8"><body><script language="decker">\n':"")+"{deck}\nversion:1\n";const o=(e,t)=>{let r="\0",i=r,l="";for(let s=0;s<t.length;s++)i=r,r=t[s],l+="{"==r?"{l}":"}"==r?"{r}":":"==r&&e?"{c}":"/"==r&&"<"==i?"{s}":r;return l},a=(e,t,r)=>{if("undefined"==ls(t))throw new Error("welp");for(let e=0;e<i.v.length;e++)if(match(i.v[e],t))return i.k[e];const l=lms(e?`${e}.${s}${r||""}`:`${s}${r||""}`);return s++,dset(i,l,t),l},d=e=>{for(;l<i.v.length;)n+=`\n{script:${o(1,ls(i.k[l]))}}\n${o(0,ls(i.v[l++]))}\n{end}\n`},c=(e,t,r,i)=>{const l=e[t];r(l)&&(n+=`${t}:${fjson(i(l))}\n`)},A=(e,t,r,i)=>{const l=dget(e,lms(t));r(l)&&(n+=`${t}:${fjson(i(l))}\n`)},m=(e,t,r)=>n+=`${count(t)?e:""}${t.k.map((e,i)=>`${o(1,ls(e))}:${flove(r(t.v[i]))}\n`).join("")}`,_=patterns_write(e.patterns),u=anims_write(e.patterns),p=dyad.parse(lms("%j"),lms(DEFAULT_ANIMS));let g=r.fonts;const f=e=>{const t=lms(e),r=dget(g,t);font_write(r)==FONTS[e]&&(g=dyad.drop(lml([t]),g))};f("body"),f("menu"),f("mono"),c(e,"card",e=>1,lmn),c(e,"size",e=>1,lmpair),c(e,"locked",e=>e,lmn),c(e,"script",e=>e&&e.length&&"undefined"!=e,e=>a(null,lms(e))),c(e,"name",e=>e.length,lms),c(e,"author",e=>e.length,lms);DEFAULT_PATTERNS;return c(e,"patterns",e=>_!=DEFAULT_PATTERNS,e=>lms(_)),c(e,"animations",e=>!match(u,p),e=>u),d(),m("\n{fonts}\n",g,e=>lms(font_write(e))),m("\n{sounds}\n",r.sounds,e=>lms(sound_write(e))),r.cards.v.map(e=>{const t=card_write(e),r=dget(t,lms("widgets")),i=ls(dget(t,lms("name")));s=0,n+=`\n{card:${o(1,i)}}\n`,A(t,"image",e=>e,e=>e),A(t,"script",count,e=>a(i,e)),r.v.map(e=>{const t=lms("script"),r=dget(e,t);r&&"undefined"!=ls(r)&&dset(e,t,a(i,r))}),m("{widgets}\n",r,e=>e),d()}),r.modules.v.map(e=>{const t=module_write(e);n+=`\n{module:${o(1,ls(dget(t,lms("name"))))}}\n`,A(t,"description",e=>e,e=>e),A(t,"version",e=>e,e=>e),m("{data}\n",dget(t,lms("data")),e=>e),n+=`{script}\n${o(0,ls(ifield(e,"script")))}\n{end}\n`}),r.contraptions.v.map(e=>{const t=prototype_write(e),r=dget(t,lms("widgets")),i=ls(dget(t,lms("name")));s=0,n+=`\n{contraption:${o(1,i)}}\n`,A(t,"size",e=>1,e=>e),A(t,"resizable",e=>e&&lb(e),e=>e),A(t,"margin",e=>1,e=>e),A(t,"description",e=>e,e=>e),A(t,"version",e=>e,e=>e),A(t,"image",e=>e,e=>e),A(t,"script",e=>count(e)&&"undefined"!=ls(e),e=>a(i,e,"p")),A(t,"script",e=>count(e)&&"undefined"!=ls(e),e=>a(i,e,"p")),A(t,"template",e=>count(e),e=>e),A(t,"attributes",e=>count(e),e=>e),r.v.map(e=>{const t=lms("script"),r=dget(e,t);r&&dset(e,t,a(i,r,"p"))}),m("{widgets}\n",r,e=>e),d()}),void 0!==autoSwitchState&&autoSwitchState.intervals&&autoSwitchState.intervals.length>0&&(console.log("Saving autoswitch config:",autoSwitchState),n+="\n{autoswitch_config}\n",n+=`uniformInterval:${autoSwitchState.uniformInterval}\n`,n+=`intervals:${JSON.stringify(autoSwitchState.intervals)}\n`,n+=`startCard:${autoSwitchState.startCard||0}\n`,n+=`endCard:${autoSwitchState.endCard||(e.cards?e.cards.v.length-1:0)}\n`,n+=`isEnabled:${autoSwitchState.isEnabled?1:0}\n`,n+="{end}\n"),n+"\n"+(t?"<\/script>\nRuntime stub is NYI.":"")},n_go=([e,t,r],i)=>{let l=null,s=i.card;if(lin(e))l=clamp(0,ln(e),count(i.cards)-1);else if(card_is(e)){const t=dvix(i.cards,e);t>=0&&(l=t)}else if(e=ls(e),i.history.length>1&&"Back"==e){i.history.pop();const l=last(i.history);if(l>=0&&l<count(i.cards))return go_notify(i,l,t,e,r),i.card=l,lmn(i.card)}else if("First"==e)l=0;else if("Last"==e)l=count(i.cards)-1;else if("Prev"==e)l=mod(s-1,count(i.cards));else if("Next"==e)l=mod(s+1,count(i.cards));else if(isNaN(+e)){const t=dkix(i.cards,lms(e));t>=0&&(l=t)}else l=e;return null!=l?(go_notify(i,l,t,e,r),i.card=l,s!=l&&i.history.push(l)):go_notify(i,-1,t,e,r),lmn(i.card)},n_sleep=([e])=>(lis(e)&&"play"==ls(e)?sleep_play=1:sleep_frames=max(1,ln(e)),e),n_transition=(e,t)=>{const r=t.transit;return lion(e)&&dset(r,lms(e.n),e),r},"undefined"==typeof window||window.ext||(window.ext={});const ext="undefined"!=typeof window?window.ext:{},ext_constants={};constants=e=>{e.local("sys",interface_system),e.local("app",interface_app),e.local("bits",interface_bits),e.local("rtext",interface_rtext),e.local("pointer",pointer),e.local("pi",lmn(3.141592653589793)),e.local("e",lmn(2.718281828459045)),e.local("colors",lmd("white|yellow|orange|red|magenta|purple|blue|cyan|green|darkgreen|brown|tan|lightgray|mediumgray|darkgray|black".split("|").map(lms),range(16).map(e=>lmn(e+32)))),Object.keys(ext_constants).map(t=>e.local(t,ext_constants[t]))},primitives=(e,t)=>{e.local("show",lmnat(n_show)),e.local("print",lmnat(n_print)),"undefined"!=typeof n_log&&e.local("log",lmnat(n_log)),"undefined"!=typeof n_quickColor&&e.local("quickColor",lmnat(n_quickColor)),"undefined"!=typeof n_showLanguagePicker&&e.local("showLanguagePicker",lmnat(n_showLanguagePicker)),"undefined"!=typeof n_isHideNav&&e.local("isHideNav",lmnat(n_isHideNav)),"undefined"!=typeof n_t_card&&e.local("t_card",lmnat(n_t_card)),"undefined"!=typeof n_log2&&e.local("log2",lmnat(n_log2)),"undefined"!=typeof n_translate&&e.local("t",lmnat(([e,...r])=>n_translate([e,...r],t))),e.local("current_lang",lmnat(()=>lms("undefined"!=typeof i18n&&i18n&&i18n.currentLang?i18n.currentLang:"en"))),"undefined"!=typeof n_refresh&&e.local("refresh",lmnat(n_refresh)),"undefined"!=typeof n_get_last_card&&e.local("get_last_card",lmnat(n_get_last_card)),"undefined"!=typeof n_debugger&&e.local("debugger",lmnat(n_debugger)),e.local("panic",lmnat(n_panic)),e.local("play",lmnat(n_play)),e.local("go",lmnat(([e,r,i])=>n_go([e,r,i],t))),e.local("transition",lmnat(([e])=>n_transition(e,t))),e.local("brush",lmnat(e=>n_brush(e,t))),e.local("sleep",lmnat(n_sleep)),e.local("eval",lmnat(n_eval)),e.local("random",lmnat(n_random)),e.local("array",lmnat(n_array)),e.local("image",lmnat(n_image)),e.local("sound",lmnat(n_sound)),e.local("newdeck",lmnat(([e])=>deck_read(lis(e)?ls(e):""))),e.local("readcsv",lmnat(n_readcsv)),e.local("writecsv",lmnat(n_writecsv)),e.local("readxml",lmnat(n_readxml)),e.local("writexml",lmnat(n_writexml)),e.local("alert",lmnat(n_alert)),e.local("read",lmnat(n_open)),e.local("write",lmnat(n_save))};let in_attr=0;function js_to_lil(e){return null==e||null==e?NIL:deck_is(e)||card_is(e)||widget_is(e)?e:"number"==typeof e?lmn(e):"string"==typeof e?lms(clchars(e)):Array.isArray(e)?lml(e.slice(0).map(js_to_lil)):"object"==typeof e?Object.getPrototypeOf(e)==Uint8Array.prototype?array_make(e.length,"u8",0,e):lmd(Object.keys(e).map(js_to_lil),Object.values(e).map(js_to_lil)):"function"==typeof e?lmnat(t=>js_to_lil(e.apply(null,t.map(lil_to_js)))):NIL}function lil_to_js(e){return deck_is(e)||card_is(e)||widget_is(e)?e:lin(e)?ln(e):lis(e)?ls(e):lil(e)?ll(e).slice(0).map(lil_to_js):lid(e)?e.k.reduce((t,r,i)=>(t[ls(r)]=lil_to_js(e.v[i]),t),{}):array_is(e)?e.slice?null:e.data:lion(e)?(...t)=>{const r=lmblk();blk_lit(r,e),blk_lit(r,js_to_lil(t)),blk_op(r,op.CALL);const i=lmenv();for(pushstate(i),issue(i,r);running();)runop();const l=arg();return popstate(),lil_to_js(l)}:null}fire_attr_sync=(e,t,r)=>{if(in_attr>=2)return NIL;in_attr++;const i=frame,l=lmenv();primitives(l,e.deck),constants(l),l.local("me",e),l.local("card",e),l.local("deck",e.deck),l.local("patterns",e.deck.patterns);const s=lmblk();e.widgets.v.map((t,r)=>{blk_lit(s,t),blk_loc(s,e.widgets.k[r]),blk_op(s,op.DROP)});try{blk_cat(s,parse(e.def.script)),blk_op(s,op.DROP)}catch(e){}blk_get(s,lms(t)),blk_lit(s,lml(r?[r]:[])),blk_op(s,op.CALL),pushstate(l),issue(l,s);let n=ATTR_QUOTA;for(;running()&&n>0;)runop(),n--;const o=running()?NIL:arg();return popstate(),frame=i,in_attr--,o},parent_deck=e=>deck_is(e)?e:card_is(e)||prototype_is(e)?e.deck:parent_deck(e.card),event_invoke=(e,t,r,i,l)=>{const s=lmd([ZERO],[parse(DEFAULT_HANDLERS)]);let n=null;const o=(e,t)=>{try{dset(s,e,parse(ls(ifield(t,"script"))))}catch(t){dset(s,e,lmblk())}},a=e=>{deck_is(e)?n=e:(contraption_is(e)?n=e.card.deck:card_is(e)||prototype_is(e)?n=e.deck:a(e.card),o(e,contraption_is(e)?ifield(e,"def"):e))},d=e=>{deck_is(e)?n=e:widget_is(e)?d(e.card):d(e.deck),o(e,e)};prototype_is(e)||prototype_is(e.card)||contraption_is(e.card)?a(e):d(e);const c=(e,t,r)=>{blk_lit(e,r),blk_loc(e,t),blk_op(e,op.DROP)},A=(e,i,l)=>{blk_lit(e,lmon(i,[],blk_end(l))),blk_op(e,op.BIND),blk_op(e,op.DROP),t=i,r=lml([])};let m=null;for(let n=s.v.length-1;n>=0;n--){let o=s.k[n],a=lmblk(),d="!widget_scope";lin(o)&&(d="!default_handlers"),deck_is(o)&&(o.modules.v.map((e,t)=>c(a,o.modules.k[t],ifield(e,"value"))),o.cards.v.map((e,t)=>c(a,o.cards.k[t],e)),d="!deck_scope"),(card_is(o)||prototype_is(o)||contraption_is(o)&&e!=o)&&(c(a,lms("card"),o),o.widgets.v.map((e,t)=>c(a,o.widgets.k[t],e)),d="!card_scope"),blk_cat(a,s.v[n]),blk_op(a,op.DROP),!m&&i?A(a,"!hunk",i):m&&A(a,d,m),blk_get(a,lms(t)),blk_lit(a,r),blk_op(a,op.CALL),i||l||blk_op(a,op.DROP),m=a}const _=lmblk();return c(_,lms("me"),proxy_is(e)?ivalue(e,"card"):e),c(_,lms("deck"),n),c(_,lms("patterns"),n.patterns),blk_cat(_,m),_},fire_async=(e,t,r,i,l)=>{const s=lmenv();primitives(s,parent_deck(e)),constants(s),l&&(pushstate(s),pending_popstate=1),issue(s,event_invoke(e,t,r,i,0))},fire_event_async=(e,t,r)=>fire_async(e,t,lml([r]),null,1),fire_hunk_async=(e,t)=>fire_async(e,null,lml([]),t,1),n_event=(e,t)=>{const r=lmenv();primitives(r,parent_deck(e)),constants(r);const i=lmblk();return blk_op(i,op.DROP),blk_cat(i,event_invoke(e,ls(t[0]),lml(t.slice(1)),null,1)),issue(r,i),NIL},readgif=(e,t)=>{const r="gray"==t||"gray_frames"==t,i="frames"==t||"gray_frames"==t;let l=0;const s=t=>e[l++]||0,n=e=>s()|s()<<8,o=(e,t)=>lmd(["frames","delays"].map(lms),[lml(e),lml(t)]);function a(e,t){const i=1<<1+(7&t);for(let t=0;t<i;t++)e[t]=readcolor(s(),s(),s(),r);return e}if(71!=s()||73!=s()||70!=s())return i?o([],[]):image_make(rect());l+=3;const d=[],c=[],A=[],m=(lmd(),n()),_=n(),u=new Uint8Array(256),p=s(),g=s();s();let f=0,w=255,y=0,h=0,x=image_make(rect(m,_));for(128&p&&a(u,p);l<e.length;){const e=s();if(59==e)break;if(33==e)if(249==(255&s())){s();const e=s();y=n();const t=s();s(),h=e>>2&7,1&e?(f=1,w=t):f=0}else for(;;){const e=s();if(!e)break;l+=e}if(44==e){const e=n(),t=n(),l=n(),o=n(),p=s(),b=128&p,v=new Uint8Array(u);b&&a(v,p),f&&(v[w]=r?255:0);const k=s(),I=new Uint8Array(l*o*2),C=new Uint8Array(l*o);let z=0,M=0;for(;;){const e=s();if(!e)break;for(let t=0;t<e;t++)I[z++]=s()}const B=new Int32Array(4096),S=new Int32Array(4096),D=new Int32Array(4096),E=1<<k;let O=k+1,N=(1<<O)-1,Q=E+2,U=-1,L=0,F=0,T=0,P=0;for(let e=0;e<E;e++)S[e]=e;for(;F<z;){for(;T<O;)P+=(255&I[F++])<<T,T+=8;let e=P&N;if(P>>=O,T-=O,e>Q||e==E+1)break;if(e==E)O=k+1,N=(1<<O)-1,Q=E+2,U=-1;else if(-1==U)C[M++]=S[U=L=e];else{let t=0,r=e;for(e==Q&&(D[t++]=L,e=U);e>E;)D[t++]=S[e],e=B[e];for(C[M++]=L=S[e];t>0;)C[M++]=D[--t];Q<4096&&(B[Q]=U,S[Q++]=L,0==(Q&N)&&Q<4096&&(O++,N+=Q)),U=r}}for(let r=0;r<o;r++)for(let i=0;i<l;i++)e+i>=0&&t+r>=0&&e+i<m&&t+r<_&&(!f||C[i+r*l]!=w)&&(x.pix[e+i+(t+r)*m]=v[C[i+r*l]]);if(d.push(image_copy(x)),c.push(lmn(y)),A.push(h),!i)break;if(2==h&&x.pix.fill(f?0:v[g]),3==h){let e=d.length-2;for(;e&&A[e]>=2;)e--;for(let t=0;t<x.pix.length;t++)x.pix[t]=d[e].pix[t]}}}return i?o(d,c):d.length?d[0]:image_make(rect())},n_autoswitch_start=(e,t)=>{const r=e.length>0?ln(e[0]):0,i=e.length>1?ln(e[1]):Math.max(0,getCardCount()-1),l=e.length>2?ln(e[2]):3e3;return autoSwitchState.startCard=r,autoSwitchState.endCard=i,autoSwitchState.uniformInterval=l,autoSwitchState.useUniformInterval=!0,startAutoSwitch(),ONE},n_autoswitch_stop=(e,t)=>(stopAutoSwitch(),ONE),n_autoswitch_config=(e,t)=>{if(0===e.length)return lmd(["enabled","startCard","endCard","uniformInterval","useUniformInterval"].map(lms),[lmn(autoSwitchState.enabled?1:0),lmn(autoSwitchState.startCard),lmn(autoSwitchState.endCard),lmn(autoSwitchState.uniformInterval),lmn(autoSwitchState.useUniformInterval?1:0)]);const r=e[0];if(lid(r)){const e=dget(r,lms("enabled")),t=dget(r,lms("startCard")),i=dget(r,lms("endCard")),l=dget(r,lms("uniformInterval")),s=dget(r,lms("useUniformInterval"));t&&(autoSwitchState.startCard=ln(t)),i&&(autoSwitchState.endCard=ln(i)),l&&(autoSwitchState.uniformInterval=ln(l)),s&&(autoSwitchState.useUniformInterval=ln(s)>0),e&&ln(e)>0&&!autoSwitchState.enabled?startAutoSwitch():e&&0===ln(e)&&autoSwitchState.enabled&&stopAutoSwitch()}return ONE},n_pastecard=(e,t)=>(pasteCard(),ONE),interface_danger=lmi((self,i,x)=>ikey(i,"js")?lmnat(args=>{try{let r=null==args[0]?null:eval(ls(args[0]));return"function"==typeof r&&args.length>1&&(r=r.apply(null,args.slice(1).map(lil_to_js))),js_to_lil(r)}catch(e){return console.log("danger.js[] error",e),NIL}}):x||NIL,"danger"),ext_add_constant=(e,t)=>{ext_constants[e]=js_to_lil(t)},endanger=e=>{ext_constants.danger=interface_danger},DANGEROUS&&endanger();let zoom=1,deck=null,fb=null,context=null,dirty=0,FONT_BODY=null,FONT_MENU=null,FONT_MONO=null;const _t=(e,t)=>{if("undefined"!=typeof i18n&&i18n&&"function"==typeof i18n.t)try{i18n.currentLang||"function"!=typeof i18n.init||i18n.init();return i18n.t(e,t)||e}catch(t){return console.warn("i18n.t error:",t,e),e}return e},_tlms=(e,t)=>lms(_t(e,t));window.isSaved=!0;let canvasRecorder=null,recordedChunks=[],isRecording=!1,recordingFrameRate=30,recordingStartTime=0,recordingCanvas=null,recordingContext=null,recordingStream=null;const DOUBLE_CLICK_DELAY=20,FIELD_CURSOR_DUTY=20,FIELD_CHANGE_DELAY=15,LISTEN_LINES=30,LISTEN_SIZE=e=>rect(context.size.x-22,100),MASTER_VOLUME=.3,BG_MASK=100;q=e=>document.querySelector(e),gcd=(e,t)=>{for(;e!=t;)e>t?e-=t:t-=e;return e},lcm=(e,t)=>{const r=gcd(e,t);return 0|e*t/(r||1)},copy_object=e=>Object.keys(e).reduce((t,r)=>(t[r]=e[r],t),{}),plain_or_rich=e=>lit(e)?rtext_cast(e):lms(e?ls(e):""),fieldstr=e=>({table:rtext_cast(e),scroll:0}),gridtab=(e,t)=>({table:e,scroll:0,row:null==t?-1:t,col:-1}),open_url=e=>{"undefined"!=typeof AndroidFileInterface&&AndroidFileInterface.openUrl?AndroidFileInterface.openUrl(e):"undefined"!=typeof cordova&&cordova.InAppBrowser?cordova.InAppBrowser.open(e,"_system"):"undefined"!=typeof webkit&&webkit.messageHandlers&&webkit.messageHandlers.openUrl?webkit.messageHandlers.openUrl.postMessage(e):window.open(e,"_blank")},open_file=(e,t)=>{const r=q("#source");r.value="",r.accept=e,r.onchange=e=>{r.files.length&&t(r.files[0])},r.click()},open_text=(e,t)=>open_file(e,e=>{const r=new FileReader;r.onload=e=>{t(clchars(r.result))},r.readAsText(e)}),load_array=(e,t)=>{const r=new FileReader;r.onload=e=>{const i=new Uint8Array(r.result);t(array_make(i.length,"u8",0,i))},r.readAsArrayBuffer(e)},load_image=(e,t,r)=>{const i=e=>{const t=q("#loader"),r=t.width,i=t.height,l=image_make(rect(r,i));if(0==r||0==i)return l;const s=document.createElement("canvas");s.width=r,s.height=i;const n=s.getContext("2d");n.drawImage(t,0,0);const o=n.getImageData(0,0,r,i).data;let a=0,d=0;for(;d<l.pix.length;){const t=o[a++],r=o[a++],i=o[a++],s=o[a++];l.pix[d++]=255!=s?e?255:0:readcolor(t,r,i,e)}return l},l=e=>{if(r)return void r(i("gray"==t));let l=i(0),s=null;if(0==l.size.x||0==l.size.y)return;let n=0,o=new Uint8Array(256);l.pix.forEach(e=>o[e]++);let a=o[0],d=o[32];o[32]=0,o[47]=0;for(let e=2;e<256;e++)if(o[e]){n=1;break}n&&a&&(l.pix.forEach((e,t)=>l.pix[t]=0!=e),s=l),n?l=i(!dr.color):d&&!a&&l.pix.forEach((e,t)=>l.pix[t]=32!=e),setmode("draw"),bg_paste(l,1),dr.limbo_dither=n&&!dr.color,dr.dither_threshold=.5,dr.fatbits=0,dr.omask=s};if("image/gif"==e.type&&r){const i=new FileReader;i.onload=e=>{r(readgif(new Uint8Array(i.result),t))},i.readAsArrayBuffer(e)}else{const t=new FileReader;t.onload=e=>{q("#loader").src=t.result,setTimeout(l,100)},t.readAsDataURL(e)}},save_text=(e,t)=>{if("undefined"!=typeof AndroidFileInterface&&AndroidFileInterface.openSaveFileDialog)AndroidFileInterface.openSaveFileDialog(e,t);else if("undefined"!=typeof cordova&&cordova.file)window.resolveLocalFileSystemURL(cordova.file.documentsDirectory,function(r){r.getFile(e,{create:!0,exclusive:!1},function(e){e.createWriter(function(e){e.write(new Blob([t],{type:"text/plain"}))})})});else if("undefined"!=typeof webkit&&webkit.messageHandlers&&webkit.messageHandlers.saveFile)webkit.messageHandlers.saveFile.postMessage({filename:e,content:t,type:"text"});else{const r=URL.createObjectURL(new Blob([t])),i=q("#target");i.download=e,i.href=r,i.click(),setTimeout(e=>URL.revokeObjectURL(r),200)}},save_bin=(e,t)=>{if("undefined"!=typeof AndroidFileInterface&&AndroidFileInterface.openSaveFileDialog){const r=btoa(String.fromCharCode.apply(null,Uint8Array.from(t)));AndroidFileInterface.openSaveFileDialog(e,r)}else if("undefined"!=typeof cordova&&cordova.file)window.resolveLocalFileSystemURL(cordova.file.documentsDirectory,function(r){r.getFile(e,{create:!0,exclusive:!1},function(e){e.createWriter(function(e){e.write(new Blob([Uint8Array.from(t)]))})})});else if("undefined"!=typeof webkit&&webkit.messageHandlers&&webkit.messageHandlers.fileSaver){const r=Uint8Array.from(t);let i="";for(let e=0;e<r.length;e++)i+=String.fromCharCode(r[e]);const l=btoa(i);window.webkit.messageHandlers.fileSaver.postMessage({filename:e,base64Data:l})}else{const r=URL.createObjectURL(new Blob([Uint8Array.from(t)])),i=q("#target");i.download=e,i.href=r,i.click(),setTimeout(e=>URL.revokeObjectURL(r),200)}},save_deck=async(e,t)=>{let r=deck_write(t);save_text(e,r),isSaved=!0},makelzww=(e,t)=>{let r=1+e,i=1+(1<<e),l=1<<e+1,s=-1,n=0,o=0,a={};return wb=e=>{for(n|=e<<o,o+=r;o>=8;)t(255&n),n>>=8,o-=8},ih=()=>{if(i++,i==l&&(r++,l<<=1),4095==i){let t=1<<e;return wb(t),r=e+1,i=t+1,l=t<<1,a={},1}},{w(t){let r=s;if(-1==r)return wb(1<<e),void(s=t);let l=r<<8|t;void 0!==a[l]?s=a[l]:(wb(r),s=t,ih()||(a[l]=i))},f(){wb(s),ih(),wb(1+(1<<e)),o>0&&t(255&n)}}},writegif=(e,t,r=!0)=>{const i=e.reduce((e,t)=>rmax(e,t.size),rect(1,1)),l=deck.patterns.pal.pix;let s=0,n=[];const o=(e,t,i)=>e==ANTS?((e,t)=>(0|(e+t+s)/3)%2?15:0)(t,i):0==e?r?16:0:e>47?0:e>31?e-32:((e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(l,e,t,r))(e,t,i)?15:0,a=e=>n.push(255&e),d=e=>{a(e),a(e>>8)},c=e=>e.split("").forEach(e=>a(e.charCodeAt(0)));c("GIF89a"),d(i.x),d(i.y),a(244),a(0),a(0);for(let e=0;e<16;e++)a(COLORS[e]>>16),a(COLORS[e]>>8),a(COLORS[e]);for(let e=0;e<16;e++)a(255),a(255),a(255);d(65313),a(11),c("NETSCAPE2.0"),a(3),a(1),d(0),a(0);for(let i=0;i<e.length;i++){const l=e[i];d(63777),a(4),r?(a(9),d(t[i]),a(16)):(a(2),d(t[i]),a(0)),a(0),a(44),d(0),d(0),d(l.size.x),d(l.size.y),a(0),a(5);let c=n.length,A=makelzww(5,e=>{c==n.length&&n.push(0),n[c]++,n.push(e),255==n[c]&&(c=n.length)});for(let e=0;e<l.size.y;e++)for(let t=0;t<l.size.x;t++)A.w(o(l.pix[e*l.size.x+t],t,e));A.f(),a(0),s++}return a(59),n},writewav=e=>{const t=[],r=e=>t.push(255&e),i=e=>(r(e),r(e>>8)),l=e=>(r(e),r(e>>8),r(e>>16),r(e>>24)),s=e=>e.split("").forEach(e=>r(e.charCodeAt(0)));s("RIFF"),l(28+(8+e.data.length)+e.data.length%2),s("WAVE"),s("fmt "),l(16),i(1),i(1),l(8e3),l(8e3),i(1),i(8),s("data"),l(e.data.length);for(let t=0;t<e.data.length;t++)r(128+e.data[t]);return e.data.length%2&&r(0),t},writearray=e=>{const t=[];for(let r=0;r<e.size;r++){const i=e.base+r;t.push(i>=0&&i<e.data.length?e.data[i]:0)}return t},keep_ratio=(e,t)=>{if(!ev.shift||0==t.x||0==t.y)return e;const r=max(e.w/(1*t.x),e.h/(1*t.y));return rect(e.x,e.y,r*t.x,r*t.y)},draw_frame=(e,t)=>({brush:0,pattern:0,font:FONT_BODY,size:e.size,clip:t||rect(0,0,e.size.x,e.size.y),image:e}),draw_pix=(e,t,r)=>{const i=rect(e,t);inclip(i)&&pix(i,r)},draw_invert=(e,t)=>{const r=(t,r,i)=>t<2?t?1:0:t>31?32==t?0:1:1&pal_pat(e,t,r,i);for(let e=(t=rclip(t,frame.clip)).y;e<t.y+t.h;e++)for(let i=t.x;i<t.x+t.w;i++){const t=rect(i,e),l=r(gpix(t),i,e);pix(t,0==l||32==l?1:32)}},draw_shadow=(e,t,r,i)=>{i&&draw_rect(rclip(e,frame.clip),r),draw_box(e,0,t),draw_hline(e.x+3,e.x+e.w,e.y+e.h,t),draw_vline(e.x+e.w,e.y+2,e.y+e.h+1,t)},draw_boxr=(e,t,r,i)=>{e=rint(e),draw_hline(e.x+2,e.x+e.w-2,e.y,t),draw_hline(e.x+2,e.x+e.w-2,e.y+e.h-1,t),draw_vline(e.x,e.y+2,e.y+e.h-2,t),draw_vline(e.x+e.w-1,e.y+2,e.y+e.h-2,t),draw_pix(e.x+1,e.y+1,t),draw_pix(e.x+e.w-2,e.y+1,t),draw_pix(e.x+1,e.y+e.h-2,t),draw_pix(e.x+e.w-2,e.y+e.h-2,t),i&&(draw_hline(e.x+2,e.x+e.w-2,e.y+1,r),draw_hline(e.x+2,e.x+e.w-2,e.y+e.h-2,r),draw_rect(rect(e.x+1,e.y+2,e.w-2,e.h-4),r))},draw_boxinv=(e,t)=>{draw_invert(e,rect(t.x,t.y,1,t.h)),draw_invert(e,rect(t.x+t.w-1,t.y,1,t.h)),draw_invert(e,rect(t.x+1,t.y,t.w-2,1)),draw_invert(e,rect(t.x+1,t.y+t.h-1,t.w-2,1))},draw_modalbox=e=>{const t="undefined"!=typeof window&&window.HIDE_NAV?0:16,r=rcenter(rect(0,t,frame.size.x,frame.size.y-t),e),i=.5*-e.x-r.x,l=frame.size.x-.5*e.x-r.x,s=t-.5*e.y-r.y,n=frame.size.y-.5*e.y-r.y,o=r.y+ms.drag_offset.y-5,a=rect(r.x+ms.drag_offset.x,o,e.x,20);ev.md&&over(a)&&!ms.dragging&&(ms.dragging=1,ms.drag_start.x=ev.pos.x-ms.drag_offset.x,ms.drag_start.y=ev.pos.y-ms.drag_offset.y),ev.drag&&ms.dragging&&(ms.drag_offset.x=clamp(i,ev.pos.x-ms.drag_start.x,l),ms.drag_offset.y=clamp(s,ev.pos.y-ms.drag_start.y,n),uicursor=cursor.drag),ev.mu&&(ms.dragging=0),over(a)&&!ms.dragging&&(uicursor="grab");const d=rect(r.x+ms.drag_offset.x,r.y+ms.drag_offset.y,e.x,e.y),c=rect(0,t,frame.size.x,frame.size.y-t),A=frame.clip;frame.clip=rclip(c,A);const m=inset(d,-5);return draw_rect(inset(m,-5),32),draw_box(inset(m,-5),0,1),draw_box(inset(m,-2),0,1),draw_box(inset(m,-1),0,1),frame.clip=A,rclip(d,c)},draw_modal_rtext=e=>{const t=rect(200,100),r=lit(ms.message)?layout_richtext(deck,ms.message,FONT_BODY,ALIGN.center,t.x):layout_plaintext(ls(ms.message),FONT_BODY,ALIGN.center,t),i=draw_modalbox(radd(r.size,e)),l=rect(i.x,i.y,i.w,r.size.y);return lit(ms.message)?draw_text_rich(l,r,1,1):draw_text_wrap(l,r,1),i},draw_text_outlined=(e,t,r)=>{[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].map(([i,l])=>draw_text(rect(e.x+i,e.y+l),t,r,32)),draw_text(e,t,r,1)},draw_textr=(e,t,r,i)=>{const l=font_textsize(r,t);l.x<e.w?draw_text(rect(e.x+e.w-l.x,e.y+ceil((e.h-l.y)/2),l.x,e.h),t,r,i):draw_text_fit(e,t,r,i)},draw_textc=(e,t,r,i)=>{const l=font_textsize(r,t);-1==i?draw_text_outlined(rcenter(e,l),t,r):l.x<e.w?draw_text(rcenter(e,l),t,r,i):draw_text_fit(e,t,r,i)},draw_text_fit=(e,t,r,i)=>{const l=[],s=(e,t)=>l.push({pos:e,c:t});let n=0,o=0,a=font_h(r);font_gw(r,ELLIPSIS);const d="function"==typeof segmentText?segmentText(t):t.split("");for(let t=0;t<d.length&&o+a<=e.h;t++){const i=d[t],l=getCharWidth(r,i),c=font_sw(r),A=isCanvasChar(i)&&!isThai(i)&&1===i.length?c+0:c;"\n"==i?(n=0,o+=a):n+l>=e.w&&n>0?(n=0,o+=a,t--):(s(rect(n,o),i),n+=l+A)}let c=ceil((e.h-(o+a))/2);l.map(t=>{t.pos.x+=e.x,t.pos.y+=c+e.y,draw_char(t.pos,r,t.c,i)})},draw_scaled=(e,t,r)=>{if(0==e.w||0==e.h)return;const i=t.size;e.w!=i.x||e.h!=i.y?image_paste_scaled(e,frame.clip,t,frame.image,r):image_paste(e,frame.clip,t,frame.image,r)},draw_invert_scaled=(e,t,r)=>{if(0==t.w||0==t.h)return;const i=r.size,l=frame.image.pix,s=frame.image.size.x,n=lerp_scale(t,i),o=(t,r,i)=>t<2?t?1:0:t>31?32==t?0:1:1&e[r%8+i%8*8+64*t],a=e=>l[e.x+e.y*s],d=(e,t)=>l[e.x+e.y*s]=t;for(let e=0;e<t.h;e++)for(let l=0;l<t.w;l++){const s=0|l/n.x,c=0|e/n.y,A=t.x+l,m=t.y+e,_=o(r.pix[s+c*i.x],A,m),u=rect(A,m);inclip(u)&&d(u,_^o(a(u),A,m))}},draw_fat=(e,t,r,i,l,s,n)=>{const o=deck.patterns.anim,a=(e,t,r)=>e<28||e>31?e:o[e-28][(0|i/4)%max(1,o[e-28].length)],d=(e,t,i)=>e<2?e?1:0:e>31?32==e?0:1:1&r[t%8+i%8*8+64*e],c=t.size;for(let r=0;r<ceil(e.h/s);r++)for(let i=0;i<ceil(e.w/s);i++){if(n.x+i>=c.x||n.y+r>=c.y||n.x+i<0||n.y+r<0)continue;const o=t.pix[n.x+i+(n.y+r)*c.x];if(o==l)continue;const A=a(o,n.x,n.y),m=d(A,n.x+i,n.y+r);draw_rect(radd(rect(i*s,r*s,s,s),rect(e.x,e.y)),A>=32?A:0==A?0:m?1:32)}},draw_fat_scaled=(e,t,r,i,l,s,n)=>{const o=deck.patterns.anim,a=(e,t,r)=>e<28||e>31?e:o[e-28][(0|l/4)%max(1,o[e-28].length)],d=(e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&i[t%8+r%8*8+64*e];if(0==e.w||0==e.h)return;const c=t.size,A=lerp_scale(e,c);for(let i=0;i<e.h;i++)for(let l=0;l<e.w;l++){const o=0|l/A.x,m=0|i/A.y,_=e.x+l,u=e.y+i,p=t.pix[o+m*c.x],g=a(p),f=d(g,_,u);(r||0!=p)&&draw_rect(radd(rect(_*s,u*s,s,s),n),g>=32?g:f?1:0)}},draw_dithered=(e,t,r,i,l)=>{if(0==e.w||0==e.h)return;const s=t.size,n=2*e.w,o=[0,1,e.w-2,e.w-1,e.w,n-1],a=new Float32Array(n);for(let d=0,c=0;c<e.h;c++)for(let A=0;A<e.w;A++){const m=0|1*A/e.w*s.x,_=0|1*c/e.h*s.y,u=255&t.pix[m+_*s.x],p=i?i.pix[m+_*s.x]:1,g=u/256+a[d],f=g>l?1:0,w=(g-f)/8;a[d]=0,d=(d+1)%n;for(let e=0;e<6;e++)a[(d+o[e])%n]+=w;const y=!f;if(p&&(r||0!=y)){const t=rect(e.x+A,e.y+c);inclip(t)&&pix(t,y)}}},draw_widget=e=>{if(canvas_is(e))return container_image(e,1);const t=ms.in_modal,r=ms.type;ms.in_modal=1,ms.type="about";const i=getpair(ifield(e,"size")),l=image_make(i),s=frame,n=copy_object(ev);if(frame=draw_frame(l),ev=event_state(),menus_clear(),button_is(e)){const t=unpack_button(e);t.size.x=0,t.size.y=0,widget_button(e,t,lb(ifield(e,"value")))}else if(slider_is(e)){const t=unpack_slider(e);t.size.x=0,t.size.y=0,widget_slider(e,t)}else if(grid_is(e)){const t=unpack_grid(e);t.size.x=0,t.size.y=0,widget_grid(e,t,unpack_grid_value(e))}else if(field_is(e)){const t=unpack_field(e);t.size.x=0,t.size.y=0,widget_field(e,t,unpack_field_value(e))}else if(contraption_is(e)){const t=e.pos;e.pos=rect(0,0),widget_contraption(e),e.pos=t}return ev=n,frame=s,ms.in_modal=t,ms.type=r,l},draw_con=(e,t)=>{const r=ms.in_modal,i=ms.type;ms.in_modal=t,t&&(ms.type="about",menus_clear());const l=getpair(ifield(e,"size")),s=image_make(l),n=frame,o=copy_object(ev);frame=draw_frame(s),ev=event_state();const a=ifield(e,"image"),d=a.size,c=e.widgets;return 0!=d.x&&0!=d.y&&image_paste(rpair(rect(),d),frame.clip,a,frame.image,1),("draw"!=uimode||dr.show_widgets)&&c.v.map(e=>{button_is(e)&&widget_button(e,unpack_button(e),lb(ifield(e,"value"))),slider_is(e)&&widget_slider(e,unpack_slider(e)),canvas_is(e)&&widget_canvas(e,unpack_canvas(e),container_image(e,0)),grid_is(e)&&widget_grid(e,unpack_grid(e),unpack_grid_value(e)),field_is(e)&&widget_field(e,unpack_field(e),unpack_field_value(e)),contraption_is(e)&&widget_contraption(e)}),ev=o,frame=n,ms.in_modal=r,ms.type=i,s},draw_thumbnail=(e,t)=>{const r=ifield(e,"image");t=inset(t,1),draw_rect(t,0),(r.size.x>0||r.size.y>0)&&draw_scaled(t,r,1);const i=ifield(e,"widgets"),l=getpair(ifield(e,"size")),s=t.w*(1/l.x),n=t.h*(1/l.y);i.v.map(e=>{const r=unpack_widget(e);draw_box(rclip(rect(t.x+r.size.x*s,t.y+r.size.y*n,r.size.w*s,r.size.h*n),t),0,"invert"==r.show?0:1)})},draw_lil=(e,t,r,i)=>{const l=e.x-50;let s=t==ALIGN.right?50:t==ALIGN.left?0:25;const n=image_make(e),o=frame;if(frame=draw_frame(n),lit(i)){const r=tab_cols(i),n=r.length,o=tab_rowcount(i),a=n?3+font_h(FONT_BODY):3,d=font_h(FONT_MONO),c=font_h(FONT_BODY),A=0|min((e.y-(a+c))/d,o),m=dyad.take(ZERO,i),_=range(256).map(e=>0);for(let e=0;e<n&&e<256;e++){const t=A<o?A-1:A;_[e]=0;for(let l=0;l<t;l++){const t=show(tab_cell(i,r[e],l));tab_get(m,r[e]).push(lms(t)),_[e]=max(_[e],font_textsize(FONT_MONO,t).x+10)}A<o&&tab_get(m,r[e]).push(lms(ELLIPSIS)),_[e]=min(100,max(_[e],font_textsize(FONT_BODY,r[e]).x+10))}let u=0,p=0,g=0;for(let e=0;e<n&&e<256;e++){if(p+_[e]>=l){g=1;break}u++,e+1<=n&&e+1<=256&&(p+=_[e])}s=t==ALIGN.right?e.x-p:t==ALIGN.left?0:0|(e.x-p)/2;let f=s;for(let e=0;e<u;e++){e&&draw_vline(f,0,a+d*A+(0==A),1),draw_text_fit(rect(f+2,0,_[e]-4,a),r[e],FONT_BODY,1);for(let t=0;t<A;t++)draw_text_fit(rect(f+2,a+d*t,_[e]-4,d),ls(tab_cell(m,r[e],t)),FONT_MONO,1);e+1<=u&&(f+=_[e])}draw_hline(s,f,a-1,1);const w=a+d*A+1+(0==A);f==s&&(f+=min(25,l));const y=`(${n} column${1==n?"":"s"}, ${o} row${1==o?"":"s"}.)`,h=font_textsize(FONT_BODY,y);draw_text_fit(rect(s+p-h.x,w,l,c),y,FONT_BODY,1),draw_box(rect(s,0,f-s,w),0,1),g&&draw_vline(f-1,0,w,13)}else if(image_is(i)){const t=i.size,r=`(${t.x} x ${t.y})`,n=font_textsize(FONT_BODY,r),o=max(1,min(t.y,e.y-font_h(FONT_BODY))),a=max(1,min(t.x,l)),d=0==t.x&&0==t.y?1:min(a/(1*t.x),o/(1*t.y)),c=0|d*t.x,A=0|d*t.y,m=rect(s-2+(l-max(c,n.x)),0,c+2,A+2);draw_scaled(inset(m,1),i,1),draw_box(m,0,1),draw_text(rect(m.x,m.y+m.h,n.x,n.y),r,FONT_BODY,1)}else{const n=layout_plaintext(r?ls(i):show(i,0),FONT_MONO,t,rect(l,e.y));draw_text_wrap(rect(s,0,l,e.y),n,1)}for(let t=e.y-1;t>0;t--){let r=0;for(let i=0;i<e.x;i++)if(n.pix[i+t*e.x]){r=1;break}if(r)break;n.size.y--}return frame=o,n},unpack_widget=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),show:ls(ifield(e,"show")),locked:lb(ifield(e,"locked"))}),unpack_button=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),text:ls(ifield(e,"text")),font:ifield(e,"font"),style:ls(ifield(e,"style")),show:ls(ifield(e,"show")),locked:lb(ifield(e,"locked")),shortcut:ls(ifield(e,"shortcut"))}),unpack_slider=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),font:ifield(e,"font"),format:ls(ifield(e,"format")),show:ls(ifield(e,"show")),style:ls(ifield(e,"style")),locked:lb(ifield(e,"locked")),step:ln(ifield(e,"step")),value:ln(ifield(e,"value")),min:getpair(ifield(e,"interval")).x,max:getpair(ifield(e,"interval")).y}),unpack_canvas=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),scale:ln(ifield(e,"scale")),border:lb(ifield(e,"border")),draggable:lb(ifield(e,"draggable")),show:ls(ifield(e,"show")),locked:lb(ifield(e,"locked"))}),unpack_field=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),font:ifield(e,"font"),show:ls(ifield(e,"show")),scrollbar:lb(ifield(e,"scrollbar")),colorpicker:lb(ifield(e,"colorpicker")),border:lb(ifield(e,"border")),style:ls(ifield(e,"style")),locked:lb(ifield(e,"locked")),align:ALIGN[ls(ifield(e,"align"))]}),unpack_field_value=e=>({table:ifield(e,"value"),scroll:ln(ifield(e,"scroll"))}),unpack_grid=e=>({size:rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),widths:ll(ifield(e,"widths")).map(ln),font:ifield(e,"font"),format:ls(ifield(e,"format")),headers:lb(ifield(e,"headers")),scrollbar:lb(ifield(e,"scrollbar")),lines:lb(ifield(e,"lines")),bycell:lb(ifield(e,"bycell")),show:ls(ifield(e,"show")),locked:lb(ifield(e,"locked"))}),unpack_grid_value=e=>({table:ifield(e,"value"),scroll:ln(ifield(e,"scroll")),row:ln(ifield(e,"row")),col:ln(ifield(e,"col"))});let cursor={default:"default",point:"pointer",ibeam:"text",drag:"grabbing"};image_tiles=(e,t,r)=>range(e).map(e=>image_copy(r,rect(0,e*t,t,t))),TOOLS=image_tiles(12,16,image_read("%%IMG0ABAAwAMABIAEgASABIAEgGTwlKxMqiQKJAIQAggCCAQEBAQEAAAAAAAAAAA//EACgAGAAYABgAFAAz/+H/wAAAAAAAAAAAAA8+eAAYABAAAAAIABgAGAAQAAAACAAYAB588AAADwAIgBCAGQAnACIAQgBEAIQAiAEIARAB4AHAAYABAAAAAAAAP4HAYgAUABgAGAAoAcuOBnAFQAOAAIAAgAEAAAAAAAAADAADAADAADAADAADAADAADAAAAAAAAAAAAAAcACIAJgArADLAInBCOIUdAh4APgBdAJyBHEIcJBgYEAAAAADgcVjar69VVqqvVVaqrVVZqrDVYGrAHwAAAAAAAAAAA//+AAYABgAGAAYABgAGAAYABgAH//wAAAAAAAAAAAAD//6qr1VWqq9VVqqvVVaqr1VWqq///AAAAAAAAAAAAAAAAB+AYGCAEQAKAAYABgAFAAiAEGBgH4AAAAAAAAAAAAAAH4B1YKqxVVqqr1VWqq1VWKqwdWAfgAAAAAA==")),ARROWS=image_tiles(8,12,image_read("%%IMG0AAwAYAAABgAJARCCIERAL/DxEIEQgRCBH4AAAAABH4EQgRCBEI/w9EAiIEEQgAkABgAAAAAABgAPAR+DP8d/7//xH4EfgR+BH4AAAAABH4EfgR+BH4//93/jP8EfgA8ABgAAAAIABgAKARPiICRAJEAiICET4AoABgACAAQABgAFB3yEQERAJEAkQEd8gAUABgAEAAIABgAOAR/jP+d/53/jP+Ef4A4ABgACAAQABgAHB3+Hf8d/53/nf8d/gAcABgAEAA==")),CHECK=image_read("%%IMG0AAkABwCAAcGDY8Y2bBw4CBAA"),CHECKS=["%%IMG0AA8ADQAAf/BAEEAQQBBAEEAQQBBAEEAQQBB/8AAA","%%IMG0AA8ADQAAf/BgMFBQSJBFEEIQRRBIkFBQYDB/8AAA","%%IMG0AA8ADQAAVVAAAEAQAABAEAAAQBAAAEAQAABVUAAA","%%IMG0AA8ADQAAVVAgIFBQCIBFEAIARRAIgFBQICBVUAAA"].map(image_read),LOCK=image_read("%%IMG0AAgACDhERP7+/v4A"),ANIM=image_read("%%IMG0AAgACBAoKER8goIA"),ZOOM=image_read("%%IMG0AAwADB4AIQBMgIxAv0C/QIxATIAhwB7gAHAAMA=="),CORNERS=["%%IMG0AAUABf/mxISA","%%IMG0AAUABfk4GAgI","%%IMG0AAUABYSGx+f4","%%IMG0AAUABQgIGT/4"].map(image_read),GESTURES={left:image_read("%%IMG2ABAAEAAaIAQACiADAQIgAQAIIAMBBCABAAYgAwEGIAEABCADAQggBgEMIAIBDiAEAQwgAQACIAMBCCADAAQgAwEGIAEACCADAQQgAQAKIAMBAiABAAwgBAAi"),right:image_read("%%IMG2ABAAEAASIAQADCABAQIgAwAKIAEBBCADAAggAQEGIAMABCADAQggAwACIAEBDCAEAQ4gAgEMIAYBCCADAAQgAQEGIAMABiABAQQgAwAIIAEBAiADAAogBAAq"),up:image_read("%%IMG2ABAAEAAHIAMADSABAQEgAQAMIAIBASACAAsgAQEDIAEACiACAQMgAgAJIAEBBSABAAggAgEFIAIAByABAQcgAQAGIAIBByACAAUgAQEJIAEABCACAQkgAgADIAEBCyABAAMgAQELIAEAAyAFAQMgBQAHIAEBAyABAAsgBQAF"),down:image_read("%%IMG2ABAAEAAFIAUACyABAQMgAQAHIAUBAyAFAAMgAQELIAEAAyABAQsgAQADIAIBCSACAAQgAQEJIAEABSACAQcgAgAGIAEBByABAAcgAgEFIAIACCABAQUgAQAJIAIBAyACAAogAQEDIAEACyACAQEgAgAMIAEBASABAA0gAwAH")},RADIOS=["%%IMG0ABAADgAAB4AYYCAQIBBACEAIQAhACCAQIBAYYAeAAAA=","%%IMG0ABAADgAAB4Af4DhwMDBgGGAYYBhgGDAwOHAf4AeAAAA=","%%IMG0ABAADgAAAAAAAAAAB4APwA/AD8APwAeAAAAAAAAAAAA=","%%IMG0ABAADgAAB4Af4D/wP/B/+H/4f/h/+D/wP/Af4AeAAAA="].map(image_read),ICONS=["%%IMG0AAwADAAAAAM8BEPkQBRAFEAUQBRAFEAXf/AAAA==","%%IMG0AAwADAABHwERgRFBEeEQIRAhECEQIRAhH+AAAA==","%%IMG0AAwADAAAAgAGQA4jPqM+oz6gDiAGQAIAAAAAAA==","%%IMG0AAwADAABH4EfwAHBH8M/wznDOcM5wz/hH+AAAA==","%%IMG0AAwADAAAAgAFAAiBEEIjpERSLiEScAnwBWACAA==","%%IMG0AAwADAAAAAEf4RShF6EUoRShF6EQoR/gAAAAAA==","%%IMG0AAwADAABFUIqoRVCKqEVQiqhFUIqoRVCKqAAAA==","%%IMG0AAwADAAAAAAAIABgAMRBhmMDNgEcAAgAAAAAAA=="].map(image_read),HANDLES=["%%IMG2AAcACgABAQUAAQEBIAUBAiAFAQIgBQECIAUBAiAFAQIgBQEBAAEBASADAQEAAwEBIAEBAQAFAQEAAw==","%%IMG2AAoABwABAQYAAwEBIAYBAQACAQEgBwEBAAEBASAIAQIgBwEBAAEBASAGAQEAAwEGAAM="].map(image_read),ICON={dir:0,doc:1,sound:2,font:3,app:4,lil:5,pat:6,chek:7,none:8},PANGRAM="How razorback jumping-frogs can level six piqued gymnasts.";let uimode="interact",ui_container=null,uicursor=0,enable_touch=0,set_touch=0,toolbar_scroll=0,profiler=0,profiler_ix=0,profiler_hist=new Uint8Array(200);mark_saved=e=>{isSaved=!1},mark_dirty=e=>{dirty=1,e||mark_saved()},con_set=e=>{e!=ui_container&&(setmode(uimode),msg.next_view=1),e!=ui_container&&prototype_is(ui_container)&&contraption_update(deck,ui_container),ui_container=e},con=e=>ui_container||ifield(deck,"card"),con_wids=e=>con().widgets,con_image=e=>ifield(con(),"image"),con_size=e=>getpair(ifield(con(),"size")),con_dim=e=>rpair(rect(),con_size()),con_clip=e=>{const t=con_size();return dr.fatbits?rcenter(frame.clip,rmin(frame.size,rmul(t,dr.zoom))):rclip(frame.clip,rcenter(frame.clip,t))},con_offset=e=>{const t=con_clip();return rect(t.x,t.y)},con_to_screen=e=>radd(dr.fatbits?rmul(rsub(e,dr.offset),dr.zoom):e,con_offset()),screen_to_con=e=>(e=rsub(e,con_offset()),dr.fatbits?radd(rdiv(e,dr.zoom),dr.offset):e),con_view_dim=e=>{const t=screen_to_con(rect(0,0)),r=screen_to_con(frame.size);return rpair(t,rsub(r,t))},clamp_fatbits=e=>{dr.offset=rclamp(rect(0,0),dr.offset,rmax(rsub(con_size(),rdiv(frame.size,dr.zoom)),rect(0,0)))},center_fatbits=e=>{dr.offset=rsub(e,rdiv(rdiv(frame.size,dr.zoom),2)),clamp_fatbits()},ev_to_con=e=>(e.pos=screen_to_con(e.opos=rcopy(e.pos)),e.dpos=screen_to_con(e.odpos=rcopy(e.dpos)),pointer.prev=screen_to_con(pointer.prev),e),con_to_ev=e=>(e.pos=e.opos,e.dpos=e.odpos,pointer.prev=con_to_screen(pointer.prev),e),tracking=e=>{const t=con();if(prototype_is(t)){const e=deck.contraptions,r=dkix(e,ifield(t,"name")),i=count(e);"left"==ev.dir&&con_set(e.v[(r+(i-1))%i]),"right"==ev.dir&&con_set(e.v[(r+1)%i])}card_is(t)&&("left"==ev.dir&&n_go([lms("Prev")],deck),"right"==ev.dir&&n_go([_tlms("next_card")],deck))},is_fullscreen=e=>null!=(document.fullscreenElement||document.webkitFullscreenElement),toggle_fullscreen=e=>{if(is_fullscreen())document.exitFullscreen&&document.exitFullscreen(),document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=q("body"),t={navigationUI:"hide"};e.requestFullscreen&&e.requestFullscreen(t),e.webkitRequestFullscreen&&e.webkitRequestFullscreen(t)}setTimeout(resize,500)},set_fullscreen=e=>{const t=is_fullscreen();t&&!e?toggle_fullscreen():!t&&e&&modal_enter("fullscreen_lil")},setmode=e=>{n_play([NIL,lms("loop")]),grid_exit(),field_exit(),bg_end_selection(),bg_end_lasso(),ob.sel=[],wid.active=-1,sc.others=[],dr.poly=[],msg.next_view=uimode!=e&&"interact"==e,msg.pending_loop=uimode!=e&&"interact"==e,uimode=e,"interact"!=e&&(msg.pending_halt=1),"draw"==e||prototype_is(con())||(dr.fatbits=0),"interact"==e&&(dr.fatbits=0)},event_state=e=>({mu:0,md:0,clicktime:0,click:0,rdown:0,rup:0,mdown:0,dclick:0,clicklast:0,down_modal:0,down_uimode:0,down_caps:0,drag:0,tab:0,shift:0,alt:0,action:0,dir:0,exit:0,eval:0,scroll:0,hidemenu:0,pos:rect(),dpos:rect(),rawpos:rect(),rawdpos:rect(),shortcuts:{},opos:rect(),odpos:rect(),callback:null,callback_rect:null,callback_drag:0});let ev=event_state();over=e=>rin(e,ev.pos),dover=e=>rin(e,ev.dpos),wid_state=e=>({active:0,count:0,scrolls:0,thumbid:0,thumbo:0,col_drag:0,col_num:0,col_orig:0,ingrid:0,g:null,gt:null,gv:null,pending_grid_edit:0,infield:0,f:null,ft:null,fv:null,field_dirty:0,change_timer:0,cursor:rect(),cursor_timer:0,hist:[],hist_cursor:0}),wid_state_clone=e=>{const t=Object.assign({},e);return t.cursor=rcopy(t.cursor),t.hist=t.hist.slice(0),t};let wid=wid_state();modal_state=e=>({type:null,subtype:null,in_modal:0,edit_json:0,old_wid:null,filter:0,grid:null,grid2:null,text:null,name:null,form0:null,form1:null,form2:null,desc:"",path:"",path_suffix:"",filter:"",message:null,verb:null,cell:rect(),from_listener:0,from_action:0,from_keycaps:0,act_go:0,act_card:0,act_gomode:0,act_trans:0,act_transo:0,act_sound:0,time_curr:0,time_end:0,time_start:0,carda:null,cardb:null,trans:null,canvas:null,pending_grid_cell:rect(),drag_offset:rect(),dragging:0,drag_start:rect()}),modal_state_clone=e=>{const t=Object.assign({},e);return t.cell=rcopy(t.cell),t.drag_offset=rcopy(t.drag_offset),t.drag_start=rcopy(t.drag_start),t};let ms=modal_state(),ms_stack=[];modal_push=e=>{ms.type&&ms_stack.push({ms:modal_state_clone(ms),wid:wid_state_clone(wid)}),modal_enter(e)},modal_pop=e=>{const t="link"==ms.type&&e?rtext_string(ms.text.table):null;if(modal_exit(e),ms_stack.length){const e=ms_stack.pop();ms=e.ms,wid=e.wid}if(t){const e=rcopy(wid.cursor);field_stylespan(lms(""),t),wid.cursor=e}};let kc={shift:0,lock:0,alt:0,comb:0,on:0,heading:null},keydown={},keyup={};keycaps_force_enter=e=>{kc.shift=0,kc.lock=0,kc.alt=0,kc.comb=0,kc.on=1,ev.mu=ev.md=0},keycaps_enter=e=>{enable_touch&&!kc.on&&keycaps_force_enter()};let msg={pending_drag:0,pending_halt:0,pending_view:0,pending_loop:0,next_view:0,overshoot:0,target_click:null,target_drag:null,target_release:null,target_order:null,target_run:null,target_link:null,target_ccell:null,target_change:null,target_navigate:null,arg_click:rect(),arg_drag:rect(),lastdrag:rect(),arg_release:rect(),arg_order:null,arg_run:null,arg_link:null,arg_ccell:null,arg_change:null,arg_navigate:null},li={hist:[],vars:new Map,scroll:0},ob={sel:[],show_bounds:1,show_names:0,show_cursor:0,show_margins:0,show_guides:1,move:0,move_first:0,resize:0,resize_first:0,handle:-1,prev:rect(),orig:rect()},sc={target:null,others:[],next:null,f:null,prev_mode:null,xray:0,status:""};script_save=e=>{const t=lms("script");mark_dirty(),sc.target&&iwrite(sc.target,t,e),sc.others&&sc.others.map(r=>iwrite(r,t,e))},draw_state=e=>({tool:"pencil",brush:0,pattern:1,fill:0,erasing:0,dither_threshold:0,show_widgets:1,show_anim:1,trans:0,trans_mask:0,under:0,color:0,fatbits:0,offset:rect(),show_grid:0,snap:0,grid_size:rect(16,16),sel_here:rect(),sel_start:rect(),limbo:null,limbo_dither:0,scratch:null,mask:null,omask:null,pickfill:0,poly:[],zoom:4,lasso_dirty:0});let dr=draw_state();settool=e=>{setmode("draw"),dr.tool=e},bg_pat=e=>dr.trans_mask&&0==dr.pattern?32:dr.pattern,bg_fill=e=>dr.trans_mask&&0==dr.fill?32:dr.fill,bg_has_sel=e=>"select"==dr.tool&&(dr.sel_here.w>0||dr.sel_here.h>0),bg_has_lasso=e=>"lasso"==dr.tool&&null!=dr.mask,sint=(e,t)=>t*(0|(0|e+t/2)/t),snap=e=>dr.snap?rect(sint(e.x,dr.grid_size.x),sint(e.y,dr.grid_size.y),e.w,e.h):e,snapr=e=>rpair(snap(e),snap(rect(e.w,e.h))),snap_delta=e=>{const t=snap(e);return rect(t.x-e.x,t.y-e.y)};let au={target:null,mode:"stopped",head:0,sel:rect(),hist:[],hist_cursor:0,clip:null,tick:null,record_stream:null,norecord:0};byte_to_sample=e=>(e<<24>>24)/128,sample_to_byte=e=>255&clamp(-127,128*e,127);const menu={heads:[],items:[],x:0,active:-1,stick:-1,lw:-1,sz:rect()};menu_label=e=>rect(menu.x,1,context.size.x-menu.x-2,1+font_h(FONT_MENU)),no_menu=e=>-1==menu.active&&-1==menu.stick,in_layer=e=>no_menu()&&(ms.type?ms.in_modal:1)&&(!running()&&!msg.overshoot||null!=ms.type),in_widgets=e=>null!=ms.type?ms.in_modal:1,menus_off=e=>lb(ifield(deck,"locked")),menus_hidden=e=>"undefined"!=typeof window&&window.HIDE_NAV||"draw"==uimode&&ev.hidemenu&&null==ms.type,menu_head=(e,t,r,i)=>({name:e,enabled:t,t:r,b:i}),menu_entry=(e,t,r,i,l,s)=>({name:e,enabled:t,check:r,shortcut:i,t:l,b:s}),menus_clear=e=>(menu.active=-1,menu.stick=-1),menu_setup=e=>(menu.x=10,menu.heads=[],menu.sz=rect(),menu.active=-1),menu_bar=(e,t)=>{menus_off()&&(t=0);const r=rpair(rect(menu.x,2),font_textsize(FONT_MENU,e)),i=rect(r.x-5,0,r.w+10,r.h+3),l=menu.heads.length;menu.heads.push(menu_head(e,t,r,i)),menu.x=i.x+i.w+5,menus_hidden()||(ev.click&&t&&over(i)&&(ev.mu=0,-1==menu.stick&&(menu.stick=l)),-1!=menu.stick&&t&&over(i)&&(menu.stick=l,menu.lw=0),-1==menu.stick&&(ev.drag&&t&&over(i)&&ev.dpos.y<i.h&&(ev.dpos=ev.pos,menu.lw=0),(ev.drag||ev.mu)&&t&&rin(i,ev.dpos)&&(menu.active=l)),l!=menu.active&&l!=menu.stick||(menu.sz=rect(i.x,i.h,max(i.w,menu.lw),0),menu.items=[]),ev.md&&over(i)&&t&&(ev.md=0))},shortcut_w=e=>e?10+font_textsize(FONT_MENU,"^"+e).x:0,menu_check=(e,t,r,i,l)=>{if(!last(menu.heads).enabled)return 0;const s=t&&i&&ev.shortcuts[i];if(s&&delete ev.shortcuts[i],menu.heads.length-1!=menu.active&&menu.heads.length-1!=menu.stick)return s;const n=e?rpair(rect(menu.sz.x+5+8,menu.sz.y+menu.sz.h+2),font_textsize(FONT_MENU,e)):rect(menu.sz.x,menu.sz.y+menu.sz.h+2,1,1);i&&(n.w+=shortcut_w(i));const o=rect(menu.sz.x,menu.sz.y+menu.sz.h,max(menu.sz.w,n.w+10+8),n.h+4);return menu.items.push(menu_entry(e,t,r,i,n,o)),menu.sz=runion(menu.sz,o),t&&over(o)&&l&&(ev.callback=l,ev.callback_rect=rcopy(o),ev.callback_drag=1),s||t&&ev.mu&&over(o)},menu_item=(e,t,r,i)=>menu_check(e,t,-1,r,i),menu_separator=e=>menu_check(0,0,0,0,0),menu_finish=e=>{if(menus_off()||menus_hidden())return;const t=rect(0,0,context.size.x,3+font_h(FONT_MENU));draw_rect(t,32),draw_hline(0,t.w,t.h,1);const r=deck.patterns.pal.pix;if(menu.heads.map((e,i)=>{let l=e.enabled&&(over(e.b)||i==menu.stick||i==menu.active);ev.drag&&!dover(t)&&(l=0),draw_text(e.t,e.name,FONT_MENU,e.enabled?1:13),l&&draw_invert(r,e.b)}),!menu.sz.w)return;draw_shadow(menu.sz,1,32,1),menu.lw=0;let i=0;menu.items.map(e=>{menu.lw=max(menu.lw,e.b.w),i=max(i,shortcut_w(e.shortcut))}),menu.items.map(e=>{const t=over(e.b)&&e.name&&e.enabled;e.name?draw_text(e.t,e.name,FONT_MENU,e.enabled?1:13):draw_rect(rect(e.t.x+2,e.t.y,menu.sz.w-5,1),19),1==e.check&&draw_icon(rect(menu.sz.x+2,e.t.y+3),CHECK,e.enabled?1:13),e.shortcut&&draw_text(rect(menu.sz.x+menu.sz.w-3-i+10,e.t.y),"^"+e.shortcut,FONT_MENU,e.enabled?1:13),t&&draw_invert(r,inset(e.b,1))}),ev.mu&&(menu.stick=-1)},widget_setup=e=>{(ev.mu||-1==wid.active)&&(wid.col_drag=0),wid.active>=wid.count&&(wid.active=0),"interact"!=uimode&&null==ms.type||!ev.tab||!wid.count||wid.infield&&"code"==wid.f.style||kc.on||(wid.ingrid&&grid_exit(),wid.infield&&field_exit(),wid.active+=ev.shift?-1:1,wid.active<0&&(wid.active+=wid.count),wid.cursor=rect()),"interact"!=uimode&&"script"!=uimode&&null==ms.type&&((wid.ingrid||null!=wid.gv)&&grid_exit(),(wid.infield||null!=wid.fv)&&field_exit(),wid.active=-1),wid.count=0,wid.scrolls=0,wid.ingrid=0,wid.infield=0},scrollbar=(e,t,r,i,l,s,n)=>{const o=e=>l=clamp(0,l+e,t);o(0);const a=ARROWS[0].size.x+2,d=in_layer()?n?32:1:13,c=n?1:32,A=rect(e.x+e.w-a-2,e.y,a+2,e.h),m=rect(e.x+1,e.y,s?e.w-A.w-1:e.w-2,e.h-2),_=deck.patterns.pal.pix;let u=wid.thumbid==wid.scrolls++&&dover(A);if(s){if(draw_box(A,0,d),arrow=(i,l,s)=>{const n=t>0&&over(i)&&!u,a=n&&(ev.mu||ev.drag)&&dover(e);draw_box(i,0,d),draw_icon(rect(i.x+2,i.y+2),ARROWS[l+(a?2:0)],d),a&&ev.md&&o(r*s),n&&!ev.drag&&(uicursor=cursor.point)},arrow(rect(A.x,A.y,a+2,a+2),0,-1),arrow(rect(A.x,A.y+A.h-a-2,a+2,a+2),1,1),t<=0||!in_layer())return{size:m,scroll:l};const s=rect(A.x+1,A.y+a+2,A.w-2,A.h-2*(a+2));draw_rect(s,n?9:12);const p=0|max(16,s.h/(1+t)),g=0|(s.h-p)*(l/t),f=rect(s.x,s.y+g,s.w,p);if(in_layer()&&ev.md&&over(f)&&(wid.thumbid=wid.scrolls-1,wid.thumbo=ev.dpos.y-f.y,u=1),in_layer()&&ev.drag&&u){const e=max(s.y,min(s.y+s.h-f.h,ev.pos.y-wid.thumbo))-s.y;f.y=e+s.y,l=max(0,0|min(e/(s.h-p)*t,t)),uicursor=cursor.drag}in_layer()&&ev.mu&&u&&(wid.thumbid=-1),draw_rect(f,c),draw_box(f,0,d),inner=(e,t)=>{!u&&over(e)&&(uicursor=cursor.point),!u&&ev.mu&&over(e)&&(draw_invert(_,e),o(i*t))},g>0&&inner(rect(s.x,s.y,s.w,g),-1),g+f.h<s.h&&inner(rect(s.x,s.y+g+f.h,s.w,s.h-(g+f.h)),1)}return in_layer()&&over(runion(e,A))&&ev.scroll&&o(ev.scroll*r),{size:m,scroll:l}},widget_button=(e,t,r,i)=>{const l=t.locked||!in_layer(),s=deck.patterns.pal.pix,n=t.font||FONT_MENU;let o=t.size;const a=l?13:"invert"==t.show?32:1,d="invert"==t.show?1:32,c="invert"==t.show?32:1,A=!l&&"none"!=t.show&&"invisible"!=t.style&&wid.active==wid.count;let m=0,_=0;l||"interact"!=uimode||wid.fv||ev.shift||"none"==t.show||!t.shortcut||(keyup[t.shortcut]?_=1:keydown[t.shortcut]&&(m=1));const u=!l&&dover(o)&&over(o),p=A&&!i&&ev.action,g=p||m||(ev.md||ev.drag)&&u,f=p||_|(ev.mu&&u);if(i&&u&&(ev.callback=i,ev.callback_rect=rcopy(o)),l||!over(o)||ev.drag||"none"==t.show||(uicursor=cursor.point),"none"==t.show)return 0;let w=inset(o,2);if("round"==t.style&&(draw_boxr(o,a,d,"transparent"!=t.show),draw_textc(inset(o,3),t.text,n,a),A&&draw_box(w,0,13),g&&draw_invert(s,w)),"rect"==t.style&&(g?(o=rect(o.x+1,o.y+1,o.w-1,o.h-1),w=rect(w.x+1,w.y+1,w.w-1,w.h-1),"transparent"!=t.show&&draw_rect(o,d),draw_box(o,0,a)):(o=rect(o.x,o.y,o.w-1,o.h-1),w=rect(w.x,w.y,w.w-1,w.h-1),draw_shadow(o,a,d,"transparent"!=t.show)),draw_textc(inset(o,3),t.text,n,a),A&&draw_box(w,0,13)),"check"==t.style||"radio"==t.style){"transparent"!=t.show&&draw_rect(o,d);const e=font_textsize(n,t.text),i=("check"==t.style?CHECKS[0]:RADIOS[0]).size,l=max(e.y,i.y),m=rect(o.x,o.y+(0|(o.h-l)/2),o.w,l),_=rclip(o,rect(m.x+i.x,0|m.y+(m.h-e.y)/2,o.w-i.x,e.y));if(draw_rect(rect(m.x+1,m.y+1,i.x-4,i.y-3),d),"check"==t.style)draw_icon(rect(m.x,m.y),CHECKS[(r^(g||f))+2*t.locked],c);else{const e=rect(m.x,m.y);draw_icon(e,RADIOS[3],d),draw_icon(e,RADIOS[g||f?1:0],a),r&&draw_icon(e,RADIOS[2],a)}draw_text_fit(_,t.text,n,a),w=_,A&&draw_box(rect(_.x-2,_.y-1,_.w+2,_.h+2),0,13),g&&draw_invert(s,w)}return"invisible"==t.style&&(draw_textc(inset(o,3),t.text,n,a),g&&"transparent"!=t.show&&draw_invert(s,w)),e&&f&&(msg.target_click=e),!t.locked&&in_widgets()&&wid.count++,f},widget_slider=(e,t)=>{const r=t.locked||!in_layer(),i=deck.patterns.pal.pix,l=t.font||FONT_MENU;let s=t.size,n=r?13:"invert"==t.show?32:1,o="invert"==t.show?1:32,a="invert"==t.show?9:12;const d=!r&&"none"!=t.show&&wid.active==wid.count,c=t.value;if("none"==t.show)return;const A=ls("bar"==t.style||"compact"==t.style?dyad.format(lms(t.format),lmn(t.value)):lms("")),m=frame.clip;frame.clip=rclip(s,frame.clip);const _=(e,i,l)=>{const s=!r&&over(e),a=s&&(ev.mu||ev.drag)&&dover(e);a&&ev.md&&(t.value+=i*t.step),s&&(uicursor=cursor.point),draw_rect(e,o),draw_box(e,0,n),draw_icon(rint(rect(e.x+(e.w-12)/2,e.y+(e.h-12)/2)),ARROWS[l+(a?2:0)],n)},u=(e,i,l,a)=>{let d=wid.thumbid==wid.scrolls++&&dover(s),c=0|(t.max-t.min)/t.step,A=0|max(min(e,16),e/(1+c)),m=0|(t.value-t.min)/max(1,t.max-t.min)*(e-A),_=rint(i(m,A));if(!r){if(ev.md&&over(_)&&(wid.thumbid=wid.scrolls-1,wid.thumbo=ev.dpos[l]-_[l],d=1),ev.drag&&d){const e=max(s[l],min(s[l]+s[a]-_[a],ev.pos[l]-wid.thumbo))-s[l];_[l]=e+s[l],uicursor=cursor.drag,t.value=t.min+e*((t.max-t.min)/(s[a]-A))}ev.mu&&d&&(wid.thumbid=-1)}return draw_rect(_,o),draw_box(_,0,n),{drag:d,thumb:_}},p=(e,l,s)=>{r||e||!over(l)||(uicursor=cursor.point,ev.mu&&(draw_invert(i,l),t.value+=10*s*t.step))};if("horiz"!=t.style&&"vert"!=t.style||("transparent"!=t.show&&draw_rect(s,a),draw_box(s,0,d?13:n)),"horiz"==t.style){_(rect(s.x,s.y,16,s.h),-1,4),_(rect(s.x+s.w-16,s.y,16,s.h),1,5),s=rect(s.x+16,s.y+1,s.w-32,s.h-2);const e=u(s.w,(e,t)=>rect(s.x+e,s.y,t,s.h),"x","w"),t=e.drag,r=e.thumb;p(t,rect(s.x,s.y,r.x-s.x,s.h),-1),p(t,rect(r.x+r.w,s.y,s.w-(r.x+r.w-s.x),s.h),1)}if("vert"==t.style){_(rect(s.x,s.y,s.w,16),-1,0),_(rect(s.x,s.y+s.h-16,s.w,16),1,1),s=rect(s.x+1,s.y+16,s.w-2,s.h-32);const e=u(s.h,(e,t)=>rect(s.x,s.y+e,s.w,t),"y","h"),t=e.drag,r=e.thumb;p(t,rect(s.x,s.y,s.w,r.y-s.y),-1),p(t,rect(s.x,r.y+r.h,s.w,s.h-(r.y+r.h-s.y)),1)}if("bar"==t.style){n=t.locked?"invert"==t.show?32:1:n,"transparent"!=t.show&&draw_rect(s,o),draw_box(s,0,d?13:n),s=inset(s,2),draw_textc(s,A,l,n),!r&&over(s)&&(uicursor=cursor.point);const e=t.max==t.min?0:(t.value-t.min)/(t.max-t.min)*s.w;draw_invert(i,rect(s.x,s.y,0|e,s.h)),!r&&dover(s)&&(ev.md||ev.drag)&&(t.value=t.min+(ev.pos.x-s.x)*((t.max-t.min)/s.w),uicursor=cursor.drag)}if("compact"==t.style){"transparent"==t.show&&(draw_rect(rect(s.x+1,s.y+1,13,s.h-2),o),draw_rect(rect(s.x+s.w-14,s.y+1,13,s.h-2),o)),draw_boxr(s,n,o,"transparent"!=t.show),draw_textc(rect(s.x+14,s.y,s.w-28,s.h),A,l,n);const e=(e,i,l,o,a)=>{const c=rect(s.x+e,s.y,14,s.h),A=a&&!r&&over(c),m=A&&(ev.mu||ev.drag)&&dover(c);m&&ev.md&&(t.value+=i*t.step),A&&(uicursor=cursor.point),draw_icon(rect(c.x+1,0|s.y+(s.h-12)/2),ARROWS[l+(m?2:0)],a?n:13),draw_vline(c.x+o,s.y+1,s.y+s.h-1,d?13:n)};e(0,-1,4,13,t.value!=t.min),e(s.w-14,1,5,0,t.value!=t.max)}if(d&&"up"==ev.dir&&(t.value-=t.step),d&&"down"==ev.dir&&(t.value+=t.step),in_layer()&&over(frame.clip)&&ev.scroll&&(t.value+=t.step*ev.scroll),e)t.value=slider_normalize(e,t.value);else{const e=null==t.step?1:t.step;e>0&&(t.value=t.min+Math.round((t.value-t.min)/e)*e),t.value=clamp(t.min,t.value,t.max)}e&&Math.abs(c-t.value)>t.step/2&&(msg.target_change=e,msg.arg_change=lmn(t.value),iwrite(e,lms("value"),msg.arg_change),mark_dirty()),!t.locked&&in_widgets()&&wid.count++,frame.clip=m},widget_canvas=(e,t,r)=>{if("none"==t.show)return;const i=t.size,l=deck.patterns.pal.pix;if("solid"==t.show&&(r?draw_scaled(i,r,1):draw_rect(i,0)),r&&"transparent"==t.show&&draw_scaled(i,r,0),r&&"invert"==t.show&&draw_invert_scaled(l,i,r),t.border&&("invert"==t.show?draw_boxinv(l,i):draw_box(i,0,1)),e&&in_layer())if(t.draggable){const t=ob.sel.length&&ob.sel[0]==e;ev.md&&dover(i)?(msg.target_click=e,msg.arg_click=rect(i.x,i.y),ob.sel=[e],ob.prev=rint(rsub(ev.pos,i))):ev.mu&&t?(msg.target_release=e,msg.arg_release=rsub(ev.dpos,ob.prev),ob.sel=[]):ev.drag&&t&&(msg.target_drag=e,msg.arg_drag=rsub(ev.dpos,ob.prev))}else if(dover(i)){const r=rint(rect((ev.pos.x-i.x)/t.scale,(ev.pos.y-i.y)/t.scale)),l=r.x!=msg.lastdrag.x||r.y!=msg.lastdrag.y,s=over(i);ev.md?(msg.target_click=e,msg.arg_click=r,msg.lastdrag=r):ev.mu?(msg.target_release=e,msg.arg_release=r):ev.drag&&l&&s&&(msg.target_drag=e,msg.arg_drag=r,msg.lastdrag=r)}},grid_exit=e=>{wid.ingrid=0,wid.gv=null,wid.gt=null,wid.hist&&(wid.hist=[],wid.hist_cursor=0)},widget_grid=(e,t,r)=>{if("none"==t.show)return 0;const i=FONT_BODY,l=t.headers?font_h(i)+5:0,s=t.size.h<=50+l||t.size.w<16?0:t.scrollbar,n=t.font?t.font:FONT_MONO,o=r.scroll,a=r.row,d=r.col,c=2==t.headers,A=c||t.size.h<=l?0:t.headers,m=tab_cols(r.table),_=count(r.table),u=m.length,p=font_h(n)+(t.lines?5:3),g=in_layer()?"invert"==t.show?32:1:13,f="invert"==t.show?1:32,w=t.size,y=deck.patterns.pal.pix;let h=in_layer()&&"none"!=t.show&&wid.active==wid.count;in_layer()&&dover(w)&&(ev.md||ev.mu||ev.drag)&&(!h&&wid.gv&&grid_exit(),wid.active=wid.count,h=1),h&&in_layer()&&!over(w)&&ev.md&&(h=0,wid.active=-1,grid_exit()),h&&(wid.fv&&field_exit(),wid.ingrid=1,wid.g=t,wid.gv=r,wid.gt=e),"transparent"!=t.show&&draw_rect(w,f);const x=rect(w.x,w.y,w.w,A?font_h(i)+5:0),b=0|min(_,(w.h-x.h+1)/p),v=_-b,k=scrollbar(rect(w.x,w.y+(A?x.h-1:0),w.w,w.h-(A?x.h-1:0)),v,1,b,r.scroll,s,"invert"==t.show),I=k.size;r.scroll=k.scroll,hwt=t.widths.reduce((e,t)=>e+t,0),draw_box(t.lines?w:rect(w.x,I.y,w.w,w.h-(I.y-w.y)),0,h?13:g);const C=e=>0|(e>=t.widths.length?(I.w-hwt)/(u-t.widths.length):t.widths[e]),z=e=>{let t=0;for(let r=0;r<min(u,e.x);r++)t+=C(r);return rclip(I,rect(I.x+t,I.y+p*e.y+1,e.x==u-1?I.w-t:C(e.x),p-1))},M=e=>{const r=inset(z(e),t.lines?1:0);return e.x&&t.lines&&(r.x+=1,r.w-=1),r};t.lines&&draw_rect(x,g),u<=0&&draw_textc(inset(I,1),"(no data)",i,g);const B=e=>rect(I.x,I.y+p*e,I.w,p),S=e=>inset(rect(I.x+1,I.y+p*e+2,I.w-2,p-3),t.lines?0:-1);let D=0,E=0,O=-1,N=-1;for(let e=0;e<b;e++){const i=in_layer()&&over(I)&&over(B(e));let l=rect();if(i&&t.bycell)for(let t=0;t<u;t++){const r=rect(t,e);over(z(r))&&(N=t,l=M(r))}i&&(ev.md||ev.drag)&&(E=1,O=e+r.scroll,draw_rect(t.bycell?l:S(e),g)),i&&ev.mu&&(D=1,r.row=e+r.scroll,r.col=N),i&&!ev.drag&&(uicursor=cursor.point)}const Q=r.row-r.scroll;!E&&Q>=0&&Q<b&&(!t.bycell||r.col>=0&&r.col<u)&&(O=r.row,N=r.col,draw_rect(t.bycell&&r.col>=0?M(rect(r.col,Q)):S(Q),g));for(let l=0,s=0,o=0;l<u&&o+C(s)<=I.w;l++,s++){const a=rect(x.x+4+o,x.y+1,C(s)-5,x.h-2);if(!(a.w<=0)){if(A){const r=e&&in_layer()&&over(a)&&(ev.drag||ev.mu?dover(a):1)&&!wid.col_drag,s=r&&(ev.md||ev.drag);s&&draw_rect(a,t.lines?f:g),draw_textc(a,m[l],i,t.lines^s?f:g),r&&!ev.drag&&(uicursor=cursor.point),r&&ev.mu&&(msg.target_order=e,msg.arg_order=lms(m[l]))}s&&t.lines&&draw_invert(y,rect(a.x-3,w.y+1,1,w.h-2)),o+=C(s);for(let e=0;e<b;e++){const i=rect(a.x-3,I.y+p*e+1,a.w+5,p-1),o=tab_cell(r.table,m[l],e+r.scroll),d="L"==t.format[l]?"s":t.format[l]||"s",c=e+r.scroll!=O||t.bycell&&s!=N?g:f,A=ls(dyad.format(lms(`%${d}`),"j"==d||"J"==d||"a"==d?monad.list(o):o)),_=rcenter(i,ICONS[0].size),u=frame.clip;if(frame.clip=rclip(i,frame.clip),"I"==t.format[l]){const e=clamp(0,ln(o),8);e<8&&draw_icon(_,ICONS[e],c)}else"B"==t.format[l]?lb(o)&&draw_icon(_,ICONS[ICON.chek],c):("fcCihH".indexOf(t.format[l])>=0?draw_textr:draw_text_fit)(rect(a.x+1,I.y+p*e,a.w-2,p),A,n,c);if(frame.clip=u,!t.locked&&h&&(ev.dclick&&over(i)||ev.action&&t.bycell&&l==r.col&&e+r.scroll==r.row)){const i=t.format[l]||"s",s=rect(l,e+r.scroll);"I"==i||"L"==i||("B"==i||"b"==i?grid_edit_cell(s,lmn(!lb(o))):(wid.pending_grid_edit=1,ms.pending_grid_cell=z(rect(s.x,s.y-r.scroll)),ms.pending_grid_cell.y-=1,ms.pending_grid_cell.w+=1,ms.pending_grid_cell.h+=2,ms.cell=s,ms.text=fieldstr(lms(A))))}}}}if(t.lines)for(let e=1;e<b;e++)draw_hline(I.x,I.x+I.w,I.y+p*e,g);if(!t.locked&&in_layer()&&e)for(let r=0,i=x.x;r<u;i+=C(r),r++){const l=rect(i+C(r)-1,x.y,5,x.h);if(l.x+l.w>w.x+w.w)break;if(over(l)&&draw_vline(l.x+2,l.y,l.y+l.h,13),ev.md&&dover(l)&&(wid.col_drag=1,wid.col_num=r,wid.col_orig=C(r)),h&&wid.col_drag&&wid.col_num==r&&ev.drag){const i=min(max(10,wid.col_orig+(ev.pos.x-ev.dpos.x)),I.w-10),l=r;uicursor=cursor.drag,iwrite(e,lms("widths"),lml(range(max(t.widths.length,l+1)).map(e=>lmn(l==e?i:C(e))))),mark_dirty()}}return e&&o!=r.scroll&&(iwrite(e,lms("scroll"),lmn(r.scroll)),mark_dirty()),e&&a!=r.row&&(iwrite(e,lms("row"),lmn(r.row)),mark_dirty()),e&&d!=r.col&&(iwrite(e,lms("col"),lmn(r.col)),mark_dirty()),e&&D&&(msg.target_click=e,msg.arg_click=rect(0,r.row)),in_widgets()&&wid.count++,c?D&&ev.dclick||h&&ev.action:D},grid_format=e=>lms(wid.g.format.length?wid.g.format:"s".repeat(tab_cols(wid.gv.table).length)),grid_apply=e=>{wid.gv.table=e,wid.gv.row=-1,wid.gt&&(iwrite(wid.gt,lms("value"),e),iwrite(wid.gt,lms("row"),lmn(-1)),mark_dirty(),msg.target_change=wid.gt,msg.arg_change=e)},grid_undo=e=>{const t=wid.hist[--wid.hist_cursor];grid_apply(t[0])},grid_redo=e=>{const t=wid.hist[wid.hist_cursor++];grid_apply(t[1])},grid_edit=e=>{wid.hist=wid.hist.slice(0,wid.hist_cursor),wid.hist.push([wid.gv.table,e]),grid_redo()},grid_deleterow=e=>grid_edit(dyad.drop(lml([lmn(wid.gv.row)]),wid.gv.table)),grid_insertrow=e=>{const t=ls(grid_format()),r=wid.gv.table,i=lmt(),l=wid.gv.row+1;tab_cols(r).map((e,s)=>{const n=tab_get(r,e);tab_set(i,e,range(n.length+1).map(e=>e==l?"sluro".indexOf(t[s])>=0?lms(""):ZERO:n[e-(e>=l?1:0)]))}),grid_edit(i),iwrite(wid.gt,lms("col"),ZERO),iwrite(wid.gt,lms("row"),lmn(l));const s=wid.gv.scroll,n=grid_scrollto(r,wid.g,s,l);s!=n&&(wid.gv.scroll=n,iwrite(wid.gt,lms("scroll"),lmn(n)))},grid_edit_cell=(e,t)=>{wid.gv.col=e.x,iwrite(wid.gt,lms("col"),lmn(e.x)),wid.gv.row=e.y,iwrite(wid.gt,lms("row"),lmn(e.y)),msg.target_ccell=wid.gt,msg.arg_ccell=lms(ls(t))},grid_keys=(e,t)=>{const r=wid.g.font?wid.g.font:FONT_MONO,i=FONT_BODY,l=count(wid.gv.table),s=tab_cols(wid.gv.table).length;let n=0,o=wid.gv.row,a=wid.gv.col;const d=font_h(r)+5,c=wid.g.headers?font_h(i)+5:0,A=min(l,0|(wid.g.size.h-c+1)/d);if("ArrowUp"==e&&(n=1,-1==o?o=0:o-=1),"ArrowDown"==e&&(n=1,-1==o?o=0:o+=1),"ArrowLeft"==e&&(n=1,-1==a?a=0:a-=1),"ArrowRight"==e&&(n=1,-1==a?a=0:a+=1),"PageUp"==e&&(n=1,-1==o&&(o=0),o-=A),"PageDown"==e&&(n=1,-1==o&&(o=0),o+=A),"Home"==e&&(n=1,o=0),"End"==e&&(n=1,o=l-1),wid.g.locked||"Backspace"!=e&&e!=_t("delete")||grid_deleterow(),!n)return;"prototype_attrs"==ms.type&&(ms.text.table=ms.name.table=null),wid.gv.row=o=max(0,min(o,l-1)),wid.gv.col=a=max(0,min(a,s-1)),wid.gt&&(iwrite(wid.gt,lms("row"),lmn(o)),iwrite(wid.gt,lms("col"),lmn(a)),mark_dirty(),msg.target_click=wid.gt,msg.arg_click=rect(0,o));const m=wid.gv.scroll;o-m<0&&(wid.gv.scroll=o),o-m>=A&&(wid.gv.scroll=o-(A-1)),wid.gt&&m!=wid.gv.scroll&&(iwrite(wid.gt,lms("scroll"),lmn(wid.gv.scroll)),mark_dirty())},layout_index=(e,t)=>{for(let r=0;r<e.lines.length;r++){const i=e.lines[r].pos;if(t.y>i.y+i.h)continue;const l=e.lines[r].range;if(t.y<i.y)return l.x;for(let r=l.x;r<=l.y;r++){const i=e.layout[r].pos;if(t.x<i.x+i.w/2)return r}return r==e.lines.length-1?e.layout.length:l.y}return e.layout.length},layout_last=(e,t)=>e.layout.length>0?last(e.layout):{pos:rect(0,0,1,font_h(t)),line:0,char:"\0",font:t,arg:ZERO},layout_cursor=(e,t,r,i)=>{const l=i.size.w-5-(i.scrollbar?ARROWS[0].size.x+3:0),s="center"==i.align?0|l/2:i.align==ALIGN.right?l:0,n=e.layout.length>0?rcopy(e.layout[min(t,e.layout.length-1)].pos):rect(s,0,1,font_h(r));return t>=e.layout.length&&("\n"==layout_last(e,r).char?(n.x=0,n.y+=n.h):n.x+=n.w-1),n.w=1,n},field_change=e=>{wid.field_dirty&&wid.ft&&(field_notify_disable=1,iwrite(wid.ft,lms("value"),wid.fv.table),mark_dirty(),field_notify_disable=0,msg.target_change=wid.ft,msg.arg_change=rtext_string(wid.fv.table))},field_exit=e=>{field_change(),kc.on=0,wid.infield=0,wid.fv=null,wid.ft=null,wid.cursor=rect(),wid.field_dirty=0,wid.change_timer=0,hiddenInput&&(hiddenInput.style.display="none",hiddenInput.blur(),isInputMethodActive=!1)},widget_field=(e,t,r)=>{if("none"==t.show)return;(t.size.h<=50||t.size.w<16)&&(t.scrollbar=0);const i=!in_layer(),l=t.font?t.font:"code"==t.style?FONT_MONO:FONT_BODY,s=t.size,n=deck.patterns.pal.pix,o=i&&!t.locked?13:"invert"==t.show?32:1,a="invert"==t.show?1:32,d=r.scroll;"transparent"!=t.show&&draw_rect(rclip(s,frame.clip),a),t.border&&draw_box(s,0,o);let c=inset(s,2);t.scrollbar&&(c.w-=ARROWS[0].size.x+3),i||t.locked||!over(c)||ev.drag&&!dover(c)||(uicursor=cursor.ibeam);const A=layout_richtext(deck,r.table,l,t.align,c.w),m=layout_last(A,l),_="\n"!=m.char?0:m.pos.h,u=scrollbar(s,max(0,m.pos.y+m.pos.h+_-c.h),10,c.h,r.scroll,t.scrollbar,"invert"==t.show);r.scroll=u.scroll;let p=!t.locked&&!i&&wid.active==wid.count,g=null;if(t.locked&&!p&&in_layer()&&t.locked&&(ev.md||ev.drag))for(let e=0;e<A.layout.length;e++){const t=A.layout[e],i=rcopy(t.pos);if(!(i.w<1)&&(i.y-=r.scroll,!(i.y+i.h<0||i.y>c.h)&&(i.x+=c.x,i.y+=c.y,lis(t.arg)&&count(t.arg)&&dover(i)&&over(i)))){g=t.arg;break}}if(!t.locked&&!i&&dover(c)&&(ev.md||ev.mu||ev.drag)){if(e&&lb(ifield(e,"colorpicker"))&&ev.mu&&!ev.drag)return wid.active=wid.count,wid.f=t,wid.fv=r,wid.ft=e,show_color_picker(),void(ev.mu=0);const i=layout_index(A,rect(ev.pos.x-c.x,ev.pos.y-c.y+r.scroll));if(ev.md&&!ev.shift?wid.cursor.x=wid.cursor.y=i:wid.cursor.y=i,ev.dclick){let e=0,t=A.layout.length&&/\s/g.test(A.layout[min(wid.cursor.y,A.layout.length-1)].char);for(e=wid.cursor.y;e>=0&&e<A.layout.length&&t^!/\s/g.test(A.layout[e].char);)e--;for(wid.cursor.x=e+1,e=wid.cursor.y;e<A.layout.length&&t^!/\s/g.test(A.layout[e].char);)e++;wid.cursor.y=e}const s=layout_cursor(A,wid.cursor.y,l,t);s.y-=r.scroll,ch=min(c.h,s.h),s.y<0&&(r.scroll-=4),s.y+ch>c.h&&(r.scroll+=clamp(1,s.y+ch-c.h,4)),p||!wid.fv||kc.on||field_exit(),wid.active=wid.count,p=1}p&&in_layer()&&!over(s)&&ev.md&&!kc.on&&(p=0,wid.active=-1,field_exit()),p&&(wid.gv&&grid_exit(),wid.infield=1,wid.f=t,wid.fv=r,wid.ft=e,keycaps_enter(),activateInputMethod());const f=rclip(frame.clip,c),w=frame.clip;frame.clip=f;for(let i=0;i<A.layout.length;i++){const l=A.layout[i],s=rcopy(l.pos);if(s.w<1)continue;if(s.y-=r.scroll,s.y+s.h<0||s.y>f.h)continue;if(s.x+=c.x,s.y+=c.y,lis(l.arg)&&count(l.arg)){draw_hline(s.x,s.x+s.w,s.y+s.h-1,g==l.arg?o:19);const r=t.locked&&in_layer()&&over(s)&&e;r&&!ev.drag&&(uicursor=cursor.point),r&&ev.mu&&dover(s)&&(msg.target_link=e,msg.arg_link=l.arg)}const d=p&&wid.cursor.x!=wid.cursor.y&&i>=min(wid.cursor.x,wid.cursor.y)&&i<max(wid.cursor.x,wid.cursor.y);d&&draw_rect(rclip(s,frame.clip),o),image_is(l.arg)?(image_paste(s,frame.clip,l.arg,frame.image,"transparent"!=t.show),d&&draw_invert(n,s)):draw_char(s,l.font,l.char,d?a:o)}if(p&&wid.cursor_timer<FIELD_CURSOR_DUTY){const e=layout_cursor(A,wid.cursor.y,l,t);e.y-=r.scroll,e.y+=c.y,e.x+=c.x,draw_invert(n,rclip(e,frame.clip))}e&&d!=r.scroll&&(iwrite(e,lms("scroll"),lmn(r.scroll)),mark_dirty()),frame.clip=w,!t.locked&&in_widgets()&&wid.count++},field_showcursor=e=>{const t=wid.f.size,r=inset(t,2);wid.f.scrollbar&&(r.w-=ARROWS[0].size.x+3);const i=wid.f.font?wid.f.font:"code"==wid.f.style?FONT_MONO:FONT_BODY,l=layout_richtext(deck,wid.fv.table,i,wid.f.align,r.w),s=wid.fv.scroll,n=layout_cursor(l,wid.cursor.y,i,wid.f),o=min(r.h,n.h);return n.y-=wid.fv.scroll,n.y<0&&(wid.fv.scroll+=n.y),n.y+o>=r.h&&(wid.fv.scroll+=n.y+o-r.h),wid.ft&&s!=wid.fv.scroll&&(iwrite(wid.ft,lms("scroll"),lmn(wid.fv.scroll)),mark_dirty()),l},field_apply=(e,t)=>{wid.fv.table=e,wid.cursor=rect(t.x,t.y),wid.cursor.x<0&&(wid.cursor.x=0),wid.cursor.y<0&&(wid.cursor.y=0),field_showcursor(),wid.field_dirty=1,wid.change_timer=FIELD_CHANGE_DELAY},field_undo=e=>{const t=wid.hist[--wid.hist_cursor];field_apply(t[0],t[1])},field_redo=e=>{const t=wid.hist[wid.hist_cursor++];field_apply(t[2],t[3])},field_edit=(e,t,r,i)=>{const l=rect(),s=rtext_splice(wid.fv.table,e,t,r,i,l);wid.hist=wid.hist.slice(0,wid.hist_cursor),wid.hist.push([wid.fv.table,rect(wid.cursor.x,wid.cursor.y),s,l]),field_redo()},field_editr=(e,t)=>{const r=rect(),i=rtext_splicer(wid.fv.table,e,t,r);wid.hist=wid.hist.slice(0,wid.hist_cursor),wid.hist.push([wid.fv.table,rect(wid.cursor.x,wid.cursor.y),i,r]),field_redo()},field_sel_lines=e=>{let t=min(wid.cursor.x,wid.cursor.y),r=max(wid.cursor.x,wid.cursor.y),i=field_showcursor();for(;t&&"\n"!=i.layout[t-1].char;)t--;for(;r<i.layout.length&&"\n"!=i.layout[r].char;)r++;return{layout:i,sel:rect(t,r)}},field_comment=e=>{const t=field_sel_lines(),r=t.sel,i=t.layout.layout;let l=1,s=r.x;for(;s<r.y;){for(;s<r.y&&" "==i[s].char;)s++;for(s<r.y&&"#"!=i[s].char&&(l=0);s<r.y&&"\n"!=i[s].char;)s++;s++}let n="";for(s=r.x;s<r.y;){for(;s<r.y&&" "==i[s].char;)n+=" ",s++;for(l?"#"==i[s].char&&(s++,s<r.y&&" "==i[s].char&&s++):n+="# ";s<r.y&&"\n"!=i[s].char;)n+=i[s++].char;s<r.y&&"\n"==i[s].char&&(n+="\n",s++)}field_edit(lms(""),lms(""),n,r),wid.cursor=rect(r.x,wid.cursor.y)},field_indent=e=>{const t=field_sel_lines(),r=t.sel,i=t.layout.layout;let l="",s=r.x;for(;s<r.y;){for(e?l+=" ":" "==i[s].char&&s++;s<r.y&&" "==i[s].char;)l+=" ",s++;for(;s<r.y&&"\n"!=i[s].char;)l+=i[s++].char;s<r.y&&"\n"==i[s].char&&(l+="\n",s++)}field_edit(lms(""),lms(""),l,r),wid.cursor=rect(r.x,wid.cursor.y)},field_stylespan=(e,t)=>field_edit(e,t,ls(rtext_string(wid.fv.table,wid.cursor)),wid.cursor),field_input=e=>{if("\n"==e&&("save"==ms.type&&(ev.action=1),"save"==ms.type||ev.shift))return;field_edit(((e,t)=>{const r=rtext_get(e,t);return r<0?lms(""):tab_cell(e,"font",r)})(wid.fv.table,wid.cursor.y),lms(""),clchars(e),wid.cursor)},field_keys=(e,t)=>{if("Enter"==e&&"gridcell"==ms.type)return modal_exit(1),void(ev.action=0);const r=wid.f.size,i=inset(r,2);wid.f.scrollbar&&(i.w-=ARROWS[0].size.x+3);const l=wid.f.font?wid.f.font:"code"==wid.f.style?FONT_MONO:FONT_BODY,s=layout_richtext(deck,wid.fv.table,l,wid.f.align,i.w);let n=0,o=wid.cursor.x!=wid.cursor.y;const a=wid.cursor.y>=s.layout.length?s.lines.length-1:s.layout[wid.cursor.y].line,d=layout_cursor(s,wid.cursor.y,l,wid.f);if("ArrowLeft"==e&&(n=1,o&&!t?wid.cursor.x=wid.cursor.y=min(wid.cursor.x,wid.cursor.y):wid.cursor.y--),"ArrowRight"==e&&(n=1,o&&!t?wid.cursor.x=wid.cursor.y=max(wid.cursor.x,wid.cursor.y):wid.cursor.y++),"ArrowUp"==e&&(n=1,a>=0&&(wid.cursor.y=layout_index(s,rect(d.x-1,s.lines[a].pos.y-1)))),"ArrowDown"==e&&(n=1,a>=0&&(wid.cursor.y=layout_index(s,rect(d.x-1,s.lines[a].pos.y+s.lines[a].pos.h+1)))),"PageUp"==e&&(n=1,a>=0&&(wid.cursor.y=layout_index(s,rect(d.x-1,s.lines[a].pos.y-i.h)))),"PageDown"==e&&(n=1,a>=0&&(wid.cursor.y=layout_index(s,rect(d.x-1,s.lines[a].pos.y+s.lines[a].pos.h+i.h)))),"Home"==e&&(n=1,ev.alt?wid.cursor.y=0:a>=0&&(wid.cursor.y=s.lines[a].range.x)),"End"==e&&(n=1,ev.alt?wid.cursor.y=s.layout.length:a>=0&&(wid.cursor.y=s.lines[a].range.y+(a==s.lines.length-1?1:0))),"Backspace"==e&&field_edit(lms(""),lms(""),"",o?wid.cursor:rect(wid.cursor.y-1,wid.cursor.y)),"Delete"==e&&field_edit(lms(""),lms(""),"",o?wid.cursor:rect(wid.cursor.y,wid.cursor.y+1)),"Enter"==e)if(t&&wid.ft)field_change(),msg.target_run=wid.ft,msg.arg_run=rtext_string(wid.fv.table,o?wid.cursor:rect(0,RTEXT_END));else{let e=0;if("code"==wid.f.style){const t=field_sel_lines(),r=t.sel,i=t.layout.layout;for(;r.x<i.length&&" "==i[r.x].char;)e++,r.x++}field_input("\n"+" ".repeat(e))}"Tab"==e&&"code"==wid.f.style&&(t||o?field_indent(!t):field_input(" "));const c=layout_richtext(deck,wid.fv.table,l,wid.f.align,i.w);wid.cursor.y=clamp(0,wid.cursor.y,c.layout.length),n&&(wid.cursor_timer=0,t||(wid.cursor.x=wid.cursor.y),field_showcursor())},widget_contraption=e=>{const t=ls(ifield(e,"show"));if("none"==t)return;const r=rpair(getpair(ifield(e,"pos")),getpair(ifield(e,"size"))),i=ifield(e,"image"),l=frame.clip,s=deck.patterns.pal.pix;frame.clip=rclip(frame.clip,r),draw_9seg(r,frame.image,i,getrect(ifield(e.def,"margin")),frame.clip,"solid"==t,"invert"==t?s:null),handle_widgets(e.widgets,rect(r.x,r.y)),frame.clip=l};let attrs=[],attrs_scroll=0;widget_attributes=e=>{const t={bool:16,number:20,string:20,code:80,rich:80};draw_box(e,0,1);let r=5,i=0;attrs.map(e=>{r+=t[e.type]+5,"bool"!=e.type&&(i=max(i,font_textsize(FONT_MENU,e.label).x))});const l=scrollbar(e,max(0,r-e.h),10,e.h,attrs_scroll,1,0),s=l.size;attrs_scroll=l.scroll,s.y+=1;const n=frame.clip;frame.clip=s,i=0|min(i+10,.6*s.w);const o=ev.pos,a=ev.dpos,d=ev.scroll;ev.scroll=0,over(s)||(ev.pos=rect(-1,-1)),dover(s)||(ev.dpos=rect(-1,-1));let c=5;attrs.map(e=>{const r=rect(s.x+5,s.y+c-attrs_scroll,i,t[e.type]),l=rect(r.x+r.w+5,r.y,s.w-15-r.w,r.h);if(c+=r.h+5,"bool"==e.type)return r.w=s.w-10,void(ui_checkbox(r,e.label,1,e.bval)&&(e.bval^=1));draw_text_fit(r,e.label,FONT_MENU,1),"number"==e.type&&ui_field(l,e.value),"string"==e.type&&ui_field(l,e.value),"code"==e.type&&ui_codeedit(l,1,e.value),"rich"==e.type&&ui_richedit(l,1,e.value)}),frame.clip=n,ev.pos=o,ev.dpos=a,ev.scroll=d},handle_widgets=(e,t)=>{e.v.map(e=>{if(button_is(e)){const r=lb(ifield(e,"value")),i=unpack_button(e);i.size=radd(i.size,t),widget_button(e,i,r)&&"check"==i.style&&(iwrite(e,lms("value"),lmn(!r)),mark_dirty())}if(slider_is(e)){const r=unpack_slider(e);r.size=radd(r.size,t),widget_slider(e,r)}if(canvas_is(e)){const r=unpack_canvas(e);r.size=radd(r.size,t),widget_canvas(e,r,container_image(e,0))}if(grid_is(e)){const r=unpack_grid(e),i=unpack_grid_value(e);r.size=radd(r.size,t),widget_grid(e,r,i),wid.gt==e&&(wid.gv=i)}if(field_is(e))if(wid.ft==e)widget_field(e,wid.f,wid.fv);else{const r=unpack_field(e),i=unpack_field_value(e);r.size=radd(r.size,t),widget_field(e,r,i),wid.ft==e&&(wid.fv=i)}contraption_is(e)&&widget_contraption(e)})},ui_button=(e,t,r,i)=>widget_button(null,{text:t,size:e,font:FONT_MENU,style:"round",show:"solid",locked:!r},0,i),ui_toggle=(e,t,r,i,l)=>widget_button(null,{text:t,size:e,font:FONT_MENU,style:"round",show:r?"invert":"solid",locked:!i},0,l),ui_radio=(e,t,r,i)=>widget_button(null,{text:t,size:e,font:FONT_BODY,style:"radio",show:"solid",locked:!r},i),ui_checkbox=(e,t,r,i)=>widget_button(null,{text:t,size:e,font:FONT_BODY,style:"check",show:"solid",locked:!r},i),ui_field=(e,t)=>widget_field(null,{size:e,font:FONT_BODY,show:"solid",scrollbar:0,border:1,style:"plain",align:ALIGN.left,locked:0},t),ui_dfield=(e,t,r)=>widget_field(null,{size:e,font:FONT_BODY,show:"solid",scrollbar:0,border:1,style:"plain",align:ALIGN.left,locked:!t},r),ui_textedit=(e,t,r)=>widget_field(null,{size:e,font:FONT_BODY,show:"solid",scrollbar:1,border:t,style:"plain",align:ALIGN.left,locked:0},r),ui_codeedit=(e,t,r)=>widget_field(null,{size:e,font:FONT_MONO,show:"transparent",scrollbar:1,border:t,style:"code",align:ALIGN.left,locked:running()},r),ui_richedit=(e,t,r)=>widget_field(null,{size:e,font:FONT_BODY,show:"solid",scrollbar:1,border:t,style:"rich",align:ALIGN.left,locked:0},r),ui_table=(e,t,r,i)=>widget_grid(null,{size:e,font:FONT_BODY,widths:t,format:r,headers:2,scrollbar:1,lines:0,bycell:0,show:"solid",locked:1},i),ui_list=(e,t)=>widget_grid(null,{size:e,font:FONT_BODY,widths:[],format:"",headers:0,scrollbar:1,lines:0,bycell:0,show:"solid",locked:1},t),listen_show_image=(e,t)=>{for(frame=context;li.hist.length>=LISTEN_LINES;)li.hist.shift();li.hist.push([e,t]),li.scroll=RTEXT_END},listen_show=(e,t,r)=>listen_show_image(draw_lil(rsub(LISTEN_SIZE(),rect(18,5)),e,t,r),r),n_show=e=>(e[0]=e[0]||NIL,e.length<2?listen_show(ALIGN.right,0,e[0]):listen_show(ALIGN.right,1,lms(e.map(show).join(" "))),e[0]),n_print=e=>(e[0]=e[0]||NIL,e.length<2?listen_show(ALIGN.right,1,lms(ls(e[0]))):listen_show(ALIGN.right,1,e[0]=dyad.format(e[0],lml(e.slice(1)))),e[0]),n_log=e=>{console.log(e)},n_quickColor=e=>(void 0!==ext&&ext.colorPicker&&"function"==typeof ext.colorPicker.show?ext.colorPicker.show():"function"==typeof show_color_picker_for_pattern&&show_color_picker_for_pattern(dr.pattern),lmn(0)),n_showLanguagePicker=e=>{if(void 0!==ext&&ext.languagePicker&&"function"==typeof ext.languagePicker.show){const t=e[0];ext.languagePicker.show(()=>{if(t&&lion(t)){const e=lmblk();blk_lit(e,t),blk_lit(e,lml([])),blk_op(e,op.CALL);const r=lmenv();for(pushstate(r),issue(r,e);running();)runop();popstate()}})}return lmn(0)},n_isHideNav=e=>lmn("undefined"!=typeof window&&window.HIDE_NAV?1:0),n_log2=e=>{const t=(e,r=0)=>{if(linil(e))return"nil";if(lin(e))return ln(e).toString();if(lis(e)){const t=ls(e);return t.length>50?t.substring(0,50)+"...":`"${t}"`}if(lil(e)){return 0==count(e)?"()":`(${e.v.map(e=>t(e,r+1)).join(",")})`}if(lid(e)){return 0==count(e)?"{}":`{${e.k.map((i,l)=>`${t(i,r+1)}:${t(e.v[l],r+1)}`).join(",")}}`}return lit(e)?`(table: ${tab_cols(e).length} cols, ${tab_rowcount(e)} rows)`:lion(e)?`on ${e.n}...`:linat(e)?"native":lii(e)?`<${e.n}>`:show(e)};return e.length<2?console.log(t(e[0]||NIL)):console.log(e.map(t).join(" ")),e[0]||NIL},n_translate=([e,...t],r)=>{if(!e)return lms("");const i=ls(e),l=t.length>0?Object.fromEntries(t.map((e,t)=>[t,ls(e)])):void 0,s=_t(i,l);return lms(s)},n_refresh=()=>{setmode("object"),setmode("interact")},n_get_last_card=()=>{let e=deck.history;for(let t=e.length-2;t>=0;t--)if(!isNaN(+e[t]))return deck.cards.v[e[t]]},n_debugger=()=>{},n_pre_listen=([e])=>{const t=getev();for(let e of li.vars.keys())t.v.get(e)||t.v.set(e,li.vars.get(e));return ob.sel.length&&"object"==uimode&&t.v.set("selected",lml(ob.sel.slice(0))),e},n_post_listen=([e])=>{const t=getev();for(let e of t.v.keys())li.vars.set(e,t.v.get(e));return li.vars.set("_",e),listen_show(ALIGN.right,0,e),e},n_post_query=([e])=>(ms.grid=gridtab(lt(e)),e),listener_eval=e=>{const t=rtext_string(ms.text.table);if(!(count(t)<1))try{const e=parse(ls(t)),r=lmblk();ms.text=fieldstr(lms("")),listen_show(ALIGN.left,1,t);const i="script"==uimode?sc.target:1==ob.sel.length?ob.sel[0]:con();blk_opa(r,op.BUND,1),blk_lit(r,lmnat(n_pre_listen)),blk_lit(r,NIL),blk_op(r,op.CALL),blk_op(r,op.DROP),blk_cat(r,e),blk_opa(r,op.BUND,1),blk_lit(r,lmnat(n_post_listen)),blk_op(r,op.SWAP),blk_op(r,op.CALL),blk_op(r,op.DROP),fire_hunk_async(i,r)}catch(e){return void listen_show(ALIGN.right,1,lms(`error: ${e.x}`))}},listener=e=>{const t=LISTEN_SIZE(),r=li.hist.reduce((e,t)=>e+t[0].size.y+5,0),i=min(r,t.y),l=rect(0|e.x+(e.w-t.x)/2,e.y+e.h-49,t.x,50),s=rect(l.x,l.y-(i?i+5:0),l.w,i),n=rect(l.x-5,l.y-5-(i?s.h+5:0),l.w+10,(i?s.h+5:0)+l.h+20),o=deck.patterns.pal.pix;if(draw_shadow(n,1,32,1),ui_codeedit(l,1,ms.text),i){const e=scrollbar(s,max(0,r-t.y),10,s.h,li.scroll,i>=t.y,0),l=e.size;li.scroll=e.scroll;let n=0;li.hist.map(e=>{const t=e[0],r=e[1],i=t.size;let s=rect(l.x,l.y+n-li.scroll,i.x,i.y);image_paste(s,l,t,frame.image,0),n+=i.y+5,s=rclip(l,s);const a=over(s),d=a&&dover(s);a&&(uicursor=cursor.point,draw_box(inset(s,-1),0,13)),d&&(ev.md||ev.drag)&&draw_invert(o,s),d&&ev.mu&&(ms.text=fieldstr(image_is(r)?lms(`image["${ls(ifield(r,"encoded"))}"]`):lis(r)?r:lms(show(r))))})}},n_panic=e=>{do_panic=1,halt(),states.map(e=>e.t=[]),modal_enter("listen");const t=rect(472,16),r=rpair(rect(0,0),t),i=image_make(t),l=frame;return frame=draw_frame(i),draw_box(r,0,35),draw_textc(inset(r,2),"PANIC",FONT_MONO,35),frame=l,listen_show_image(i,NIL),n_show(e),li.vars.set("_",e[0]||NIL),NIL};const SFX_VOLUME_MIN=0,SFX_VOLUME_MAX=300;let sfx_volume_percent=100;try{const t=localStorage.getItem("wpaint_sfx_volume_percent");if(null!=t){const i=Number.parseInt(t,10);Number.isFinite(i)&&(sfx_volume_percent=Math.max(SFX_VOLUME_MIN,Math.min(SFX_VOLUME_MAX,i)))}}catch(l){}let audio=null,samples_playing=0,audio_loop=null,audio_loop_playing=null;const audioContext=window.AudioContext||window.webkitAudioContext,offline=window.OfflineAudioContext||window.webkitOfflineAudioContext;initaudio=e=>{audio||(audio=new audioContext({sampleRate:44100}))},load_sound=(e,t)=>{decode_sound=e=>{const r=[];for(let t=0;t<e.length&&r.length<10*SFX_RATE;t+=8)r.push(sample_to_byte(e[t]));t?t(sound_make(Uint8Array.from(r))):(au.target=deck_add(deck,sound_read(ln(0))),mark_dirty(),sound_edit(sound_make(Uint8Array.from(r))),au.sel=rect(),au.head=0,modal_enter("recording"))},import_sound=e=>{initaudio(),audio.decodeAudioData(e,e=>{const t=new offline(1,64e3*e.length/e.sampleRate,64e3),r=t.createBufferSource();t.oncomplete=e=>{decode_sound(e.renderedBuffer.getChannelData(0))},r.buffer=e,r.connect(t.destination),r.start(0),t.startRendering()})};const r=new FileReader;r.onload=e=>import_sound(r.result),r.readAsArrayBuffer(e)},sfx_stoploop=e=>{audio_loop_playing.onended=null,audio_loop_playing.stop(),audio_loop=audio_loop_playing=null},sfx_doloop=e=>{const t=audio_loop||NIL,r=lmblk(),i=pending_popstate;let l=NIL,s=LOOP_QUOTA;for(blk_get(r,lms("loop")),blk_lit(r,lml([t])),blk_op(r,op.CALL),fire_hunk_async(ifield(deck,"card"),r);s>0&&running();)runop(),s--;running()||(l=arg()),popstate(),pending_popstate=i,e&&audio_loop&&sfx_stoploop(),n_play([l,lms("loop")]),msg.pending_loop=0},n_play=([e,t])=>{const r=e=>{const t=audio.createBuffer(1,8*e.data.length,64e3),r=t.getChannelData(0),i=MASTER_VOLUME*(sfx_volume_percent/100);for(let t=0;t<e.data.length;t++)for(let l=0;l<8;l++)r[8*t+l]=i*byte_to_sample(e.data[t]);const l=audio.createBufferSource();return l.buffer=t,l.connect(audio.destination),l};if(t&&"loop"==ls(t)&&audio)return lis(e)&&(e=dget(ifield(deck,"sounds"),e)),e&&audio_loop==e||(sound_is(e)&&ln(ifield(e,"size"))>0?(audio_loop&&sfx_stoploop(),audio_loop=e,audio_loop_playing=r(e),audio_loop_playing.onended=e=>{sfx_doloop(1)},audio_loop_playing.start()):audio_loop&&sfx_stoploop()),NIL;const i=e?sound_is(e)?e:dget(deck.sounds,lms(ls(e))):e;if(!i||ln(ifield(i,"size"))<1)return NIL;if(initaudio(),!audio)return;const l=r(i);return l.addEventListener("ended",e=>{samples_playing--,audio_playing=samples_playing>0}),l.start(),samples_playing++,audio_playing=1,NIL},stop_sound_pump=e=>{au.clip&&au.clip.stop(),au.clip=null,clearInterval(au.tick),au.mode="stopped",au.head=au.sel.x==au.sel.y?0:au.sel.x},play_sound_pump=e=>{if(initaudio(),e.data.length<1)return;const t=audio.createBuffer(1,8*e.data.length,64e3),r=t.getChannelData(0),i=MASTER_VOLUME*(sfx_volume_percent/100);for(let t=0;t<e.data.length;t++)for(let l=0;l<8;l++)r[8*t+l]=i*byte_to_sample(e.data[t]);const l=audio.createBufferSource();l.buffer=t,l.connect(audio.destination),l.addEventListener("ended",e=>stop_sound_pump),au.clip=l;let s=0;au.tick=setInterval(t=>{au.head+=400,s+=400,("playing"!=au.mode||s>=e.data.length)&&stop_sound_pump()},50),au.mode="playing",l.start()},sfx_any=e=>samples_playing>0,sound_slice=e=>{const t=[];for(let r=e.x;r<e.y;r++)t.push(au.target.data[r]);return sound_make(Uint8Array.from(t))},sound_selected=e=>sound_slice(au.sel.x==au.sel.y?rect(0,au.target.data.length):au.sel),sound_apply=e=>{au.target.data=Uint8Array.from(e.data),mark_dirty()},sound_undo=e=>{const t=au.hist[--au.hist_cursor];sound_apply(t[0])},sound_redo=e=>{const t=au.hist[au.hist_cursor++];sound_apply(t[1])},sound_edit=e=>{au.hist=au.hist.slice(0,au.hist_cursor),au.hist.push([sound_slice(rect(0,au.target.data.length)),e]),sound_redo()},sound_delete=e=>{const t=au.target.data.length,r=au.sel.x==au.sel.y?rect(0,t):rcopy(au.sel),i=[];for(let e=0;e<r.x;e++)i.push(au.target.data[e]);for(let e=0;e<t-r.y;e++)i.push(au.target.data[e+r.y]);sound_edit(sound_make(Uint8Array.from(i))),au.head=au.sel.y=au.sel.x},sound_replace=e=>{r=[];for(let e=0;e<au.sel.x;e++)r.push(au.target.data[e]);for(let t=0;t<e.data.length&&r.length<10*SFX_RATE;t++)r.push(e.data[t]);const t=r.length;for(let e=au.sel.y;e<au.target.data.length&&r.length<10*SFX_RATE;e++)r.push(au.target.data[e]);return au.sel.y=t,au.head=r.length,sound_make(Uint8Array.from(r))},sound_finish=e=>{au.head=au.sel.x!=au.sel.y?au.sel.x:0,sound_undo(),sound_redo(),au.mode="stopped"},sound_begin_record=e=>{stop_sound_pump(),sound_edit(sound_slice(rect(0,au.target.data.length))),au.sel.x!=au.sel.y&&(au.head=au.sel.x),au.mode="recording"},sound_record=e=>{initaudio(),au.record_stream?sound_begin_record():navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{try{const t=audio.createMediaStreamSource(e),r=audio.createScriptProcessor(4096,1,1);r.onaudioprocess=e=>{"recording"==au.mode&&function(e,t){const r=new offline(1,64e3*e.length/e.sampleRate,64e3),i=r.createBufferSource();r.oncomplete=e=>{t(e.renderedBuffer.getChannelData(0))},i.buffer=e,i.connect(r.destination),i.start(0),r.startRendering()}(e.inputBuffer,e=>{const t=[];for(let r=0;r<e.length;r+=8)t.push(sample_to_byte(e[r]));let r=au.head,i=au.sel.x!=au.sel.y?au.sel.y:10*SFX_RATE,l=au.hist[au.hist_cursor-1][1];const s=min(max(au.target.data.length,r+t.length),i);if(s>au.target.data.length){const e=new Uint8Array(s),t=new Uint8Array(s);for(let r=0;r<s;r++)e[r]=t[r]=au.target.data[r];au.target.data=e,l.data=t}for(let e=0;e<t.length&&r<i;e++)au.target.data[r]=l.data[r]=t[e],r++;au.head=r,r>=i&&sound_finish()})},t.connect(r),r.connect(audio.destination),au.record_stream=e,sound_begin_record()}catch(e){console.log(e),au.norecord=1}}).catch(e=>{console.log(e),au.norecord=1})},table_decode=(e,t)=>ms.edit_json?monad.table(dyad.parse(lms("%j"),e)):n_readcsv(count(t)?[e,t]:[e]),transit_enumerate=e=>monad.table(monad.keys(deck.transit)),sounds_enumerate=e=>{const t=lmt(),r=[],i=[],l=[],s=[];return tab_set(t,"icon",r),tab_set(t,"name",i),tab_set(t,"bytes",l),tab_set(t,"secs",s),deck.sounds.v.map((e,t)=>{r.push(lmn(ICON.sound)),i.push(deck.sounds.k[t]),l.push(dyad.format(lms("%.2fkb"),lmn(ln(ifield(e,"size"))/1e3*1.33))),s.push(dyad.format(lms("%.2fs"),ifield(e,"duration")))}),t},fonts_enumerate=e=>{const t=lmt(),r=[],i=[];tab_set(t,"icon",r),tab_set(t,"name",i);let l=-1;return deck.fonts.v.map((e,t)=>{"object"==uimode?ob.sel.every(t=>ifield(t,"font")==e)&&(l=t):ms.old_wid.ft&&ifield(ms.old_wid.ft,"font")==e&&(l=t),r.push(lmn(ICON.font)),i.push(deck.fonts.k[t])}),gridtab(t,l)},contraptions_enumerate=e=>{const t=lmt(),r=[],i=[];return tab_set(t,"icon",r),tab_set(t,"name",i),deck.contraptions.k.map(e=>{r.push(lmn(ICON.app)),i.push(e)}),t},res_enumerate=e=>{const t=lmt(),r=[],i=[],l=[];tab_set(t,"icon",r),tab_set(t,"name",i),tab_set(t,"value",l);const s=e.patterns,n=patterns_write(s),o=anims_write(s),a=dyad.parse(lms("%j"),lms(DEFAULT_ANIMS));match(o,a)&&n==DEFAULT_PATTERNS||(r.push(lmn(ICON.pat)),i.push(lms("patterns")),l.push(s));const d=dyad.drop(lms("mono"),dyad.drop(lms("menu"),dyad.drop(lms("body"),e.fonts)));d.v.map((e,t)=>{r.push(lmn(ICON.font)),i.push(d.k[t]),l.push(e)});const c=e.sounds;c.v.map((e,t)=>{r.push(lmn(ICON.sound)),i.push(c.k[t]),l.push(e)});const A=e.modules;A.v.map((e,t)=>{r.push(lmn(ICON.lil)),i.push(A.k[t]),l.push(e)});const m=e.contraptions;return m.v.map((e,t)=>{r.push(lmn(ICON.app)),i.push(m.k[t]),l.push(e)}),t},title_caps=e=>{let t=1;return e.split("").map(e=>(t&&(e=drom_toupper(e)),t=" "==e||"\n"==e,e)).join("")},do_transition=(e,t,r)=>{let i=frame;ms.canvas.image.size=t.size,ms.canvas.image.pix=t.pix,ms.canvas.image.pix.fill(0),canvas_clip(ms.canvas);const l=lml([ms.canvas,ms.carda,ms.cardb,lmn(e)]),s=lmblk();blk_lit(s,ms.trans),blk_lit(s,l),blk_op(s,op.CALL);const n=lmenv();pushstate(n),issue(n,s);let o=TRANS_QUOTA;for(;o&&running();)runop(),o--;return running()&&r&&(listen_show(ALIGN.right,1,lms(`warning: transition ${ms.trans.n} exceeded quota and was halted.`)),e=2),popstate(),frame=i,sleep_play=0,sleep_frames=0,e},modal_enter=e=>{if(ev.md=ev.mu=ev.dclick=0,menus_clear(),"trans"==ms.type)return;if(ms.from_listener="listen"==ms.type,ms.from_keycaps=kc.on,ms.type=ms.subtype=e,ms.old_wid=wid,wid=wid_state(),ms.drag_offset=rect(),ms.dragging=0,ms.drag_start=rect(),enable_touch&&(wid.active={link:1,gridcell:1,listen:1}[e]?0:-1),"listen"==e){if("script"==uimode)try{const e=ls(rtext_string(sc.f.table));parse(e),script_save(e)}catch(e){listen_show(ALIGN.right,1,lms("note: this script contains an error.\nexecuting under last saved version!"))}ms.text=fieldstr(lms("")),li.scroll=RTEXT_END}if("query"==e&&(ms.grid=gridtab(ms.old_wid.gv.table),ms.text=fieldstr(lms("select from me.value"))),"recording"==e&&(au.head=0,au.sel=rect(),au.mode="stopped",au.hist=[],au.hist_cursor=0,ms.name=fieldstr(dkey(deck.sounds,au.target)||lms("unknown sound"))),"cards"==e&&(ms.grid=gridtab(null)),"orderwids"==e&&(ms.grid=gridtab(null),ms.grid.col=-99),"sounds"==e&&(ms.grid=gridtab(sounds_enumerate())),"contraptions"!=e&&"pick_contraption"!=e||(ms.grid=gridtab(contraptions_enumerate())),"fonts"==e&&(ms.grid=fonts_enumerate(),ms.grid.scroll=-99),"resources"==e&&(ms.message=null,ms.grid=gridtab(lmt()),ms.grid2=gridtab(res_enumerate(deck))),"link"==e){const e=ms.old_wid.fv.table,t=tab_cell(e,"arg",rtext_get(e,ms.old_wid.cursor.y));ms.text=fieldstr(t),count(t)&&(ms.old_wid.cursor=rtext_getr(e,ms.old_wid.cursor.y))}if("grid"==e&&(ms.name=fieldstr(lmn(dr.grid_size.x)),ms.text=fieldstr(lmn(dr.grid_size.y))),"deck_props"==e){ms.name=fieldstr(ifield(deck,"name")),ms.text=fieldstr(ifield(deck,"author"));const e=deck.size||rect(512,342);ms.form0=fieldstr(lms(e.x+"")),ms.form1=fieldstr(lms(e.y+""))}if("resize_deck"==e){const e=deck.size||rect(512,342);ms.form0=fieldstr(lms(e.x+"")),ms.form1=fieldstr(lms(e.y+"")),ms.form2=fieldstr(lms("1")),ms.temp_deck_data=deck_write(deck)}if("button_props"==e&&(ms.name=fieldstr(ifield(ob.sel[0],"name")),ms.text=fieldstr(ifield(ob.sel[0],"text")),ms.form0=fieldstr(ifield(ob.sel[0],"shortcut"))),"autoswitch_settings"==e){autoSwitchState.enabled&&stopAutoSwitch(),0===autoSwitchState.startCard&&(autoSwitchState.startCard=1),0===autoSwitchState.endCard&&(autoSwitchState.endCard=Math.max(1,getCardCount()-5)),3e3===autoSwitchState.uniformInterval&&(autoSwitchState.uniformInterval=100),void 0===autoSwitchState.multiSelect&&(autoSwitchState.multiSelect=!1),autoSwitchState.selectedCards||(autoSwitchState.selectedCards=[]);const e=Math.max(1,autoSwitchState.endCard-autoSwitchState.startCard+1);for(;autoSwitchState.intervals.length<e;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);const t=ifield(deck,"card"),r=ln(ifield(t,"index"));let i=autoSwitchState.uniformInterval;if(r>=autoSwitchState.startCard&&r<=autoSwitchState.endCard){const e=r-autoSwitchState.startCard;i=autoSwitchState.intervals[e]||autoSwitchState.uniformInterval}ms.form0=fieldstr(lms(autoSwitchState.startCard+"")),ms.form1=fieldstr(lms(autoSwitchState.endCard+"")),ms.form2=fieldstr(lms(i+"")),ms.text=fieldstr(lms(autoSwitchState.useUniformInterval?"1":"0"));const l=[];for(let e=autoSwitchState.startCard;e<=autoSwitchState.endCard;e++){const t=e-autoSwitchState.startCard;l.push({index:e,name:`卡片 ${e}`,interval:autoSwitchState.intervals[t]||autoSwitchState.uniformInterval})}ms.grid=gridtab(lt(l.map(e=>[lms(e.name),lms(e.interval+" ms")])))}if("field_props"==e&&(ms.name=fieldstr(ifield(ob.sel[0],"name")),ms.text=fieldstr(ifield(ob.sel[0],"value"))),"grid_props"==e&&(ms.name=fieldstr(ifield(ob.sel[0],"name")),ms.text=fieldstr(ifield(ob.sel[0],"format"))),"grid_props"==e&&(ms.form0=fieldstr(lms(fjson(monad.cols(ifield(ob.sel[0],"value"))))),ms.edit_json=1),"canvas_props"==e){const e=ob.sel[0],t=getpair(ifield(e,"size"));ms.name=fieldstr(ifield(e,"name")),ms.text=fieldstr(ifield(e,"scale")),ms.form0=fieldstr(lms(t.x.toString())),ms.form1=fieldstr(lms(t.y.toString()))}if("slider_props"==e&&(ms.name=fieldstr(ifield(ob.sel[0],"name")),ms.text=fieldstr(ifield(ob.sel[0],"format")),ms.form0=fieldstr(ll(ifield(ob.sel[0],"interval"))[0]),ms.form1=fieldstr(ll(ifield(ob.sel[0],"interval"))[1]),ms.form2=fieldstr(ifield(ob.sel[0],"step"))),"contraption_props"==e){const e=ob.sel[0],t=ifield(e.def,"attributes");ms.name=fieldstr(ifield(e,"name")),attrs=[],attrs_scroll=0,tab_get(t,"name").map((r,i)=>{const l=iwrite(e,r),s={type:ls(tab_cell(t,"type",i)),label:ls(tab_cell(t,"label",i)),bval:0,value:fieldstr("")};"bool"==s.type?s.bval=lb(l):(s.type,s.value.table=rtext_cast(l)),attrs.push(s)})}if("prototype_props"==e){const e=con();ms.name=fieldstr(ifield(e,"name")),ms.form0=fieldstr(ifield(e,"description")),ms.form1=fieldstr(ifield(e,"template")),ms.form2=fieldstr(ifield(e,"version"))}if("prototype_attrs"==e){const e=ifield(con(),"attributes");ms.grid=gridtab(dyad.take(lmn(count(e)),e)),ms.name=fieldstr(lms("")),ms.text=fieldstr(lms(""))}if("pick_card"==e&&(ms.act_card=ln(ifield(ifield(deck,"card"),"index")),ms.carda=ob.sel.slice(0)),"action"==e){sc.target=ob.sel[0],sc.others=[],ms.act_go=1,ms.act_gomode=5,ms.act_trans=0,ms.act_sound=0,ms.verb=lms(""),ms.message=lms(""),ms.grid=gridtab(transit_enumerate(),0),ms.canvas=free_canvas(deck),ms.canvas.size=rect(17,13),ms.carda=image_read("%%IMG0ABEADQAAAAAAAACAAAFAAAIgAAIgAAQQAAfwAAgIAAgIAAgIAAAAAAAAAA=="),ms.cardb=image_read("%%IMG0ABEADf//gP//gPA/gPffgPffgPAPgPf3gPf3gPf3gPf3gPAPgP//gP//gA==");const e=ifield(sc.target,"script"),t=dyad.parse(lms("on click do\n  play[%q]\nend%m"),e),r=dyad.parse(lms("on click do\n  play[%q]\n  go[%q %q]\nend%m"),e),i=dyad.parse(lms("on click do\n  play[%q]\n  go[%q]\nend%m"),e),l=dyad.parse(lms("on click do\n  go[%q %q]\nend%m"),e),s=dyad.parse(lms("on click do\n  go[%q]\nend%m"),e),n=lb(monad.last(t))||lb(monad.last(r))||lb(monad.last(i))?ls(monad.first(t)):null,o=lb(monad.last(r))||lb(monad.last(i))?ls(r.v[1]):lb(monad.last(l))||lb(monad.last(s))?ls(monad.first(l)):null,a=lb(monad.last(r))?ls(r.v[2]):lb(monad.last(l))?ls(l.v[1]):null,d={First:0,Prev:1,Next:2,Last:3,Back:4};null==n&&null==o&&null==a||(null!=n&&(ms.act_sound=1,ms.message=lms(n)),null!=a&&(ms.grid.scroll=-99,tab_get(ms.grid.table,"value").map((e,t)=>{a==ls(e)&&(ms.act_trans=1,ms.grid.row=t)})),ms.act_go=null!=o,null!=o&&(null!=d[o]&&(ms.act_gomode=d[o]),5==ms.act_gomode&&(ms.verb=lms(o))))}const t=(e,t)=>(e=e||"untitled",lms(/\.(deck|html)$/.test(e)?e:e+t));"card_props"==e&&(ms.name=fieldstr(ifield(ifield(deck,"card"),"name"))),"link"!=e&&"gridcell"!=e&&"query"!=e||(wid.cursor=rect(0,RTEXT_END)),"alert_lil"==e&&(ms.type=e="alert"),"confirm_lil"==e&&(ms.type=e="confirm"),"input_lil"==e&&(ms.type=e="input"),"confirm_new"==e&&(ms.type=e="confirm",ms.subtype="confirm_new"),"confirm_script"==e&&(ms.type=e="confirm",ms.subtype="confirm_script"),"multiscript"==e&&(ms.type=e="confirm",ms.subtype="multiscript"),"confirm_transparent_bg"==e&&(ms.type=e="confirm",ms.subtype="confirm_transparent_bg"),"save_deck"==e&&(ms.type=e="save",ms.text=fieldstr(t(deck.name,".deck")),ms.desc=_t("save_deck_desc")),"save_locked"==e&&(ms.type=e="save",ms.text=fieldstr(t(deck.name,".html")),ms.desc=_t("save_locked_desc")),"export_script"==e&&(ms.type=e="save",ms.text=fieldstr(lms("script.lil")),ms.desc=_t("export_script_desc")),"export_image"==e&&(ms.type=e="save",ms.text=fieldstr(lms("image.gif")),ms.desc=_t("export_image_desc")),"save_lil"==e&&(ms.type=e="save",ms.text=fieldstr(lms("untitled.txt")),ms.desc=_t("save_lil_desc")),"input"==e&&(ms.text=fieldstr(lms("")))},modal_exit=e=>{if(wid=ms.old_wid,"gridcell"==ms.type&&e&&grid_edit_cell(ms.cell,rtext_string(ms.text.table)),"card_props"==ms.type&&(iwrite(ifield(deck,"card"),lms("name"),rtext_string(ms.name.table)),mark_dirty()),"grid_props"==ms.type){const e=table_decode(rtext_string(ms.form0.table),rtext_string(ms.text.table));match(e,ifield(ob.sel[0],"value"))||ob_edit_prop("value",e)}if("contraption_props"==ms.type){const e=ob.sel[0],t=ifield(e.def,"attributes");tab_get(t,"name").map((r,i)=>{const l=ls(tab_cell(t,"type",i));let s=lmn(attrs[i].bval);"number"==l&&(s=lmn(ln(rtext_string(attrs[i].value.table)))),"string"==l&&(s=rtext_string(attrs[i].value.table)),"code"==l&&(s=rtext_string(attrs[i].value.table)),"rich"==l&&(s=attrs[i].value.table),iwrite(e,r,s)})}if("action"==ms.type&&e){let e="on click do\n";ms.act_sound&&(e+=`  play[${show(ms.message)}]\n`),ms.act_go&&(e+="  go[",e+=0==ms.act_gomode?'"First"':1==ms.act_gomode?'"Prev"':2==ms.act_gomode?'"Next"':3==ms.act_gomode?'"Last"':4==ms.act_gomode?'"Back"':show(ms.verb),ms.act_trans&&(e+=` ${show(tab_cell(ms.grid.table,"value",ms.grid.row))}`),e+="]\n"),e+="end",script_save(lms(e))}if("recording"==ms.type){const e=rtext_string(ms.name.table);return rename_sound(deck,au.target,e),au.mode="stopped",modal_enter("sounds"),void(ms.grid.row=dkix(deck.sounds,e))}if("confirm_new"==ms.subtype&&e&&load_deck(deck_read("")),"confirm_script"==ms.subtype&&e&&finish_script(),"multiscript"==ms.subtype&&e&&setscript(ob.sel),"confirm_transparent_bg"==ms.subtype&&ms.pending_gif_frames&&ms.pending_gif_delays){try{const t="all_wiggler.gif",r=1==e,i=writegif(ms.pending_gif_frames,ms.pending_gif_delays,r);save_bin(t,i)}catch(e){console.error("Error saving all wiggler GIF:",e)}ms.pending_gif_frames=null,ms.pending_gif_delays=null}"alert_lil"==ms.subtype&&(arg(),ret(lmn(e))),"confirm_lil"==ms.subtype&&(arg(),ret(lmn(e))),"input_lil"==ms.subtype&&(arg(),ret(rtext_string(ms.text.table))),"choose_lil"==ms.subtype&&(arg(),ret(ms.verb.v[ms.grid.row])),ms.type=null,ms.from_listener&&modal_enter("listen"),enable_touch&&ms.from_keycaps&&(kc.on=1),null==ms.type&&"interact"==uimode&&(msg.next_view=1)},modals=e=>{ms.in_modal=1;const t=deck.patterns.pal.pix;if("about"==ms.type){const e=draw_modalbox(rect(200,100));(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0),draw_text(e,`Decker v${VERSION}`,FONT_MENU,1),e.y+=15,draw_text(e,_t("about_author"),FONT_BODY,1),e.y+=12,draw_text(e,_t("about_website"),FONT_BODY,1),e.y+=13,draw_text(e,_t("translation_credit"),FONT_MENU,1),e.y+=15,draw_text(e,"雪风与梦",FONT_MENU,1),e.y+=15,draw_text(e,"角赤pulupo",FONT_MENU,1),e.y+=15}else if("listen"==ms.type)kc.on||(listener(rect(0,0,frame.size.x,frame.size.y)),ev.eval&&listener_eval()),ev.exit&&modal_exit(0);else if("cards"==ms.type){const e=draw_modalbox(rect(210,frame.size.y-46)),r=rect(e.x,e.y+15,e.w,e.h-20-20),i=30,l=i*count(deck.cards);let s=0,n=0,o=-1,a=ifield(deck,"card");draw_textc(rect(e.x,e.y-5,e.w,20),_t("cards"),FONT_MENU,1),draw_box(r,0,1);const d=scrollbar(r,max(0,l-(r.h-2)),10,r.h,ms.grid.scroll,l>=r.h,0),c=d.size;ms.grid.scroll=d.scroll,c.y++;const A=frame.clip;frame.clip=c;for(let e=0;e<count(deck.cards);e++){const r=rect(c.x,c.y+e*i-ms.grid.scroll,c.w,i),l=deck.cards.v[e];if(r.y>c.y+c.h||r.y+r.h<c.y)continue;const d=rclip(r,c),A=rect(r.x+2,r.y+1,40,28),m=rect(A.x+A.w+5,A.y,c.w-(2+A.w+5+5),font_h(FONT_MENU)),_=rect(m.x,m.y+m.h+2,m.w,font_h(FONT_BODY));ev.md&&dover(d)&&(s=1,n_go([l],deck),a=l,ms.grid.row=e),ev.dclick&&over(d)&&(n=1);const u=ev.drag&&ms.grid.row==e?13:1;if(draw_text_fit(m,ls(ifield(l,"name")),FONT_MENU,u),draw_text_fit(_,`${count(l.widgets)} widget${1==count(l.widgets)?"":"s"}`,FONT_BODY,u),draw_box(A,0,u),l==a&&1==u&&draw_invert(t,r),draw_thumbnail(l,A),(ev.drag||ev.mu)&&-1!=ms.grid.row){{const t=rect(r.x,r.y-3,r.w,7);over(t)&&(draw_hline(r.x,r.x+r.w,r.y,13),o=e)}{const t=rect(r.x,r.y-3+r.h,r.w,7);over(t)&&(draw_hline(r.x,r.x+r.w,r.y+r.h-1,13),o=e+1)}}}frame.clip=A,(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit||ev.action)&&modal_exit(0);const m=rect(e.x,e.y+e.h-20);if(ui_button(rect(m.x,m.y,60,20),_t("new"),1)){const e=deck_add(deck,lms("card")),t=ln(ifield(a,"index"));iwrite(e,lms("index"),lmn(t+1)),s=1,n_go([e],deck)}if(m.x+=65,ev.mu){if(-1!=ms.grid.row&&-1!=o){const e=deck.cards.v[ms.grid.row],t=ln(ifield(e,"index"));iwrite(e,lms("index"),lmn(o>t?o-1:o)),s=1,n_go([e],deck)}ms.grid.row=-1}else if(ev.drag&&-1!=ms.grid.row){const e=rect(ev.pos.x-5,ev.pos.y-5,10,10);draw_rect(e,0),draw_box(e,0,1),uicursor=cursor.drag}else"up"==ev.dir&&ev.shift?(iwrite(a,lms("index"),lmn(ln(ifield(a,"index"))-1)),s=1,n_go([a],deck)):"down"==ev.dir&&ev.shift?(iwrite(a,lms("index"),lmn(ln(ifield(a,"index"))+1)),s=1,n_go([a],deck)):"left"==ev.dir||"up"==ev.dir?(s=1,n_go([lms("Prev")],deck)):"right"!=ev.dir&&"down"!=ev.dir||(s=1,n_go([_tlms("next_card")],deck));if(s){a=ifield(deck,"card");const e=ln(ifield(a,"index"))*i-ms.grid.scroll;e<0&&(ms.grid.scroll+=e),e+i>=c.h&&(ms.grid.scroll+=e+i-c.h)}n&&modal_enter("card_props")}else if("orderwids"==ms.type){const e=draw_modalbox(rect(210,frame.size.y-46)),r=con(),i=ll(ifield(r,"widgets"));draw_textc(rect(e.x,e.y-5,e.w,20),_t("widget_order"),FONT_MENU,1);const l=rect(e.x,e.y+15,e.w,e.h-20-20),s=16,n=s*i.length;let o=-99==ms.grid.col?-1:0,a=0,d=-1;draw_box(l,0,1);const c=scrollbar(l,max(0,n-(l.h-2)),10,l.h,ms.grid.scroll,n>=l.h,0),A=c.size;ms.grid.scroll=c.scroll,A.y++;const m=frame.clip;frame.clip=A;for(let e=0;e<i.length;e++){const r=rect(A.x,A.y+e*s-ms.grid.scroll,A.w,s),l=i[e];if(r.y>A.y+A.h||r.y+r.h<A.y)continue;const n=rclip(r,A);ev.dclick&&over(n)&&(a=1),ev.md&&dover(n)&&(ev.shift?ob.sel.indexOf(l)>=0?(ob.sel=ob.sel.filter(e=>e!=l),a=0):ob.sel.push(l):(object_select(l),ms.grid.row=e));const o=ev.drag&&ms.grid.row==e?13:1;if(draw_text_fit(rect(r.x+3,r.y+2,A.w-6,font_h(FONT_BODY)),ls(ifield(l,"name")),FONT_BODY,o),ls(ifield(l,"script")).length){const e=rect(r.x+r.w-13,r.y+2,12,12);draw_rect(rect(e.x+2,e.y+1,e.w-2,e.h-2),0),draw_icon(e,ICONS[ICON.lil],1)}if(ob.sel.indexOf(l)>=0&&draw_invert(t,r),(ev.drag||ev.mu)&&-1!=ms.grid.row){{const t=rect(r.x,r.y-3,r.w,7);over(t)&&(draw_hline(r.x,r.x+r.w,r.y,13),d=e)}{const t=rect(r.x,r.y-3+r.h,r.w,7);over(t)&&(draw_hline(r.x,r.x+r.w,r.y+r.h-1,13),d=e+1)}}}frame.clip=m,(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0);const _=rect(e.x,e.y+e.h-20);if((ui_button(rect(_.x,_.y,80,20),_t("properties"),1==ob.sel.length)||a)&&ob.sel.length&&object_properties(ob.sel[0]),ev.mu){if(-1!=ms.grid.row&&-1!=d){const e=i[ms.grid.row],t=ln(ifield(e,"index"));iwrite(e,lms("index"),lmn(d>t?d-1:d)),o=1,object_select(e)}ms.grid.row=-1}else if(ev.drag&&-1!=ms.grid.row){const e=rect(ev.pos.x-5,ev.pos.y-5,10,10);draw_rect(e,0),draw_box(e,0,1),uicursor=cursor.drag}else ev.shift&&"up"==ev.dir?(ob_move_dn(),o=-1):ev.shift&&"down"==ev.dir?(ob_move_up(),o=1):ob.sel.length&&"up"==ev.dir?(ob_order(),object_select(i[mod(ln(ifield(ob.sel[0],"index"))-1,i.length)]),o=-1):ob.sel.length&&"down"==ev.dir&&(ob_order(),object_select(i[mod(ln(ifield(ob.sel[ob.sel.length-1],"index"))+1,i.length)]),o=1);if(0!=o&&ob.sel.length){ms.grid.col=-1,ob_order();const e=-1==o?ob.sel[0]:ob.sel[ob.sel.length-1],t=ln(ifield(e,"index"))*s-ms.grid.scroll;t<0&&(ms.grid.scroll+=t),t+s>=A.h&&(ms.grid.scroll+=t+s-A.h)}}else if("sounds"==ms.type){const e=20,t=5,r=draw_modalbox(rect(250,frame.size.y-16-30)),i=rect(r.x,r.y+15,r.w,r.h-16-50-e-t);draw_textc(rect(r.x,r.y-5,r.w,20),_t("sounds"),FONT_MENU,1);const l=ms.grid.row>=0?dget(deck.sounds,tab_cell(ms.grid.table,"name",ms.grid.row)):null;ui_table(i,[16,130],"Isss",ms.grid)&&n_play([l]);{const l={size:rint(rect(r.x,i.y+i.h+t,r.w,e)),font:FONT_BODY,show:"solid",locked:0,value:sfx_volume_percent,min:SFX_VOLUME_MIN,max:SFX_VOLUME_MAX,step:1,style:"bar",format:`${_t("volume")}: %0.0f%%`};widget_slider(null,l);const s=0|l.value;if(s!=sfx_volume_percent){sfx_volume_percent=s;try{localStorage.setItem("wpaint_sfx_volume_percent",""+s)}catch(e){}}}(ui_button(rect(r.x+r.w-60,r.y+r.h-20,60,20),_t("ok"),1)||ev.exit)&&(ms.from_action?(ms.grid.row>=0&&(ms.message=deck.sounds.k[ms.grid.row]),ms.grid=gridtab(transit_enumerate(),ms.act_transno),ms.type="action",ms.from_action=0):modal_exit(1));const s=rect(r.x,r.y+r.h-20);ui_button(rect(s.x,s.y,60,20),_t("edit")+"...",null!=l)&&(au.target=l,modal_enter("recording")),ui_button(rect(s.x,s.y-25,60,20),_t("new")+"...",1)&&(au.target=deck_add(deck,lms("sound")),mark_dirty(),modal_enter("recording")),s.x+=65,ui_button(rect(s.x,s.y,60,20),_t("delete"),null!=l)&&(deck_remove(deck,l),mark_dirty(),ms.grid=gridtab(sounds_enumerate()))}else if("recording"==ms.type){const e=draw_modalbox(rect(frame.size.x-50,130)),r=max(1,ln(ifield(au.target,"size")));draw_textc(rect(e.x,e.y-5,e.w,20),_t("audio_editor"),FONT_MENU,1),au.head=clamp(0,au.head,r),au.sel.x=clamp(0,au.sel.x,r),au.sel.y=clamp(0,au.sel.y,r);const i=rect(e.x,e.y+15,e.w,64),l=rint(rect(e.x,i.y+i.h+2,e.w/2,font_h(FONT_BODY))),s=e=>0|e*(1*i.w/r),n=e=>0|max(0,min(r-1,e/i.w*r));if((ev.mu||ev.drag)&&dover(i)&&"stopped"==au.mode){const e=n(ev.dpos.x-i.x),t=n(ev.pos.x-i.x);field_exit(),ev.mu&&(au.head=t),ev.drag&&(au.sel=rect(min(e,t),max(e,t)),au.head=au.sel.x)}const o=au.sel,a=o.y-o.x,d=frame.clip;frame.clip=i;for(let e=0;e<i.w;e++){let t=0,l=n(e);for(let e=-1;e<=1;e++){if(l+e<0||l+e>=r)continue;let i=byte_to_sample(au.target.data[l+e]);Math.abs(i)>Math.abs(t)&&(t=i)}let s=0|64*t;draw_vline(i.x+e,i.y+32,i.y+32+s,1),draw_vline(i.x+e,i.y+32-s,i.y+32,1)}frame.clip=d,a&&draw_invert(t,rect(i.x+s(o.x),i.y,s(o.y)-s(o.x),i.h)),draw_invert(t,rect(i.x+s(au.head)-1,i.y,3,i.h)),draw_box(i,0,1);const c=0==a?ls(dyad.format(lms("%0.2fkb, %0.2fs"),lml([lmn(r/1e3*1.33),ifield(au.target,"duration")]))):ls(dyad.format(lms("%0.2fkb, %0.2fs selected"),lml([lmn(a/1e3*1.33),lmn(a/SFX_RATE)])));draw_text_fit(l,c,FONT_BODY,1),(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0);const A=rect(e.x,e.y+e.h-20);ui_toggle(rect(A.x,A.y,60,20),_t("play"),"playing"==au.mode,1)&&("recording"==au.mode&&sound_finish(),au.head=a?au.sel.x:0,"playing"==au.mode?stop_sound_pump():play_sound_pump(sound_selected())),A.x+=65,ui_toggle(rect(A.x,A.y,60,20),_t("record"),"recording"==au.mode,!au.norecord)&&("recording"==au.mode?sound_finish():sound_record()),A.x+=65,ui_button(rect(A.x,A.y,60,20),"Crop",a&&"stopped"==au.mode)&&(sound_edit(sound_slice(au.sel)),au.sel=rect(),au.head=0),draw_text(rect(e.x+e.w/2,i.y+i.h+9,37,20),_t("name"),FONT_MENU,1),ui_field(rint(rect(e.x+e.w/2+37,i.y+i.h+5,e.w/2-37,20)),ms.name)}else if("fonts"==ms.type){const e=draw_modalbox(rect(170,170));draw_textc(rect(e.x,e.y-5,e.w,20),_t("fonts"),FONT_MENU,1);const t=rect(e.x,e.y+15,e.w,e.h-20-50-25);-99==ms.grid.scroll&&(ms.grid.scroll=grid_scrollto(ms.grid.table,{size:t,font:FONT_BODY,headers:0},-1,ms.grid.row));const r=ui_table(t,[16],"Is",ms.grid);let i=rect(e.x,t.y+t.h+5,e.w,50);if(draw_box(i,0,1),i=inset(i,2),ms.grid.row>=0){const e=layout_plaintext(PANGRAM,deck.fonts.v[ms.grid.row],ALIGN.left,rect(i.w,i.h));draw_text_wrap(i,e,1)}const l=rect(e.x+e.w-60,e.y+e.h-20);if(ui_button(rect(l.x,l.y,60,20),_t("ok"),ms.grid.row>=0)||r){const e=tab_cell(ms.grid.table,"name",ms.grid.row),t=ms_stack.length>0;if(modal_pop(1),"object"!=uimode||t)if(wid.fv&&wid.cursor.x!=wid.cursor.y){const t=wid.cursor;field_stylespan(e,lms("")),wid.cursor=t,mark_dirty()}else wid.ft&&(iwrite(wid.ft,lms("font"),e),wid.f=unpack_field(ms.old_wid.ft),wid.fv=unpack_field_value(ms.old_wid.ft),mark_dirty());else ob_edit_prop("font",e)}l.x-=65,(ui_button(rect(l.x,l.y,60,20),_t("cancel"),1)||ev.exit)&&modal_pop(0)}else if("contraptions"==ms.type||"pick_contraption"==ms.type){const e=draw_modalbox(rect(250,230));draw_textc(rect(e.x,e.y-5,e.w,20),"contraptions"==ms.type?_t("contraption_prototype"):_t("new_contraption"),FONT_MENU,1);const t=rect(e.x,e.y+15,e.w,e.h-20-50-25-("contraptions"==ms.type?25:0)),r=ui_table(t,[16],"Is",ms.grid);let i=rect(e.x,t.y+t.h+5,e.w,50);if(draw_box(i,0,1),i=inset(i,2),ms.grid.row>=0){const e=ls(ifield(deck.contraptions.v[ms.grid.row],"description")),t=layout_plaintext(e,FONT_BODY,ALIGN.left,rect(i.w,i.h));draw_text_wrap(i,t,1)}const l=rect(e.x+e.w-60,e.y+e.h-20);if("contraptions"==ms.type){if((ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0),ui_button(rect(e.x,e.y+e.h-45,60,20),_t("new")+"...",1)&&(modal_exit(1),con_set(deck_add(deck,lms("contraption"))),mark_dirty()),(ui_button(rect(e.x,e.y+e.h-20,60,20),_t("edit")+"...",ms.grid.row>=0)||r)&&(modal_exit(2),con_set(deck.contraptions.v[ms.grid.row])),ui_button(rect(e.x+65,e.y+e.h-45,60,20),_t("clone"),ms.grid.row>=0)){const e=ifield(deck,"contraptions").v[ms.grid.row];deck_add(deck,e,lms(ls(ifield(e,"name"))+"_clone")),ms.grid=gridtab(contraptions_enumerate())}ui_button(rect(e.x+65,e.y+e.h-20,60,20),_t("delete"),ms.grid.row>=0)&&(deck_remove(deck,ifield(deck,"contraptions").v[ms.grid.row]),ms.grid=gridtab(contraptions_enumerate()))}"pick_contraption"==ms.type&&((ui_button(rect(l.x,l.y,60,20),_t("create"),ms.grid.row>=0)||r)&&(ob_create([lmd(["type","def"].map(lms),[lms("contraption"),tab_cell(ms.grid.table,"name",ms.grid.row)])]),modal_exit(1)),l.x-=65,(ui_button(rect(l.x,l.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0))}else if("contraption_props"==ms.type){const e=draw_modalbox(rect(240,240)),t=ob.sel[0];draw_textc(rect(e.x,e.y-5,e.w,20),_t("contraption_properties",{name:title_caps(t.def.name)}),FONT_MENU,1),draw_text(rect(e.x,e.y+22,47,20),_t("name"),FONT_MENU,1),ui_field(rect(e.x+47,e.y+20,e.w-47,18),ms.name),iwrite(t,lms("name"),rtext_string(ms.name.table)),mark_dirty(),widget_attributes(rect(e.x,e.y+42,e.w,e.h-42-25));const r=rect(e.x,e.y+e.h-20);ui_button(rect(r.x,r.y,60,20),_t("script"),1)&&(modal_exit(0),setscript(t)),r.x+=65,ui_button(rect(r.x,r.y,80,20),_t("prototype"),1)&&(modal_exit(1),con_set(t.def)),(ui_button(rect(e.x+e.w-60,r.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("prototype_props"==ms.type){const e=draw_modalbox(rect(220,230)),t=con(),r=67;draw_textc(rect(e.x,e.y-5,e.w,20),_t("prototype_properties"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,r,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,r,20),_t("version"),FONT_MENU,1),draw_text(rect(e.x,e.y+62,r,20),_t("description"),FONT_MENU,1),draw_text(rect(e.x,e.y+122,r,20),_t("template_script"),FONT_MENU,1),ui_field(rect(e.x+r,e.y+20,e.w-r,18),ms.name),ui_field(rect(e.x+r,e.y+40,e.w-r,18),ms.form2),ui_textedit(rect(e.x+r,e.y+60,e.w-r,58),1,ms.form0),ui_codeedit(rect(e.x+r,e.y+120,e.w-r,78),1,ms.form1),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("version"),rtext_string(ms.form2.table)),iwrite(t,lms("description"),rtext_string(ms.form0.table)),iwrite(t,lms("template"),rtext_string(ms.form1.table)),mark_dirty();const i=rect(e.x,e.y+e.h-20);ui_button(rect(i.x,i.y,60,20),_t("script"),1)&&(modal_exit(1),setscript(t)),i.x+=65,(ui_button(rect(e.x+e.w-60,i.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0)}else if("prototype_attrs"==ms.type){const e=draw_modalbox(rect(220,200)),t=con(),r=42;draw_textc(rect(e.x,e.y-5,e.w,20),`${title_caps(t.name)} 特性`,FONT_MENU,1);const i=rect(e.x,e.y+20,80,e.h-45),l=ms.grid.row;ui_table(i,[i.w-18],"s",ms.grid),l==ms.grid.row&&null!=ms.name.table&&null!=ms.text.table||(ms.name=fieldstr(ms.grid.row>=0?tab_cell(ms.grid.table,"name",ms.grid.row):lms("")),ms.text=fieldstr(ms.grid.row>=0?tab_cell(ms.grid.table,"label",ms.grid.row):lms("")));const s=ms.grid.row>=0;draw_text(rect(i.x+i.w+10,e.y+20+2,r,20),_t("name"),FONT_MENU,1),draw_text(rect(i.x+i.w+10,e.y+40+2,r,20),_t("label"),FONT_MENU,1),draw_text(rect(i.x+i.w+10,e.y+60+2,r,20),_t("type"),FONT_MENU,1),ui_dfield(rect(i.x+i.w+5+r,e.y+20,e.w-(r+5+i.w),18),s,ms.name),ui_dfield(rect(i.x+i.w+5+r,e.y+40,e.w-(r+5+i.w),18),s,ms.text),s&&(tab_get(ms.grid.table,"name")[ms.grid.row]=rtext_string(ms.name.table),tab_get(ms.grid.table,"label")[ms.grid.row]=rtext_string(ms.text.table));const n=rect(i.x+i.w+5+r,e.y+62),o=rect(e.x,e.y+e.h-20),a=["bool","number","string","code","rich"],d=[_t("attr_boolean"),_t("attr_number"),_t("attr_string"),_t("attr_code"),_t("attr_richtext")],c=s?ls(tab_cell(ms.grid.table,"type",ms.grid.row)):"";for(let t=0;t<a.length;t++,n.y+=16)ui_radio(rect(n.x,n.y,e.w-(r+5+i.w),16),d[t],s,c==a[t])&&(tab_get(ms.grid.table,"type")[ms.grid.row]=lms(a[t]));ui_button(rect(o.x,o.y,60,20),_t("add"),1)&&(tab_get(ms.grid.table,"name").push(lms("untitled")),tab_get(ms.grid.table,"label").push(lms("")),tab_get(ms.grid.table,"type").push(lms("bool")),ms.grid.row=count(ms.grid.table)-1,ms.name.table=null,ms.text.table=null),o.x+=65,ui_button(rect(o.x,o.y,60,20),_t("remove"),s)&&(ms.grid.table=dyad.drop(lml([lmn(ms.grid.row)]),ms.grid.table),ms.grid.row=-1,ms.name.table=null,ms.text.table=null),(ui_button(rect(e.x+e.w-60,o.y,60,20),_t("ok"),1)||ev.exit)&&(iwrite(t,lms("attributes"),ms.grid.table),mark_dirty(),modal_exit(1))}else if("resources"==ms.type){const e=draw_modalbox(rect(380,190));draw_textc(rect(e.x,e.y-5,e.w,20),_t("font_deck_mover"),FONT_MENU,1);const t=rect(e.x,e.y+15,120,e.h-55),r=rect(e.x+e.w-t.w,t.y,t.w,t.h);(ui_button(rect(r.x+(r.w-80)/2,e.y+e.h-20,80,20),_t("ok"),1)||ev.exit)&&modal_exit(0),ui_table(t,[16,t.w-38],"Is",ms.grid),ms.grid.row>-1&&(ms.grid2.row=-1),ui_table(r,[16,r.w-38],"Is",ms.grid2),ms.grid2.row>-1&&(ms.grid.row=-1),draw_vline(t.x+t.w,t.y+t.h+5,e.y+e.h,18),draw_vline(r.x,r.y+r.h+5,e.y+e.h,18),draw_textc(rect(t.x,t.y+t.h+3,t.w,15),ms.message?ls(ifield(ms.message,"name")):"(选择一个卡组)",FONT_BODY,1),draw_textc(rect(r.x,r.y+r.h+3,r.w,15),ls(ifield(deck,"name")),FONT_BODY,1);const i=rect(t.x+t.w+5,t.y+5,e.w-(t.w+5+5+r.w),20),l=(e,t)=>tab_cell(e.table,t,e.row);let s=ms.grid.table&&ms.grid.row>-1?l(ms.grid,"value"):ms.grid2.row>-1?l(ms.grid2,"value"):null,n=">> 复制 >>",o=1;if(ms.grid.row>-1&&s&&(module_is(s)||prototype_is(s))){const e=ifield(s,"name");let t=ln(ifield(s,"version")),r=t;if(o=0,module_is(s)){const t=dget(deck.modules,e);t?r=ln(ifield(t,"version")):o=1}if(prototype_is(s)){const t=dget(deck.contraptions,e);t?r=ln(ifield(t,"version")):o=1}t>r&&(o=1,n=">> 升级 >>"),t<r&&(o=1,n=">> 降级 >>")}if(ui_button(i,n,o&&ms.grid.row>-1)){if(patterns_is(s)){const e=ifield(deck,"patterns");for(let t=2;t<=47;t++)iindex(e,t,iindex(s,t))}else module_is(s)||prototype_is(s)?deck_add(deck,s):deck_add(deck,s,l(ms.grid,"name"));ms.grid2=gridtab(res_enumerate(deck)),mark_dirty(),module_is(s)&&validate_modules()}i.y+=25,ui_button(i,_t("remove"),ms.grid2.row>-1)&&(deck_remove(deck,l(ms.grid2,"value")),ms.grid2=gridtab(res_enumerate(deck)),mark_dirty(),s=null),i.y+=25;const a=rect(i.x,i.y,i.w,e.h-(i.y-e.y));if(s&&font_is(s)){draw_textc(rect(a.x,a.y+a.h-18,a.w,18),count(ifield(s,"glyphs"))+" 字形",FONT_BODY,1),a.h-=20;const e=layout_plaintext(PANGRAM,s,ALIGN.center,rect(a.w,a.h));draw_text_wrap(a,e,1)}if(s&&(module_is(s)||prototype_is(s))){draw_textc(rect(a.x,a.y+a.h-18,a.w,18),ls(dyad.format(lms("version %f"),ifield(s,"version"))),FONT_BODY,1),a.h-=20;const e=layout_plaintext(ls(ifield(s,"description")),FONT_BODY,ALIGN.center,rect(a.w,a.h));draw_text_wrap(a,e,1)}if(s&&sound_is(s)&&ui_button(i,_t("play"),1)&&n_play([s]),s&&patterns_is(s)){const e=frame.clip,t=s.pal.pix;frame.clip=a;const r=(e,t)=>(0|(e+t+(0|frame_count/2))/3)%2?15:0,i=(e,r,i)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(t,e,r,i),l=(e,t,l)=>e==ANTS?r(t,l):e>47?0:e>31?e-32:i(e,t,l)?15:0;for(let e=0;e<32;e++)for(let t=0;t<16;t++)for(let r=0;r<16;r++){const i=rect(3+r+a.x+e%(0|a.w/16)*16,t+a.y+16*(0|e/(0|a.w/16)));inclip(i)&&pix(i,32+l(e,r,t))}frame.clip=e}ui_button(rint(rect(t.x+(t.w-80)/2,e.y+e.h-20,80,20)),_t("choose"),1,e=>open_text(".html,.deck",e=>{ms.message=deck_read(e),ms.grid=gridtab(res_enumerate(ms.message))}))}else if("query"==ms.type){const e=draw_modalbox(rect(frame.size.x-30,frame.size.y-16-30)),t=ms.grid.table,r=t?_t("query_result",{cols:tab_cols(t).length,cols_plural:1==tab_cols(t).length?"":"s",rows:count(t),rows_plural:1==count(t)?"":"s"}):_t("executing_query");let i=0,l=" ";try{parse(ls(rtext_string(ms.text.table))),i=1}catch(e){l=e.x}const s=font_textsize(FONT_BODY,r);draw_text(e,r,FONT_BODY,1);const n=font_textsize(FONT_BODY,l),o=rint(rect(e.x,e.y+s.y,e.w,(e.h-10-s.y-20)/2)),a=rect(e.x,o.y+o.h+5,e.w,o.h-n.y);ui_codeedit(a,1,ms.text),i||draw_text_fit(rect(e.x,a.y+a.h,e.w,n.y),l,FONT_BODY,1);const d=rect(e.x+e.w-60,e.y+e.h-20);if(ui_button(rect(d.x,d.y,60,20),_t("run"),i)||ev.eval)try{const e=parse(ls(rtext_string(ms.text.table)));blk_opa(e,op.BUND,1),blk_lit(e,lmnat(n_post_query)),blk_op(e,op.SWAP),blk_op(e,op.CALL),fire_hunk_async(ms.old_wid.gt,e),ms.grid=gridtab(null)}catch(e){console.log(e)}if(d.x-=65,ui_button(rect(d.x,d.y,60,20),_t("apply"),null!=ms.grid.table&&ms.grid.table!=ms.old_wid.gv.table&&!ms.old_wid.g.locked)){const e=ms.grid.table;modal_exit(0),grid_edit(e),listen_show(ALIGN.right,1,lms("applied table query:")),listen_show(ALIGN.left,1,rtext_string(ms.text.table))}d.x-=65,(ui_button(rect(d.x,d.y,60,20),_t("close"),1)||ev.exit)&&modal_exit(0),ms.grid.table?widget_grid(null,{size:o,font:FONT_MONO,widths:[],format:"",headers:1,scrollbar:1,lines:1,bycell:0,show:"solid",locked:1},ms.grid):(draw_box(o,0,1),draw_textc(o,_t("working"),FONT_BODY,1))}else if("url"==ms.type){const e=draw_modalbox(rect(200,90));draw_textc(rect(e.x,e.y,e.w,20),_t("open_url_prompt"),FONT_BODY,1),ui_textedit(rect(e.x,e.y+20+5,e.w,40),1,ms.text);const t=rect(e.x+e.w-(e.w-125)/2-60,e.y+e.h-20);ui_button(rect(t.x,t.y,60,20),_t("open"),1,e=>{open_url(ls(rtext_string(ms.text.table))),modal_exit(0)}),t.x-=65,(ui_button(rect(t.x,t.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0)}else if("link"==ms.type){const e=draw_modalbox(rect(230,70));draw_textc(rect(e.x,e.y,e.w,20),kc.heading=_t("enter_link"),FONT_BODY,1),ui_field(rect(e.x,e.y+20+5,e.w,20),ms.text);const t=rect(e.x+e.w-60,e.y+e.h-20);ui_button(rect(t.x,t.y,60,20),_t("ok"),1)&&modal_pop(1),t.x-=65,(ui_button(rect(t.x,t.y,60,20),_t("cancel"),1)||ev.exit)&&modal_pop(0),ui_button(rect(e.x,t.y,60,20),_t("cards_menu"),1)&&modal_push("pick_card")}else if("gridcell"==ms.type){const e=ms.pending_grid_cell;draw_rect(inset(e,-2),32),draw_box(inset(e,-2),0,1),ui_field(e,ms.text),ev.click&&!over(e)&&modal_exit(1),ev.exit&&modal_exit(0)}else if("save"==ms.type){const e=layout_plaintext(ms.desc,FONT_BODY,ALIGN.center,rect(250,100)),r=draw_modalbox(radd(e.size,rect(0,70))),i=rect(r.x,r.y+20,r.w,e.size.y);draw_textc(rect(r.x,r.y-5,r.w,20),_t("save_file"),FONT_MENU,1),draw_text_wrap(i,e,1),draw_text(rect(r.x,i.y+i.h+7,56,20),_t("filename"),FONT_MENU,1),ui_field(rect(r.x+56,i.y+i.h+5,r.w-56,18),ms.text);const l=rect(r.x+r.w-60,r.y+r.h-20),s=ms.subtype;ui_button(rect(l.x,l.y,60,20),_t("save"),1,e=>{const r=ls(rtext_string(ms.text.table)),i=e=>{save_deck(r,deck),dirty=0};if("save_deck"==s&&i(),"save_locked"==s&&(iwrite(deck,lms("locked"),ONE),i(),iwrite(deck,lms("locked"),ZERO)),"export_script"==s&&save_text(r,ls(rtext_string(sc.f.table))),"export_image"==s&&(()=>{if(bg_has_sel()){const e=rcopy(dr.sel_here);bg_end_selection(),dr.sel_here=e}let e=draw_con(con(),1),i=rect(),l=1,s=0,n=dr.trans?0:32,o=[];const a=deck.patterns.anim,d=(e,t,r,i)=>e<28||e>31?e:a[e-28][i%max(1,a[e-28].length)],c=(e,r,i)=>e<2?e?1:0:e>31?32==e?0:1:1&t[r%8+i%8*8+64*e];if(bg_has_sel()||bg_has_lasso()){const t=rclip(dr.sel_here,con_dim());e=image_copy(e,t),i=rcopy(t)}for(let e=0;e<4&&dr.show_anim;e++){const t=a[e].length;t&&(l=lcm(l,t))}for(let t=0;t<l;t++){const r=image_copy(e);for(let l=0;l<e.size.y;l++)for(let o=0;o<e.size.x;o++){const a=r.pix[o+e.size.x*l];a>=28&&a<=31&&(s=1);const A=d(a,0,0,t),m=c(A,o+i.x,l+i.y);r.pix[o+e.size.x*l]=A>=32?A:m?1:n}o.push(bg_has_lasso()?image_mask(r,dr.mask):r)}save_bin(r,writegif(s?o:[o[0]],s?o.map(e=>10):[10]))})(),"save_lil"==s){let e=ms.verb;arg(),ret(ONE);let t=image_is(e)?[e]:lid(e)?ll(dget(e,lms("frames"))||lml([])):lil(e)?ll(e):[],i=image_is(e)?lml([]):lid(e)&&dget(e,lms("delays"))||lml([]),l=[],s=[];t.map((e,t)=>{image_is(e)&&(l.push(e),s.push(0|clamp(1,lil(i)?t>=count(i)?3:ln(i.v[t]):ln(i),65535)))}),(lil(e)||lid(e)||image_is(e))&&t.length?save_bin(r,writegif(l,s)):sound_is(e)?save_bin(r,writewav(e)):array_is(e)?save_bin(r,writearray(e)):deck_is(e)?save_deck(r,e):save_text(r,ls(e))}})&&modal_exit(1),l.x-=65,(ui_button(rect(l.x,l.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0)}else if("alert"==ms.type){const e=draw_modal_rtext(rect(0,25));(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0)}else if("confirm"==ms.type){const e=draw_modal_rtext(rect(0,25)),t=ms.verb?ls(ms.verb):_t("ok"),r=font_textsize(FONT_MENU,t);r.x=min(max(60,r.x+10),135);const i=rect(e.x+e.w-r.x,e.y+e.h-20);ui_button(rect(i.x,i.y,r.x,20),t,1)&&modal_exit(1);const l=ms.cancel_text?ls(ms.cancel_text):_t("cancel"),s=font_textsize(FONT_MENU,l),n=min(max(60,s.x+10),i.x-5);i.x-=n+5,(ui_button(rect(i.x,i.y,n,20),l,1)||ev.exit)&&modal_exit(0)}else if("input"==ms.type){const e=draw_modal_rtext(rect(0,50));ui_field(rect(e.x,e.y+e.h-45,e.w,20),ms.text),(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),1)||ev.exit)&&modal_exit(0)}else if("choose_lil"==ms.type){const e=draw_modal_rtext(rect(0,110)),t=ui_table(rect(e.x,e.y+e.h-105,e.w,80),[],"s",ms.grid);(ui_button(rect(e.x+e.w-60,e.y+e.h-20,60,20),_t("ok"),ms.grid.row>=0)||t)&&modal_exit(1)}else if("open_lil"==ms.type){const e=draw_modalbox(rect(125,45));draw_textc(rect(e.x,e.y,e.w,16),ms.prompt||_t("click_to_open"),FONT_BODY,1);const t=rect(e.x+e.w-60,e.y+e.h-20);ui_button(rect(t.x,t.y,60,20),_t("open"),1,e=>{"array"==ls(ms.verb)?open_file(ms.filter,e=>{load_array(e,e=>{arg(),ret(e),modal_exit(1)})}):"image/*"==ms.filter||".gif"==ms.filter?open_file(ms.filter,e=>{load_image(e,ms.verb,e=>{arg(),ret(e),modal_exit(1)})}):"audio/*"==ms.filter?open_file(ms.filter,e=>{load_sound(e,e=>{arg(),ret(e),modal_exit(1)})}):".csv,.txt"==ms.filter?open_text(ms.filter,e=>{arg(),ret(lms(e)),modal_exit(1)}):".html,.deck"==ms.filter?open_text(ms.filter,e=>{arg(),ret(deck_read(e)),modal_exit(1)}):open_text("",e=>{arg(),ret(lms(e)),modal_exit(1)})}),t.x-=65,(ui_button(rect(t.x,t.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0)}else if("fullscreen_lil"==ms.type){const e=draw_modalbox(rect(150,45));draw_textc(rect(e.x,e.y,e.w,16),_t("click_fullscreen"),FONT_BODY,1);const t=rect(e.x+e.w-80,e.y+e.h-20);ui_button(rect(t.x,t.y,80,20),_t("fullscreen"),1,e=>{toggle_fullscreen(),modal_exit(1)}),t.x-=65,(ui_button(rect(t.x,t.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0)}else if("brush"==ms.type){const e=rect(6,4),r=25,i=r+4,l=5,s=font_h(FONT_BODY),n=deck.brushes;e.y+=ceil(count(n)/e.x);const o=draw_modalbox(rect(l+e.x*i+l,l+e.y*i+s+l)),a=dr.brush>=24?ls(n.k[dr.brush-24]):_t("select_brush_shape");draw_textc(rect(o.x,o.y+o.h-s,o.w,s),a,FONT_BODY,1);for(let s=0;s<e.x*e.y;s++){const n=rect(o.x+l+2+i*(s%e.x),o.y+l+2+i*(0|s/e.x),r,r),a=rint(rect(n.x+n.w/2,n.y+n.h/2));draw_line(rpair(a,a),s,1,deck),s==dr.brush&&draw_box(inset(n,-2),0,1);const d=dover(n)&&over(n),c=s==dr.brush&&ev.action,A=c||(ev.md||ev.drag)&&d,m=c||ev.mu&&d;if(A&&draw_invert(t,inset(n,-1)),m){dr.brush=s,modal_exit(s);break}}(ev.exit||ev.mu&&!dover(o)&&!over(o))&&(modal_exit(-1),ev.mu=0),"left"==ev.dir&&(dr.brush=(0|dr.brush/e.x)*e.x+(dr.brush+e.x-1)%e.x),"right"==ev.dir&&(dr.brush=(0|dr.brush/e.x)*e.x+(dr.brush+1)%e.x),"up"==ev.dir&&(dr.brush=(dr.brush+e.x*(e.y-1))%(e.x*e.y)),"down"==ev.dir&&(dr.brush=(dr.brush+e.x)%(e.x*e.y)),dr.brush=clamp(0,dr.brush,24+count(n)-1)}else if("pattern"==ms.type||"fill"==ms.type){const e=rect(8,dr.color?2:4),r=25,i=r+4,l=5,s=font_h(FONT_BODY),n=e=>"pattern"==ms.type?dr.pattern:dr.fill,o=e=>"pattern"==ms.type?dr.pattern=e:dr.fill=e,a=draw_modalbox(rect(l+e.x*i+l,l+e.y*i+s+l));let d=n();draw_textc(rect(a.x,a.y+a.h-s,a.w,s),_t("select_fill_stroke_color",{type:"fill"==ms.type?_t("fill"):_t("stroke"),color_or_pattern:dr.color?_t("color"):_t("pattern")}),FONT_BODY,1);for(let s=0;s<e.x*e.y;s++){const n=rint(rect(a.x+l+2+i*(s%e.x),a.y+l+2+i*(0|s/e.x),r,r)),c=dr.color?s<2?s:31+s:s;draw_rect(n,0==c?32:c),c==d&&draw_box(inset(n,-2),0,1);const A=dover(n)&&over(n),m=c==d&&ev.action,_=m||(ev.md||ev.drag)&&A,u=m||ev.mu&&A;if(_&&draw_invert(t,inset(n,-1)),u){o(c),modal_exit(c);break}}(ev.exit||ev.mu&&!dover(a)&&!over(a))&&(modal_exit(-1),ev.mu=0),ev.dir&&dr.color&&d>=2&&(d-=31),"left"==ev.dir&&o((0|d/e.x)*e.x+(d+e.x-1)%e.x),"right"==ev.dir&&o((0|d/e.x)*e.x+(d+1)%e.x),"up"==ev.dir&&o((d+e.x*(e.y-1))%(e.x*e.y)),"down"==ev.dir&&o((d+e.x)%(e.x*e.y)),ev.dir&&dr.color&&n()>=2&&o(n()+31)}else if("grid"==ms.type){const e=draw_modalbox(rect(120,160));draw_textc(rect(e.x,e.y-5,e.w,20),_t("grid_size"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("width"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("height"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name),ui_field(rect(e.x+42,e.y+40,e.w-42,18),ms.text),dr.grid_size.x=ln(rtext_string(ms.name.table)),dr.grid_size.x=0|max(1,dr.grid_size.x),dr.grid_size.y=ln(rtext_string(ms.text.table)),dr.grid_size.y=0|max(1,dr.grid_size.y);const t=rect(e.x,e.y+70);draw_hline(e.x,e.x+e.w,t.y-5,13),draw_textc(rect(t.x,t.y,e.w,20),_t("pixel_scale"),FONT_MENU,1),t.y+=20,ui_radio(rect(t.x,t.y,e.w,16),"2x",1,2==dr.zoom)&&(dr.zoom=2),t.y+=16,ui_radio(rect(t.x,t.y,e.w,16),"4x",1,4==dr.zoom)&&(dr.zoom=4),t.y+=16,ui_radio(rect(t.x,t.y,e.w,16),"8x",1,8==dr.zoom)&&(dr.zoom=8),t.y+=16;const r=rect(e.x,e.y+e.h-20);(ui_button(rect(e.x+e.w-60,r.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("deck_props"==ms.type){const e=draw_modalbox(rect(220,100));draw_textc(rect(e.x,e.y-5,e.w,20),_t("deck_properties"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("author"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name),ui_field(rect(e.x+42,e.y+40,e.w-42,30),ms.text),iwrite(deck,lms("name"),rtext_string(ms.name.table)),iwrite(deck,lms("author"),rtext_string(ms.text.table)),mark_dirty();const t=rect(e.x,e.y+e.h-20);ui_button(rect(t.x,t.y,60,20),_t("script"),1)&&(setscript(deck),modal_exit(0)),t.x+=65,ui_button(rect(t.x,t.y,60,20),_t("protect")+"...",1)&&modal_enter("save_locked"),(ui_button(rect(e.x+e.w-60,t.y,60,20),_t("ok"),1)||ev.exit)&&(sync(),modal_exit(1))}else if("resize_deck"==ms.type){const e=draw_modalbox(rect(280,140));draw_textc(rect(e.x,e.y-5,e.w,20),_t("resize_deck_title"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("width"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("height"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.form0),ui_field(rect(e.x+42,e.y+40,e.w-42,18),ms.form1);let t=parseInt(rtext_string(ms.form2.table).v)||0;ui_checkbox(rect(e.x,e.y+82,e.w,16),_t("adaptive"),1,t)&&(t^=1,ms.form2.table=rtext_cast(lms(t+"")));const r=rect(e.x,e.y+e.h-20);if(ui_button(rect(r.x,r.y,60,20),_t("cancel"),1)&&modal_exit(0),ui_button(rect(e.x+e.w-60,r.y,60,20),_t("ok"),1)||ev.exit){const e=parseInt(rtext_string(ms.form0.table).v)||512,t=parseInt(rtext_string(ms.form1.table).v)||342,r=parseInt(rtext_string(ms.form2.table).v)||0,i=deck_read(ms.temp_deck_data),l=i.size||rect(512,342);if(i.size=rect(e,t),r){const r=r=>{r.forEach(r=>{if(r.pos&&r.size){const i=l.x-(r.pos.x+r.size.x),s=l.y-(r.pos.y+r.size.y);(i<146||s<54)&&(r.pos.x=e-r.size.x-i,r.pos.y=t-r.size.y-s)}})},s=r=>{if(r.image&&r.image.pix&&r.image.size){const i=r.image.size.x,l=r.image.size.y,s=e,n=t;if(s!=i||n!=l){const e=r.image.pix,t=new Uint8Array(s*n);for(let r=0;r<Math.min(l,n);r++){for(let l=0;l<Math.min(i,s);l++)t[r*s+l]=e[r*i+l];for(let e=i;e<s;e++)t[r*s+e]=0}for(let e=l;e<n;e++)for(let r=0;r<s;r++)t[e*s+r]=0;const o=146,a=54,d=Math.max(0,i-o),c=Math.max(0,l-a),A=i-d,m=l-c;if(A>0&&m>0){for(let r=0;r<l;r++)for(let o=0;o<A;o++){const a=r*i+(d+o),c=Math.max(0,n-l+r),m=s-A+o,_=c*s+m;a<e.length&&c<n&&m>=0&&m<s&&(t[_]=e[a])}for(let r=0;r<m;r++)for(let l=0;l<d;l++){const o=(c+r)*i+l,a=n-m+r,d=s-i+l,A=a*s+d;o<e.length&&a>=0&&a<n&&d>=0&&d<s&&(t[A]=e[o])}}r.image.pix=t,r.image.size.x=s,r.image.size.y=n;const _=s-i,u=n-l;r.widgets&&r.widgets.v&&r.widgets.v.forEach(e=>{if("target"===e.name){e.size&&(e.size.x+=_,e.size.y+=u),e.clip&&(e.clip.w+=_,e.clip.h+=u);const t=dget(e.widgets,lms("c"));if(t&&canvas_is(t)){t.size&&(t.size.x+=_,t.size.y+=u);let e=container_image(t,!0);e&&image_resize(e,rect(t.size.x,t.size.y)),canvas_clip(t)}}else"canvas"===e.name&&(e.size&&(e.size.x+=_,e.size.y+=u),e.clip&&(e.clip.w+=_,e.clip.h+=u),e.image&&e.image.size&&(e.image.size.x+=_,e.image.size.y+=u),canvas_clip(e))})}}};if(i.cards&&i.cards.v&&Array.isArray(i.cards.v)&&i.cards.v.forEach(e=>{e.widgets&&e.widgets.v&&r(e.widgets.v)}),i.cards&&i.cards.v&&void 0!==i.card){const e=i.cards.v[i.card];e&&s(e)}}load_deck(i),resize(),modal_exit(1)}}else if("card_props"==ms.type){const e=draw_modalbox(rect(220,100)),t=ifield(deck,"card");draw_textc(rect(e.x,e.y-5,e.w,20),_t("card_properties"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name);const r=rect(e.x,e.y+e.h-20);(ui_button(rect(e.x+e.w-60,r.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1),ui_button(rect(r.x,r.y,60,20),_t("script"),1)&&(setscript(t),modal_exit(0))}else if("button_props"==ms.type){const e=draw_modalbox(rect(220,170)),t=ob.sel[0];draw_textc(rect(e.x,e.y-5,e.w,20),_t("button_attributes"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("text"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name),ui_field(rect(e.x+42,e.y+40,e.w-42,18),ms.text),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("text"),rtext_string(ms.text.table)),draw_text(rect(e.x+(0|e.w/2),e.y+72,54,20),_t("shortcut"),FONT_MENU,1);const r=normalize_shortcut(rtext_string(ms.form0.table));ms.form0.table=rtext_cast(lms(r)),wid.fv==ms.form0&&(wid.cursor=rect(clamp(0,wid.cursor.x,r.length),clamp(0,wid.cursor.y,r.length))),ui_field(rect(e.x+(0|e.w/2)+54,e.y+70,(0|e.w/2)-54,18),ms.form0),iwrite(t,lms("shortcut"),rtext_string(ms.form0.table)),mark_dirty();const i=ls(ifield(t,"style")),l=rect(e.x,e.y+70);ui_radio(rint(rect(l.x,l.y,e.w/2,16)),_t("button_style_round"),1,"round"==i)&&(iwrite(t,lms("style"),lms("round")),mark_dirty()),l.y+=16,ui_radio(rint(rect(l.x,l.y,e.w/2,16)),_t("button_style_rect"),1,"rect"==i)&&(iwrite(t,lms("style"),lms("rect")),mark_dirty()),l.y+=16,ui_radio(rint(rect(l.x,l.y,e.w/2,16)),_t("button_style_check"),1,"check"==i)&&(iwrite(t,lms("style"),lms("check")),mark_dirty()),l.y+=16,ui_radio(rint(rect(l.x,l.y,e.w/2,16)),_t("button_style_invisible"),1,"invisible"==i)&&(iwrite(t,lms("style"),lms("invisible")),mark_dirty()),l.y+=16;const s=rect(e.x,e.y+e.h-20);ui_button(rect(s.x,s.y,60,20),_t("script"),1)&&(setscript(t),modal_exit(0)),s.x+=65,ui_button(rect(s.x,s.y,60,20),_t("action")+"...",card_is(con()))&&modal_enter("action"),(ui_button(rect(e.x+e.w-60,s.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("field_props"==ms.type){const e=draw_modalbox(rect(260,260)),t=ob.sel[0],r=unpack_field(t);draw_textc(rect(e.x,e.y-5,e.w,20),_t("field_attributes"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,60),_t("text"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name);const i=ls(ifield(t,"style"));widget_field(null,{size:rect(e.x+42,e.y+40,e.w-42,88),font:r.font,show:"solid",scrollbar:1,border:1,style:i,align:r.align,locked:0},ms.text),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("value"),ms.text.table),mark_dirty();let l=lb(ifield(t,"border")),s=lb(ifield(t,"scrollbar")),n=rect(e.x,e.y+80+60);ui_checkbox(rect(n.x,n.y,e.w,16),_t("border"),1,l)&&(l^=1,iwrite(t,lms("border"),lmn(l)),mark_dirty()),n.y+=16,ui_checkbox(rect(n.x,n.y,e.w,16),_t("scrollbar"),1,s)&&(s^=1,iwrite(t,lms("scrollbar"),lmn(s)),mark_dirty()),n.y+=16;const o=rect(e.x,n.y+10);let a=0;ui_radio(rint(rect(o.x,o.y,e.w/2,16)),_t("attr_richtext"),1,"rich"==i)&&(iwrite(t,lms("style"),lms("rich")),mark_dirty()),o.y+=16,ui_radio(rint(rect(o.x,o.y,e.w/2,16)),"Plain Text",1,"plain"==i)&&(iwrite(t,lms("style"),lms("plain")),mark_dirty(),a=1),o.y+=16,ui_radio(rint(rect(o.x,o.y,e.w/2,16)),_t("attr_code"),1,"code"==i)&&(iwrite(t,lms("style"),lms("code")),mark_dirty(),a=1),o.y+=16,a&&!rtext_is_plain(ms.text.table)&&(ms.text.table=rtext_cast(rtext_string(ms.text.table)));const d=ls(ifield(t,"align")),c=rect(e.x+e.w/2,n.y+10);ui_radio(rint(rect(c.x,c.y,e.w/2,16)),"Left",1,"left"==d)&&(iwrite(t,lms("align"),lms("left")),mark_dirty()),c.y+=16,ui_radio(rint(rect(c.x,c.y,e.w/2,16)),"Center",1,"center"==d)&&(iwrite(t,lms("align"),lms("center")),mark_dirty()),c.y+=16,ui_radio(rint(rect(c.x,c.y,e.w/2,16)),"Right",1,"right"==d)&&(iwrite(t,lms("align"),lms("right")),mark_dirty()),c.y+=16;const A=rect(e.x,e.y+e.h-20);ui_button(rect(A.x,A.y,60,20),_t("script")+"...",1)&&(setscript(t),modal_exit(0)),(ui_button(rect(e.x+e.w-60,A.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("slider_props"==ms.type){const e=draw_modalbox(rect(220,170)),t=ob.sel[0];draw_textc(rect(e.x,e.y-5,e.w,20),_t("slider_attributes"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("format"),FONT_MENU,1),ui_field(rect(e.x+50,e.y+20,e.w-50,18),ms.name),ui_field(rect(e.x+50,e.y+40,e.w-50,18),ms.text),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("format"),rtext_string(ms.text.table)),mark_dirty();const r=ls(ifield(t,"style")),i=rect(e.x,e.y+70);ui_radio(rint(rect(i.x,i.y,e.w/2,16)),_t("slider_style_horiz"),1,"horiz"==r)&&(iwrite(t,lms("style"),lms("horiz")),mark_dirty()),i.y+=16,ui_radio(rint(rect(i.x,i.y,e.w/2,16)),_t("slider_style_vert"),1,"vert"==r)&&(iwrite(t,lms("style"),lms("vert")),mark_dirty()),i.y+=16,ui_radio(rint(rect(i.x,i.y,e.w/2,16)),_t("slider_style_bar"),1,"bar"==r)&&(iwrite(t,lms("style"),lms("bar")),mark_dirty()),i.y+=16,ui_radio(rint(rect(i.x,i.y,e.w/2,16)),_t("slider_style_compact"),1,"compact"==r)&&(iwrite(t,lms("style"),lms("compact")),mark_dirty()),i.y+=16;const l=rint(rect(e.x+e.w/2,e.y+70));draw_text(rect(l.x+5,l.y+2,40,20),_t("min_value"),FONT_MENU,1),ui_field(rint(rect(l.x+40,l.y,e.w/2-40,18)),ms.form0),l.y+=20,draw_text(rect(l.x+5,l.y+2,40,20),_t("max_value"),FONT_MENU,1),ui_field(rint(rect(l.x+40,l.y,e.w/2-40,18)),ms.form1),l.y+=20,draw_text(rect(l.x+5,l.y+2,40,20),_t("step"),FONT_MENU,1),ui_field(rint(rect(l.x+40,l.y,e.w/2-40,18)),ms.form2),l.y+=20;const s=rect(e.x,e.y+e.h-20);iwrite(t,lms("interval"),lml([rtext_string(ms.form0.table),rtext_string(ms.form1.table)])),iwrite(t,lms("step"),rtext_string(ms.form2.table)),mark_dirty(),ui_button(rect(s.x,s.y,60,20),_t("script")+"...",1)&&(setscript(t),modal_exit(0)),(ui_button(rect(e.x+e.w-60,s.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("canvas_props"==ms.type){const e=draw_modalbox(rect(220,181)),t=ob.sel[0];draw_textc(rect(e.x,e.y-5,e.w,20),_t("canvas_attributes"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,42,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,42,20),_t("scale"),FONT_MENU,1),draw_text(rect(e.x,e.y+62,42,20),_t("width"),FONT_MENU,1),draw_text(rect(e.x,e.y+82,42,20),_t("height"),FONT_MENU,1),ui_field(rect(e.x+42,e.y+20,e.w-42,18),ms.name),ui_field(rect(e.x+42,e.y+40,e.w-42,18),ms.text),ui_field(rect(e.x+42,e.y+60,e.w-42,18),ms.form0),ui_field(rect(e.x+42,e.y+80,e.w-42,18),ms.form1),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("scale"),rtext_string(ms.text.table)),mark_dirty();const r=parseInt(rtext_string(ms.form0.table)),i=parseInt(rtext_string(ms.form1.table));if(!isNaN(r)&&!isNaN(i)&&r>0&&i>0){const e=rect(r,i);iwrite(t,lms("size"),lmpair(e)),mark_dirty()}let l=lb(ifield(t,"border")),s=lb(ifield(t,"draggable")),n=rect(e.x,e.y+90+20);ui_checkbox(rint(rect(n.x,n.y,e.w/2,16)),_t("border"),1,l)&&(l^=1,iwrite(t,lms("border"),lmn(l)),mark_dirty()),n.y+=16,ui_checkbox(rect(n.x,n.y,e.w,16),_t("draggable"),1,s)&&(s^=1,iwrite(t,lms("draggable"),lmn(s)),mark_dirty());const o=rect(e.x,e.y+e.h-20);ui_button(rect(o.x,o.y,60,20),_t("script"),1)&&(setscript(t),modal_exit(0)),(ui_button(rect(e.x+e.w-60,o.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("grid_props"==ms.type){const e=draw_modalbox(rect(280,286)),t=ob.sel[0];draw_textc(rect(e.x,e.y-5,e.w,20),_t("grid_properties"),FONT_MENU,1),draw_text(rect(e.x,e.y+22,47,20),_t("name"),FONT_MENU,1),draw_text(rect(e.x,e.y+42,47,20),_t("format"),FONT_MENU,1),draw_text(rect(e.x,e.y+62,47,20),_t("value"),FONT_MENU,1),ui_field(rect(e.x+47,e.y+20,e.w-47,18),ms.name),ui_field(rect(e.x+47,e.y+40,e.w-47,18),ms.text),ui_codeedit(rect(e.x+47,e.y+60,e.w-47,118),1,ms.form0);const r=rtext_string(ms.form0.table),i=rtext_string(ms.text.table),l=table_decode(r,i),s=tab_cols(l).length,n=count(l);draw_text(rect(e.x+47,e.y+120+60,e.w-47,18),`${s} 列，${n} 行。`,FONT_BODY,1),iwrite(t,lms("name"),rtext_string(ms.name.table)),iwrite(t,lms("format"),i),mark_dirty();let o=lb(ifield(t,"headers")),a=lb(ifield(t,"scrollbar")),d=lb(ifield(t,"lines")),c=lb(ifield(t,"bycell")),A=rect(e.x,e.y+130+70);ui_checkbox(rint(rect(A.x,A.y,e.w/2,16)),_t("headers"),1,o)&&(o^=1,iwrite(t,lms("headers"),lmn(o)),mark_dirty()),A.y+=16,ui_checkbox(rint(rect(A.x,A.y,e.w/2,16)),_t("scrollbar"),1,a)&&(a^=1,iwrite(t,lms("scrollbar"),lmn(a)),mark_dirty()),A.y+=16,ui_checkbox(rint(rect(A.x,A.y,e.w/2,16)),_t("grid_lines"),1,d)&&(d^=1,iwrite(t,lms("lines"),lmn(d)),mark_dirty()),A.y+=16,ui_checkbox(rint(rect(A.x,A.y,e.w/2,16)),_t("select_by_cell"),1,c)&&(c^=1,iwrite(t,lms("bycell"),lmn(c)),mark_dirty()),A.y+=16;const m=rint(rect(e.x+e.w/2,e.y+130+70));ui_radio(rint(rect(m.x,m.y,e.w/2,16)),_t("edit_as_json"),1,1==ms.edit_json)&&(ms.form0=fieldstr(lms(fjson(monad.cols(l)))),ms.edit_json=1),m.y+=16,ui_radio(rint(rect(m.x,m.y,e.w/2,16)),_t("edit_as_csv"),1,0==ms.edit_json)&&(ms.form0=fieldstr(n_writecsv(count(i)?[l,i]:[l])),ms.edit_json=0);const _=rect(e.x,e.y+e.h-20),u=ll(ifield(t,"widths"));ui_button(rect(_.x,_.y,60,20),_t("script"),1)&&(modal_exit(0),setscript(t)),_.x+=65,ui_button(rect(_.x,_.y,90,20),_t("reset_widths"),u.length)&&(iwrite(t,lms("widths"),lml([])),mark_dirty()),(ui_button(rect(e.x+e.w-60,_.y,60,20),_t("ok"),1)||ev.exit)&&modal_exit(1)}else if("action"==ms.type){const e=draw_modalbox(rect(220,190));draw_textc(rect(e.x,e.y-5,e.w,20),_t("button_action"),FONT_MENU,1);const t=rect(e.x+e.w-60,e.y+e.h-20),r=rect(e.x,e.y+36),i=(ms.act_go||ms.act_sound)&&(ms.act_go?5!=ms.act_gomode||count(ms.verb):1)&&(ms.act_sound?count(ms.message):1);if(ui_button(rect(t.x,t.y,60,20),_t("ok"),i)&&modal_exit(1),t.x-=65,(ui_button(rect(t.x,t.y,60,20),_t("cancel"),1)||ev.exit)&&modal_exit(0),ui_checkbox(rint(rect(e.x,e.y+20,e.w/2,16)),_t("go_to_card"),1,ms.act_go)&&(ms.act_go^=1),ui_radio(rect(r.x+5,r.y,80,16),_t("go_to_first"),ms.act_go,0==ms.act_gomode)&&(ms.act_gomode=0),r.y+=16,ui_radio(rect(r.x+5,r.y,80,16),_t("prev_card"),ms.act_go,1==ms.act_gomode)&&(ms.act_gomode=1),r.y+=16,ui_radio(rect(r.x+5,r.y,80,16),_t("next_card"),ms.act_go,2==ms.act_gomode)&&(ms.act_gomode=2),r.y+=16,ui_radio(rect(r.x+5,r.y,80,16),_t("go_to_last"),ms.act_go,3==ms.act_gomode)&&(ms.act_gomode=3),r.y+=16,ui_radio(rect(r.x+5,r.y,80,16),_t("go_back"),ms.act_go,4==ms.act_gomode)&&(ms.act_gomode=4),r.y+=16,ui_radio(rect(r.x+5,r.y,45,16),_t("select")+":",ms.act_go,5==ms.act_gomode)&&(ms.act_gomode=5),ms.act_go&&5==ms.act_gomode){const t=rect(r.x+5+45,r.y,e.w-5-45-5-60,16);draw_hline(t.x,t.x+t.w,t.y+t.h,13),draw_text_fit(inset(t,1),ls(ms.verb),FONT_BODY,1),ui_button(rect(e.x+e.w-60,r.y,60,20),_t("choose"),ms.act_go&&5==ms.act_gomode)&&modal_push("pick_card")}if(r.y+=26,ui_checkbox(rect(r.x,r.y,80,16),_t("play")+" "+_t("sounds"),1,ms.act_sound)&&(ms.act_sound^=1),ms.act_go&&(ui_checkbox(rint(rect(e.x+e.w/2,e.y+20,e.w/2-19,16)),_t("with_transition"),1,ms.act_trans)&&(ms.act_trans^=1),ms.act_trans)){const t=rint(rect(e.x+e.w/2,e.y+36,e.w/2,70));-99==ms.grid.scroll&&(ms.grid.scroll=grid_scrollto(ms.grid.table,{size:t,font:FONT_BODY,headers:0},-1,ms.grid.row)),ui_list(t,ms.grid);const r=rpair(rect(e.x+e.w-17,e.y+20),ms.canvas.size),i=image_make(ms.canvas.size);ms.trans=dget(deck.transit,tab_cell(ms.grid.table,"value",ms.grid.row)),do_transition(frame_count%60/60,i,0),draw_scaled(r,i,1),draw_box(r,0,1)}if(ms.act_sound){const t=rect(r.x+5+75,r.y,e.w-5-75-5-60,16);draw_hline(t.x,t.x+t.w,t.y+t.h,13),draw_text_fit(inset(t,1),ls(ms.message),FONT_BODY,1),ui_button(rect(e.x+e.w-60,r.y,60,20),_t("choose"),ms.act_sound)&&(ms.act_transno=ms.grid.row,ms.grid=gridtab(sounds_enumerate()),ms.from_action=1,ms.type="sounds")}}else if("pick_card"==ms.type){const e=draw_modalbox(rect(220,45));draw_textc(rect(e.x,e.y,e.w,16),_t("select_card_any"),FONT_BODY,1);const t=rint(rect(e.x+(e.w-60-5-60-5-60)/2,e.y+e.h-20));if((ui_button(rect(t.x,t.y,60,20),_t("previous"),1)||"left"==ev.dir)&&n_go([lms("Prev")],deck),t.x+=65,ui_button(rect(t.x,t.y,60,20),_t("select"),1)){const e=ifield(ifield(deck,"card"),"name");n_go([lmn(ms.act_card)],deck),ms.carda.length&&(ob.sel=ms.carda),modal_pop(0),"action"==ms.type&&(ms.verb=e),"link"==ms.type&&(ms.text=fieldstr(e))}t.x+=65,(ui_button(rect(t.x,t.y,60,20),_t("next"),1)||"right"==ev.dir)&&n_go([lms("Next")],deck)}else if("autoswitch_settings"==ms.type){const e=draw_modalbox(rect(280,250));draw_textc(rect(e.x,e.y-5,e.w,20),_t("auto_switch_settings_title"),FONT_MENU,1);const r=ifield(deck,"card"),i=ln(ifield(r,"index"));ls(ifield(r,"name"));ui_button(rect(e.x+5,e.y+25,75,20),_t("set_as_start"),1)&&(autoSwitchState.startCard=i,autoSwitchState.startCard>autoSwitchState.endCard&&(autoSwitchState.endCard=autoSwitchState.startCard)),ui_button(rect(e.x+85,e.y+25,75,20),_t("set_as_end"),1)&&(autoSwitchState.endCard=i,autoSwitchState.endCard<autoSwitchState.startCard&&(autoSwitchState.startCard=autoSwitchState.endCard)),draw_text(rect(e.x+165,e.y+27,150,16),`${_t("range")}: ${autoSwitchState.startCard} - ${autoSwitchState.endCard}`,FONT_BODY,1),draw_text(rect(e.x+5,e.y+50,100,16),_t("current_card_interval"),FONT_BODY,1);let l=autoSwitchState.uniformInterval;if(i>=autoSwitchState.startCard&&i<=autoSwitchState.endCard){const e=i-autoSwitchState.startCard;l=autoSwitchState.intervals[e]||autoSwitchState.uniformInterval}if(ms.form2||(ms.form2=fieldstr(lms(l.toString()))),!autoSwitchState.multiSelect){const e=ms.form2._prevValue||l.toString(),t=ls(rtext_string(ms.form2.table));if(t!==e){const e=parseInt(t)||100;if(i>=autoSwitchState.startCard&&i<=autoSwitchState.endCard){const t=i-autoSwitchState.startCard;for(;autoSwitchState.intervals.length<=t;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);autoSwitchState.intervals[t]=e}ms.form2._prevValue=t}}if(ui_field(rect(e.x+105,e.y+48,60,18),ms.form2),autoSwitchState.multiSelect){if(ui_button(rect(e.x+185,e.y+47,100,20),_t("apply_to_selected"),1)&&autoSwitchState.selectedCards.length>0){const e=parseInt(ls(rtext_string(ms.form2.table)))||100;for(let t=0;t<autoSwitchState.selectedCards.length;t++){const r=autoSwitchState.selectedCards[t];if(r>=autoSwitchState.startCard&&r<=autoSwitchState.endCard){const t=r-autoSwitchState.startCard;for(;autoSwitchState.intervals.length<=t;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);autoSwitchState.intervals[t]=e}}}}else if(ui_button(rect(e.x+185,e.y+47,80,20),_t("apply_to_all"),1)){const e=parseInt(ls(rtext_string(ms.form2.table)))||100,t=Math.max(1,autoSwitchState.endCard-autoSwitchState.startCard+1);autoSwitchState.intervals=[];for(let r=0;r<t;r++)autoSwitchState.intervals.push(e);autoSwitchState.uniformInterval=e}ui_checkbox(rect(e.x+5,e.y+75,100,16),_t("multi_select"),1,autoSwitchState.multiSelect)&&(autoSwitchState.multiSelect=!autoSwitchState.multiSelect,autoSwitchState.multiSelect||(autoSwitchState.selectedCards=[])),ui_button(rect(e.x+90,e.y+70,120,20),_t("copy_and_paste_card"),1)&&copyAndPasteCard(),draw_text(rect(e.x+215,e.y+77,e.w-220,16),_t("card_list"),FONT_BODY,1);const s=rect(e.x+5,e.y+95,e.w-10,130);draw_box(s,0,1);const n=Math.max(1,autoSwitchState.endCard-autoSwitchState.startCard+1);for(;autoSwitchState.intervals.length<n;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);const o=30,a=o*count(deck.cards);let d=0,c=ifield(deck,"card");ms.grid||(ms.grid={scroll:0,row:-1});const A=scrollbar(s,Math.max(0,a-(s.h-2)),10,s.h,ms.grid.scroll,a>=s.h,0),m=A.size;ms.grid.scroll=A.scroll,m.y++;const _=frame.clip;frame.clip=m;for(let e=0;e<count(deck.cards);e++){const r=rect(m.x,m.y+e*o-ms.grid.scroll,m.w,o),i=deck.cards.v[e];if(r.y>m.y+m.h||r.y+r.h<m.y)continue;const l=rclip(r,m),s=rect(r.x+2,r.y+1,40,28),n=rect(s.x+s.w+5,s.y,m.w-(2+s.w+5+5),font_h(FONT_MENU)),a=rect(n.x,n.y+n.h+2,n.w,font_h(FONT_BODY));if(ev.md&&dover(l)){const t=ln(ifield(i,"index"));if(autoSwitchState.multiSelect){const e=autoSwitchState.selectedCards.indexOf(t);e>=0?autoSwitchState.selectedCards.splice(e,1):(autoSwitchState.selectedCards.push(t),autoSwitchState.selectedCards.sort((e,t)=>e-t))}else{d=1,n_go([i],deck),c=i,ms.grid.row=e;let r=autoSwitchState.uniformInterval;if(t>=autoSwitchState.startCard&&t<=autoSwitchState.endCard){const e=t-autoSwitchState.startCard;r=autoSwitchState.intervals[e]||autoSwitchState.uniformInterval}ms.form2=fieldstr(lms(r.toString()))}}const A=1;let _=ls(ifield(i,"name"));const u=ln(ifield(i,"index"));u>=autoSwitchState.startCard&&u<=autoSwitchState.endCard&&(u===autoSwitchState.startCard&&u===autoSwitchState.endCard?_+=" [起始/结束]":u===autoSwitchState.startCard?_+=" [起始]":u===autoSwitchState.endCard&&(_+=" [结束]")),draw_text_fit(n,_,FONT_MENU,A);let p=`${count(i.widgets)} 控件`;if(u>=autoSwitchState.startCard&&u<=autoSwitchState.endCard){const e=u-autoSwitchState.startCard;for(;autoSwitchState.intervals.length<=e;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);p+=` | ${autoSwitchState.intervals[e]||autoSwitchState.uniformInterval}ms`}if(draw_text_fit(a,p,FONT_BODY,A),draw_box(s,0,A),autoSwitchState.multiSelect){autoSwitchState.selectedCards.indexOf(u)>=0&&(draw_box(r,0,1),draw_box(rect(r.x+1,r.y+1,r.w-2,r.h-2),0,1))}else i==c&&1==A&&draw_invert(t,r);if(draw_thumbnail(i,s),ev.dclick&&over(l)&&u>=autoSwitchState.startCard&&u<=autoSwitchState.endCard){const e=u-autoSwitchState.startCard,t=autoSwitchState.intervals[e]||autoSwitchState.uniformInterval,r=prompt(_t("enter_interval_prompt"),t);null===r||isNaN(parseInt(r))||(autoSwitchState.intervals[e]=parseInt(r),ms.form2=fieldstr(lms(parseInt(r).toString())))}}if(frame.clip=_,d){c=ifield(deck,"card");const e=ln(ifield(c,"index"))*o-ms.grid.scroll;e<0&&(ms.grid.scroll+=e),e+o>=m.h&&(ms.grid.scroll+=e+o-m.h)}const u=rect(e.x,e.y+200);ui_button(rect(u.x+5,u.y+30,95,20),autoSwitchState.enabled?_t("stop"):_t("start_auto_switch"),1)&&(autoSwitchState.enabled?stopAutoSwitch():(startAutoSwitch(),modal_exit(0))),ui_button(rect(u.x+105,u.y+30,70,20),_t("start_recording"),1)&&(startCanvasRecording(),modal_exit(0)),(ui_button(rect(e.x+e.w-60,u.y+30,55,20),_t("ok"),1)||ev.exit)&&modal_exit(0)}else if("trans"==ms.type){const e=(new Date).getTime()/1e3,t=-1==ms.time_start?0:e-ms.time_start;-1==ms.time_start&&(ms.time_start=e),(do_transition(min(60*t/ms.time_end,1),frame.image,1)>=1||do_panic)&&modal_exit(0)}ms.in_modal=0},n_open=([e,t,r])=>{modal_enter("open_lil");let i=e?ls(e):"",l=lms("");return ms.filter="",ms.prompt="","array"==i&&(l=array_make(0,"u8",0)),"sound"==i&&(ms.filter="audio/*",l=sound_make(new Uint8Array(0))),"image"==i&&(ms.filter="image/*",l=image_make(rect())),"deck"==i&&(ms.filter=".html,.deck",l=deck_read("")),"text"==i&&(ms.filter=".csv,.txt"),image_is(l)&&t&&("frames"==ls(t)||"gray_frames"==ls(t))&&(l=readgif([],ls(t)),ms.filter=".gif"),r&&(ms.prompt=ls(r)),ms.verb="array"==i?lms(i):t?ls(t):"",l},n_save=([e,t])=>(modal_enter("save_lil"),e=e||NIL,ms.path_suffix=array_is(e)&&t?ls(t):"",array_is(e)&&(ms.desc=_t("save_binary"),ms.text=fieldstr(lms("untitled"+ms.path_suffix))),sound_is(e)&&(ms.desc=_t("save_wav"),ms.text=fieldstr(lms("sound.wav"))),deck_is(e)&&(ms.desc=_t("save_deck_html"),ms.text=fieldstr(lms("untitled.deck"))),(image_is(e)||lid(e)||lil(e)&&e.v.some(image_is))&&(ms.desc=_t("save_gif"),ms.text=fieldstr(lms("image.gif"))),ms.verb=e,NIL),n_alert=([e,t,r,i])=>("bool"==ls(t)?(modal_enter("confirm_lil"),ms.verb=r?lms(ls(r)):null):"string"==ls(t)?(modal_enter("input_lil"),r&&(ms.text=fieldstr(r))):"choose"==ls(t)?(modal_enter("choose_lil"),ms.verb=r?lil(r)?dyad.dict(r,r):ld(r):ld(NIL),count(ms.verb)<1&&(ms.verb=ld(monad.list(NIL))),ms.grid=gridtab(lt(monad.keys(ms.verb)),i?dvix(ms.verb,i):-1)):modal_enter("alert_lil"),ms.message=plain_or_rich(e),NIL),free_canvas=e=>{const t=deck_read('{deck}\n{card:home}\n{widgets}\nc:{"type":"canvas"}'),r=t.cards.v[0].widgets.v[0];return iwrite(r,lms("size"),lmpair(e.size)),t.fonts=e.fonts,t.patterns=e.patterns,r.free=1,container_image(r,1),r},go_notify=(e,t,r,i,l)=>{if(e!=deck)return;if(i&&/^(http|https|ftp|gopher|gemini):\/\//.test(i))return modal_enter("url"),void(ms.text=fieldstr(lms(i)));const s=t!=ln(ifield(ifield(e,"card"),"index"));if(s&&(con_set(null),"script"==uimode&&close_script()),s&&!e.locked&&t>=0)try{const r=ls(ifield(e.cards.v[t],"name"));history.replaceState(void 0,void 0,"#"+r)}catch(e){}const n=null==r?null:lion(r)?r:dget(e.transit,r);"trans"!=ms.type&&t>=0&&n&&(modal_enter("trans"),ms.time_curr=0,ms.time_end=null==l?30:0|max(1,ln(l)),ms.time_start=-1,ms.trans=n,ms.canvas=free_canvas(e),ms.carda=draw_con(ifield(e,"card")),ms.cardb=draw_con(ifield(e,"cards").v[t])),s&&"interact"==uimode&&(msg.pending_loop=1),(s||r)&&(grid_exit(),field_exit(),bg_end_selection(),bg_end_lasso(),ob.sel=[],wid.active="listen"==ms.type?0:-1,mark_dirty()),"interact"==uimode&&(msg.next_view=1)};let field_notify_disable=0;field_notify=e=>{if(field_notify_disable||!wid.infield||wid.ft!=e)return;const t=ifield(e,"value");rtext_len(t)||(wid.fv={table:t,scroll:0},wid.cursor=rect(),wid.field_dirty=0,wid.hist=[],wid.hist_cursor=0,enable_touch&&(field_exit(),wid.active=-1))},KS=(e,t,r)=>({v:e,l:t,w:r}),K=e=>KS(e,e,1),KCOMB=e=>KS(e,"",1),KSP=e=>K(drom_from_ord(e)),KBL=KS(null,"",1);const LCAPS=[[K("`"),K("1"),K("2"),K("3"),K("4"),K("5"),K("6"),K("7"),K("8"),K("9"),K("0"),K("-"),K("="),KS("Backspace","delete",1.5)],[KS("Tab","tab",1.5),K("q"),K("w"),K("e"),K("r"),K("t"),K("y"),K("u"),K("i"),K("o"),K("p"),K("["),K("]"),K("\\")],[KS("CapsLock","capslock",2),K("a"),K("s"),K("d"),K("f"),K("g"),K("h"),K("j"),K("k"),K("l"),K(";"),K("'"),KS("Enter","return",2)],[KS("Shift","shift",2.5),K("z"),K("x"),K("c"),K("v"),K("b"),K("n"),K("m"),K(","),K("."),K("/"),KS("Shift","shift",2.5)],[KS("ArrowLeft","",1),KS("ArrowDown","",1),KS("ArrowUp","",1),KS("ArrowRight","",1),KS("alt","alt",1),KS(" "," ",5),KS("alt","alt",1),KS(-2,"",2),KS(-1,_t("ok"),2)]],UCAPS=[[K("~"),K("!"),K("@"),K("#"),K("$"),K("%"),K("^"),K("&"),K("*"),K("("),K(")"),K("_"),K("+"),KS("Backspace","delete",1.5)],[KS("Tab","tab",1.5),K("Q"),K("W"),K("E"),K("R"),K("T"),K("Y"),K("U"),K("I"),K("O"),K("P"),K("{"),K("}"),K("|")],[KS("CapsLock","capslock",2),K("A"),K("S"),K("D"),K("F"),K("G"),K("H"),K("J"),K("K"),K("L"),K(":"),K('"'),KS("Enter","return",2)],[KS("Shift","shift",2.5),K("Z"),K("X"),K("C"),K("V"),K("B"),K("N"),K("M"),K("<"),K(">"),K("?"),KS("Shift","shift",2.5)],[KS("ArrowLeft","",1),KS("ArrowDown","",1),KS("ArrowUp","",1),KS("ArrowRight","",1),KS("alt","alt",1),KS(" "," ",5),KS("alt","alt",1),KS(-2,"",2),KS(-1,_t("ok"),2)]],ALCAPS=[[KBL,KSP(235),KBL,KBL,KSP(239),KBL,KBL,KBL,KSP(240),KBL,KBL,KCOMB("MACRON"),KSP(255),KS(0,"",1.5)],[KS(0,"",1.5),KSP(214),KSP(193),KCOMB("ACUTE"),KBL,KSP(188),KBL,KCOMB("UMLAUT"),KCOMB("CIRCUM"),KSP(182),KBL,KSP(237),KSP(238),KBL],[KS("CapsLock","capslock",2),KSP(164),KSP(158),KSP(175),KBL,KCOMB("GRAVE"),KCOMB("HUNGRA"),KBL,KCOMB("OGONEK"),KSP(206),KSP(127),KSP(165),KS(0,"",2)],[KS("Shift","shift",2.5),KBL,KBL,KSP(166),KCOMB("CARON"),KSP(204),KCOMB("TILDE"),KBL,KCOMB("COMMA"),KSP(227),KSP(236),KS("Shift","shift",2.5)],[KBL,KBL,KBL,KBL,KS("alt","alt",1),KS(" "," ",5),KS("alt","alt",1),KS(0,"",2),KS(0,"",2)]],AUCAPS=[[KBL,KSP(235),KBL,KBL,KSP(239),KBL,KBL,KBL,KSP(240),KBL,KBL,KCOMB("MACRON"),KSP(255),KS(0,"",1.5)],[KS(0,"",1.5),KSP(213),KSP(192),KCOMB("ACUTE"),KBL,KSP(157),KBL,KCOMB("UMLAUT"),KCOMB("CIRCUM"),KSP(151),KBL,KSP(237),KSP(238),KBL],[KS("CapsLock","capslock",2),KSP(133),KSP(234),KSP(144),KBL,KCOMB("GRAVE"),KCOMB("HUNGRA"),KBL,KCOMB("OGONEK"),KSP(205),KSP(127),KSP(134),KS(0,"",2)],[KS("Shift","shift",2.5),KBL,KBL,KSP(135),KCOMB("CARON"),KSP(204),KCOMB("TILDE"),KBL,KCOMB("COMMA"),KSP(226),KSP(236),KS("Shift","shift",2.5)],[KBL,KBL,KBL,KBL,KS("alt","alt",1),KS(" "," ",5),KS("alt","alt",1),KS(0,"",2),KS(0,"",2)]],ACCENTS={MACRON:image_read("%%IMG2AAYADQAHAQQAQw=="),ACUTE:image_read("%%IMG0AAYADRAgAAAAAAAAAAAAAAA="),UMLAUT:image_read("%%IMG0AAYADQBIAAAAAAAAAAAAAAA="),CIRCUM:image_read("%%IMG0AAYADTBIAAAAAAAAAAAAAAA="),GRAVE:image_read("%%IMG0AAYADSAQAAAAAAAAAAAAAAA="),HUNGRA:image_read("%%IMG0AAYADQBEiAAAAAAAAAAAAAA="),OGONEK:image_read("%%IMG0AAYADQAAAAAAAAAAAAAYDAA="),CARON:image_read("%%IMG0AAUADVAgAAAAAAAAAAAAAAA="),TILDE:image_read("%%IMG0AAYADTRYAAAAAAAAAAAAAAA="),COMMA:image_read("%%IMG0AAUADQAAAAAAAAAAAAAAIEA=")},ACCENT={MACRON:"ā   ē   ī     ō     ū     ",ACUTE:"á ć é   í    ńó   ś ú   ýź",UMLAUT:"ä   ë   ï     ö     ü   ÿ ",CIRCUM:"â   ê   î     ô     û     ",GRAVE:"à   è   ì     ò     ù     ",HUNGRA:"              ő     ű     ",OGONEK:"ą   ę                     ",CARON:"                  š      ž",TILDE:"ã            ñõ           ",COMMA:"                  șț      "};soft_keyboard=e=>{let t=0,r=0,i=e.y,l=0|e.h/LCAPS.length,s=ev.shift^kc.lock^kc.shift,n=kc.comb,o=deck.patterns.pal.pix;for(let a=0;a<LCAPS.length;a++){const d=LCAPS[a].reduce((e,t)=>e+t.w,0),c=(kc.alt?s?AUCAPS:ALCAPS:s?UCAPS:LCAPS)[a];let A=0;c.forEach((a,c,m)=>{let _=rint(rect(e.x+A+1,i,c==m.length-1?e.w-A:a.w*(e.w/d),l+1));A+=_.w-1,draw_box(_,0,1);const u=-2==a.v&&wid.f&&"code"==wid.f.style&&"interact"==uimode,p=a.v&&/^[a-zA-Z]$/.test(a.v)?a.v.toLowerCase().charCodeAt(0)-97:-1,g=-1!=p&&ACCENT[n]?ACCENT[n][p]:" ",f=ACCENT[n]?s?drom_toupper(g):g:"",w="Shift"==a.v||"CapsLock"==a.v;n&&!w?" "!=g&&draw_textc(_,f,FONT_MENU,1):"ArrowLeft"==a.v?draw_iconc(_,ARROWS[4],1):"ArrowDown"==a.v?draw_iconc(_,ARROWS[1],1):"ArrowUp"==a.v?draw_iconc(_,ARROWS[0],1):"ArrowRight"==a.v?draw_iconc(_,ARROWS[5],1):draw_textc(_,u?"运行":a.l,FONT_MENU,1);let y=keydown[a.v];_=inset(_,2);const h=dover(_)&&over(inset(_,-4))&&ev.down_modal==ms.type&&ev.down_uimode==uimode&&1==ev.down_caps;a.v&&h&&(ev.md||ev.drag)&&(y=1),n&&!w?(ev.mu&&h&&" "!=g&&(field_input(f),kc.shift=0,kc.alt=0,kc.comb=0),y=y&&" "!=g&&h):-1==a.v?(draw_box(_,0,13),ev.mu&&h&&(t=1)):"alt"==a.v?(ev.mu&&h&&(kc.alt^=1),kc.alt&&(y=1)):u?ev.mu&h&&(r=1):"Shift"==a.v?(ev.mu&&h&&(kc.shift^=1),kc.shift&&(y=1)):"CapsLock"==a.v?(ev.mu&&h&&(kc.lock^=1),kc.lock&&(y=1)):ACCENT[a.v]?(draw_box(_,0,1),draw_iconc(_,ACCENTS[a.v],1),ev.mu&&h&&(kc.comb=a.v,kc.alt=0)):ev.mu&&h&&a.v&&(1==a.v.length?field_input(a.v):field_keys(a.v,s),kc.shift=0,kc.alt=0),y&&draw_invert(o,_)}),i+=l}return{exit:t,eval:r}},keycaps=e=>{if(wid.fv||(kc.on=0),!kc.on)return;frame.image.pix.fill(32);const t=3+font_h(FONT_MENU),r=rect(0,t,frame.size.x+1,0|frame.size.y/2-t);if(kc.heading){const e=font_textsize(FONT_MENU,kc.heading),t=rect(r.x,r.y,r.w,e.y+5);draw_textc(t,kc.heading,FONT_MENU,1),r.h-=t.h,r.y+=t.h}if(ms.type&&(ms.in_modal=1),"script"==uimode)script_editor(r);else if("listen"==ms.type){const e=frame.clip;frame.clip=rect(r.x,r.y,r.w,r.h+6),wid.count=0,listener(r),frame.clip=e}else wid.count=wid.active,widget_field(wid.ft,{size:inset(r,5),font:wid.f.font,show:"solid",scrollbar:1,border:1,style:wid.f.style,align:wid.f.align,locked:0},wid.fv),ms.in_modal=0;const i=soft_keyboard(inset(rect(r.x,r.y+r.h+1,r.w-2,frame.size.y-(r.y+r.h)),5));"listen"==ms.type&&(i.eval||ev.eval)&&listener_eval(),"listen"!=ms.type&&(i.eval||ev.eval)&&field_keys("Enter",1),(i.exit||ev.exit)&&(field_exit(),wid.active=-1,"script"==uimode&&close_script(),"gridcell"==ms.type&&modal_exit(1),"link"==ms.type&&modal_pop(1),"listen"==ms.type&&modal_exit(0))};let doc_hist=[],doc_hist_cursor=0;has_undo=e=>doc_hist_cursor>0,has_redo=e=>doc_hist_cursor<doc_hist.length,undo=e=>{const t=doc_hist[--doc_hist_cursor];apply(0,t)},redo=e=>{const t=doc_hist[doc_hist_cursor++];apply(1,t)},edit=e=>{doc_hist=doc_hist.slice(0,doc_hist_cursor),doc_hist.push(e),redo()},edit_target=e=>{const t=con();return card_is(t)&&(e.card=ln(ifield(t,"index"))),prototype_is(t)&&(e.def=ifield(t,"name")),e},apply=(e,t)=>{let r=null,i=t.type;if(t.def)con_set(r=dget(deck.contraptions,t.def));else if(null!=t.card){let e=ifield(deck,"card");ln(ifield(e,"index"))!=t.card&&(n_go([lmn(t.card)],deck),e=ifield(deck,"card")),con_set(null),r=e}if(!r)return;const l=con_wids();if("ob_create"==i&&(e=!e,i="ob_destroy"),"bg_block"==i){"draw"!=uimode&&setmode("draw");const i=t.pos,l=t[e?"after":"before"];let s=container_image(r,1),n=s.size;const o=getpair(ifield(r,"size"));n.x==o.x&&n.y==o.y||(s=image_resize(s,o),iwrite(r,lms("image"),s),n=o);const a=t.clr_before,d=t.clr_after,c=rect(0,0,n.x,n.y);e&&d&&image_paste(t.clr_pos,c,d,s,1),image_paste(i,c,l,s,1),!e&&a&&image_paste(t.clr_pos,c,a,s,1)}else if("ob_props"==i){"object"!=uimode&&setmode("object");const r=t[e?"after":"before"];Object.keys(r).map(e=>{const t=r[e],i=dget(l,lms(e));i&&Object.keys(t).map(e=>iwrite(i,lms(e),t[e]))})}else if("ob_destroy"==i)if("object"!=uimode&&setmode("object"),ob.sel=[],e){const e=t.props.map(e=>dget(l,dget(e,lms("name")))).filter(e=>null!=e);t.props=con_copy_raw(r,e),e.map(e=>card_remove(r,e))}else{con_paste_raw(r,t.props).map((e,r)=>{dset(t.props[r],lms("name"),ifield(e,"name")),ob.sel.push(e),dget(t.props[r],lms("pos"))||iwrite(e,lms("pos"),lmpair(rcenter(con_dim(),getpair(ifield(e,"size")))))})}else if("proto_props"==i){const i=t[e?"after":"before"];t.keys.map((e,t)=>iwrite(r,e,i[t]))}mark_dirty()},image_overlay=(e,t,r,i)=>{const l=e.size,s=t.size,n=rect(0,0,l.x,l.y);for(let o=0;o<s.y;o++)for(let a=0;a<s.x;a++){const d=t.pix[a+o*s.x],c=rect(a+i.x,o+i.y);d!=r&&rin(n,c)&&(e.pix[c.x+c.y*l.x]=d)}},image_mask=(e,t)=>{const r=image_copy(e);for(let e=0;e<t.pix.length;e++)t.pix[e]||(r.pix[e]=0);return r},bg_scratch_clear=e=>dr.scratch.pix.fill(BG_MASK),bg_scratch_under=e=>{if(dr.scratch&&dr.under){const e=con_image();for(let t=0;t<e.pix.length;t++)1==e.pix[t]&&(dr.scratch.pix[t]=BG_MASK)}},bg_scratch=e=>{const t=con_size();dr.scratch||(dr.scratch=image_make(t));const r=dr.scratch.size;r.x==t.x&&r.y==t.y||(dr.scratch=image_make(t)),bg_scratch_clear()},bg_edit=e=>{const t=find_occupied(dr.scratch,BG_MASK),r=con_image(),i=image_copy(r,t);image_overlay(i,image_copy(dr.scratch,t),BG_MASK,rect(0,0)),edit(edit_target({type:"bg_block",pos:t,before:image_copy(r,t),after:i}))},draw_limbo=(e,t)=>{e=rnorm(e),dr.limbo&&(t&&dr.limbo_dither?draw_rect(e,21):t?draw_fat_scaled(screen_to_con(e),dr.limbo,!dr.trans,deck.patterns.pal.pix,frame_count,dr.zoom,con_to_screen(rect(0,0))):dr.limbo_dither?draw_dithered(e,dr.limbo,!dr.trans,dr.omask,dr.dither_threshold):draw_scaled(e,dr.limbo,!dr.trans))},bg_scaled_limbo=e=>{const t=dr.sel_here,r=con_image(),i=dr.trans||dr.omask?image_copy(r,t):image_make(rect(t.w,t.h)),l=(i.size,frame);if(frame=draw_frame(i),dr.trans){const e=dr.sel_start;draw_rect(rect(e.x-t.x,e.y-t.y,e.w,e.h),dr.fill)}return draw_limbo(frame.clip,0),frame=l,i},bg_edit_sel=e=>{if(!dr.limbo)return;const t=rcopy(dr.sel_here),r=con_image(),i={type:"bg_block",pos:t,before:image_copy(r,t),after:bg_scaled_limbo()};if(dr.limbo=null,dr.limbo_dither=0,dr.sel_start.w>0||dr.sel_start.h>0){const e=image_make(rect(dr.sel_start.w,dr.sel_start.h));for(let t=0;t<e.pix.length;t++)e.pix[t]=dr.fill;i.clr_pos=rcopy(dr.sel_start),i.clr_before=image_copy(r,dr.sel_start),i.clr_after=e,dr.sel_start=rect()}edit(edit_target(i))},bg_copy_selection=e=>image_copy(container_image(con(),1),e),bg_scoop_selection=e=>{dr.limbo||(dr.sel_start=rcopy(dr.sel_here),dr.limbo=bg_copy_selection(dr.sel_start),dr.limbo_dither=0)},bg_draw_lasso=(e,t,r,i)=>{if(dr.omask){const e=dr.omask.size;for(let r=0;r<e.y;r++)for(let l=0;l<e.x;l++){const s=rect(l+t.x,r+t.y);inclip(s)&&dr.omask.pix[l+r*e.x]&&pix(s,i)}}if(dr.mask){const t=dr.mask.size,i=dr.limbo.size;for(let l=0;l<t.y;l++)for(let s=0;s<t.x;s++){const n=rect(s+e.x,l+e.y);if(inclip(n)&&dr.mask.pix[s+l*t.x]){const e=r&&ANTS==(255&dr.mask.pix[s+l*t.x])?ANTS:dr.limbo.pix[s+l*i.x];!e&&dr.trans||pix(n,e)}}}},bg_lasso_preview=e=>{if(!bg_has_lasso())return;const t=rsub(ev.pos,ev.dpos),r=rect(dr.sel_here.x+t.x,dr.sel_here.y+t.y,dr.sel_here.w,dr.sel_here.h),i=rsub(ev.pos,r),l=null!=dr.mask&&rin(r,ev.pos)&&dr.mask.pix[i.x+i.y*r.w],s=ev.drag&&l?r:dr.sel_here,n=con_to_screen(rect(0,0));if(!dr.fatbits)return void bg_draw_lasso(con_to_screen(s),con_to_screen(dr.sel_start),1,dr.fill);const o=dr.sel_start,a=deck.patterns.anim,d=deck.patterns.pal.pix,c=(e,t,r)=>e<28||e>31?e:a[e-28][(0|frame_count/4)%max(1,a[e-28].length)],A=(e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(d,e,t,r);for(let e=0;e<s.h;e++)for(let t=0;t<s.w;t++)dr.omask.pix[t+e*dr.omask.size.x]&&draw_rect(radd(rmul(rect(t+o.x,e+o.y,1,1),dr.zoom),n),dr.fill);for(let e=0;e<s.h;e++)for(let t=0;t<s.w;t++){if(!dr.mask.pix[t+e*s.w])continue;const r=c(dr.limbo.pix[t+e*s.w],s.x,s.y),i=A(r,s.x+t,s.y+e);!r&&dr.trans||draw_rect(radd(rmul(rect(t+s.x,e+s.y,1,1),dr.zoom),n),r>=32||0==r?r:i?1:32)}for(let e=0;e<s.h;e++)for(let t=0;t<s.w;t++){if((255&dr.mask.pix[t+e*s.w])!=ANTS)continue;const r=radd(rmul(rect(t+s.x,e+s.y),dr.zoom),n);(t<=0||!dr.mask.pix[t-1+e*s.w])&&draw_vline(r.x,r.y,r.y+dr.zoom-1,ANTS),(t>=s.w-1||!dr.mask.pix[t+1+e*s.w])&&draw_vline(r.x+dr.zoom-1,r.y,r.y+dr.zoom-1,ANTS),(e<=0||!dr.mask.pix[t+(e-1)*s.w])&&draw_hline(r.x,r.x+dr.zoom-1,r.y,ANTS),(e>=s.h-1||!dr.mask.pix[t+(e+1)*s.w])&&draw_hline(r.x,r.x+dr.zoom-1,r.y+dr.zoom-1,ANTS)}},bg_tools=e=>{const t=e=>{bg_scratch(),dr.poly=[]};if(!dr.fatbits&&ev.mu&&ev.alt)return dr.fatbits=1,center_fatbits(ev.pos),void t();if(dr.fatbits&&ev.mu&&ev.alt)return dr.fatbits=0,void t();if(!ev.alt){if(ev.md&&(pointer.prev=ev.pos),dover(con_view_dim())||(ev.md=ev.mu=ev.drag=0),"pencil"==dr.tool||"line"==dr.tool||"rect"==dr.tool||"fillrect"==dr.tool||"ellipse"==dr.tool||"fillellipse"==dr.tool){let e=0;if(dr.scratch||bg_scratch(),ev.mdown)dr.pattern=ln(iwrite(con_image(),lmpair(ev.pos)));else if(ev.md)bg_scratch(),dr.erasing=ev.rdown||ev.shift;else if(ev.mu||ev.drag){const t=frame;if(frame=draw_frame(dr.scratch),"pencil"==dr.tool||dr.erasing)draw_line(rpair(pointer.prev,ev.pos),dr.brush,dr.erasing?0:bg_pat(),deck);else if("line"==dr.tool){let e=rcopy(snap(ev.dpos)),t=rcopy(snap(ev.pos));if(ev.shift){const r=rsub(t,e);t=e,4*Math.abs(r.x)<Math.abs(r.y)?t.y+=r.y:4*Math.abs(r.y)<Math.abs(r.x)?t.x+=r.x:2*Math.abs(r.x)<Math.abs(r.y)?(t.x+=sign(r.x)*Math.abs(r.y)/2,t.y+=r.y):2*Math.abs(r.y)<Math.abs(r.x)?(t.y+=sign(r.y)*Math.abs(r.x)/2,t.x+=r.x):(t.x+=sign(r.x)*Math.abs(max(r.x,r.y)),t.y+=sign(r.y)*Math.abs(max(r.x,r.y)))}bg_scratch_clear(),draw_line(rpair(rint(e),rint(t)),dr.brush,bg_pat(),deck)}else if("rect"==dr.tool||"fillrect"==dr.tool){const e=snap(ev.dpos),t=snap(ev.pos),r=rsub(t,e);ev.shift&&(r.x=r.y=max(r.x,r.y)),bg_scratch_clear();const i=rnorm(rpair(e,r));i.w++,i.h++,"fillrect"==dr.tool&&draw_rect(i,bg_fill()),draw_boxf(i,dr.brush,bg_pat(),deck)}else if("ellipse"==dr.tool||"fillellipse"==dr.tool){const e=snap(ev.dpos),t=snap(ev.pos),r=rsub(t,e);ev.shift&&(r.x=r.y=max(r.x,r.y)),bg_scratch_clear();const i=rnorm(rpair(radd(e,rect(1,1)),r));i.w--,i.h--;const l=rect(i.x+i.w/2,i.y+i.h/2),s=100,n=range(s).map(e=>{const t=e*(2*Math.PI)/s;return rint(rect(l.x+(.5+i.w/2)*Math.cos(t),l.y+(.5+i.h/2)*Math.sin(t)))});n.push(n[0]),"fillellipse"==dr.tool&&draw_poly(n,bg_fill()),draw_lines(n,dr.brush,bg_pat(),deck)}bg_scratch_under(),frame=t,ev.mu&&(bg_edit(),e=1)}dr.scratch&&(dr.fatbits?draw_fat(con_clip(),dr.scratch,deck.patterns.pal.pix,frame_count,BG_MASK,dr.zoom,dr.offset):image_overlay(frame.image,dr.scratch,BG_MASK,con_offset())),e&&bg_scratch_clear()}if("lasso"==dr.tool){const e=rect(ev.pos.x-ev.dpos.x,ev.pos.y-ev.dpos.y),t=rect(dr.sel_here.x+e.x,dr.sel_here.y+e.y,dr.sel_here.w,dr.sel_here.h),r=rect(ev.pos.x-t.x,ev.pos.y-t.y),i=null!=dr.mask&&over(t)&&dr.mask.pix[r.x+r.y*t.w];if(ev.md&&!i)bg_lasso_preview(),bg_end_lasso(),dr.poly.push(rcopy(ev.dpos));else if(ev.drag&&!i&&dr.poly.length>0){const e=last(dr.poly);ev.pos.x==e.x&&ev.pos.y==e.y||dr.poly.push(rcopy(ev.pos))}else if(ev.mu&&i)dr.sel_here=radd(dr.sel_here,e);else if(ev.mu){const e=poly_bounds(dr.poly);if(e.w>1&&e.h>1){dr.mask=image_make(rect(e.w,e.h));const t=frame;frame=draw_frame(dr.mask);for(let t=0;t<e.h;t++)for(let r=0;r<e.w;r++)poly_in(dr.poly,rect(r+e.x,t+e.y))&&pix(rect(r,t),1);dr.poly.length>0&&draw_lines(dr.poly.concat(dr.poly[0]).map(t=>rsub(t,rect(e.x,e.y))),0,ANTS,deck),frame=t,dr.sel_here=rcopy(e),dr.sel_start=rcopy(e),dr.omask=image_copy(dr.mask),dr.omask.pix.forEach((e,t)=>dr.omask.pix[t]=0!=e),bg_scoop_selection()}dr.poly=[]}dr.mask&&dr.limbo&&("left"==ev.dir&&(ev.dir=0,dr.sel_here.x--),"up"==ev.dir&&(ev.dir=0,dr.sel_here.y--),"right"==ev.dir&&(ev.dir=0,dr.sel_here.x++),"down"==ev.dir&&(ev.dir=0,dr.sel_here.y++),ev.exit&&(dr.limbo=dr.mask=dr.omask=null,bg_end_lasso()))}if("poly"==dr.tool)if(ev.md)dr.poly=[rect(ev.dpos.x,ev.dpos.y)];else if(ev.drag&&dr.poly.length>0){const e=last(dr.poly);ev.pos.x==e.x&&ev.pos.y==e.y||dr.poly.push(rcopy(ev.pos))}else if(ev.mu){dr.poly.push(rcopy(ev.dpos)),bg_scratch();const e=frame;frame=draw_frame(dr.scratch),draw_poly(dr.poly,bg_fill()),draw_lines(dr.poly,dr.brush,bg_pat(),deck),bg_scratch_under(),frame=e,bg_edit(),bg_scratch_clear(),dr.poly=[]}if("lasso"==dr.tool||"poly"==dr.tool){const e=rsub(dr.sel_here,dr.sel_start);e.w=e.h=0,draw_lines(dr.poly.map(t=>radd(e,con_to_screen(t))),"lasso"==dr.tool?0:dr.brush,"lasso"==dr.tool?ANTS:bg_pat(),deck)}if("fill"==dr.tool&&ev.mu){const e=container_image(con(),1),t=frame;bg_scratch(),frame=draw_frame(dr.scratch),draw_fill(ev.pos,ev.rup?0:bg_pat(),e),frame=t,bg_edit(),bg_scratch_clear()}bg_has_sel()||bg_has_lasso()||(dr.fatbits?("left"==ev.dir&&(dr.offset.x-=ev.shift?dr.grid_size.x:1),"right"==ev.dir&&(dr.offset.x+=ev.shift?dr.grid_size.x:1),"up"==ev.dir&&(dr.offset.y-=ev.shift?dr.grid_size.y:1),"down"==ev.dir&&(dr.offset.y+=ev.shift?dr.grid_size.y:1),clamp_fatbits(),ev.exit&&(dr.fatbits=0,ev.exit=0)):tracking())}},bg_end_lasso=e=>{if("draw"!=uimode||"lasso"!=dr.tool)return;const t=dr.mask&&dr.limbo,r=!requ(dr.sel_here,dr.sel_start);let i=null==dr.omask||dr.mask&&dr.omask.pix.length!=dr.mask.pix.length;if(dr.omask&&!i)for(let e=0;t&&e<dr.mask.pix.length;e++)if(dr.mask.pix[e]>0!=dr.omask.pix[e]>0){i=1;break}if(t&&(r||i||dr.lasso_dirty)){bg_scratch();const e=frame;frame=draw_frame(dr.scratch),bg_draw_lasso(dr.sel_here,dr.sel_start,0,dr.fill),frame=e,bg_edit(),bg_scratch_clear()}dr.poly=[],dr.mask=null,dr.omask=null,dr.limbo=null,dr.lasso_dirty=0,dr.sel_here=rect(),dr.sel_start=rect()},bg_end_selection=e=>{"draw"==uimode&&"select"==dr.tool&&(dr.sel_here.w<=0&&dr.sel_here.h<=0||(bg_edit_sel(),dr.sel_start=rcopy(ev.dpos),dr.sel_here=rcopy(ev.dpos)))},bg_delete_selection=e=>{if(bg_has_lasso()){dr.mask=null,bg_scratch();const e=frame;return frame=draw_frame(dr.scratch),bg_draw_lasso(dr.sel_here,dr.sel_start,0,dr.fill),frame=e,bg_edit(),bg_scratch_clear(),void bg_end_lasso()}if(bg_has_sel()){if(null!=dr.limbo&&dr.sel_start.w<=0&&dr.sel_start.h<=0)return dr.sel_here=rect(),dr.limbo=null,void(dr.limbo_dither=0);dr.sel_start.w<=0&&dr.sel_start.h<=0&&(dr.sel_start=rcopy(dr.sel_here)),dr.sel_here=rect(),dr.limbo=image_make(rect(1,1)),dr.limbo_dither=0,bg_edit_sel(),dr.sel_start=rcopy(ev.dpos),dr.sel_here=rcopy(ev.dpos)}},bg_paste=(e,t,r)=>{const i=con_dim(),l=rect(.75*i.w,.75*i.h);let s=e.size;if(t&&(s.x>l.x||s.y>l.y)){const e=min(l.x/s.x,l.y/s.y);s=rect(s.x*e,s.y*e)}s.x&&(bg_has_sel()?(bg_scoop_selection(),dr.limbo=e,dr.limbo_dither=0):(settool("select"),dr.sel_start=rect(),dr.sel_here=r?rect(r.x,r.y,s.x,s.y):rcenter(con_view_dim(),s),dr.limbo=e,dr.limbo_dither=0))},handle_size=e=>enable_touch?10:5,draw_handles=e=>{const t=handle_size(),r=deck.patterns.pal.pix,i=e.x+1-t,l=e.x+e.w-1,s=e.y+1-t,n=e.y+e.h-1,o=0|(l-i)/2+i,a=0|(n-s)/2+s;draw_invert(r,rclip(rect(i,s,t,t),frame.clip)),draw_invert(r,rclip(rect(i,n,t,t),frame.clip)),draw_invert(r,rclip(rect(l,s,t,t),frame.clip)),draw_invert(r,rclip(rect(l,n,t,t),frame.clip)),draw_invert(r,rclip(rect(l,a,t,t),frame.clip)),draw_invert(r,rclip(rect(o,n,t,t),frame.clip)),draw_invert(r,rclip(rect(o,s,t,t),frame.clip)),draw_invert(r,rclip(rect(i,a,t,t),frame.clip))},in_handle=e=>{const t=handle_size(),r=e.x+1-t,i=e.x+e.w-1,l=e.y+1-t,s=e.y+e.h-1,n=0|(i-r)/2+r,o=0|(s-l)/2+l;return over(rect(r,l,t,t))?4:over(rect(r,s,t,t))?6:over(rect(i,l,t,t))?2:over(rect(i,s,t,t))?0:over(rect(i,o,t,t))?1:over(rect(n,l,t,t))?3:over(rect(r,o,t,t))?5:over(rect(n,s,t,t))?7:-1},bg_select=e=>{if("draw"!=uimode||"select"!=dr.tool)return rect(0,0,0,0);let t=rcopy(dr.sel_here),r=t.w>0||t.h>0,i=r&&dover(t);const l=min(ev.dpos.x,ev.pos.x),s=max(ev.dpos.x,ev.pos.x),n=min(ev.dpos.y,ev.pos.y),o=max(ev.dpos.y,ev.pos.y),a=handle_size(),d=t.x+1-a,c=t.x+t.w-1,A=t.y+1-a,m=t.y+t.h-1,_=0|(c-d)/2+d,u=0|(m-A)/2+A,p=ev.pos.x-ev.dpos.x,g=ev.pos.y-ev.dpos.y,f=dr.limbo?dr.limbo.size:rect(dr.sel_start.w,dr.sel_start.h);if(handle=(e,i,l,s,n,o)=>r&&(ev.mu||ev.drag)&&dover(rect(e,i,a,a))?(t=rnorm(keep_ratio(rect(t.x+l,t.y+s,t.w+n,t.h+o),f)),ev.mu&&(dr.sel_here=snapr(t)),bg_scoop_selection(),uicursor=cursor.drag,1):0,in_layer()&&(handle(c,m,0,0,p,g)||handle(d,m,p,0,-p,g)||handle(c,A,0,g,p,-g)||handle(d,A,p,g,-p,-g)||handle(c,u,0,0,p,0)||handle(_,A,0,g,0,-g)||handle(d,u,p,0,-p,0)||handle(_,m,0,0,0,g)||(ev.md&&i?bg_scoop_selection():(ev.mu||ev.drag)&&i?(t.x+=p,t.y+=g,ev.mu&&(dr.sel_here=snap(t))):ev.md&&!i?(r&&(draw_limbo(con_to_screen(t),dr.fatbits),bg_end_selection(),r=0),t=rcopy(dr.sel_here)):(ev.mu||ev.drag)&&(t=snapr(rect(l,n,s-l,o-n)),ev.mu&&(dr.sel_here=t)))),r&&draw_limbo(con_to_screen(t),dr.fatbits),in_layer()){let e=0;r&&"left"==ev.dir&&(ev.dir=0,bg_scoop_selection(),dr.sel_here.x-=ev.shift?dr.grid_size.x:1,e=1),r&&"up"==ev.dir&&(ev.dir=0,bg_scoop_selection(),dr.sel_here.y-=ev.shift?dr.grid_size.y:1,e=1),r&&"right"==ev.dir&&(ev.dir=0,bg_scoop_selection(),dr.sel_here.x+=ev.shift?dr.grid_size.x:1,e=1),r&&"down"==ev.dir&&(ev.dir=0,bg_scoop_selection(),dr.sel_here.y+=ev.shift?dr.grid_size.y:1,e=1),e&&ev.shift&&(dr.sel_here=snap(dr.sel_here)),ev.exit&&(dr.limbo=null,dr.limbo_dither=0,bg_end_selection())}return t},bg_box_to_lasso=e=>{const t=dr.sel_here;if("select"==dr.tool){dr.tool="lasso",bg_scoop_selection();const e=dr.sel_start,r=dr.limbo,i=frame;dr.limbo=image_make(rect(t.w,t.h)),frame=draw_frame(dr.limbo),dr.limbo_dither?(draw_dithered(frame.clip,r,1,dr.omask,dr.dither_threshold),dr.limbo_dither=0):draw_scaled(frame.clip,r,1),frame=i,dr.mask=image_make(rect(t.w,t.h)),dr.mask.pix.fill(1),e.w>0&&e.h>0?(dr.omask=image_make(rect(e.w,e.h)),dr.omask.pix.fill(1)):dr.omask=null}},bg_regenerate_lasso_outline=e=>{const t=dr.sel_here,r=(e,t)=>dr.mask.pix[e.x+e.y*dr.sel_here.w]=t,i=e=>e.x<0||e.y<0||e.x>=dr.sel_here.w||e.y>=dr.sel_here.h?0:dr.mask.pix[e.x+e.y*dr.sel_here.w];for(let e=0;e<t.h;e++)for(let l=0;l<t.w;l++)if(i(rect(l,e))){i(rect(l-1,e))&&i(rect(l,e-1))&&i(rect(l+1,e))&&i(rect(l,e+1))||r(rect(l,e),ANTS)}},bg_tighten=e=>{const t=dr.sel_here;bg_box_to_lasso();const r=(e,t)=>dr.mask.pix[e.x+e.y*dr.sel_here.w]=t,i=e=>e.x<0||e.y<0||e.x>=dr.sel_here.w||e.y>=dr.sel_here.h?0:dr.mask.pix[e.x+e.y*dr.sel_here.w];let l=1,s=dr.fill;for(;l;){l=0;for(let e=0;e<t.h;e++)for(let n=0;n<t.w;n++)if(i(rect(n,e))&&dr.limbo.pix[n+e*t.w]==s){i(rect(n-1,e))&&i(rect(n,e-1))&&i(rect(n+1,e))&&i(rect(n,e+1))||(r(rect(n,e),0),l=1)}}bg_regenerate_lasso_outline();const n=find_occupied(dr.mask,0);n.w<1||n.h<1||n.w==t.w&&n.h==t.h||(dr.limbo=image_copy(dr.limbo,n),dr.mask&&(dr.mask=image_copy(dr.mask,n)),dr.sel_here.x+=n.x,dr.sel_here.y+=n.y,dr.sel_here.w=n.w,dr.sel_here.h=n.h)},bg_outline=e=>{const t=dr.sel_here;bg_box_to_lasso(),dr.mask.pix.forEach((e,t)=>dr.mask.pix[t]=0!=e);const r=image_copy(dr.limbo);for(let e=0;e<t.h;e++)for(let i=0;i<t.w;i++){const l=i+e*t.w;if(dr.limbo.pix[l]||!dr.mask.pix[l])continue;let s=0;if(i>0){const r=i-1+e*t.w;s|=dr.limbo.pix[r]&&dr.mask.pix[r]}if(i<t.w-1){const r=i+1+e*t.w;s|=dr.limbo.pix[r]&&dr.mask.pix[r]}if(e>0){const r=i+(e-1)*t.w;s|=dr.limbo.pix[r]&&dr.mask.pix[r]}if(e<t.h-1){const r=i+(e+1)*t.w;s|=dr.limbo.pix[r]&&dr.mask.pix[r]}s&&(r.pix[l]=bg_pat())}dr.limbo=r,dr.lasso_dirty=1,bg_regenerate_lasso_outline()},ob_order=e=>{ob.sel.sort((e,t)=>ln(ifield(e,"index"))-ln(ifield(t,"index")))},ob_move_up=e=>{ob.sel.length<1||(ob_order(),ob.sel.slice(0).reverse().map(e=>iwrite(e,lms("index"),lmn(ln(ifield(e,"index"))+1))))},ob_move_dn=e=>{ob.sel.length<1||(ob_order(),ob.sel.map(e=>iwrite(e,lms("index"),lmn(ln(ifield(e,"index"))-1))))},ob_edit_prop=(e,t)=>{const r={},i={};ob.sel.map(l=>{const s=ls(ifield(l,"name")),n={},o={};n[e]=ifield(l,e),o[e]=t,r[s]=n,i[s]=o}),edit(edit_target({type:"ob_props",before:r,after:i}))},ob_create=e=>{edit(edit_target({type:"ob_create",props:e}))},ob_destroy=e=>{if(ob.sel.length<1)return;const t=ob.sel.map(e=>lmd([lms("name")],[ifield(e,"name")]));edit(edit_target({type:"ob_destroy",props:t})),ob.sel=[]},can_coalesce=e=>{if(has_redo()||0==doc_hist.length)return!1;const t=doc_hist[doc_hist_cursor-1],r=con();if("ob_props"!=t.type)return!1;if("def"in t&&(!prototype_is(r)||ls(t.def)!=ls(ifield(r,"name"))))return!1;if("card"in t&&(!card_is(r)||t.card!=ln(ifield(r,"index"))))return!1;if(Object.keys(t.after).length!=ob.sel.length)return!1;for(let r=0;r<ob.sel.length;r++){const i=Object.keys(t.after)[r],l=t.after[i];if(ls(ifield(ob.sel[r],"name"))!=i)return!1;if(Object.keys(l).length!=(e?1:2))return!1;const s=Object.keys(l);if("pos"!=s[0])return!1;if(!e&&"size"!=s[1])return!1}return!0},ob_move=(e,t)=>{if(!(ob.sel.length<1))if(t&&can_coalesce(1)){const t=doc_hist[doc_hist_cursor-1];Object.values(t.after).map(t=>t.pos=lmpair(radd(getpair(t.pos),e))),undo(),redo()}else{const t={},r={};ob.sel.map(i=>{const l=ls(ifield(i,"name")),s=ifield(i,"pos"),n=getpair(s);t[l]={pos:s},r[l]={pos:lmpair(radd(n,e))}}),edit(edit_target({type:"ob_props",before:t,after:r}))}},ob_resize=(e,t)=>{if(1!=ob.sel.length)return;const r=ob.sel[0];if(t&&can_coalesce(0)){const t=doc_hist[doc_hist_cursor-1],r=Object.values(t.after)[0];r.pos=lmpair(rect(e.x,e.y)),r.size=lmpair(rect(e.w,e.h)),undo(),redo()}else{const t={pos:ifield(r,"pos"),size:ifield(r,"size")},i={pos:lmpair(rect(e.x,e.y)),size:lmpair(rect(e.w,e.h))},l={},s={},n=ls(ifield(r,"name"));l[n]=t,s[n]=i,edit(edit_target({type:"ob_props",before:l,after:s}))}},proto_prop=(e,t,r)=>{edit(edit_target({type:"proto_props",keys:[lms(t)],before:[ifield(e,t)],after:[r]}))},proto_size=(e,t,r)=>{const i=image_resize(image_copy(ifield(e,"image")),getpair(ifield(e,"size"))),l=image_make(t),s=rpair(rect(0,0),t);draw_9seg(s,l,i,getrect(ifield(e,"margin")),s,1,null),edit(edit_target({type:"proto_props",keys:["size","image","margin"].map(lms),before:[ifield(e,"size"),i,ifield(e,"margin")],after:[lmpair(t),l,lmrect(r)]}))},object_select=e=>{ob.sel=[e]},object_properties=e=>{ob.sel=[e],button_is(e)&&modal_enter("button_props"),field_is(e)&&modal_enter("field_props"),slider_is(e)&&modal_enter("slider_props"),canvas_is(e)&&modal_enter("canvas_props"),grid_is(e)&&modal_enter("grid_props"),contraption_is(e)&&modal_enter("contraption_props")},is_resizable=e=>1==ob.sel.length&&(contraption_is(ob.sel[0])?lb(ifield(ob.sel[0].def,"resizable")):1),object_editor=e=>{const t=con_wids(),r=deck.patterns.pal.pix;if(t.v.map(e=>{const t=unpack_widget(e),i=ob.sel.some(t=>t==e);if(t.size=con_to_screen(t.size),i?draw_box(inset(t.size,-1),0,ANTS):ob.show_bounds&&draw_boxinv(r,inset(t.size,-1)),i&&is_resizable()&&draw_handles(t.size),ob.show_bounds){lb(ifield(e,"volatile"))&&(draw_line(rect(t.size.x,t.size.y,t.size.x+t.size.w,t.size.y+t.size.h),0,1,deck),draw_line(rect(t.size.x+t.size.w,t.size.y,t.size.x,t.size.y+t.size.h),0,1,deck));const r=rect(t.size.x+t.size.w-10,t.size.y,10,10);t.locked&&(draw_rect(r,1),draw_icon(rect(r.x+1,r.y+1),LOCK,32),r.y+=10),lb(ifield(e,"animated"))&&(draw_rect(r,1),draw_icon(rect(r.x+1,r.y+1),ANIM,32))}}),!in_layer())return;if(ob.sel.length>0){let e=0;if("left"==ev.dir&&(ob_move(rect(-1*(ev.shift?dr.grid_size.x:1),0),1),e=1),"right"==ev.dir&&(ob_move(rect(1*(ev.shift?dr.grid_size.x:1),0),1),e=1),"up"==ev.dir&&(ob_move(rect(0,-1*(ev.shift?dr.grid_size.y:1)),1),e=1),"down"==ev.dir&&(ob_move(rect(0,1*(ev.shift?dr.grid_size.y:1)),1),e=1),e&&ev.shift&&ob.sel.length){const e=ob.sel.reduce((e,t)=>rmin(e,getpair(ifield(t,"pos"))),rect(RTEXT_END,RTEXT_END));ob_move(snap_delta(e),1)}}const i=is_resizable()?in_handle(unpack_widget(ob.sel[0]).size):-1,l=t.v.some(e=>over(unpack_widget(e).size)&&ob.sel.some(t=>t==e)),s=ev.pos,n=ob.prev,o=s.x!=n.x||s.y!=n.y,a=rnorm(rect(ev.dpos.x,ev.dpos.y,ev.pos.x-ev.dpos.x,ev.pos.y-ev.dpos.y)),d=a.w>1||a.h>1;if(l&&ev.dclick)for(let e=count(t)-1;e>=0;e--){const r=t.v[e],i=unpack_widget(r);if(over(i.size)){object_properties(r);break}}else if(l&&ev.mu&&!d)for(let e=ob.sel.length-1;e>=0;e--){const t=ob.sel[e],r=unpack_widget(t);if(over(r.size)){ev.shift?ob.sel=ob.sel.filter(e=>e!=t):ob.sel=[t];break}}else if(-1!=i&&ev.md)ob.resize=1,ob.resize_first=1,ob.handle=i,ob.prev=rcopy(ev.pos),ob.orig=unpack_widget(ob.sel[0]).size;else if(l&&ev.md)ob.move=1,ob.move_first=1,ob.prev=rcopy(ev.pos);else if(!ob.resize||ev.drag&&ob.sel.length)if(!ob.move||ev.drag&&ob.sel.length)if(ob.resize){let e=rsub(ev.pos,ev.dpos),t=rcopy(ob.orig);0==ob.handle&&(t.w+=e.x,t.h+=e.y),2==ob.handle&&(t.w+=e.x,t.h-=e.y,t.y+=e.y),6==ob.handle&&(t.w-=e.x,t.h+=e.y,t.x+=e.x),4==ob.handle&&(t.w-=e.x,t.h-=e.y,t.x+=e.x,t.y+=e.y),1==ob.handle&&(t.w+=e.x),3==ob.handle&&(t.h-=e.y,t.y+=e.y),5==ob.handle&&(t.w-=e.x,t.x+=e.x),7==ob.handle&&(t.h+=e.y),t=snapr(t),t.w=max(8,t.w),t.h=max(8,t.h),o&&(ob_resize(t,!ob.resize_first),ob.resize_first=0,ob.prev=rcopy(ev.pos))}else if(ob.move){const e=rsub(s,n);o&&(ob_move(e,!ob.move_first),ob.move_first=0,ob.prev=rcopy(ev.pos))}else{d&&ev.drag&&draw_box(con_to_screen(a),0,ANTS),d&&(ev.drag||ev.mu)&&(ob.sel=[]);let e=0;for(let r=count(t)-1;r>=0;r--){const i=t.v[r],l=unpack_widget(i),s=ob.sel.some(e=>e==i),n=rclip(l.size,a),o=d?n.w>=1&&n.h>=1:over(l.size)&&dover(l.size),c=ev.mu&o;if(c&&(e=1),c)if(d)ob.sel.push(i);else if(!s){ev.shift||(ob.sel=[]),ob.sel.push(i);break}}ev.mu&&!e&&(ob.sel=[])}else{if(ob.sel.length){const e=ob.sel.reduce((e,t)=>rmin(e,getpair(ifield(t,"pos"))),rect(RTEXT_END,RTEXT_END));ob_move(snap_delta(e),!ob.move_first)}ob.move=0,ob.move_first=0}else ob.resize=0,ob.resize_first=0},prototype_size_editor=e=>{const t=con(),r=rect(0,0,0,0);if("interact"==uimode||!prototype_is(t))return 0;let i=0;const l=rsub(screen_to_con(ev.pos),screen_to_con(ev.dpos)),s=con_clip();let n=0,o=getpair(ifield(t,"size")),a=getrect(ifield(t,"margin")),d=rcopy(a);if(0!=s.x&&0!=s.y&&s.w!=frame.size.x&&s.h!=frame.size.y&&"draw"!=uimode){let e=rpair(radd(con_to_screen(o),rect(1,1)),rect(8,8));over(e)&&(i=1),!ev.drag&&!ev.mu||!dover(e)||0==l.x&&0==l.y||(o=snap(rmax(rect(1,1),radd(o,l))),e=rpair(radd(con_to_screen(o),rect(1,1)),rect(8,8)),draw_box(con_to_screen(rpair(rect(0,0),o)),0,ANTS),i=1,ev.mu&&(n=1)),draw_rect(e,32),draw_box(e,0,1),over(e)&&(uicursor=cursor.drag),draw_text(rect(e.x+10,e.y+10,100,20),`${o.x} x ${o.y}`,FONT_MONO,1);const s=(e,t,r)=>rpair(rsub(con_to_screen(t),r),e.size),d=(e,t,l,n,o)=>{const d=s(e,t,l);(over(d)||dover(d))&&(i=1),(ev.drag||ev.mu)&&dover(d)&&(a[o]+=n,r[o]=1)},c=(e,t)=>{image_paste(e,frame.clip,t,frame.image,0),over(e)&&(uicursor=cursor.drag)},A=(e,t)=>{const r=`${t}`,i=font_textsize(FONT_MONO,r);draw_text(rect(e.x-2-i.x,e.y-3,60,20),r,FONT_MONO,1)},m=(e,t)=>{const r=`${t}`,i=font_textsize(FONT_MONO,r);draw_text(rect(e.x+3-(0|i.x/2),e.y-i.y,60,20),r,FONT_MONO,1)},_=(e,t,i,l)=>{const n=s(e,t,i);r[l]&&A(n,a[l]),c(n,e)},u=(e,t,i,l)=>{const n=s(e,t,i);r[l]&&m(n,a[l]),c(n,e)};ob.show_margins&&(d(HANDLES[0],rect(a.x,0),rect(3,11),l.x,"x"),d(HANDLES[1],rect(0,a.y),rect(11,3),l.y,"y"),d(HANDLES[0],rect(o.x-a.w,0),rect(3,11),-l.x,"w"),r.x&&r.w&&(a.w+=l.x,r.w=0),d(HANDLES[1],rect(0,o.y-a.h),rect(11,3),-l.y,"h"),r.y&&r.h&&(a.h+=l.y,r.h=0),a=normalize_margin(lmrect(a),getpair(ifield(t,"size"))),u(HANDLES[0],rect(a.x,0),rect(3,11),"x"),_(HANDLES[1],rect(0,a.y),rect(11,3),"y"),u(HANDLES[0],rect(o.x-a.w,0),rect(3,11),"w"),_(HANDLES[1],rect(0,o.y-a.h),rect(11,3),"h"))}if(ob.show_margins){const e=con_to_screen(rect(a.x,0,1,o.y));draw_vline(e.x,e.y,e.y+e.h,ANTS);const t=con_to_screen(rect(0,a.y,o.x,1));draw_hline(t.x,t.x+t.w,t.y,ANTS);const r=con_to_screen(rect(o.x-a.w,0,1,o.y));draw_vline(r.x,r.y,r.y+r.h,ANTS);const i=con_to_screen(rect(0,o.y-a.h,o.x,1));draw_hline(i.x,i.x+i.w,i.y,ANTS)}const c=a.x!=d.x||a.y!=d.y||a.w!=d.w||a.h!=d.h;return n?proto_size(t,o,a):ev.mu&&c&&proto_prop(t,"margin",lmrect(a)),i||n||c};let toolbars_enable=0,tzoom=1;const tcellw=22,tcellh=19,tgap=1,toolsize=rect(2*tcellw+1,19*tcellh+tgap+1),tfb=image_make(toolsize),tid=new ImageData(toolsize.x,toolsize.y),tooltypes=["select","pencil","lasso","line","fill","poly","rect","fillrect","ellipse","fillellipse"],patorder=[0,1,4,5,8,9,16,17,12,13,18,19,20,21,22,23,24,25,26,27,2,6,3,7,10,11,14,15,28,29,30,31];toolbars=e=>{if(!toolbars_enable||kc.on)return;if(ms.type||"script"==uimode)return clr=e=>{const t=q(e);t.getContext("2d").clearRect(0,0,t.width,t.height)},clr("#ltools"),void clr("#rtools");const t=(e,t,r)=>{const i=e.getBoundingClientRect(),l=rint(rect((ev.rawpos.x-i.x)/tzoom,(ev.rawpos.y-i.y)/tzoom)),s=rint(rect((ev.rawdpos.x-i.x)/tzoom,(ev.rawdpos.y-i.y)/tzoom));tfb.pix.fill(0),frame=draw_frame(tfb),draw_box(rpair(rect(),toolsize),0,1),r(l,s);const n=deck.patterns.anim,o=deck.patterns.pal.pix,a=rin(rect(i.x,i.y,i.width,i.height),ev.rawpos)&&dr.show_anim?0|frame_count/4:0,d=(e,t,r)=>e<28||e>31?e:n[e-28][a%max(1,n[e-28].length)],c=(e,t,r)=>e>47?0:e>31?e-32:((e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(o,e,t,r))(e,t,r)?15:0,A=tid.data;for(let e=0,t=0,r=0;r<tid.height;r++)for(let i=0;i<tid.width;i++,e++){const l=c(d(tfb.pix[e]),i,r),s=COLORS[l];A[t++]=255&s>>16,A[t++]=255&s>>8,A[t++]=255&s,A[t++]=255}t.getContext("2d").putImageData(tid,0,0);const m=e.getContext("2d");m.imageSmoothingEnabled=tzoom!=(0|tzoom),m.save(),m.scale(tzoom,tzoom),m.drawImage(t,0,0),m.restore()},r=(e,t,r,i,l)=>{const s=rcenter(r,rect(16,16));return draw_box(r,0,1),l&&draw_rect(r,1),draw_icon(s,TOOLS[i],l?0:1),rin(r,e)&&(uicursor=cursor.point),rin(r,e)&&rin(r,t)&&ev.mu},i=(e,t,r,i,l)=>(draw_box(r,0,1),l&&draw_rect(inset(r,2),1),draw_textc(r,i,FONT_BODY,l?0:1),rin(r,e)&&(uicursor=cursor.point),rin(r,e)&&rin(r,t)&&ev.mu),l=(e,t,r,i)=>{const l=rcenter(r,rect(12,12)),s=rin(r,t)&&(ev.mu||ev.drag);return draw_box(r,0,1),s&&draw_rect(r,1),draw_icon(l,ARROWS[i],s?0:1),rin(r,e)&&(uicursor=cursor.point),rin(r,e)&&s&&ev.mu},s=(e,t,r,i)=>{const l=rint(rect(r.x+r.w/2,r.y+r.h/2));draw_box(r,0,1),draw_line(rect(l.x,l.y,l.x,l.y),i,1,deck),dr.brush==i&&draw_box(inset(r,2),0,1),rin(r,e)&&(uicursor=cursor.point,ev.mu&&rin(r,t)&&(setmode("draw"),"select"!=dr.tool&&"lasso"!=dr.tool&&"fill"!=dr.tool||settool("pencil"),dr.brush=i))},n=(e,t,r,i,l)=>{const s=l.v[i-24],n=frame.clip;frame.clip=r,image_paste(rcenter(r,s.size),r,s,frame.image,1),frame.clip=n,draw_box(r,0,1),dr.brush==i&&draw_box(inset(r,2),0,1),rin(r,e)&&(uicursor=cursor.point,ev.mu&&rin(r,t)&&(setmode("draw"),"select"!=dr.tool&&"lasso"!=dr.tool&&"fill"!=dr.tool||settool("pencil"),dr.brush=i))},o=(e,t,r,i)=>{(dr.pickfill?dr.fill:dr.pattern)==i?(draw_rect(inset(r,3),i),draw_box(inset(r,3),0,1)):draw_rect(r,i),rin(r,e)&&(uicursor=cursor.point,ev.mu&&rin(r,t)&&(dr.pickfill?dr.fill=i:dr.pattern=i)),draw_box(r,0,1)};t(q("#ltools"),q("#lrender"),(e,t)=>{const i=deck.brushes,o=deck.brusht,a=count(i)?17:tcellh;toolbar_scroll=clamp(0,toolbar_scroll,count(i)),draw_rect(rect(0,6*tcellh,toolsize.x,tgap),1),r(e,t,rect(0,0,tcellw+1,tcellh+1),0,"interact"==uimode)&&(setmode("interact"),ev.mu=ev.md=0),r(e,t,rect(tcellw,0,tcellw+1,tcellh+1),1,"object"==uimode)&&(setmode("object"),ev.mu=ev.md=0);for(let i=0;i<10;i++)r(e,t,rect(i%2*tcellw,(1+(0|i/2))*tcellh,tcellw+1,tcellh+1),i+2,"draw"==uimode&&dr.tool==tooltypes[i])&&(settool(tooltypes[i]),ev.mu=ev.md=0);let d=6*tcellh+tgap,c=0;for(let r=0;r<12-toolbar_scroll;r++)s(e,t,rect(0,d,tcellw+1,a+1),r+toolbar_scroll),s(e,t,rect(tcellw,d,tcellw+1,a+1),r+12+toolbar_scroll),d+=a,c++;if(count(i)){for(let r=0;c<12;r++,d+=a,c++)n(e,t,rect(0,d,toolsize.x,a+1),24+r+max(toolbar_scroll-12,0),o);draw_rect(rect(0,d+1,toolsize.x,tgap),1),d+=tgap,toolbar_scroll>0&&l(e,t,rect(0,d,tcellw+1,toolsize.y-d),0)&&toolbar_scroll--,toolbar_scroll<count(i)&&l(e,t,rect(tcellw,d,tcellw+1,toolsize.y-d),1)&&toolbar_scroll++}}),t(q("#rtools"),q("#rrender"),(e,t)=>{if(draw_rect(rect(0,16*tcellh,toolsize.x,tgap),1),i(e,t,rect(0,0,2*tcellw+1,tcellh+1),_t("stroke"),0==dr.pickfill)&&(dr.pickfill=0),i(e,t,rect(0,tcellh,2*tcellw+1,tcellh+1),_t("fill"),1==dr.pickfill)&&(dr.pickfill=1),dr.color)for(let r=0;r<16;r++){const i=(r>=2?31:0)+r;o(e,t,rect(0,2*tcellh+r*tcellh,2*tcellw+1,tcellh+1),i)}else for(let r=0;r<32;r++){const i=patorder[r];o(e,t,rect(r%2*tcellw,2*tcellh+(0|r/2)*tcellh+(r>=28?tgap:0),tcellw+1,tcellh+1),i)}const r=(dr.color,2*tcellh+16*tcellh);if(i(e,t,rect(0,r,2*tcellw+1,tcellh+1),_t("edit_color"),0)){const e=dr.pickfill?dr.fill:dr.pattern;e>=32&&e<=47&&show_color_picker_for_pattern(e)}})},setscript=e=>{"script"!=uimode&&(sc.prev_mode=uimode),setmode("script"),sc.status="",sc.target=lii(e)?e:e[0],sc.others=lii(e)?[]:e.slice(1);let t=ifield(sc.target,"script"),r=0;if(count(t)||(t=card_is(sc.target)?(r=1,lms("on view do\n \nend")):button_is(sc.target)?(r=1,lms("on click do\n \nend")):grid_is(sc.target)?(r=1,lms("on click row do\n \nend")):field_is(sc.target)||slider_is(sc.target)?(r=1,lms("on change val do\n \nend")):canvas_is(sc.target)?(r=1,lms("on click pos do\n \nend\n\non drag pos do\n \nend\n\non release pos do\n \nend")):t),r&&widget_is(sc.target)&&!contraption_is(sc.target)&&lb(ifield(sc.target,"animated"))&&(t=lms(ls(t)+"\n\non view do\n \nend")),!count(t)&&contraption_is(sc.target)){const e=sc.target.def.template;e&&e.length&&(r=1,t=lms(e))}sc.status=r?_t("no_script_template_filled"):"",sc.f=fieldstr(t),wid.active=0},finish_script=e=>{sc.next?(setscript(sc.next),sc.next=null):setmode(sc.prev_mode)},close_script=e=>{sc.next=e,field_exit();try{const e=ls(rtext_string(sc.f.table));parse(e),script_save(lms(e)),finish_script()}catch(e){modal_enter("confirm_script"),ms.message=lms(_t("script_error_discard",{error:e.x})),ms.verb=_tlms("discard")}},script_editor=e=>{const t=(e,t)=>{if(e.layout.length<1)return rect(1,1);const r=(t=max(0,min(t,e.layout.length+1)))>=e.layout.length?1:0,i=t-r,l=e.layout[i].line,s=i-e.lines[l].range.x;return rect(l+1,s+1+r)},r=3+font_h(FONT_MENU);let i=null;if(sc.xray){const e=con_wids();let t=0;for(let r=e.v.length-1;r>=0;r--){const l=e.v[r],s=con_to_screen(unpack_widget(l).size),n=ev.alt&&over(s)&&!t,o=n?(i=l,13):44;if(t|=n,draw_textc(s,ls(ifield(l,"name")),FONT_BODY,n?-1:o),draw_box(s,0,o),count(ifield(l,"script"))&&draw_icon(rect(s.x-1,s.y),ICONS[ICON.lil],n?1:o),ev.alt&&ev.mu&&over(s)&&dover(s)){close_script(l),ev.md=ev.mu=0;break}}ev.alt&&ev.mu&&(close_script(con()),ev.md=ev.mu=0)}if(ui_codeedit(rect(e.x,e.y,e.w,e.h-r),0,sc.f),draw_hline(e.x,e.x+e.w,e.y+e.h-r-1,1),i&&(uicursor=cursor.point,draw_textc(con_to_screen(unpack_widget(i).size),ls(ifield(i,"name")),FONT_BODY,-1)),sc.status.length)draw_text_fit(rect(e.x+3,e.y+e.h-r+3,e.w,r-6),sc.status,FONT_BODY,1);else{let i="";if(in_layer()&&wid.infield){const r=layout_richtext(deck,sc.f.table,FONT_MONO,ALIGN.left,e.w);let l=min(wid.cursor.x,wid.cursor.y),s=max(wid.cursor.x,wid.cursor.y);if(l!=s&&l<r.layout.length){l=max(0,min(l,r.layout.length)),s=max(0,min(s,r.layout.length));const e=t(r,l),n=t(r,s).x-e.x+1,o=s-l;i=`已选择 ${n} 行，${o} 个字符`}else{const e=t(r,min(l,s));i=`第 ${e.x} 行，第 ${e.y} 列`}}const l=font_textsize(FONT_BODY,i);draw_text(rect(3,e.y+e.h-r+3,l.x,l.y),i,FONT_BODY,1),i=`${sc.target.n} '${ls(ifield(sc.target,"name"))}' 的脚本${sc.others.length?` 和其他 ${sc.others.length} 个`:""}`;const s=layout_plaintext(i,FONT_BODY,ALIGN.right,rect(e.x+e.w-6-20-l.x,font_h(FONT_BODY)));draw_text_wrap(rect(3+l.x+20,e.y+e.h-r+3,s.size.x,s.size.y),s,1)}in_layer()&&ev.exit&&(close_script(),ev.exit=0)};let viewed=lmd();find_animated=e=>{const t=lmd();return"interact"!=uimode||con_wids().v.map(e=>{lb(ifield(e,"animated"))&&!dget(viewed,e)&&dset(t,e,ZERO),contraption_is(e)&&ivalue(e,"widgets").v.map(e=>{lb(ifield(e,"animated"))&&!dget(viewed,e)&&dset(t,e,ONE)})}),t},fire_animate=e=>{const t=lmenv(),r=lmblk();primitives(t,deck),constants(t),e.k.map(e=>{blk_cat(r,event_invoke(e,"view",lml([NIL]),null)),dset(viewed,e,ONE)}),pushstate(t),pending_popstate=1,issue(t,r)},fire_view=e=>{const t=lmenv();primitives(t,deck),constants(t);const r=event_invoke(e,"view",lml([NIL]),null);ifield(e,"widgets").v.filter(e=>contraption_is(e)&&!dget(viewed,e)).map(e=>{blk_cat(r,event_invoke(e.viewproxy,"view",lml([NIL]),null)),dset(viewed,e,ONE)}),pushstate(t),pending_popstate=1,issue(t,r)},interpret=e=>{if(viewed=lmd(),!msg.overshoot||running()||msg.pending_view||msg.next_view||(msg.overshoot=0),msg.pending_halt&&(running()&&halt(),sleep_frames=0,sleep_play=0,msg.pending_view=0,msg.next_view=0),sleep_play&&sfx_any())return 0;if(sleep_play=0,sleep_frames)return sleep_frames--,0;const t=e=>null==ms.type||"query"==ms.type||"listen"==ms.type;let r=FRAME_QUOTA;for(;;){for(;t()&&running()&&0==sleep_frames&&0==sleep_play&&r>0;)runop(),r--,mark_dirty(1);if(frame=context,r<=0&&running()&&(msg.overshoot=1),!t()||r<=0||sleep_frames||sleep_play){sleep_frames&&sleep_frames--;break}!running()&&pending_popstate&&(popstate(),pending_popstate=0);const e=find_animated();if(msg.pending_halt||pending_popstate);else if(msg.pending_view)fire_view(con()),msg.pending_view=0;else if(msg.target_click){mark_saved();const e=grid_is(msg.target_click)?lmn(msg.arg_click.y):canvas_is(msg.target_click)?lmpair(msg.arg_click):NIL;fire_event_async(msg.target_click,"click",e),msg.target_click=null}else msg.target_drag?(fire_event_async(msg.target_drag,"drag",lmpair(msg.arg_drag)),msg.target_drag=null):msg.target_release?(fire_event_async(msg.target_release,"release",lmpair(msg.arg_release)),msg.target_release=null):msg.target_run?(fire_event_async(msg.target_run,"run",msg.arg_run),msg.target_run=null):msg.target_link?(fire_event_async(msg.target_link,"link",msg.arg_link),msg.target_link=null):msg.target_order?(fire_event_async(msg.target_order,"order",msg.arg_order),msg.target_order=null):msg.target_ccell?(fire_event_async(msg.target_ccell,"changecell",msg.arg_ccell),msg.target_ccell=null):msg.target_change?(fire_event_async(msg.target_change,"change",msg.arg_change),msg.target_change=null):msg.target_navigate?(fire_event_async(msg.target_navigate,"navigate",msg.arg_navigate),msg.target_navigate=null):count(e)&&fire_animate(e);if(!running())break}return msg.next_view&&"listen"!=ms.type&&(msg.pending_view=1,msg.next_view=0),FRAME_QUOTA-r},text_edit_menu=e=>{const t=null!=wid.fv&&wid.cursor.x!=wid.cursor.y,r=null!=wid.fv&&"rich"==wid.f.style;menu_item(_t("undo"),wid.hist_cursor>0,"z")&&field_undo(),menu_item(_t("redo"),wid.hist_cursor<wid.hist.length,"Z")&&field_redo(),menu_separator(),menu_item(_t("cut"),t,"x",menucut),menu_item(_t("copy"),t,"c",menucopy),r&&menu_item(_t("copy_rich_text"),t,0,menucopyrich),menu_item(_t("paste"),null!=wid.fv,"v",menupaste),menu_item(_t("clear"),null!=wid.fv)&&(wid.cursor=rect(0,RTEXT_END),field_keys("Delete",0)),enable_touch||kc.on||(menu_separator(),menu_item(_t("soft_keyboard"),null!=wid.fv)&&keycaps_force_enter()),null!=wid.fv&&(menu_separator(),menu_item(_t("color_picker"),null!=wid.fv)&&show_color_picker()),menu_separator(),menu_item(_t("select_all"),null!=wid.fv,"a")&&(wid.cursor=rect(0,RTEXT_END))},all_menus=e=>{const t=running()||msg.overshoot,r=!t&&("listen"==ms.type||null==ms.type);if("undefined"!=typeof i18n&&i18n&&"function"==typeof i18n.init&&!i18n.currentLang&&i18n.init(),menu_bar("WPaint",r&&!kc.on),menu_item(_t("about"),1)&&modal_enter("about"),menu_separator(),"undefined"!=typeof i18n&&i18n&&!window.CHINESE_ONLY&&(i18n.currentLang||"function"!=typeof i18n.init||i18n.init(),menu_check(_t("chinese"),1,"zh"==i18n.currentLang)&&(i18n.setLang("zh"),resize(),msg&&(msg.pending_view=1)),menu_check(_t("english"),1,"en"==i18n.currentLang)&&(i18n.setLang("en"),resize(),msg&&(msg.pending_view=1)),menu_separator()),menu_check(_t("listener"),r,"listen"==ms.type,"l")&&("listen"!=ms.type?modal_enter("listen"):modal_exit(0)),menu_separator(),menu_check(_t("fullscreen"),1,is_fullscreen(),null,toggle_fullscreen),menu_check(_t("touch_input"),1,enable_touch)&&(enable_touch^=1,set_touch=1,enable_touch||(kc.on=0)),menu_check(_t("script_analyzer"),1,profiler)&&(profiler^=1),menu_check(_t("toolbar"),tzoom>0,toolbars_enable)&&(toolbars_enable^=1,resize()),t)return menu_bar(_t("menu_script"),1),menu_item(_t("stop"),1)&&(msg.pending_halt=1,"query"!=ms.type&&"listen"!=ms.type&&(null!=ms.type&&modal_exit(0),setmode("object"))),menu_bar(_t("menu_edit"),("input"==ms.type||"save"==ms.type)&&wid.fv),void text_edit_menu();if(menu_bar(_t("menu_file"),!(null!=ms.type&&"recording"!=ms.type||kc.on&&"script"!=uimode)),"script"==uimode){if(menu_item(_t("close_script"),1)&&close_script(),menu_item(_t("save_script"),1,"s"))try{const e=ls(rtext_string(sc.f.table));parse(e),script_save(lms(e)),sc.status=_t("saved")}catch(e){sc.status=`Error: ${e.x}`,wid.cursor=rect(e.i,e.i)}menu_separator(),menu_item(_t("import_script"),1,0,e=>open_text(".lil,.txt",e=>{field_exit(),sc.f=fieldstr(lms(e))})),menu_item(_t("export_script_menu"),1)&&modal_enter("export_script"),menu_separator(),menu_item(_t("go_to_deck"),!deck_is(sc.target))&&close_script(deck);const e=con();menu_item(_t(prototype_is(e)?"go_to_prototype":"go_to_card"),sc.target!=e)&&close_script(e),menu_check(_t("perspective_mode"),!kc.on,sc.xray)&&(sc.xray^=1)}else if("recording"==ms.type)menu_item(_t("import_sound"),1,0,e=>open_file("audio/*",load_sound)),menu_separator(),menu_item(_t("close_sound"),1)&&modal_exit(0);else{if(menu_item(_t("new_deck"),1)&&(dirty?(modal_enter("confirm_new"),ms.message=_tlms("unsaved_changes"),ms.verb=_tlms("discard")):load_deck(deck_read(""))),menu_item(_t("new_card"),1)){const e=deck_add(deck,lms("card")),t=ln(ifield(ifield(deck,"card"),"index"));iwrite(e,lms("index"),lmn(t+1)),n_go([e],deck)}if(menu_separator(),menu_item(_t("open_menu"),1,0,e=>open_text(".html,.deck",e=>{load_deck(deck_read(e))})),menu_item(_t("save_as"),1)&&modal_enter("save_deck"),menu_separator(),menu_item(_t("import_image"),1,0,e=>{open_file("image/*",load_image)}),menu_item(_t("export_image_menu"),1)&&modal_enter("export_image"),menu_item(_t("save_gif_menu"),1)){(()=>{try{if(!deck||!deck.cards)return;let e=[],t=[];for(let r=1;r<count(deck.cards);r++){const i=deck.cards.v[r];if(!i||!i.widgets)continue;const l=dget(i.widgets,lms("target"));if(!l||!contraption_is(l))continue;const s=ifield(l,"def");if("wiggler"!=ls(ifield(s,"name")))continue;let n=[],o=null;try{o=ifield(l,lms("frames")),lil(o)&&o.v.length>0&&(n=ll(o).filter(image_is))}catch(e){console.error(`Error getting frames from card ${r}:`,e)}if(0==n.length)try{const e=fire_attr_sync(l,"get_value",null);if(lid(e)){const t=dget(e,lms("frames"));lil(t)&&(n=ll(t).filter(image_is))}}catch(e){console.error(`Error getting value from card ${r}:`,e)}if(0==n.length)try{const e=fire_attr_sync(l,"get_frames",null);lil(e)&&(n=ll(e).filter(image_is))}catch(e){console.error(`Error getting frames via get_frames from card ${r}:`,e)}n.length>0&&(e=e.concat(n),t=t.concat(n.map(e=>10)))}if(0==e.length)return;modal_enter("confirm_transparent_bg"),ms.message=_tlms("select_background_type"),ms.verb=_tlms("transparent_background"),ms.cancel_text=_tlms("opaque_background"),ms.pending_gif_frames=e,ms.pending_gif_delays=t}catch(e){console.error("Error saving all wiggler GIF:",e)}})()}menu_separator(),menu_item(_t("clear_volatile"),1)&&(deck_purge(deck),msg.next_view=1),menu_separator(),menu_item(_t("cards_menu"),1,"C")&&modal_enter("cards"),menu_item(_t("sounds_menu"),1,"S")&&modal_enter("sounds"),menu_item(_t("prototypes_menu"),1,"T")&&modal_enter("contraptions"),menu_item(_t("resources"),1)&&modal_enter("resources"),menu_item(_t("properties_menu"),1)&&modal_enter("deck_props"),menu_item(_t("resize"),1)&&modal_enter("resize_deck")}if(null==ms.type||wid.gv||wid.fv){if(menu_bar(_t("menu_edit"),wid.gv||wid.fv||null==ms.type&&"interact"==uimode||"draw"==uimode||"object"==uimode),wid.gv){const e=!wid.g.locked&&null==ms.type;menu_item(_t("undo"),wid.hist_cursor>0,"z")&&grid_undo(),menu_item(_t("redo"),wid.hist_cursor<wid.hist.length,"Z")&&grid_redo(),menu_separator(),menu_item(_t("copy_table"),1,"c",menucopy),menu_item(_t("paste_table"),e,"v",menupaste),menu_separator(),menu_item(_t("delete_row"),e&&-1!=wid.gv.row)&&grid_deleterow(),menu_item(_t("add_row"),e)&&grid_insertrow(),menu_item(_t("query_menu"),null==ms.type,"u")&&modal_enter("query")}if(wid.fv&&text_edit_menu(),null==ms.type&&"interact"==uimode&&(menu_item(_t("undo"),has_undo(),"z")&&undo(),menu_item(_t("redo"),has_redo(),"Z")&&redo(),menu_separator(),menu_item(_t("paste"),1,"v",menupaste)),null==ms.type&&"draw"==uimode){const e=bg_has_sel()||bg_has_lasso();if(menu_item(_t("undo"),!e&&has_undo(),"z")&&undo(),menu_item(_t("redo"),!e&&has_redo(),"Z")&&redo(),menu_separator(),menu_item(_t("cut_image"),e,0,menucut),menu_item(_t("copy_image"),e,0,menucopy),menu_item(_t("paste"),1,"v",menupaste),menu_item(_t("clear"),1)){const t=dr.tool;e||(settool("select"),dr.sel_here=rcopy(con_dim())),bg_delete_selection(),settool(t)}if(menu_separator(),menu_item(_t("select_all"),1,"a")&&(settool("select"),dr.sel_here=rcopy(con_dim())),menu_item(_t("tight_selection"),e,"g")&&bg_tighten(),menu_item(_t("add_outline"),e)&&bg_outline(),menu_item(_t("resize_to_original"),e&&"select"==dr.tool,0)){bg_scoop_selection();const e=dr.limbo.size;dr.sel_here.w=e.x,dr.sel_here.h=e.y}if(menu_item(_t(prototype_is(con())?"resize_to_prototype":"resize_to_card"),e&&"select"==dr.tool,0)&&(bg_scoop_selection(),dr.sel_here=con_dim()),menu_separator(),menu_item(_t("invert"),e&&!dr.limbo_dither,"i")){bg_has_sel()&&bg_scoop_selection();const e=dr.limbo.size;deck.patterns.pal.pix;for(let t=0;t<dr.limbo.pix.length;t++)dr.limbo.pix[t]=1^draw_pattern(dr.limbo.pix[t],t%e.x,0|t/e.x)}if(menu_item(_t("flip_horizontal"),e)&&(bg_has_sel()&&bg_scoop_selection(),image_flip_h(dr.limbo),dr.mask&&image_flip_h(dr.mask),dr.omask&&dr.limbo_dither&&image_flip_h(dr.omask)),menu_item(_t("flip_vertical"),e)&&(bg_has_sel()&&bg_scoop_selection(),image_flip_v(dr.limbo),dr.mask&&image_flip_v(dr.mask),dr.omask&&dr.limbo_dither&&image_flip_v(dr.omask)),menu_item(_t("rotate_left"),e,",")){const e=rect(dr.sel_here.w,dr.sel_here.h);bg_has_sel()&&bg_scoop_selection(),image_flip_h(dr.limbo),image_flip(dr.limbo),dr.mask&&(image_flip_h(dr.mask),image_flip(dr.mask)),dr.omask&&dr.limbo_dither&&(image_flip_h(dr.omask),image_flip(dr.omask)),dr.sel_here.w=e.y,dr.sel_here.h=e.x}if(menu_item(_t("rotate_right"),e,".")){const e=rect(dr.sel_here.w,dr.sel_here.h);bg_has_sel()&&bg_scoop_selection(),image_flip(dr.limbo),image_flip_h(dr.limbo),dr.mask&&(image_flip(dr.mask),image_flip_h(dr.mask)),dr.omask&&dr.limbo_dither&&(image_flip(dr.omask),image_flip_h(dr.omask)),dr.sel_here.w=e.y,dr.sel_here.h=e.x}dr.limbo_dither&&e&&(menu_separator(),menu_item(_t("brighten"),dr.dither_threshold>-2)&&(dr.dither_threshold-=.1),menu_item(_t("darken"),dr.dither_threshold<2)&&(dr.dither_threshold+=.1))}if(null==ms.type&&"object"==uimode&&(menu_item(_t("undo"),has_undo(),"z")&&undo(),menu_item(_t("redo"),has_redo(),"Z")&&redo(),menu_separator(),menu_item(_t("cut_widgets"),ob.sel.length,"x",menucut),menu_item(_t("copy_widgets"),ob.sel.length,"c",menucopy),menu_item(_t("copy_image"),1==ob.sel.length,0,copywidgetimg),menu_item(_t("paste"),1,"v",menupaste),menu_separator(),menu_item(_t("paste_as_new_canvas"),1,0,pasteascanvas),menu_item(_t("paste_into_canvas"),1==ob.sel.length&&canvas_is(ob.sel[0]),0,pasteintocanvas),menu_separator(),menu_item(_t("select_all"),1,"a")&&(ob.sel=con_wids().v.slice(0)),menu_item(_t("move_to_front"),ob.sel.length)&&(ob_order(),ob.sel.map(e=>iwrite(e,lms("index"),lmn(RTEXT_END))),mark_dirty()),menu_item(_t("move_up"),ob.sel.length)&&ob_move_up(),menu_item(_t("move_down"),ob.sel.length)&&ob_move_dn(),menu_item(_t("move_to_back"),ob.sel.length)&&(ob_order(),ob.sel.slice(0).reverse().map(e=>iwrite(e,lms("index"),ZERO)),mark_dirty())),wid.fv&&wid.f){const e=null!=wid.fv&&wid.cursor.x!=wid.cursor.y;menu_bar(_t("menu_text"),e&&"plain"!=wid.f.style),"rich"==wid.f.style?(menu_item(_t("title"),e)&&field_stylespan(lms("menu"),lms("")),menu_item(_t("body"),e)&&field_stylespan(lms(""),lms("")),menu_item(_t("monospace"),e)&&field_stylespan(lms("mono"),lms("")),menu_item(_t("link_menu"),e)&&modal_push("link")):"code"==wid.f.style&&(menu_item(_t("indent"),1)&&field_indent(1),menu_item(_t("unindent"),1)&&field_indent(0),menu_item(_t("toggle_comment"),1,"/")&&field_comment()),wid.f&&"code"!=wid.f.style&&menu_item(_t("font_menu"),"plain"!=wid.f.style)&&modal_push("fonts")}}if("recording"!=ms.type||wid.fv||(menu_bar(_t("menu_edit"),"stopped"==au.mode),menu_item(_t("undo"),au.hist_cursor>0,"z")&&sound_undo(),menu_item(_t("redo"),au.hist_cursor<au.hist.length,"Z")&&sound_redo(),menu_separator(),menu_item(_t("cut_sound"),1,"x",menucut),menu_item(_t("copy_sound"),1,"c",menucopy),menu_item(_t("paste_sound"),1,"v",menupaste),menu_item(_t("clear"),1,0)&&sound_delete(),menu_separator(),menu_item(_t("select_all"),1,"a")&&(au.head=0,au.sel=rect(0,au.target.data.length-1))),"interact"!=uimode&&"draw"!=uimode&&"object"!=uimode||!card_is(con())||(menu_bar(_t("card"),null==ms.type&&!kc.on),menu_item(_t("go_to_first"),1)&&n_go([lms("First")],deck),menu_item(_t("go_to_previous"),1)&&n_go([lms("Prev")],deck),menu_item(_t("go_to_next"),1)&&n_go([lms("Next")],deck),menu_item(_t("go_to_last"),1)&&n_go([lms("Last")],deck),menu_item(_t("go_back"),deck.history.length>1)&&n_go([lms("Back")],deck),menu_separator(),menu_item(_t("cut_card"),1,0,cutcard),menu_item(_t("copy_card"),1,0,copycard),menu_item(_t("copy_and_paste_card"),1)&&copyAndPasteCard(),menu_separator(),menu_item(_t("auto_switch_settings"),1)&&modal_enter("autoswitch_settings"),menu_item(_t(autoSwitchState.enabled?"stop_auto_switch":"start_auto_switch"),1)&&(autoSwitchState.enabled?stopAutoSwitch():startAutoSwitch()),menu_separator(),menu_item(_t("script"),1)&&setscript(con()),menu_item(_t("properties"),1)&&modal_enter("card_props")),("interact"==uimode||"draw"==uimode||"object"==uimode)&&prototype_is(con())){menu_bar(_t("prototype"),null==ms.type&&!kc.on);const e=con(),t=deck.contraptions;menu_item(_t("close"),1)&&con_set(null),menu_item(_t("go_to_previous_menu"),count(t)>1)&&(ev.dir="left",tracking(),ev.dir=0),menu_item(_t("go_to_next_menu"),count(t)>1)&&(ev.dir="right",tracking(),ev.dir=0),menu_separator(),menu_item(_t("script"),1)&&setscript(con()),menu_item(_t("properties"),1)&&modal_enter("prototype_props"),menu_item(_t("attributes"),1)&&modal_enter("prototype_attrs"),menu_check(_t("show_margins"),1,ob.show_margins)&&(ob.show_margins^=1),menu_separator();let r=lb(ifield(e,"resizable"));menu_check(_t("resizable"),1,r,0)&&(r^=1,iwrite(e,lms("resizable"),lmn(r)),mark_dirty())}if("interact"!=uimode&&"draw"!=uimode&&"object"!=uimode||(menu_bar(_t("menu_tool"),null==ms.type&&!kc.on),menu_check(_t("interact"),1,"interact"==uimode,0)&&setmode("interact"),menu_check(_t("widget"),1,"object"==uimode,0)&&setmode("object"),menu_separator(),menu_check(_t("select_tool"),1,"draw"==uimode&&"select"==dr.tool)&&settool("select"),menu_check(_t("lasso"),1,"draw"==uimode&&"lasso"==dr.tool)&&settool("lasso"),menu_check(_t("pencil"),1,"draw"==uimode&&"pencil"==dr.tool)&&settool("pencil"),menu_check(_t("line"),1,"draw"==uimode&&"line"==dr.tool)&&settool("line"),menu_check(_t("fill"),1,"draw"==uimode&&"fill"==dr.tool)&&settool("fill"),menu_check(_t("rectangle"),1,"draw"==uimode&&"rect"==dr.tool)&&settool("rect"),menu_check(_t("filled_rectangle"),1,"draw"==uimode&&"fillrect"==dr.tool)&&settool("fillrect"),menu_check(_t("ellipse"),1,"draw"==uimode&&"ellipse"==dr.tool)&&settool("ellipse"),menu_check(_t("filled_ellipse"),1,"draw"==uimode&&"fillellipse"==dr.tool)&&settool("fillellipse"),menu_check(_t("polygon"),1,"draw"==uimode&&"poly"==dr.tool)&&settool("poly")),"draw"!=uimode&&"object"!=uimode||(menu_bar(_t("menu_view"),null==ms.type&&!kc.on),menu_check(_t("show_widgets"),1,dr.show_widgets)&&(dr.show_widgets^=1),menu_check(_t("show_widget_boundaries"),1,ob.show_bounds)&&(ob.show_bounds^=1),menu_check(_t("show_widget_names"),1,ob.show_names)&&(ob.show_names^=1),menu_check(_t("show_cursor_info"),1,ob.show_cursor)&&(ob.show_cursor^=1),menu_check(_t("show_alignment_guides"),1,ob.show_guides)&&(ob.show_guides^=1),menu_separator(),menu_check(_t("show_grid_overlay"),1,dr.show_grid)&&(dr.show_grid^=1),menu_check(_t("snap_to_grid"),1,dr.snap)&&(dr.snap^=1),menu_item(_t("grid_and_scale"),1)&&modal_enter("grid"),menu_separator(),menu_check(_t("show_animation"),1,dr.show_anim)&&(dr.show_anim^=1),menu_check(_t("transparency_mask"),1,dr.trans_mask)&&(dr.trans_mask^=1),menu_check(_t("fatbits"),1,dr.fatbits)&&(null==ms.type&&"draw"!=uimode&&setmode("draw"),dr.fatbits^=1,dr.fatbits&&center_fatbits(rcenter(bg_has_sel()||bg_has_lasso()?dr.sel_here:con_dim(),rect())))),"draw"==uimode&&(menu_bar(_t("menu_style"),null==ms.type&&!kc.on),menu_item(_t("stroke_menu"),1)&&modal_enter("pattern"),menu_item(_t("fill_menu"),1)&&modal_enter("fill"),menu_item(_t("brush_menu"),1)&&modal_enter("brush"),menu_separator(),menu_check(_t("color"),1,dr.color)&&(dr.color^=1),menu_check(_t("transparency"),1,dr.trans)&&(dr.trans^=1),menu_check(_t("underlay"),1,dr.under)&&(dr.under^=1)),"object"==uimode){menu_bar(_t("widget"),null==ms.type),menu_item(_t("new_button"),1)&&ob_create([lmd([lms("type")],[lms("button")])]),menu_item(_t("new_field"),1)&&ob_create([lmd([lms("type")],[lms("field")])]),menu_item(_t("new_slider"),1)&&ob_create([lmd([lms("type")],[lms("slider")])]),menu_item(_t("new_canvas"),1)&&ob_create([lmd([lms("type")],[lms("canvas")])]),menu_item(_t("new_grid"),1)&&ob_create([lmd([lms("type")],[lms("grid")])]),card_is(con())&&menu_item(_t("new_contraption_menu"),1)&&modal_enter("pick_contraption"),menu_separator(),menu_item(_t("sort"),count(ifield(con(),"widgets")))&&modal_enter("orderwids"),menu_separator();let e=1,t=1,r=1,i=1,l=1,s=1,n=1;ob.sel.map(unpack_widget).map(t=>{e&=t.locked,i&="solid"==t.show,l&="transparent"==t.show,s&="invert"==t.show,n&="none"==t.show}),ob.sel.map(e=>t&=lb(ifield(e,"animated"))),ob.sel.map(e=>r&=lb(ifield(e,"volatile"))),menu_check(_t("lock"),ob.sel.length,ob.sel.length&&e)&&ob_edit_prop("locked",lmn(!e)),menu_check(_t("animate"),ob.sel.length,ob.sel.length&&t)&&ob_edit_prop("animated",lmn(!t)),menu_check(_t("volatile"),ob.sel.length,ob.sel.length&&r)&&ob_edit_prop("volatile",lmn(!r)),menu_separator(),menu_check(_t("show_solid"),ob.sel.length,ob.sel.length&&i)&&ob_edit_prop("show",lms("solid")),menu_check(_t("show_transparent"),ob.sel.length,ob.sel.length&&l)&&ob_edit_prop("show",lms("transparent")),menu_check(_t("show_invert"),ob.sel.length,ob.sel.length&&s)&&ob_edit_prop("show",lms("invert")),menu_check(_t("show_none"),ob.sel.length,ob.sel.length&&n)&&ob_edit_prop("show",lms("none")),menu_separator(),menu_item(_t("font_menu"),ob.sel.length)&&modal_enter("fonts"),menu_item(_t("script"),ob.sel.length)&&(ob.sel.reduce((e,t)=>e&&ob.sel[0].script==t.script,1)?setscript(ob.sel):(modal_enter("multiscript"),ms.message=_tlms("different_scripts_edit_together"),ms.verb=_tlms("edit"))),(menu_item(_t("properties"),1==ob.sel.length)||1==ob.sel.length&&ev.action&&null==ms.type)&&object_properties(ob.sel[0])}if("listen"==ms.type){if(menu_bar(_t("listener"),1),menu_item(_t("clear_history"),1)&&(li.hist=[],li.scroll=0),menu_item(_t("clear_locals"),1)&&(li.vars=new Map),menu_separator(),menu_item(_t("show_locals"),1)){const e=lmd();for(let t of li.vars.keys())dset(e,lms(t),li.vars.get(t));listen_show(ALIGN.right,0,e)}menu_separator(),menu_item(_t("evaluate"),rtext_len(ms.text.table))&&listener_eval()}menu_bar(_t("menu_help"),1),menu_item("Wpaint 网站...",1)&&n_go([lms("https://wpaint.fun")],deck),menu_item("Decker 网站...",1)&&n_go([lms("http://beyondloom.com/decker/index.html")],deck),menu_item("Decker 社区...",1)&&n_go([lms("https://internet-janitor.itch.io/decker/community")],deck),menu_item("Decker 参考...",1)&&n_go([lms("http://beyondloom.com/decker/decker.html")],deck),menu_item("Lil 参考...",1)&&n_go([lms("http://beyondloom.com/decker/lil.html")],deck)},main_view=e=>{in_layer()&&"object"==uimode&&0==ob.sel.length&&tracking();const t=con_image(),r=con_wids(),i=deck.patterns.pal.pix;if("trans"!=ms.type){const e=con_clip(),r=con_size();if(t.size.x==r.x&&t.size.y==r.y||(image_resize(t,r),mark_dirty()),dr.fatbits)frame.image.pix.fill(46),draw_rect(e,dr.trans_mask?45:32),draw_fat(e,t,i,frame_count,0,dr.zoom,dr.offset);else if(r.x==frame.size.x&&r.y==frame.size.y)for(let e=0;e<t.pix.length;e++)frame.image.pix[e]=t.pix[e];else frame.image.pix.fill(46),draw_rect(e,dr.trans_mask?45:32),image_paste(e,frame.clip,t,frame.image,0)}ev=ev_to_con(ev),"draw"==uimode&&in_layer()&&bg_tools(),"select"==dr.tool&&(dr.sel_start.w>0||dr.sel_start.h>0)&&draw_rect(con_to_screen(dr.sel_start),dr.fill),bg_lasso_preview();const l=bg_select();if(ev=con_to_ev(ev),("object"==uimode||"draw"==uimode)&&dr.show_grid||"grid"==ms.type){const e=con_dim();if(dr.fatbits){for(let t=dr.grid_size.x;t<e.w;t+=dr.grid_size.x){const r=con_to_screen(rect(e.x+t,e.y,1,e.h));draw_vline(r.x,r.y,r.y+r.h,44)}for(let t=dr.grid_size.y;t<e.h;t+=dr.grid_size.y){const r=con_to_screen(rect(e.x,e.y+t,e.w,1));draw_hline(r.x,r.x+r.w,r.y,44)}}else for(let t=dr.grid_size.x;t<e.w;t+=dr.grid_size.x)for(let r=dr.grid_size.y;r<e.h;r+=dr.grid_size.y){const e=con_to_screen(rect(t,r));draw_rect(rect(e.x,e.y,1,1),44)}}if("object"==uimode&&ob.show_guides&&ob.sel.length){const e=ob.sel.map(e=>con_to_screen(unpack_widget(e).size)).reduce(runion);r.v.filter(e=>!ob.sel.some(t=>t==e)).map(t=>{const r=con_to_screen(unpack_widget(t).size),i=runion(r,e);e.y==r.y&&draw_hline(i.x,i.x+i.w,i.y,13),e.y+e.h==r.y+r.h&&draw_hline(i.x,i.x+i.w,i.y+i.h,13),e.x==r.x&&draw_vline(i.x,i.y,i.y+i.h,13),e.x+e.w==r.x+r.w&&draw_vline(i.x+i.w,i.y,i.y+i.h,13),e.y==r.y+r.h&&draw_hline(i.x,i.x+i.w,e.y,13),e.y+e.h==r.y&&draw_hline(i.x,i.x+i.w,r.y,13),e.x==r.x+r.w&&draw_vline(e.x,i.y,i.y+i.h,13),e.x+e.w==r.x&&draw_vline(r.x,i.y,i.y+i.h,13)})}const s=ev;"interact"!=uimode&&(ev=event_state()),"interact"==uimode||dr.show_widgets&&!dr.fatbits?handle_widgets(r,con_offset()):dr.show_widgets&&dr.fatbits&&r.v.map(e=>{draw_boxinv(i,con_to_screen(unpack_widget(e).size))}),ev=s;const n=prototype_size_editor();if("draw"==uimode&&(bg_has_sel()&&draw_handles(con_to_screen(l)),draw_box(con_to_screen(l),0,ANTS)),wid.pending_grid_edit&&(wid.pending_grid_edit=0,modal_enter("gridcell")),"object"!=uimode||n||(ev=ev_to_con(ev),object_editor(),ev=con_to_ev(ev)),("object"==uimode&&ob.show_names||"draw"==uimode&&dr.show_widgets&&dr.fatbits||"listen"==ms.type)&&r.v.map(e=>{const t=con_to_screen(unpack_widget(e).size),r=ls(ifield(e,"name")),i=font_textsize(FONT_BODY,r);draw_text_outlined(rect(t.x,t.y-i.y,i.x,i.y),r,FONT_BODY)}),ob.show_cursor&&null==ms.type&&{draw:1,object:1}[uimode]){ev=ev_to_con(ev);const e=(e,t)=>{const r=ls(dyad.format(lms(e),lml([t.x,t.y,t.w,t.h].map(lmn)))),i=font_textsize(FONT_BODY,r);draw_text_outlined(rsub(con_to_screen(rpair(ev.pos,i)),rect(0,i.y)),r,FONT_BODY)};if("draw"==uimode&&bg_has_sel())e("(%3i,%3i,%3i,%3i)",l);else if("object"==uimode&&ev.drag&&is_resizable())e("(%3i,%3i,%3i,%3i)",unpack_widget(ob.sel[0]).size);else if(ev.drag){const t=ev.dpos,r=ev.pos;e("(%3i,%3i,%3i,%3i)",rpair(r,rsub(r,t)))}else e("(%3i,%3i)",ev.pos);ev=con_to_ev(ev)}in_layer()&&ev.exit&&!dr.fatbits&&!card_is(con())&&(con_set(null),ev.exit=0)},gestures=e=>{if(!enable_touch||!card_is(con()))return;if(!in_layer()||"interact"!=uimode||!ev.drag&&!ev.mu)return;if(ev.drag&&ob.sel.length&&lb(ifield(ob.sel[0],"draggable")))return;if(con_wids().v.some(e=>dover(unpack_widget(e).size)))return;const t=rsub(ev.pos,ev.dpos);if(Math.sqrt(t.x*t.x+t.y*t.y)<50)return;if(Math.abs(t.x)<2*Math.abs(t.y)&&Math.abs(t.y)<2*Math.abs(t.x))return;const r=Math.abs(t.x)>2*Math.abs(t.y)?t.x<0?"left":"right":t.y<0?"up":"down";image_paste(rect(ev.pos.x-8,ev.pos.y-8,16,16),frame.clip,GESTURES[r],frame.image,0),ev.mu&&(msg.target_navigate=con(),msg.arg_navigate=lms(r))},validate_modules=e=>{for(let e=0;e<count(deck.modules);e++){const t=ifield(deck.modules.v[e],"error");if(count(t)){modal_enter("alert"),ms.message=rtext_cast(lms(`The module "${ls(deck.modules.k[e])}" failed to initialize: ${ls(t)}`));break}}},load_deck=e=>{deck=e,dirty=0,wid.active=-1,wid.hist=[],au.hist=[],doc_hist=[],doc_hist_cursor=0,dr=draw_state(),con_set(null),FONT_BODY=dget(deck.fonts,lms("body")),FONT_MENU=dget(deck.fonts,lms("menu")),FONT_MONO=dget(deck.fonts,lms("mono")),fb=image_make(deck.size),context=frame=draw_frame(fb),validate_modules(),setmode("interact"),msg.next_view=1,seed=0|(new Date).getTime()/1e3,n_play([NIL,lms("loop")]);const t=(e=0)=>{if(!(e>10))try{if(deck.hasOwnProperty("autoswitch_uniformInterval")&&(autoSwitchState.uniformInterval=ln(deck.autoswitch_uniformInterval),console.log("Loaded uniformInterval:",autoSwitchState.uniformInterval)),deck.hasOwnProperty("autoswitch_intervals"))try{const e=deck.autoswitch_intervals;console.log("Raw intervals data:",e),e&&e.v&&Array.isArray(e.v)?autoSwitchState.intervals=e.v.map(e=>ln(e)):autoSwitchState.intervals="string"==typeof e?JSON.parse(e):[],console.log("Loaded intervals:",autoSwitchState.intervals)}catch(e){console.warn("Failed to parse autoswitch intervals:",e),autoSwitchState.intervals=[]}deck.hasOwnProperty("autoswitch_startCard")&&(autoSwitchState.startCard=ln(deck.autoswitch_startCard),console.log("Loaded startCard:",autoSwitchState.startCard)),deck.hasOwnProperty("autoswitch_endCard")&&(autoSwitchState.endCard=ln(deck.autoswitch_endCard),console.log("Loaded endCard:",autoSwitchState.endCard)),deck.hasOwnProperty("autoswitch_isEnabled")&&(autoSwitchState.isEnabled=1===ln(deck.autoswitch_isEnabled),console.log("Loaded isEnabled:",autoSwitchState.isEnabled))}catch(r){console.log("第"+(e+1)+"次加载失败"),setTimeout(()=>{t(e+1)},300)}};t()},tick=e=>{pointer.up=ev.mu,pointer.down=ev.md,toolbars(),msg.pending_drag=0,msg.pending_halt=0,frame=context,uicursor=0,fb.pix.fill(0),menu_setup(),all_menus(),widget_setup();const t=ev;if(kc.heading=null,kc.on&&(ev=event_state()),"script"==uimode){const e="undefined"!=typeof window&&window.HIDE_NAV?0:3+font_h(FONT_MENU);kc.on||script_editor(rect(0,e,frame.size.x+1,frame.size.y-e))}else main_view();if(modals(),gestures(),kc.on&&(ev=t,keycaps()),"script"==uimode&&enable_touch&&null==ms.type&&(wid.active=0),menu_finish(),"draw"==uimode&&dr.fatbits&&!ev.hidemenu&&draw_icon(rect(frame.size.x-14,2),ZOOM,1),"interact"==uimode&&ev.drag&&ob.sel.length&&lb(ifield(ob.sel[0],"draggable"))){const e=ob.sel[0].card,t=contraption_is(e)||prototype_is(e)?getpair(ifield(e,"pos")):rect(0,0);iwrite(ob.sel[0],lms("pos"),lmpair(rsub(rsub(ev.pos,ob.prev),t))),mark_dirty()}document.title=ls(ifield(deck,"name"))||_t("untitled_deck");for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)draw_icon(rect(e*(context.size.x-5),t*(context.size.y-5)),CORNERS[e+2*t],1);const r=interpret();if("interact"==uimode&&profiler){const e=rect(frame.size.x-60,2,50,12),t=deck.patterns.pal.pix;draw_text(inset(e,2),ls(dyad.format(lms("%0.2f%%"),lmn(100*r/FRAME_QUOTA))),FONT_BODY,1),draw_box(e,0,1);for(let r=0;r<e.w-2;r++){let i=0;for(let e=0;e<4;e++)i=max(i,profiler_hist[(profiler_ix+4*r+e)%profiler_hist.length]);draw_invert(t,rect(e.x+1+r,e.y+e.h-i,1,i-1))}profiler_hist[profiler_ix]=(e.h-2)*r/FRAME_QUOTA,profiler_ix=(profiler_ix+1)%profiler_hist.length}if(("object"==uimode||"draw"==uimode&&!dr.fatbits)&&!ev.hidemenu){const e=menu_label();draw_textr(e,ls(ifield(con(),"name")),FONT_BODY,1),null==ms.type&&(over(e)&&(uicursor=cursor.point),ev.mu&&over(e)&&dover(e)&&modal_enter(card_is(con())?"card_props":"prototype_props"))}q("#display").style.cursor=uicursor||"default",msg.pending_loop&&sfx_doloop(),ui_container&&ui_container.dead&&(ui_container=null),ev.shortcuts={},ev.mu=ev.md=ev.click=ev.dclick=ev.tab=ev.action=ev.dir=ev.exit=ev.eval=ev.scroll=ev.rdown=ev.mdown=ev.rup=0,ev.clicktime&&ev.clicktime--,ev.clicklast&&ev.clicklast--,ev.pos.x==ev.dpos.x&&ev.pos.y==ev.dpos.y||(ev.clicklast=0),wid.cursor_timer=(wid.cursor_timer+1)%(2*FIELD_CURSOR_DUTY),wid.change_timer&&(wid.change_timer--,0==wid.change_timer&&field_change()),keyup={},pending_tick=1,frame_count++};let id=null,sync_first_call=!0;sync=e=>{pick_palette(deck),sync_first_call&&(sync_first_call=!1);const t=deck.patterns.anim,r=deck.patterns.pal.pix,i=dr.trans_mask&&"draw"==uimode,l=dr.show_anim?0|frame_count/4:0,s=(e,r,i)=>e<28||e>31?e:t[e-28][l%max(1,t[e-28].length)],n=(e,t,i)=>e==ANTS?((e,t)=>(0|(e+t+(0|frame_count/2))/3)%2?15:0)(t,i):e>47?0:e>31?e-32:((e,t,i)=>e<2?e?1:0:e>31?32==e?0:1:1&pal_pat(r,e,t,i))(e,t,i)?15:0;id&&id.width==fb.size.x&&id.height==fb.size.y||(id=new ImageData(fb.size.x,fb.size.y),id.data.fill(255));for(let e=0,t=0,r=0;r<id.height;r++)for(let l=0;l<id.width;l++,e++,t+=4){const o=s(fb.pix[e]),a=0==o&&i?13:n(o,l,r),d=COLORS[a];id.data[t]=255&d>>16,id.data[t+1]=255&d>>8,id.data[t+2]=255&d}const o=q("#render");o.getContext("2d").putImageData(id,0,0);const a=q("#display").getContext("2d");a.imageSmoothingEnabled=zoom!=(0|zoom),a.save(),a.scale(zoom,zoom),a.drawImage(o,0,0),a.restore(),updateRecordingCanvas()},move=(e,t)=>{msg.pending_drag||(pointer.prev=pointer.pos),pointer.pos=ev.pos=rect(e,t),pointer.held&&(msg.pending_drag=1)},down=(e,t,r)=>{ev.rawdpos=ev.rawpos,ev.down_modal=ms.type,ev.down_uimode=uimode,ev.down_caps=kc.on,move(e,t),pointer.held=ev.drag=1,pointer.start=ev.dpos=pointer.pos,ev.md=1,ev.clicktime=12,r&&(ev.rdown=1),initaudio()},up=(e,t,r)=>{move(e,t),pointer.held=ev.drag=0,pointer.end=pointer.pos,ev.mu=1,r&&(ev.rup=1),ev.clicktime&&(ev.click=1),ev.clicktime=0,ev.clicklast&&(ev.dclick=1),ev.clicklast=DOUBLE_CLICK_DELAY,ev.callback&&ev.callback_rect&&over(ev.callback_rect)&&(ev.callback_drag||dover(ev.callback_rect))&&ev.callback(),ev.callback=null,ev.callback_rect=null,ev.callback_drag=0,audio&&audio.resume()},mouse=(e,t)=>{const r=q("#colorPickerModal");if(r&&"none"!==r.style.display){if(r.contains(e.target))return;const t=q(".sp-container");return void(t&&t.contains(e.target))}ev.rawpos=rect(e.pageX,e.pageY);const i=q("#display").getBoundingClientRect();1!=e.button?t(0|(e.pageX-i.x)/zoom,0|(e.pageY-i.y)/zoom,0!=e.button):t==down&&(ev.mdown=1)},touch=(e,t)=>{const r=e.targetTouches[0]||{};mouse({pageX:r.clientX,pageY:r.clientY,button:0},t),set_touch||(enable_touch=1)};let prev_stamp=null,leftover=0;loop=e=>{prev_stamp||(prev_stamp=e);let t=e-prev_stamp+leftover,r=1e3/60,i=0;for(;t>r;)if(tick(),i++,t-=r,5==i){t=0;break}leftover=t,sync(),prev_stamp=e,requestAnimationFrame(loop),do_panic&&setmode("object"),do_panic=0},resize=e=>{const t=q("body"),r=rect(t.clientWidth,t.clientHeight),i=min(r.x/fb.size.x,r.y/fb.size.y);zoom=max(1,is_fullscreen()?i:0|i),tzoom=0|min((r.x-zoom*fb.size.x)/(2*toolsize.x),r.y/toolsize.y);const l=tzoom*toolbars_enable,s=q("#display");s.width=fb.size.x*zoom,s.height=fb.size.y*zoom;const n=q("#ltools");n.width=toolsize.x*l,n.height=toolsize.y*l;const o=q("#rtools");o.width=toolsize.x*l,o.height=toolsize.y*l;const a=q("#render");a.width=fb.size.x,a.height=fb.size.y;const d=q("#lrender");d.width=toolsize.x,d.height=toolsize.y;const c=q("#rrender");c.width=toolsize.x,c.height=toolsize.y},window.onresize=e=>{resize(),sync()},q("body").addEventListener("mousedown",e=>mouse(e,down)),q("body").addEventListener("mouseup",e=>mouse(e,up)),q("body").addEventListener("mousemove",e=>mouse(e,move)),q("body").addEventListener("contextmenu",e=>e.preventDefault());const handleTouchStart=e=>{if(q(".lang-modal-overlay"))return;const t=q("#colorPickerModal");if(t&&"none"!==t.style.display){if(t.contains(e.target))return void console.log("Touch event on color picker, letting it pass.");const r=q(".sp-container");return r&&r.contains(e.target)?void console.log("Touch event on spectrum container, letting it pass."):void console.log("Color picker is open, ignoring touch event on background")}e.preventDefault(),touch(e,down)};q("body").addEventListener("touchstart",handleTouchStart,{passive:!1}),q("body").addEventListener("touchend",e=>{if(q(".lang-modal-overlay"))return;const t=q("#colorPickerModal");t&&"none"!==t.style.display||touch({targetTouches:e.changedTouches},up)}),q("body").addEventListener("touchmove",e=>{if(q(".lang-modal-overlay"))return;const t=q("#colorPickerModal");t&&"none"!==t.style.display||touch(e,move)}),q("body").onwheel=e=>ev.scroll=e.deltaY<0?-1:e.deltaY>0?1:0;let hiddenInput=null,isInputMethodActive=!1;function createHiddenInput(){return hiddenInput||(hiddenInput=document.createElement("input"),hiddenInput.style.position="absolute",hiddenInput.style.left="-9999px",hiddenInput.style.opacity="0",hiddenInput.style.pointerEvents="none",hiddenInput.setAttribute("autocomplete","off"),hiddenInput.setAttribute("autocorrect","off"),hiddenInput.setAttribute("autocapitalize","off"),hiddenInput.setAttribute("spellcheck","false"),hiddenInput.setAttribute("inputmode","text"),hiddenInput.setAttribute("enterkeyhint","done"),document.body.appendChild(hiddenInput),hiddenInput.addEventListener("input",e=>{wid.infield&&e.data&&(field_input(clchars(e.data)),hiddenInput.value="")}),hiddenInput.addEventListener("compositionstart",e=>{isInputMethodActive=!0}),hiddenInput.addEventListener("compositionend",e=>{isInputMethodActive=!1,wid.infield&&e.data&&(field_input(clchars(e.data)),hiddenInput.value="")}),hiddenInput.addEventListener("blur",e=>{isInputMethodActive=!1})),hiddenInput}function activateInputMethod(){if(wid.infield&&window.chineseInputEnabled){const e=createHiddenInput();e.focus(),setTimeout(()=>{wid.infield&&window.chineseInputEnabled&&e.focus()},100)}}function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0}window.chineseInputEnabled=!1,q("body").onkeydown=e=>{const t=document.activeElement;if(!t||!t.classList.contains("sp-input")&&!t.closest(".sp-container")){if(initaudio(),keydown[e.key]=1,e.shiftKey&&(ev.shift=1),"ArrowUp"==e.key&&(ev.dir="up"),"ArrowDown"==e.key&&(ev.dir="down"),"ArrowLeft"==e.key&&(ev.dir="left"),"ArrowRight"==e.key&&(ev.dir="right"),e.metaKey||e.ctrlKey)ev.alt=1,ev.shortcuts[e.shiftKey?e.key.toUpperCase():e.key]=1;else{if(1==e.key.length&&wid.infield)return window.chineseInputEnabled?("Process"===e.key||e.isComposing,activateInputMethod(),void e.preventDefault()):(field_input(clchars(e.key)),void e.preventDefault());"draw"==uimode&&null==ms.type?"Backspace"!=e.key&&"Delete"!=e.key||bg_delete_selection():"object"==uimode&&null==ms.type?("["==e.key&&ob_move_dn(),"]"==e.key&&ob_move_up(),"Backspace"!=e.key&&"Delete"!=e.key||ob_destroy()):"recording"!=ms.type||wid.infield||"stopped"!=au.mode||"Backspace"!=e.key&&"Delete"!=e.key||sound_delete()}"Enter"==e.key&&(ev.action=1),wid.ingrid?grid_keys(e.key,e.shiftKey):wid.infield&&field_keys(e.key,e.shiftKey),"script"==uimode&&(sc.status="")," "!=e.key||wid.infield||(ev.action=1),"Tab"==e.key&&(ev.tab=1),"L"!=e.key||null!=ms.type||wid.ingrid||wid.infield||(ev.shortcuts.l=1),"f"!=e.key||null!=ms.type||wid.ingrid||wid.infield||toggle_fullscreen,"j"==e.key&&null==ms.type&&dr.limbo_dither&&dr.dither_threshold>-2&&(dr.dither_threshold-=.1),"k"==e.key&&null==ms.type&&dr.limbo_dither&&dr.dither_threshold<2&&(dr.dither_threshold+=.1),(e.metaKey||e.ctrlKey)&&{c:1,x:1,v:1}[e.key]||e.preventDefault()}},q("body").onkeyup=e=>{keydown[e.key]=0,keyup[e.key]=1,("Meta"==e.key||"Control"==e.key||e.metaKey||e.ctrlKey)&&(ev.alt=0,keydown={}),"Enter"==e.key&&e.shiftKey&&(ev.eval=1),("Shift"==e.key||e.shiftKey)&&(ev.shift=0),"m"==e.key&&"draw"==uimode&&in_layer()&&(ev.hidemenu^=1),"t"==e.key&&"draw"==uimode&&in_layer()&&(dr.trans^=1),"u"==e.key&&"draw"==uimode&&in_layer()&&(dr.under^=1);const t=24+count(deck.brushes);"9"==e.key&&"draw"==uimode&&null==ms.type&&(dr.brush=max(0,dr.brush-1)),"0"==e.key&&"draw"==uimode&&null==ms.type&&(dr.brush=min(t-1,dr.brush+1)),"Escape"==e.key&&(ev.exit=1),wid.infield||wid.ingrid||null!=ms.type||"interact"!=uimode||!card_is(con())||("ArrowUp"==e.key&&(msg.target_navigate=ifield(deck,"card"),msg.arg_navigate=lms("up")),"ArrowDown"==e.key&&(msg.target_navigate=ifield(deck,"card"),msg.arg_navigate=lms("down")),"ArrowLeft"==e.key&&(msg.target_navigate=ifield(deck,"card"),msg.arg_navigate=lms("left")),"ArrowRight"==e.key&&(msg.target_navigate=ifield(deck,"card"),msg.arg_navigate=lms("right"))),e.preventDefault()},q("body").onblur=e=>{ev.alt=0,keydown={}};let local_clipboard="";getclipboard=e=>{const t=document.createElement("textarea");t.style.top="0",t.style.left="0",t.position="fixed",t.onpaste=e=>{e.stopPropagation()},document.body.appendChild(t),t.focus(),t.select();const r=document.execCommand("paste"),i=t.value;if(document.body.removeChild(t),r)e(i);else try{navigator.clipboard.readText().then(t=>{e(t)},e=>e)}catch(t){e(local_clipboard)}},setclipboard=e=>{local_clipboard=e;const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.position="fixed",t.oncopy=e=>{e.stopPropagation()},document.body.appendChild(t),t.focus(),t.select();const r=document.execCommand("copy");if(document.body.removeChild(t),!r)try{navigator.clipboard.writeText(e).then(e=>e,e=>e)}catch(e){console.log(e)}},docut=e=>{if(wid.fv){const e=rtext_span(wid.fv.table,wid.cursor),t=rtext_is_image(e);return field_keys("Delete",0),t?image_write(t):ls(rtext_string(e))}if("recording"==ms.type&&"stopped"==au.mode){const e=sound_write(sound_selected());return sound_delete(),e}if(null==ms.type&&"draw"==uimode&&(bg_has_sel()||bg_has_lasso())){const e=bg_has_lasso()?image_mask(dr.limbo,dr.mask):dr.limbo?bg_scaled_limbo():bg_copy_selection(dr.sel_here);return bg_scoop_selection(),bg_delete_selection(),image_write(e)}if(null==ms.type&&"object"==uimode&&ob.sel.length){ob_order();const e=ls(con_copy(con(),lml(ob.sel)));return ob_destroy(),e}return null},docopy=e=>{if(wid.gv)return ls(n_writecsv([wid.gv.table,grid_format()]));if(wid.fv){const e=rtext_span(wid.fv.table,wid.cursor),t=rtext_is_image(e);return t?image_write(t):ls(rtext_string(e))}if("recording"==ms.type&&"stopped"==au.mode)return sound_write(sound_selected());if(null==ms.type&&"draw"==uimode&&(bg_has_sel()||bg_has_lasso())){const e=bg_has_lasso()?image_mask(dr.limbo,dr.mask):dr.limbo?bg_scaled_limbo():bg_copy_selection(dr.sel_here);return image_write(e)}return null==ms.type&&"object"==uimode&&ob.sel.length?(ob_order(),ls(con_copy(con(),lml(ob.sel)))):null},dopaste=(e,t)=>{if(e=clchars(e),(null==ms.type||"contraption_props"==ms.type&&wid.fv)&&/^%%IMG[012]/.test(e)){const r=image_read(e);if(0==r.size.x||0==r.size.y)return;wid.fv?"rich"!=wid.f.style?field_input(e):field_edit(lms(""),r,"i",wid.cursor):(setmode("draw"),bg_paste(r,0,t))}else if("recording"==ms.type&&"stopped"==au.mode&&/^%%SND0/.test(e))sound_edit(sound_replace(sound_read(e)));else if(null==ms.type&&/^%%WGT0/.test(e)){const t=pjson(e,6,e.length-6).value;let r=dget(t,lms("d")),i=dget(t,lms("w"));i=i?ll(i):[],merge_fonts(deck,dget(t,lms("f"))),merge_prototypes(deck,r?ld(r):lmd(),i),ob_create(i)}else if(null==ms.type&&/^%%CRD0/.test(e)){const t=deck_paste(deck,lms(e));con_set(null);const r=ifield(deck,"card"),i=ln(ifield(r,"index"));iwrite(t,lms("index"),lmn(i+1)),n_go([t],deck)}else if(/^%%RTX0/.test(e)){if(wid.fv){const t=rtext_decode(e);"rich"==wid.f.style?field_editr(t,wid.cursor):field_input(ls(rtext_string(t)))}}else wid.gv&&!wid.g.locked&&null==ms.type?grid_edit(n_readcsv([lms(e),lms(wid.g.format)])):wid.fv&&field_input(e)},cutcard=e=>{const t=ifield(deck,"card");setclipboard(ls(deck_copy(deck,t))),deck_remove(deck,t),mark_dirty()},copycard=e=>{const t=ifield(deck,"card");setclipboard(ls(deck_copy(deck,t)))},copywidgetimg=e=>{setclipboard(image_write(draw_widget(ob.sel[0]))),frame=context},pasteascanvas=e=>getclipboard(e=>{ob_create([lmd(["type","locked","image","border"].map(lms),[lms("canvas"),ONE,lms(e),ZERO])]),frame=context}),pasteintocanvas=e=>getclipboard(e=>{const t=image_read(e),r=ob.sel[0];iwrite(r,lms("size"),ifield(t,"size")),r.image=t}),menucut=e=>{const t=docut();t&&setclipboard(t)},menucopy=e=>{const t=docopy();t&&setclipboard(t)},menucopyrich=e=>{setclipboard(rtext_encode(rtext_span(wid.fv.table,wid.cursor)))},menupaste=e=>getclipboard(e=>{e.length&&dopaste(e)}),document.oncut=e=>{const t=docut();t&&(e.clipboardData.setData("text/plain",t),local_clipboard=t),e.preventDefault()},document.oncopy=e=>{const t=docopy();t&&(e.clipboardData.setData("text/plain",t),local_clipboard=t),e.preventDefault()},document.onpaste=e=>{const t=e.clipboardData||e.originalEvent.clipboardData;if(t.items[0]){const e=t.items[0].getAsFile();if(e&&/^image\//.test(e.type))return void load_image(e);if(e&&/^audio\//.test(e.type))return void load_sound(e)}dopaste(t.getData("text/plain")),e.preventDefault()},q("body").ondragover=e=>e.preventDefault(),q("body").ondrop=e=>{e.preventDefault();const t=e.dataTransfer.files.item(0);t&&!lb(ifield(deck,"locked"))&&(/\.(psv|csv)$/i.test(t.name)&&t.text().then(e=>{const r=n_readcsv([lms(e),NIL,lms("text/csv"==t.type?",":"|")]);setmode("object"),ob_create([lmd([lms("type"),lms("value")],[lms("grid"),monad.cols(r)])])}),/\.(html|deck)$/i.test(t.name)&&t.text().then(e=>{modal_enter("resources"),ms.message=deck_read(e),ms.grid=gridtab(res_enumerate(ms.message))}),/\.hex$/i.test(t.name)&&t.text().then(e=>{const t=(e,t)=>{const r=(255&e>>16)-(255&t>>16),i=(255&e>>8)-(255&t>>8),l=(255&e)-(255&t);return r*r+i*i+l*l};iwrite(deck.patterns,lmn(32),lmn(16777215)),iwrite(deck.patterns,lmn(47),ZERO);let r=ll(dyad.parse(lms("%h"),lml(e.split("\n").slice(0,-1).map(lms))));if(r.length>14){let e=0,i=0;r.map((l,s)=>{t(ln(l),0)<t(ln(r[e]),0)&&(e=s),t(ln(l),16777215)<t(ln(r[i]),16777215)&&(i=s)}),iwrite(deck.patterns,lmn(47),r[e]),iwrite(deck.patterns,lmn(32),r[i]),r=r.filter((t,r)=>r!=e&&r!=i)}for(let e=0;e<15&&e<r.length;e++)iwrite(deck.patterns,lmn(33+e),r[e])}),/^image\//.test(t.type)&&load_image(t),/^audio\//.test(t.type)&&load_sound(t))};const calculateColorPickerCenterPosition=(e,t)=>{const r=window.self!==window.top;let i,l,s=0,n=0,o=0,a=0,d=!1;if(r)try{const e=window.top,t=e.innerWidth||e.document.documentElement.clientWidth,r=e.innerHeight||e.document.documentElement.clientHeight;d=!0;try{const e=window.frameElement;if(e&&e.getBoundingClientRect){const d=e.getBoundingClientRect();s=d.left,n=d.top;const c=d.left,A=d.top,m=d.right,_=d.bottom,u=Math.max(0,c),p=Math.max(0,A),g=Math.min(t,m),f=Math.min(r,_);o=Math.max(0,g-u),a=Math.max(0,f-p),i=t,l=r,0!==o&&0!==a||(o=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight)}else i=t,l=r,o=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight}catch(e){i=t,l=r,o=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight}}catch(e){i=window.innerWidth||document.documentElement.clientWidth,l=window.innerHeight||document.documentElement.clientHeight,o=i,a=l,d=!1}else i=window.innerWidth||document.documentElement.clientWidth,l=window.innerHeight||document.documentElement.clientHeight,o=i,a=l,d=!1;const c=window.innerWidth||document.documentElement.clientWidth,A=window.innerHeight||document.documentElement.clientHeight;let m,_;if(r){m=c/2-e/2,_=A/2-t/2,m=Math.max(10,Math.min(m,c-e-10)),_=Math.max(10,Math.min(_,A-t-10))}else{m=i/2-e/2,_=l/2-t/2,m=Math.max(10,Math.min(m,i-e-10)),_=Math.max(10,Math.min(_,l-t-10))}if(r&&d){const r=Math.max(0,s),d=Math.max(0,n),u=Math.min(i,s+o),p=Math.min(l,n+a),g=s+m,f=n+_,w=f+t;if(g+e>u){const t=u-e-s-10;m=Math.max(10,Math.min(t,m))}if(w>p){const e=p-t-n-10;_=Math.max(10,Math.min(e,_))}if(g<r){const t=r-s+10;m=Math.min(c-e-10,Math.max(t,m))}if(f<d){const e=d-n+10;_=Math.min(A-t-10,Math.max(e,_))}}else r||(e>i&&(m=10),t>l&&(_=10));return{left:m,top:_}},ensureColorPickerInView=()=>{const e=q(".sp-container");if(!e)return;e.style.position="fixed",e.style.transform="none",e.style.zIndex="10001";const t=e.getBoundingClientRect(),r=t.width,i=t.height,l=calculateColorPickerCenterPosition(r,i);e.style.top=l.top+"px",e.style.left=l.left+"px"};let resizeTimeout=null;window.addEventListener("resize",()=>{resizeTimeout&&clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{const e=q(".sp-container");e&&"none"!==e.style.display&&ensureColorPickerInView()},30)}),show_color_picker_for_pattern=e=>{if(console.log("为图案索引显示调色板:",e),!deck.patterns)return void console.error("deck.patterns不存在，无法编辑颜色");const t="#"+("000000"+(ln(dget(deck.patterns,lmn(e)))||0).toString(16)).slice(-6),r=q("#colorPickerModal");r.style.display="block",r.style.background="transparent",r.style.border="none",r.style.padding="0";const i=calculateColorPickerCenterPosition(300,400);r.style.top=i.top+"px",r.style.left=i.left+"px",r.style.transform="none";const l=r.querySelector('div[style*="font-weight:bold"]'),s=r.querySelector('div[style*="margin-top:10px"]');l&&(l.style.display="none"),s&&(s.style.display="none");const n=()=>{const e=q("#display"),t=q("#ltools"),r=q("#rtools");e&&(e.style.pointerEvents=""),t&&(t.style.pointerEvents=""),r&&(r.style.pointerEvents="")};if((()=>{const e=q("#display"),t=q("#ltools"),r=q("#rtools");e&&(e.style.pointerEvents="none"),t&&(t.style.pointerEvents="none"),r&&(r.style.pointerEvents="none")})(),"undefined"!=typeof $&&$.fn.spectrum){q("#colorPicker1").type="text",$("#colorPicker1").spectrum("destroy"),$("#colorPicker1").spectrum({color:t,showInput:!0,showSelectionPalette:!1,animationSpeed:0,preferredFormat:"hex",showAlpha:!1,chooseText:_t("choose"),cancelText:_t("cancel"),togglePaletteMoreText:_t("more"),togglePaletteLessText:_t("less"),clearText:_t("clear"),noColorSelectedText:_t("no_color_selected"),hide:function(e){if("none"!==r.style.display){r.style.display="none",r.style.background="",r.style.border="",r.style.padding="",r.style.top="",r.style.left="",r.style.transform="";const e=r.querySelector('div[style*="font-weight:bold"]'),t=r.querySelector('div[style*="margin-top:10px"]'),i=q("#colorPicker1");e&&(e.style.display=""),t&&(t.style.display=""),i&&(i.style.display=""),n()}},cancel:function(){r.style.display="none",r.style.background="",r.style.border="",r.style.padding="",r.style.top="",r.style.left="",r.style.transform="";const e=r.querySelector('div[style*="font-weight:bold"]'),t=r.querySelector('div[style*="margin-top:10px"]'),i=q("#colorPicker1");e&&(e.style.display=""),t&&(t.style.display=""),i&&(i.style.display=""),n()}}),setTimeout(()=>{$("#colorPicker1").spectrum("show"),requestAnimationFrame(()=>{ensureColorPickerInView();const e=document.querySelector(".sp-original-input-container");e&&(e.style.display="none");document.querySelectorAll(".sp-input").forEach(e=>{e.removeAttribute("readonly"),e.removeAttribute("disabled"),e.style.pointerEvents="auto",e.addEventListener("focus",e=>{e.stopPropagation()},!0),e.addEventListener("click",e=>{e.stopPropagation()},!0),e.addEventListener("keydown",e=>{e.stopPropagation()},!0),e.addEventListener("keyup",e=>{e.stopPropagation()},!0),e.addEventListener("input",e=>{e.stopPropagation()},!0)})})},0)}else{const e=q("#colorPicker1");e.type="color",e.value=t,e.style.display="block",e.style.width="100%",e.style.height="50px",e.style.cursor="pointer",r.style.background="white",r.style.border="2px solid #333",r.style.padding="20px",l&&(l.style.display=""),s&&(s.style.display=""),e.addEventListener("click",e=>{e.stopPropagation()},!0),l&&l.addEventListener("click",e=>{e.stopPropagation()},!0),e.onchange=e=>{t=e.target.value},setTimeout(()=>{e.click()},10)}q("#colorOk").onclick=i=>{let l=t;if(l="undefined"!=typeof $&&$.fn.spectrum?$("#colorPicker1").spectrum("get").toHexString():q("#colorPicker1").value,console.log("选择的颜色:",l,"应用到图案索引:",e),!deck.patterns)return console.error("deck.patterns不存在，无法应用颜色"),r.style.display="none",void n();const s=parseInt(l.slice(1),16);iwrite(deck.patterns,lmn(e),lmn(s)),r.style.display="none",r.style.background="",r.style.border="",r.style.padding="",r.style.top="",r.style.left="",r.style.transform="";const o=r.querySelector('div[style*="font-weight:bold"]'),a=r.querySelector('div[style*="margin-top:10px"]'),d=q("#colorPicker1");o&&(o.style.display=""),a&&(a.style.display=""),d&&(d.style.display=""),n(),mark_dirty()},q("#colorCancel").onclick=e=>{r.style.display="none",r.style.background="",r.style.border="",r.style.padding="",r.style.top="",r.style.left="",r.style.transform="";const t=r.querySelector('div[style*="font-weight:bold"]'),i=r.querySelector('div[style*="margin-top:10px"]'),l=q("#colorPicker1");t&&(t.style.display=""),i&&(i.style.display=""),l&&(l.style.display=""),n()},r.onclick=e=>{if(e.target===r){const e=q("#colorPicker1");if(e&&"color"===e.type)return;r.style.display="none",r.style.background="",r.style.border="",r.style.padding="",r.style.top="",r.style.left="",r.style.transform="";const t=r.querySelector('div[style*="font-weight:bold"]'),i=r.querySelector('div[style*="margin-top:10px"]');t&&(t.style.display=""),i&&(i.style.display=""),e&&(e.style.display=""),n()}}},show_color_picker=e=>{console.log("调色板被调用，当前wid状态:",wid);const t={wid:wid,fv:wid.fv,infield:wid.infield,cursor:wid.cursor?{...wid.cursor}:null};console.log("保存的上下文:",t);let r="";try{wid.fv&&wid.fv.table&&(r=wid.fv.table.v.get("text")[0].v)}catch(e){console.log("获取文本内容失败:",e),r=""}const i=q("#colorPickerModal");i.style.display="block",i.style.background="transparent",i.style.border="none",i.style.padding="0";const l=calculateColorPickerCenterPosition(300,400);i.style.top=l.top+"px",i.style.left=l.left+"px",i.style.transform="none";const s=i.querySelector('div[style*="font-weight:bold"]'),n=i.querySelector('div[style*="margin-top:10px"]'),o=q("#colorPicker1");s&&(s.style.display="none"),n&&(n.style.display="none"),o&&(o.style.display="none");const a=()=>{const e=q("#display"),t=q("#ltools"),r=q("#rtools");e&&(e.style.pointerEvents=""),t&&(t.style.pointerEvents=""),r&&(r.style.pointerEvents="")};(()=>{const e=q("#display"),t=q("#ltools"),r=q("#rtools");e&&(e.style.pointerEvents="none"),t&&(t.style.pointerEvents="none"),r&&(r.style.pointerEvents="none")})();let d=r.trim()||"#ff0000";6===d.length&&/^[0-9A-Fa-f]{6}$/.test(d)?d="#"+d:7===d.length&&d.startsWith("#")||(d="#ff0000");const c=()=>{if(console.log("自动应用颜色:",d),7!=d.length)return;window.currentColor2=d.slice(1,7);let e=!1;setTimeout(()=>{if(!e&&t.fv&&t.fv.table)try{t.fv.table.v.set("text",[{t:"str",v:window.currentColor2}]),field_notify(),console.log("方式2成功：直接设置文本字段为:",window.currentColor2),e=!0}catch(e){console.log("方式2失败:",e)}},1),i.style.display="none",i.style.background="",i.style.border="",i.style.padding="",i.style.top="",i.style.left="",i.style.transform="";const r=i.querySelector('div[style*="font-weight:bold"]'),l=i.querySelector('div[style*="margin-top:10px"]'),s=q("#colorPicker1");r&&(r.style.display=""),l&&(l.style.display=""),s&&(s.style.display=""),a()};if("undefined"!=typeof $&&$.fn.spectrum){q("#colorPicker1").type="text",$("#colorPicker1").spectrum("destroy"),$("#colorPicker1").spectrum({color:d,showInput:!0,showSelectionPalette:!1,animationSpeed:0,preferredFormat:"hex",change:function(e){d=e.toHexString(),c()},hide:function(e){if("none"!==i.style.display){i.style.display="none",i.style.background="",i.style.border="",i.style.padding="",i.style.top="",i.style.left="",i.style.transform="";const e=i.querySelector('div[style*="font-weight:bold"]'),t=i.querySelector('div[style*="margin-top:10px"]'),r=q("#colorPicker1");e&&(e.style.display=""),t&&(t.style.display=""),r&&(r.style.display=""),a()}},cancel:function(){i.style.display="none",i.style.background="",i.style.border="",i.style.padding="",i.style.top="",i.style.left="",i.style.transform="";const e=i.querySelector('div[style*="font-weight:bold"]'),t=i.querySelector('div[style*="margin-top:10px"]'),r=q("#colorPicker1");e&&(e.style.display=""),t&&(t.style.display=""),r&&(r.style.display=""),a()},showAlpha:!1,chooseText:_t("choose"),cancelText:_t("cancel"),togglePaletteMoreText:_t("more"),togglePaletteLessText:_t("less"),clearText:_t("clear"),noColorSelectedText:_t("no_color_selected")}),setTimeout(()=>{$("#colorPicker1").spectrum("show"),requestAnimationFrame(()=>{ensureColorPickerInView();const e=document.querySelector(".sp-original-input-container");e&&(e.style.display="none");document.querySelectorAll(".sp-input").forEach(e=>{e.removeAttribute("readonly"),e.removeAttribute("disabled"),e.style.pointerEvents="auto",e.addEventListener("focus",e=>{e.stopPropagation()},!0),e.addEventListener("click",e=>{e.stopPropagation()},!0),e.addEventListener("keydown",e=>{e.stopPropagation()},!0),e.addEventListener("keyup",e=>{e.stopPropagation()},!0),e.addEventListener("input",e=>{e.stopPropagation()},!0)})})},10)}else{const e=q("#colorPicker1");e.type="color",e.value=d,e.style.display="block",e.style.width="100%",e.style.height="50px",e.style.cursor="pointer",i.style.background="white",i.style.border="2px solid #333",i.style.padding="20px",s&&(s.style.display=""),n&&(n.style.display=""),e.addEventListener("click",e=>{e.stopPropagation()},!0),s&&s.addEventListener("click",e=>{e.stopPropagation()},!0),e.onchange=e=>{d=e.target.value,7==d.length&&c()},setTimeout(()=>{e.click()},10)}q("#colorOk").onclick=e=>{c()},q("#colorCancel").onclick=e=>{i.style.display="none",i.style.background="",i.style.border="",i.style.padding="",i.style.top="",i.style.left="",i.style.transform="";const t=i.querySelector('div[style*="font-weight:bold"]'),r=i.querySelector('div[style*="margin-top:10px"]'),l=q("#colorPicker1");t&&(t.style.display=""),r&&(r.style.display=""),l&&(l.style.display=""),a()},i.onclick=e=>{if(e.target===i){const e=q("#colorPicker1");if(e&&"color"===e.type)return;i.style.display="none",i.style.background="",i.style.border="",i.style.padding="",i.style.top="",i.style.left="",i.style.transform="";const t=i.querySelector('div[style*="font-weight:bold"]'),r=i.querySelector('div[style*="margin-top:10px"]');t&&(t.style.display=""),r&&(r.style.display=""),e&&(e.style.display=""),a()}}},apply_color_to_text=(e,t,r)=>{if(!wid.fv)return;let i=e;if(r&&t.trim()){const e=t.trim();(/^#[0-9A-Fa-f]{3,6}$/.test(e)||/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/i.test(e)||/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[0-9.]+\s*\)$/i.test(e)||/^(red|blue|green|yellow|black|white|gray|orange|purple|pink|brown)$/i.test(e))&&(i=e)}r&&field_keys("Delete",0),field_input(i)},pushstate(lmenv()),load_deck(deck_read(q('script[language="decker"]')?.innerText||window.DECK_DATA)),window.DECK_DATA="";const tag=decodeURI(document.URL.split("#")[1]||"");tag.length&&iwrite(deck,lms("card"),lms(tag)),resize(),requestAnimationFrame(loop),window.loadDeckFile=function(e){"function"==typeof e?open_text(".deck,.html",function(t){try{const r=deck_read(t);e(null,r,t)}catch(r){console.error("Error reading deck file:",r),e(r,null,t)}}):console.error("loadDeckFile: callback must be a function")},window.loadDeckFileAsync=function(){return new Promise((e,t)=>{window.loadDeckFile((r,i,l)=>{r?t(r):e({deckData:i,rawText:l})})})},window.exportDeckFile=function(e,t){e||(e="exported_deck.deck"),"html"===t||e.endsWith(".html")?(e.endsWith(".html")||(e+=".html"),save_deck(deck,e)):(e.endsWith(".deck")||(e=e.replace(/\.[^.]*$/,"")+".deck"),save_deck(deck,e))},window.getDeckData=function(e){try{const t=deck_write(deck);return isSaved=!0,"html"===e?deck_html(deck,t):t}catch(e){return console.error("Error serializing deck:",e),null}};const generateGifFromFrames=(e,t,r,i)=>{if(!e||0===e.length)return null;const l=writegif(e,t,r);if(i&&"base64"===i.format){const e=btoa(String.fromCharCode.apply(null,Uint8Array.from(l)));return i.dataUrl?`data:image/gif;base64,${e}`:e}return i&&"blob"===i.format?new Blob([Uint8Array.from(l)],{type:"image/gif"}):new Uint8Array(l)};window.getGifData=function(e){try{const t=!1!==(e=e||{}).transparent,r=e.delay||10;if(!deck||!dr||"undefined"==typeof con)return console.error("Required context not available"),null;if(bg_has_sel()){const e=rcopy(dr.sel_here);bg_end_selection(),dr.sel_here=e}let i=draw_con(con(),1),l=rect(),s=1,n=0,o=dr.trans?0:32,a=[];const d=deck.patterns.anim,c=deck.patterns.pal.pix,A=(e,t,r,i)=>e<28||e>31?e:d[e-28][i%max(1,d[e-28].length)],m=(e,t,r)=>e<2?e?1:0:e>31?32==e?0:1:1&c[t%8+r%8*8+64*e];if(bg_has_sel()||bg_has_lasso()){const e=rclip(dr.sel_here,con_dim());i=image_copy(i,e),l=rcopy(e)}for(let e=0;e<4&&dr.show_anim;e++){const t=d[e].length;t&&(s=lcm(s,t))}for(let e=0;e<s;e++){const t=image_copy(i);for(let r=0;r<i.size.y;r++)for(let s=0;s<i.size.x;s++){const a=t.pix[s+i.size.x*r];a>=28&&a<=31&&(n=1);const d=A(a,s,r,e),c=m(d,s+l.x,r+l.y);t.pix[s+i.size.x*r]=d>=32?d:c?1:o}a.push(bg_has_lasso()?image_mask(t,dr.mask):t)}const _=n?a:[a[0]],u=n?a.map(()=>r):[r];return generateGifFromFrames(_,u,t,e)}catch(e){return console.error("Error generating GIF:",e),null}};let autoSwitchState={enabled:!1,startCard:1,endCard:Math.max(1,getCardCount()-5),currentCard:1,intervals:[],uniformInterval:100,useUniformInterval:!0,timer:null,startTime:0,multiSelect:!1,selectedCards:[]};function copyAndPasteCard(){const e=ifield(deck,"card");if(e){const t=deck_copy(deck,e),r=deck_paste(deck,t);con_set(null);const i=ln(ifield(e,"index"));iwrite(r,lms("index"),lmn(i+1)),n_go([r],deck),mark_dirty()}}function startAutoSwitch(){autoSwitchState.enabled||(autoSwitchState.enabled=!0,autoSwitchState.currentCard=autoSwitchState.startCard,autoSwitchState.startTime=Date.now(),n_go([lmn(autoSwitchState.currentCard)],deck),scheduleNextSwitch())}function stopAutoSwitch(){autoSwitchState.enabled&&(autoSwitchState.enabled=!1,autoSwitchState.timer&&(clearTimeout(autoSwitchState.timer),autoSwitchState.timer=null))}function scheduleNextSwitch(){if(!autoSwitchState.enabled)return;let e;const t=autoSwitchState.currentCard-autoSwitchState.startCard;for(;autoSwitchState.intervals.length<=t;)autoSwitchState.intervals.push(autoSwitchState.uniformInterval);e=autoSwitchState.intervals[t]||autoSwitchState.uniformInterval,autoSwitchState.timer=setTimeout(()=>{autoSwitchState.currentCard++,autoSwitchState.currentCard>autoSwitchState.endCard&&(autoSwitchState.currentCard=autoSwitchState.startCard),n_go([lmn(autoSwitchState.currentCard)],deck),scheduleNextSwitch()},e)}function pasteCard(){getclipboard(e=>{if(e&&/^%%CRD0/.test(e)){const t=deck_paste(deck,lms(e));con_set(null);const r=ifield(deck,"card"),i=ln(ifield(r,"index"));iwrite(t,lms("index"),lmn(i+1)),n_go([t],deck),mark_dirty()}})}function getCardCount(){return count(ifield(deck,"cards"))}function getCurrentCardIndex(){return ln(ifield(ifield(deck,"card"),"index"))}function startCanvasRecording(){console.log("开始Canvas录制..."),recordingCanvas||(recordingCanvas=document.createElement("canvas"),recordingContext=recordingCanvas.getContext("2d"),recordingContext.imageSmoothingEnabled=!1,recordingContext.webkitImageSmoothingEnabled=!1,recordingContext.mozImageSmoothingEnabled=!1,recordingContext.msImageSmoothingEnabled=!1);const e=deck.size;recordingCanvas.width=e.x,recordingCanvas.height=e.y;try{let e;recordingStream=recordingCanvas.captureStream(recordingFrameRate),recordedChunks=[],e=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:8e6}:MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?{mimeType:"video/webm;codecs=vp8",videoBitsPerSecond:8e6}:{videoBitsPerSecond:8e6},canvasRecorder=new MediaRecorder(recordingStream,e),canvasRecorder.ondataavailable=function(e){e.data.size>0&&recordedChunks.push(e.data)},canvasRecorder.onstop=function(){console.log("录制停止，保存视频..."),saveRecordedVideo()},canvasRecorder.start(),isRecording=!0,recordingStartTime=Date.now(),console.log("录制已开始"),startAutoSwitchForRecording()}catch(e){console.error("启动录制失败:",e),alert("录制启动失败: "+e.message)}}function startAutoSwitchForRecording(){console.log("开始自动播放用于录制..."),autoSwitchState.enabled&&stopAutoSwitch(),startAutoSwitch();const e=autoSwitchState.endCard-autoSwitchState.startCard+1;let t=0;for(let r=0;r<e;r++){t+=autoSwitchState.intervals[r]||autoSwitchState.uniformInterval}console.log(`预计录制时间: ${t}ms`),setTimeout(()=>{stopCanvasRecording()},t+1e3)}function stopCanvasRecording(){console.log("停止Canvas录制..."),stopAutoSwitch(),canvasRecorder&&isRecording&&(canvasRecorder.stop(),isRecording=!1)}function saveRecordedVideo(){if(console.log("保存录制视频..."),0===recordedChunks.length)return console.error("没有录制数据"),void alert("录制失败：没有录制数据");try{const e=new Blob(recordedChunks,{type:"video/webm"}),t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=`deck_recording_${(new Date).getTime()}.webm`,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>{URL.revokeObjectURL(t)},1e3),console.log("视频保存完成"),alert("录制完成！视频已保存。")}catch(e){console.error("保存视频失败:",e),alert("保存视频失败: "+e.message)}recordedChunks=[],canvasRecorder=null,isRecording=!1}function updateRecordingCanvas(){if(isRecording&&recordingCanvas&&recordingContext)try{const e=q("#render");if(!e)return;recordingContext.imageSmoothingEnabled=!1,recordingContext.webkitImageSmoothingEnabled=!1,recordingContext.mozImageSmoothingEnabled=!1,recordingContext.msImageSmoothingEnabled=!1,recordingContext.clearRect(0,0,recordingCanvas.width,recordingCanvas.height),recordingContext.drawImage(e,0,0)}catch(e){console.error("更新录制Canvas失败:",e)}}if(window.isInWebView){const s=512,n=342;window.canvasTransform={scale:1,offsetX:0,offsetY:0,originalWidth:s,originalHeight:n,isRotated:!1};let o=!1;const a=window.resize;function adjustCanvasSizeForMobile(){if(o)return;o=!0;const e=document.getElementById("display");if(!e)return void(o=!1);const t=window.innerWidth,r=window.innerHeight,i=r>t,l=s,a=n;let d,c,A;if(console.log("Canvas actual size:",l,"x",a),console.log("Viewport:",t,"x",r),console.log("Is portrait:",i),i){const i=t/a,s=r/l;d=Math.min(i,s);const n=a*d,o=l*d;c=(t-n)/2,A=(r-o)/2,console.log("Portrait mode - Scale:",d.toFixed(3)),console.log("Visual size after rotation:",n.toFixed(1),"x",o.toFixed(1));const m=t/2-l/2,_=r/2-a/2;e.style.position="absolute",e.style.left=m+"px",e.style.top=_+"px",e.style.width="",e.style.height="",e.style.transformOrigin="center center",e.style.transform=`rotate(90deg) scale(${d})`,window.canvasTransform={scale:d,offsetX:c,offsetY:A,originalWidth:l,originalHeight:a,isRotated:!0,viewportWidth:t,viewportHeight:r}}else{const i=t/l,s=r/a;d=Math.min(i,s);const n=l*d,o=a*d;c=(t-n)/2,A=(r-o)/2,console.log("Landscape mode - Scale:",d.toFixed(3)),console.log("Scaled size:",n.toFixed(1),"x",o.toFixed(1));const m=t/2-l/2,_=r/2-a/2;e.style.position="absolute",e.style.left=m+"px",e.style.top=_+"px",e.style.width="",e.style.height="",e.style.transformOrigin="center center",e.style.transform=`scale(${d})`,window.canvasTransform={scale:d,offsetX:c,offsetY:A,originalWidth:l,originalHeight:a,isRotated:!1,viewportWidth:t,viewportHeight:r}}e.style.margin="0",e.style.padding="0",document.body.style.overflow="hidden",document.body.style.display="block",document.body.style.margin="0",document.body.style.padding="0",document.documentElement.style.overflow="hidden",setTimeout(()=>{o=!1},200)}window.resize=function(){window.zoom=1,window.tzoom=0;const e=document.getElementById("display"),t=document.getElementById("render"),r=document.getElementById("ltools"),i=document.getElementById("rtools"),l=document.getElementById("lrender"),o=document.getElementById("rrender");e&&(e.width=s,e.height=n),t&&(t.width=s,t.height=n),r&&(r.width=0,r.height=0),i&&(i.width=0,i.height=0),l&&(l.width=0,l.height=0),o&&(o.width=0,o.height=0),console.log("WebView resize: zoom=1, canvas="+s+"x"+n),setTimeout(adjustCanvasSizeForMobile,50)},void 0===window.originalMouse&&(window.originalMouse=window.mouse,window.mouse=function(e,t){const r=window.canvasTransform;let i,l;const s=r.viewportWidth/2,n=r.viewportHeight/2,o=e.pageX-s,a=e.pageY-n;if(r.isRotated){const e=-o;i=a/r.scale+r.originalWidth/2,l=e/r.scale+r.originalHeight/2}else i=o/r.scale+r.originalWidth/2,l=a/r.scale+r.originalHeight/2;void 0!==ev&&(ev.rawpos={x:e.pageX,y:e.pageY}),1!=e.button?t(Math.floor(i),Math.floor(l),0!=e.button):"undefined"!=typeof down&&t==down&&void 0!==ev&&(ev.mdown=1)}),document.addEventListener("DOMContentLoaded",function(){setTimeout(adjustCanvasSizeForMobile,100)}),window.addEventListener("resize",function(){setTimeout(adjustCanvasSizeForMobile,100)})}function adjustCanvasSize(){const e=document.getElementById("display");if(e){const t=e.getContext("2d");t&&(t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1)}}setTimeout(()=>{adjustCanvasSize()},1e3),window.addEventListener("beforeunload",function(e){if(!isSaved)return e.preventDefault(),e.returnValue=_t("unsaved_changes_leave"),_t("unsaved_changes_leave")});